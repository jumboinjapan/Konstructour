<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Konstructour ‚Äî –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../styles/admin-japanese.css" rel="stylesheet">
    <style>
      body{ background: rgb(var(--color-washi)); min-height:100vh; }
      .tab{ padding:14px 20px; font-size:16px; border-radius:10px; cursor:pointer; flex:1 1 0%; text-align:center; }
      .tab.active{ background:#fff; border:1px solid rgba(139,90,43,.15); }
      .tab-content{ display:none; }
      .tab-content.active{ display:block; }
      
      /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .fade-in {
        animation: fadeInUp 0.4s ease-out forwards;
        opacity: 0;
      }
      
      .region-count-badge {
        animation: fadeInUp 0.3s ease-out forwards;
        opacity: 0;
      }
      /* Fixed sizes to keep API action row stable */
      .api-select{ width: 180px; }
      .api-base-label{ display:inline-block; width: 120px; }
      .api-base-input{ width: 280px; }
      .api-table-label{ display:inline-block; width: 140px; }
      .api-table-input{ width: 220px; }
      
      /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π POI */
      .text-brown-600 { color: #8B4513; }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è POI –∫–∞—Ä—Ç–æ—á–µ–∫ */
      .poi-card {
        position: relative;
        transform: translateY(0);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .poi-card:hover {
        transform: translateY(-4px);
      }
      
      .poi-card:active {
        transform: translateY(-2px);
      }
      
      /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
      .poi-card {
        animation: fadeInCard 0.4s ease-out forwards;
        opacity: 0;
      }
      
      @keyframes fadeInCard {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* –ó–∞–¥–µ—Ä–∂–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ */
      .poi-card:nth-child(1) { animation-delay: 0.05s; }
      .poi-card:nth-child(2) { animation-delay: 0.1s; }
      .poi-card:nth-child(3) { animation-delay: 0.15s; }
      .poi-card:nth-child(4) { animation-delay: 0.2s; }
      .poi-card:nth-child(5) { animation-delay: 0.25s; }
      .poi-card:nth-child(6) { animation-delay: 0.3s; }
      .poi-card:nth-child(n+7) { animation-delay: 0.35s; }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
      #poi-search-input:focus,
      #poi-category-filter:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }
      
      /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å—á–µ—Ç—á–∏–∫–∞ */
      #poi-count-label {
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body data-no-redirect="true">
    <div class="dashboard-grid">
      <aside class="sidebar texture-wood">
        <div class="p-6">
          <div class="flex items-center mb-8">
            <div class="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center mr-3">
              <svg class="w-8 h-8 text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
            </div>
            <div>
              <h1 class="text-xl font-light text-gray-800">Konstructour</h1>
              <p class="text-xs text-gray-600">Site Admin</p>
            </div>
          </div>
          <nav class="space-y-2">
            <a href="dashboard.html" class="sidebar-link"><i class="fas fa-th-large mr-3 text-indigo-600"></i>–û–±–∑–æ—Ä</a>
            <a href="api-catalog.html" class="sidebar-link"><i class="fas fa-list mr-3 text-gray-600"></i>–ö–∞—Ç–∞–ª–æ–≥ API</a>
            <a href="databases.html" class="menu-item active sidebar-link"><i class="fas fa-database mr-3 text-green-600"></i>–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</a>
            <a href="health-dashboard.html" class="sidebar-link"><i class="fas fa-heartbeat mr-3 text-red-600"></i>Health Dashboard</a>
          </nav>
        </div>
      </aside>
      <main class="p-8">
        <header class="mb-6">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h2 class="text-3xl font-light text-gray-800 mb-1">–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>
              <p class="text-gray-600">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –¥–∞–Ω–Ω—ã–º–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ API</p>
            </div>
            <div class="flex items-center gap-3">
              <button id="clear-cache-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2" title="–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à">
                <i class="fas fa-trash"></i>
                <span>–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</span>
              </button>
            </div>
          </div>
        </header>

        <div class="glass-panel p-8 rounded-lg mb-6">
          <div class="flex items-center gap-3">
            <button class="tab active" data-tab="regions"><i class="fas fa-globe-asia mr-2 text-blue-600"></i>–†–µ–≥–∏–æ–Ω—ã</button>
            <button class="tab" data-tab="tours"><i class="fas fa-route mr-2 text-green-600"></i>–¢—É—Ä—ã</button>
            <button class="tab" data-tab="templates"><i class="fas fa-layer-group mr-2 text-purple-600"></i>–®–∞–±–ª–æ–Ω—ã</button>
          </div>
        </div>

        <!-- –†–µ–≥–∏–æ–Ω—ã (–∏–µ—Ä–∞—Ä—Ö–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫) -->
        <section id="tab-regions" class="tab-content active">
          <div class="glass-panel p-6 rounded-lg relative">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-globe-asia mr-2 text-blue-600"></i>–†–µ–≥–∏–æ–Ω—ã</h3>
            </div>

            <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
            <div class="mb-4 -mt-1">
              <div id="db_breadcrumbs" class="flex items-center flex-wrap text-base text-gray-600"></div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ —É—Ä–æ–≤–Ω—è (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) -->
            <div id="db_cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥ —Å–µ—Ç–∫–æ–π -->
            <div class="mt-6 flex justify-center gap-4">
              <button id="db_fab_add" class="btn-japanese rounded-full w-12 h-12 flex items-center justify-center shadow-lg" title="–î–æ–±–∞–≤–∏—Ç—å">
                <i class="fas fa-plus"></i>
              </button>
              <button id="db_fab_sync" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg transition-colors" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å Airtable">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>
        </section>

        <!-- –¢—É—Ä—ã -->
        <section id="tab-tours" class="tab-content">
          <div class="glass-panel p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-route mr-2 text-green-600"></i>–¢—É—Ä—ã</h3>
            </div>
            <div id="tours_schema" class="text-sm text-gray-600">
              –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ Project Description.md. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ö–µ–º—ã –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.
            </div>
            <div class="mt-4">
              <div class="text-xs text-gray-500 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö</div>
              <div id="tours_preview" class="japanese-table w-full rounded-lg overflow-hidden">
                <div class="p-4 text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞–∂–º–∏—Ç–µ ¬´–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª.</div>
              </div>
            </div>
          </div>
        </section>

        <!-- –®–∞–±–ª–æ–Ω—ã -->
        <section id="tab-templates" class="tab-content">
          <div class="glass-panel p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-layer-group mr-2 text-purple-600"></i>–®–∞–±–ª–æ–Ω—ã</h3>
            </div>
            <div id="templates_schema" class="text-sm text-gray-600">
              –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ.
            </div>
            <div class="mt-4">
              <div class="text-xs text-gray-500 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö</div>
              <div id="templates_preview" class="japanese-table w-full rounded-lg overflow-hidden">
                <div class="p-4 text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞–∂–º–∏—Ç–µ ¬´–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª.</div>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>

    <script>
      // Airtable table IDs - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ
      window.AIRTABLE_BASE_ID = 'apppwhjFN82N9zNqm';
      window.AIRTABLE_COUNTRY_TABLE_ID = 'tble0eh9mstZeBKxM';
      window.AIRTABLE_REGIONS_TABLE_ID = 'tblbSajWkzI8X7M4U';
      window.AIRTABLE_CITIES_TABLE_ID = 'tblHaHc9NV0mA8bSa';
      window.AIRTABLE_POI_TABLE_ID = 'tblVCmFcHRpXUT24y';
      window.AIRTABLE_TICKETS_TABLE_ID = 'tblKOLhiHMihpWsVl';
      
      
      // –õ–æ–∫–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ DOM –∫–∞—Ä—Ç–æ—á–∫–∞–º
      window.getLocalRegionIds = function() {
        const regionCards = document.querySelectorAll('[data-go="cities"]');
        const regions = [];
        
        // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏–∑ –∫–æ–¥–∞
        const regionNames = ['–•–æ–∫–∫–∞–π–¥–æ', '–¢–æ—Ö–æ–∫—É', '–ö–∞–Ω—Ç–æ', '–¢—é–±—É', '–ö–∞–Ω—Å–∞–π', '–¢—é–≥–æ–∫—É', '–°–∏–∫–æ–∫—É', '–ö—é—Å—é', '–û–∫–∏–Ω–∞–≤–∞'];
        
        regionCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const ridElement = card.querySelector('.text-xs');
          
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞
          const correctName = regionNames[idx] || `–†–µ–≥–∏–æ–Ω ${idx+1}`;
          
          regions.push({
            id: id || `recREG${String(idx+1).padStart(3,'0')}`,
            name: nameElement ? nameElement.textContent.trim() : correctName,
            rid: ridElement ? ridElement.textContent.trim() : `REG-${String(idx+1).padStart(3,'0')}`,
            element: card
          });
        });
        
        console.log('–õ–æ–∫–∞–ª—å–Ω—ã–µ ID —Ä–µ–≥–∏–æ–Ω–æ–≤:', regions);
        return regions;
      };

      window.getLocalCityIds = function(regionId) {
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
        const cityCards = document.querySelectorAll('[data-go="pois"]');
        const cities = [];
        
        cityCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const codeElement = card.querySelector('.text-xs');
          
          cities.push({
            id: id || `recCITY${String(idx+1).padStart(3,'0')}`,
            name: nameElement ? nameElement.textContent.trim() : `–ì–æ—Ä–æ–¥ ${idx+1}`,
            code: codeElement ? codeElement.textContent.trim() : `CTY-${String(idx+1).padStart(3,'0')}`,
            element: card
          });
        });
        
        console.log(`–õ–æ–∫–∞–ª—å–Ω—ã–µ ID –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞ ${regionId}:`, cities);
        return cities;
      };

      window.getLocalPoiIds = function(cityId) {
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ POI –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
        const poiCards = document.querySelectorAll('[data-go="poi-details"]');
        const pois = [];
        
        poiCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const poiIdElement = card.querySelector('.text-xs');
          
          pois.push({
            id: id || `recPOI${String(idx+1).padStart(3,'0')}`,
            name: nameElement ? nameElement.textContent.trim() : `POI ${idx+1}`,
            poi_id: poiIdElement ? poiIdElement.textContent.trim() : `POI-${String(idx+1).padStart(3,'0')}`,
            element: card
          });
        });
        
        console.log(`–õ–æ–∫–∞–ª—å–Ω—ã–µ ID POI –¥–ª—è –≥–æ—Ä–æ–¥–∞ ${cityId}:`, pois);
        return pois;
      };

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏–∑ Airtable
      window.getRegionIds = async function() {
        try {
          const baseId = window.AIRTABLE_BASE_ID;
          const regTbl = window.AIRTABLE_REGIONS_TABLE_ID;
          const url = `/api/test-proxy.php?provider=airtable&base_id=${encodeURIComponent(baseId)}&table=${encodeURIComponent(regTbl)}`;
          
          console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º ID —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏–∑ Airtable...');
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.ok && data.body && data.body.records) {
            console.log('=== ID –†–ï–ì–ò–û–ù–û–í –ò–ó AIRTABLE ===');
            data.body.records.forEach((record, idx) => {
              const fields = record.fields || {};
              const name = fields['Name (RU)'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ (RU)'] || fields['Name'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ'] || `–†–µ–≥–∏–æ–Ω ${idx + 1}`;
              const rid = fields['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä'] || fields['Region ID'] || fields['ID'] || fields['–†–µ–≥–∏–æ–Ω ID'] || '';
              
              console.log(`${name}:`, {
                id: record.id,
                name: name,
                rid: rid || '–Ω–µ—Ç',
                fields: Object.keys(fields)
              });
            });
            console.log('=== –ö–û–ù–ï–¶ –°–ü–ò–°–ö–ê ID –†–ï–ì–ò–û–ù–û–í ===');
            return data.body.records;
          } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–≥–∏–æ–Ω–æ–≤:', data);
            return [];
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ID —Ä–µ–≥–∏–æ–Ω–æ–≤:', error);
          return [];
        }
      };

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –≥–æ—Ä–æ–¥–æ–≤ –∏–∑ Airtable
      window.getCityIds = async function(regionId) {
        try {
          const baseId = window.AIRTABLE_BASE_ID;
          const cityTbl = window.AIRTABLE_CITIES_TABLE_ID;
          const url = `/api/test-proxy.php?provider=airtable&base_id=${encodeURIComponent(baseId)}&table=${encodeURIComponent(cityTbl)}`;
          
          console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º ID –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞ ${regionId}...`);
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.ok && data.body && data.body.records) {
            console.log('=== ID –ì–û–†–û–î–û–í –ò–ó AIRTABLE ===');
            data.body.records.forEach((record, idx) => {
              const fields = record.fields || {};
              const name = fields['Name (RU)'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ (RU)'] || fields['Name'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ'] || `–ì–æ—Ä–æ–¥ ${idx + 1}`;
              const rid = fields['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä'] || fields['City ID'] || fields['ID'] || fields['–ì–æ—Ä–æ–¥ ID'] || '';
              const regions = fields['Regions'] || fields['–†–µ–≥–∏–æ–Ω—ã'] || fields['Region'] || fields['–†–µ–≥–∏–æ–Ω'] || [];
              
              console.log(`${name}:`, {
                id: record.id,
                name: name,
                rid: rid || '–Ω–µ—Ç',
                regions: regions,
                fields: Object.keys(fields)
              });
            });
            console.log('=== –ö–û–ù–ï–¶ –°–ü–ò–°–ö–ê ID –ì–û–†–û–î–û–í ===');
            return data.body.records;
          } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤:', data);
            return [];
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ID –≥–æ—Ä–æ–¥–æ–≤:', error);
          return [];
        }
      };

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID POI –∏–∑ Airtable
      window.getPoiIds = async function() {
        try {
          const baseId = window.AIRTABLE_BASE_ID;
          const poiTbl = window.AIRTABLE_POI_TABLE_ID;
          const url = `/api/test-proxy.php?provider=airtable&base_id=${encodeURIComponent(baseId)}&table=${encodeURIComponent(poiTbl)}`;
          
          console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º ID POI –∏–∑ Airtable...');
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.ok && data.body && data.body.records) {
            console.log('=== ID POI –ò–ó AIRTABLE ===');
            data.body.records.forEach((record, idx) => {
              const fields = record.fields || {};
              const name = fields['POI Name (RU)'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ (RU)'] || fields['POI Name (EN)'] || fields['Name'] || `POI ${idx + 1}`;
              const rid = fields['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä'] || fields['POI ID'] || fields['ID'] || fields['POI ID'] || '';
              const cities = fields['City'] || fields['–ì–æ—Ä–æ–¥'] || fields['Cities'] || fields['–ì–æ—Ä–æ–¥–∞'] || [];
              const regions = fields['Regions'] || fields['–†–µ–≥–∏–æ–Ω—ã'] || fields['Region'] || fields['–†–µ–≥–∏–æ–Ω'] || [];
              
              console.log(`${name}:`, {
                id: record.id,
                name: name,
                rid: rid || '–Ω–µ—Ç',
                cities: cities,
                regions: regions,
                fields: Object.keys(fields)
              });
            });
            console.log('=== –ö–û–ù–ï–¶ –°–ü–ò–°–ö–ê ID POI ===');
            return data.body.records;
          } else {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ POI:', data);
            return [];
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ID POI:', error);
          return [];
        }
      };

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö ID –≤ —Å–∏—Å—Ç–µ–º–µ
      window.showAllIds = function() {
        console.log('=== –í–°–ï ID –í –°–ò–°–¢–ï–ú–ï ===');
        console.log('Base ID:', window.AIRTABLE_BASE_ID);
        console.log('Regions Table ID:', window.AIRTABLE_REGIONS_TABLE_ID);
        console.log('Cities Table ID:', window.AIRTABLE_CITIES_TABLE_ID);
        console.log('POI Table ID:', window.AIRTABLE_POI_TABLE_ID);
        console.log('Tickets Table ID:', window.AIRTABLE_TICKETS_TABLE_ID);
        
        console.log('\n=== –†–ï–ì–ò–û–ù–´ ===');
        if (window.regions) {
          window.regions.forEach((region, idx) => {
            console.log(`–†–µ–≥–∏–æ–Ω ${idx + 1}:`, {
              id: region.id,
              name: region.name,
              rid: region.rid || '–Ω–µ—Ç'
            });
          });
        } else {
          console.log('–†–µ–≥–∏–æ–Ω—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        }
        
        console.log('\n=== –ì–û–†–û–î–ê –ü–û –†–ï–ì–ò–û–ù–ê–ú ===');
        if (window.citiesByRegion) {
          Object.keys(window.citiesByRegion).forEach(regionId => {
            const region = window.regions?.find(r => r.business_id === regionId);
            console.log(`–†–µ–≥–∏–æ–Ω ${region?.name || regionId}:`);
            window.citiesByRegion[regionId].forEach((city, idx) => {
              console.log(`  –ì–æ—Ä–æ–¥ ${idx + 1}:`, {
                id: city.id,
                name: city.name,
                code: city.code || '–Ω–µ—Ç',
                type: city.type
              });
            });
          });
        } else {
          console.log('–ì–æ—Ä–æ–¥–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        }
        
        console.log('\n=== POI –ü–û –ì–û–†–û–î–ê–ú ===');
        if (window.poisByCity) {
          Object.keys(window.poisByCity).forEach(cityId => {
            const city = Object.values(window.citiesByRegion || {}).flat().find(c => c.business_id === cityId);
            console.log(`–ì–æ—Ä–æ–¥ ${city?.name || cityId}:`);
            window.poisByCity[cityId].forEach((poi, idx) => {
              console.log(`  POI ${idx + 1}:`, {
                id: poi.id,
                name: poi.name,
                poi_id: poi.poi_id || '–Ω–µ—Ç',
                category: poi.category || '–Ω–µ—Ç'
              });
            });
          });
        } else {
          console.log('POI –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        }
        
        console.log('=== –ö–û–ù–ï–¶ –°–ü–ò–°–ö–ê ID ===');
      };

      // –°–∏—Å—Ç–µ–º–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è ID
      const CACHE_KEYS = {
        regions: 'konstructour_regions_cache_v2',
        cities: 'konstructour_cities_cache_v2', 
        pois: 'konstructour_pois_cache_v2'
      };

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ID –≤ localStorage
      window.saveIdsToCache = function(scope, data) {
        try {
          const key = CACHE_KEYS[scope];
          if (key && data) {
            localStorage.setItem(key, JSON.stringify({
              timestamp: Date.now(),
              data: data
            }));
            console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∫—ç—à ${scope}:`, data.length, '–∑–∞–ø–∏—Å–µ–π');
          }
        } catch (e) {
          console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫—ç—à:', e);
        }
      };

      // –ó–∞–≥—Ä—É–∑–∫–∞ ID –∏–∑ localStorage
      window.loadIdsFromCache = function(scope) {
        try {
          const key = CACHE_KEYS[scope];
          if (!key) return null;
          
          const cached = localStorage.getItem(key);
          if (!cached) return null;
          
          const parsed = JSON.parse(cached);
          const age = Date.now() - parsed.timestamp;
          
          // –ö—ç—à –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 24 —á–∞—Å–∞
          if (age > 24 * 60 * 60 * 1000) {
            localStorage.removeItem(key);
            return null;
          }
          
          console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –∫—ç—à–∞ ${scope}:`, parsed.data.length, '–∑–∞–ø–∏—Å–µ–π');
          return parsed.data;
        } catch (e) {
          console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –∫—ç—à–∞:', e);
          return null;
        }
      };

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      window.shouldRefreshData = function() {
        const lastRefresh = localStorage.getItem('konstructour_last_refresh');
        if (!lastRefresh) return true;
        
        const age = Date.now() - parseInt(lastRefresh);
        const maxAge = 6 * 60 * 60 * 1000; // 6 —á–∞—Å–æ–≤
        
        return age > maxAge;
      };

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      window.autoRefreshIfNeeded = async function() {
        if (shouldRefreshData()) {
          console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
          await refreshAllData();
          localStorage.setItem('konstructour_last_refresh', Date.now().toString());
        }
      };

      // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ –∫—ç—à–∞
      window.clearAllCache = function() {
        // –û—á–∏—â–∞–µ–º localStorage
        Object.values(CACHE_KEYS).forEach(key => {
          localStorage.removeItem(key);
        });
        
        // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏
        regions = [];
        citiesByRegion = {};
        poisByCity = {};
        ticketsByPoi = {};
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        selectedRegion = null;
        selectedCity = null;
        selectedPoi = null;
        
        console.log('–í–µ—Å—å –∫—ç—à –æ—á–∏—â–µ–Ω (localStorage + –ø–∞–º—è—Ç—å)');
      };

      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫—ç—à)
      window.forceRefreshCache = async function() {
        console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞...');
        clearAllCache();
        await syncRegionsFromAirtable();
        console.log('–ö—ç—à –æ–±–Ω–æ–≤–ª–µ–Ω');
      };

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
      window.refreshRegionData = async function(regionId) {
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞:', regionId);
        const region = regions.find(r => r.business_id === regionId);
        if (!region) return;
        
        // –û—á–∏—â–∞–µ–º –∫—ç—à –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
        localStorage.removeItem(`cities_${regionId}`);
        localStorage.removeItem(`pois_${regionId}`);
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        await loadCitiesForRegion(region);
        console.log('–î–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
      };

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
      window.refreshCityData = async function(cityId) {
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–∞:', cityId);
        const city = Object.values(citiesByRegion).flat().find(c => c.business_id === cityId);
        if (!city) return;
        
        // –û—á–∏—â–∞–µ–º –∫—ç—à –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞
        localStorage.removeItem(`pois_${cityId}`);
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        await loadPoisForCity(city);
        console.log('–î–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
      };

      // –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
      window.refreshAllData = async function() {
        console.log('–ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö...');
        clearAllCache();
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–≥–∏–æ–Ω—ã
        await syncRegionsFromAirtable();
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
        for (const region of regions) {
          await loadCitiesForRegion(region);
        }
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º POI –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤
        for (const region of regions) {
          const cities = citiesByRegion[region.business_id] || [];
          for (const city of cities) {
            await loadPoisForCity(city);
          }
        }
        
        console.log('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
      };

      // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∫—ç—à–∞
      window.showCacheStatus = function() {
        console.log('=== –°–¢–ê–¢–£–° –ö–≠–®–ê ===');
        Object.entries(CACHE_KEYS).forEach(([scope, key]) => {
          const cached = localStorage.getItem(key);
          if (cached) {
            try {
              const parsed = JSON.parse(cached);
              const age = Math.round((Date.now() - parsed.timestamp) / 1000 / 60); // –º–∏–Ω—É—Ç—ã
              console.log(`${scope}: ${parsed.data.length} –∑–∞–ø–∏—Å–µ–π, –≤–æ–∑—Ä–∞—Å—Ç: ${age} –º–∏–Ω`);
            } catch (e) {
              console.log(`${scope}: –ø–æ–≤—Ä–µ–∂–¥–µ–Ω`);
            }
          } else {
            console.log(`${scope}: –ø—É—Å—Ç`);
          }
        });
      };

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
      document.addEventListener('DOMContentLoaded', function() {
        const clearCacheBtn = document.getElementById('clear-cache-btn');
        
        if (clearCacheBtn) {
          clearCacheBtn.addEventListener('click', function() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à? –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω–æ–≤–æ.')) {
              clearAllCache();
              alert('–ö—ç—à –æ—á–∏—â–µ–Ω!');
            }
          });
        }
      });

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö ID –∏–∑ –º–∞—Å—Å–∏–≤–∞ regions
      window.showRealRegionIds = function() {
        console.log('=== –†–ï–ê–õ–¨–ù–´–ï ID –†–ï–ì–ò–û–ù–û–í –ò–ó –ú–ê–°–°–ò–í–ê ===');
        
        if (window.regions && window.regions.length > 0) {
          window.regions.forEach((region, idx) => {
            console.log(`–†–µ–≥–∏–æ–Ω ${idx + 1}:`, {
              id: region.id || '–ù–ï–¢ ID',
              name: region.name || '–ù–ï–¢ –ù–ê–ó–í–ê–ù–ò–Ø',
              rid: region.rid || '–ù–ï–¢ RID'
            });
          });
        } else {
          console.log('–ú–∞—Å—Å–∏–≤ regions –ø—É—Å—Ç –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        }
      };

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö ID –∏–∑ DOM –∫–∞—Ä—Ç–æ—á–µ–∫
      window.showRealIdsFromCards = function() {
        console.log('=== –†–ï–ê–õ–¨–ù–´–ï ID –ò–ó DOM –ö–ê–†–¢–û–ß–ï–ö ===');
        
        // –†–µ–≥–∏–æ–Ω—ã
        const regionCards = document.querySelectorAll('[data-go="cities"]');
        console.log('\n=== –†–ï–ì–ò–û–ù–´ (–∏–∑ DOM) ===');
        regionCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const ridElement = card.querySelector('.text-xs');
          
          console.log(`–†–µ–≥–∏–æ–Ω ${idx + 1}:`, {
            id: id || '–ù–ï–¢ ID',
            name: nameElement ? nameElement.textContent.trim() : '–ù–ï–¢ –ù–ê–ó–í–ê–ù–ò–Ø',
            rid: ridElement ? ridElement.textContent.trim() : '–ù–ï–¢ RID'
          });
        });
        
        // –ì–æ—Ä–æ–¥–∞
        const cityCards = document.querySelectorAll('[data-go="pois"]');
        console.log('\n=== –ì–û–†–û–î–ê (–∏–∑ DOM) ===');
        cityCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const codeElement = card.querySelector('.text-xs');
          
          console.log(`–ì–æ—Ä–æ–¥ ${idx + 1}:`, {
            id: id || '–ù–ï–¢ ID',
            name: nameElement ? nameElement.textContent.trim() : '–ù–ï–¢ –ù–ê–ó–í–ê–ù–ò–Ø',
            code: codeElement ? codeElement.textContent.trim() : '–ù–ï–¢ CODE'
          });
        });
        
        // POI
        const poiCards = document.querySelectorAll('[data-go="poi-details"]');
        console.log('\n=== POI (–∏–∑ DOM) ===');
        poiCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const poiIdElement = card.querySelector('.text-xs');
          
          console.log(`POI ${idx + 1}:`, {
            id: id || '–ù–ï–¢ ID',
            name: nameElement ? nameElement.textContent.trim() : '–ù–ï–¢ –ù–ê–ó–í–ê–ù–ò–Ø',
            poi_id: poiIdElement ? poiIdElement.textContent.trim() : '–ù–ï–¢ POI_ID'
          });
        });
      };
      
      // SVG –∏–∫–æ–Ω–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π POI
      window.POI_CATEGORY_ICONS = {
        '–°–∏–Ω—Ç–æ–∏—Å—Ç—Å–∫–æ–µ —Å–≤—è—Ç–∏–ª–∏—â–µ': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L14 6H20V8H18V20H16V8H8V20H6V8H4V6H10L12 2ZM10 10H14V12H10V10ZM10 14H14V16H10V14Z"/>
        </svg>`,
        '–ë—É–¥–¥–∏–π—Å–∫–∏–π —Ö—Ä–∞–º': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L13.5 5.5H18V7H16V11H18.5L20 14H4L5.5 11H8V7H6V5.5H10.5L12 2ZM10 9H14V13H10V9Z"/>
        </svg>`,
        '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±—ä–µ–∫—Ç': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M6 20V9L12 4L18 9V20H16V11.5L12 8.5L8 11.5V20H6ZM10 15H14V17H10V15Z"/>
        </svg>`,
        '–ú—É–∑–µ–π': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 1L21 6V8H3V6L12 1ZM5 10H7V18H5V10ZM9 10H11V18H9V10ZM13 10H15V18H13V10ZM17 10H19V18H17V10ZM3 20V22H21V20H3Z"/>
        </svg>`,
        '–ê—Ä—Ç-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ / –ì–∞–ª–µ—Ä–µ—è': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M9 10V8L7 6L9 4V2H15V4L17 6L15 8V10H9ZM12 5.5L13.5 4H10.5L12 5.5ZM4 12H20V20H4V12ZM6 14V18H18V14H6Z"/>
        </svg>`,
        '–°–º–æ—Ç—Ä–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2C15.31 2 18 4.69 18 8C18 11.54 12 22 12 22S6 11.54 6 8C6 4.69 8.69 2 12 2ZM12 6C10.9 6 10 6.9 10 8S10.9 10 12 10 14 9.1 14 8 13.1 6 12 6ZM12 9C11.45 9 11 8.55 11 8S11.45 7 12 7 13 7.45 13 8 12.55 9 12 9Z"/>
        </svg>`,
        '–õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–π —Å–∞–¥ / –ü–∞—Ä–∫': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M17 8C8 10 5.9 16.17 3.82 21.34L5.71 22L6.66 19.7C7.14 19.87 7.64 20 8 20C8.36 20 8.86 19.87 9.34 19.7L10.29 22L12.18 21.34C10.1 16.17 8 10 17 8ZM3 3L12 2L21 3V6H3V3Z"/>
        </svg>`,
        '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2ZM12 6.5L11.5 8.5L9.5 9L11.5 9.5L12 11.5L12.5 9.5L14.5 9L12.5 8.5L12 6.5Z"/>
        </svg>`,
        '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L22 6V8H2V6L12 2ZM4 10H20V18H16V20H8V18H4V10ZM6 12V16H18V12H6ZM8 13H16V15H8V13Z"/>
        </svg>`,
        '–Ø–ø–æ–Ω—Å–∫–∏–π –æ—Ç–µ–ª—å': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M7 13C7.55 13 8 12.55 8 12S7.55 11 7 11 6 11.45 6 12 6.45 13 7 13ZM12 13C12.55 13 13 12.55 13 12S12.55 11 12 11 11 11.45 11 12 11.45 13 12 13ZM17 13C17.55 13 18 12.55 18 12S17.55 11 17 11 16 11.45 16 12 16.45 13 17 13ZM19 7H5V5H19V7ZM19 9H5V19H19V9ZM21 3H3V21H21V3Z"/>
        </svg>`,
        '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"/>
        </svg>`,
        '–®–æ–ø–ø–∏–Ω–≥': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M7 18C5.9 18 5 18.9 5 20S5.9 22 7 22 9 21.1 9 20 8.1 18 7 18ZM1 2V4H3L6.6 11.59L5.25 14.04C5.09 14.32 5 14.65 5 15C5 16.1 5.9 17 7 17H19V15H7.42C7.28 15 7.17 14.89 7.17 14.75L7.2 14.63L8.1 13H15.55C16.3 13 16.96 12.59 17.3 11.97L20.88 5H5.21L4.27 3H1ZM17 18C15.9 18 15 18.9 15 20S15.9 22 17 22 19 21.1 19 20 18.1 18 17 18Z"/>
        </svg>`,
        '–¢–µ—Ä–º–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M9 17C9 15.34 10.34 14 12 14S15 15.34 15 17 13.66 20 12 20 9 18.66 9 17ZM12 2C10.89 2 10 2.89 10 4S10.89 6 12 6 14 5.11 14 4 13.11 2 12 2ZM6 6C4.89 6 4 6.89 4 8S4.89 10 6 10 8 9.11 8 8 7.11 6 6 6ZM18 6C16.89 6 16 6.89 16 8S16.89 10 18 10 20 9.11 20 8 19.11 6 18 6Z"/>
        </svg>`,
        '–°–ü–ê': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M19 12C19 8.13 15.87 5 12 5S5 8.13 5 12C5 15.87 8.13 19 12 19S19 15.87 19 12ZM12 7C14.76 7 17 9.24 17 12S14.76 17 12 17 7 14.76 7 12 9.24 7 12 7ZM12 9C10.34 9 9 10.34 9 12S10.34 15 12 15 15 13.66 15 12 13.66 9 12 9Z"/>
        </svg>`
      };
      
      // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      window.getPOICategoryIcon = function(category) {
        return window.POI_CATEGORY_ICONS[category] || `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"/>
        </svg>`;
      };
      
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫ ‚Äî –ø–∏—à–µ–º –≤ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ª–æ–≥
    (function(){
      function postError(payload){
        try{ fetch('/api/error-log.php?action=add',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }); }catch(_e){}
      }
      window.addEventListener('error', function(e){
        postError({ type:'js-error', page:'databases.html', msg: String(e.message||'error'), file: e.filename||'', line: e.lineno||0, col: e.colno||0, stack: e.error && e.error.stack ? String(e.error.stack) : '' });
      });
      window.addEventListener('unhandledrejection', function(e){
        const r = e && (e.reason||e.detail||{});
        postError({ type:'js-unhandled', page:'databases.html', msg: (r && (r.message||r)) ? String(r.message||r) : 'unhandled', stack: r && r.stack ? String(r.stack) : '' });
      });
    })();
    // –ü—Ä–æ—Å—Ç—ã–µ –≤–∫–ª–∞–¥–∫–∏ –±–µ–∑ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    (function(){
      window.__ADMIN_DB_DEBUG = /(^|[?&])debug=1(&|$)/.test(location.search) || (localStorage.getItem('debug_admin_db')==='1');
      window.dlog = function(){ if (window.__ADMIN_DB_DEBUG) { try{ console.log.apply(console, ['[DB]'].concat(Array.from(arguments))); }catch(_e){} } };
      const tabs = document.querySelectorAll('.tab');
      const sections = {
        regions: document.getElementById('tab-regions'),
        tours: document.getElementById('tab-tours'),
        templates: document.getElementById('tab-templates')
      };
      tabs.forEach(btn=>{
        btn.addEventListener('click', function(e){
          e.preventDefault();
          tabs.forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          Object.values(sections).forEach(s=> s && s.classList.remove('active'));
          const key = this.getAttribute('data-tab');
          if (sections[key]) sections[key].classList.add('active');
        });
      });

      // Fake sync state toggling for icon demo (replace with real sync hooks)
      function setSyncing(scope, isSyncing){
        const el = document.getElementById(scope+'_sync_icon');
        if (!el) return;
        if (isSyncing) el.classList.add('animate-spin'); else el.classList.remove('animate-spin');
      }

      // Remove placeholder spinner handler to avoid side-effects on clicks

      // Base label auto-switch for API type
      function bindApiLabel(){ /* —É–¥–∞–ª–µ–Ω–æ –≤–º–µ—Å—Ç–µ —Å UI */ }

      // Load saved config from server and populate fields
        window.airtableReg = null; // cache for mapping header - –¥–µ–ª–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–π
        
        
      async function loadDbConfig(){
        try{
          const res = await fetch('/api/config-read.php', { headers: { 'X-Admin-Token': (window.ADMIN_TOKEN||'') } });
          if (!res.ok) return;
          const data = await res.json();
          const db = (data && data.databases) || {};
          const reg = (data && data.airtable_registry) || null;
            window.airtableReg = reg;
          function fill(){ /* UI —É–¥–∞–ª—ë–Ω */ }
          fill('regions', db.regions);
          fill('tours', db.tours);
          fill('templates', db.templates);
          // Fill Airtable Mapping UI
          if (reg){
            const baseId = reg.baseId || reg.base_id || '';
            const t = reg.tables || {};
            document.getElementById('am_base_id') && (document.getElementById('am_base_id').value = baseId);
            function setv(id, val){ const el = document.getElementById(id); if (el && typeof val==='string') el.value = val; }
            setv('am_country_label', t.country?.label||''); setv('am_country_table', t.country?.tableId||''); setv('am_country_view', t.country?.viewId||'');
            setv('am_region_label',  t.region?.label||'');  setv('am_region_table',  t.region?.tableId||'');  setv('am_region_view',  t.region?.viewId||'');
            setv('am_city_label',    t.city?.label||'');    setv('am_city_table',    t.city?.tableId||'');    setv('am_city_view',    t.city?.viewId||'');
            setv('am_poi_label',     t.poi?.label||'');     setv('am_poi_table',     t.poi?.tableId||'');     setv('am_poi_view',     t.poi?.viewId||'');
            // Render mapping header for Regions
            // initial header will be set by render functions
          }
        }catch(e){ console.warn('loadDbConfig failed', e); }
      }
      loadDbConfig();

      function setMappingHeader(){ /* –±–µ–π–¥–∂ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω ‚Äî –∑–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º */ }
      // –°–¥–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–π –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      window.setMappingHeader = setMappingHeader;

      // Fallback: –ø—Ä—è–º–æ–π —Å–ø–∏—Å–æ–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤ —á–µ—Ä–µ–∑ test-proxy, —á–∏—Ç–∞—è —Ä–µ–µ—Å—Ç—Ä —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      async function loadRegionsViaProxy(){
        try{
            let baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || '';
            let regTbl = (window.airtableReg && window.airtableReg.tables && (window.airtableReg.tables.region?.tableId || window.airtableReg.tables.region?.table_id)) || '';
          if (!baseId || !regTbl){
            const cfg = await fetch('/api/config-read.php').then(r=>r.ok?r.json():null).catch(()=>null);
            const reg = cfg && (cfg.airtable_registry||{});
            if (reg){
              baseId = baseId || reg.baseId || reg.base_id || '';
              const t = reg.tables||{}; regTbl = regTbl || t.region?.tableId || t.region?.table_id || '';
            }
          }
          // –ñ—ë—Å—Ç–∫–∏–µ –¥–µ—Ñ–æ–ª—Ç—ã (–µ—Å–ª–∏ —Ä–µ–µ—Å—Ç—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω): Regions table
            if (!baseId) baseId = window.AIRTABLE_BASE_ID;
            if (!regTbl) regTbl = window.AIRTABLE_REGIONS_TABLE_ID;
          if (!baseId || !regTbl) return false;
          const u = '/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId)+'&table='+encodeURIComponent(regTbl);
          const r2 = await fetch(u); if(!r2.ok) return false; const j2 = await r2.json();
          console.log('Airtable API response for regions:', j2);
          const recs = (j2 && j2.body && (j2.body.records || j2.body.items)) || j2.records || j2.items || [];
          console.log('Parsed records from Airtable:', recs);
          regions = recs.map((rec, idx)=>{
            const fields = rec.fields || {};
            const name = fields['Name (RU)'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ (RU)'] || fields['Name'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ'] || ('–†–µ–≥–∏–æ–Ω '+(idx+1));
            const rid = fields['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä'] || fields['Region ID'] || fields['ID'] || fields['–†–µ–≥–∏–æ–Ω ID'] || '';
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥ —Ä–µ–≥–∏–æ–Ω–∞ –µ—Å–ª–∏ –≤ Airtable –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
            const correctRid = rid && rid.match(/^REG-\d{3}$/) ? rid : ('REG-'+String(idx+1).padStart(3,'0'));
            return { 
              id: rec.id || ('REG-'+String(idx+1).padStart(3,'0')), 
              name, 
              rid: correctRid
            };
          });
          console.log('Final regions array:', regions);
          citiesByRegion = {};
          renderRegions();
          return regions.length>0;
        }catch(e){ 
          console.warn('loadRegionsViaProxy failed', e); 
          return false;
        }
      }

      // Save Airtable Mapping
      async function saveAirtableRegistry(){
        const reg = {
          baseId: document.getElementById('am_base_id')?.value || '',
          tables: {
            country: { label: document.getElementById('am_country_label')?.value || '', tableId: document.getElementById('am_country_table')?.value || '', viewId: document.getElementById('am_country_view')?.value || '' },
            region:  { label: document.getElementById('am_region_label')?.value  || '', tableId: document.getElementById('am_region_table')?.value  || '', viewId: document.getElementById('am_region_view')?.value  || '' },
            city:    { label: document.getElementById('am_city_label')?.value    || '', tableId: document.getElementById('am_city_table')?.value    || '', viewId: document.getElementById('am_city_view')?.value    || '' },
            poi:     { label: document.getElementById('am_poi_label')?.value     || '', tableId: document.getElementById('am_poi_table')?.value     || '', viewId: document.getElementById('am_poi_view')?.value     || '' }
          }
        };
        try{
          await fetch('/api/config-store.php',{
            method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
            body: JSON.stringify({ airtable_registry: reg })
          });
        }catch(e){ console.warn('save registry failed', e); }
      }
      document.getElementById('am_save')?.addEventListener('click', saveAirtableRegistry);

      // Test Base / Table
      document.getElementById('am_test_base')?.addEventListener('click', async function(){
        const baseId = document.getElementById('am_base_id')?.value || '';
        const key = ''; // —Å–µ—Ä–≤–µ—Ä –≤–æ–∑—å–º—ë—Ç PAT –∏–∑ server keys
        const res = await fetch('/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId));
        const t = await res.json();
        const label = document.getElementById('am_base_status');
        if (label) label.textContent = t.ok ? 'OK' : ('–û—à–∏–±–∫–∞: '+(t.error||''));
      });
      document.querySelectorAll('.am_test_table').forEach(btn=>{
        btn.addEventListener('click', async function(){
          const entity = this.getAttribute('data-entity');
          const baseId = document.getElementById('am_base_id')?.value || '';
          const tableId = document.getElementById('am_'+entity+'_table')?.value || '';
          const viewId = document.getElementById('am_'+entity+'_view')?.value || '';
          const url = '/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId)+'&table='+encodeURIComponent(tableId)+(viewId?('&view='+encodeURIComponent(viewId)):'');
          const res = await fetch(url);
          const t = await res.json();
          const label = document.getElementById('am_'+entity+'_status');
          if (label) label.textContent = t.ok ? 'OK' : ('–û—à–∏–±–∫–∞: '+(t.error||''));
        });
      });
    })();

    // –ò–µ—Ä–∞—Ä—Ö–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫: —Ä–µ–≥–∏–æ–Ω—ã ‚Üí –≥–æ—Ä–æ–¥–∞ ‚Üí POI ‚Üí –±–∏–ª–µ—Ç—ã (UI, –±–µ–∑ API)
    (function(){
      // helper: save to server as server key
      async function saveDbConfig(scope){
        try{
          // UI –ø–æ–ª–µ–π —É–¥–∞–ª—ë–Ω ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –Ω–∞ –±—É–¥—É—â–µ–µ, —Å–µ–π—á–∞—Å no-op
          await fetch('/api/config-store.php',{
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
            body: JSON.stringify({})
          }).then(r=>{
            if (!r.ok) throw new Error('HTTP '+r.status);
            if (window.osNotify){ window.osNotify('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ','–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞'); }
          }).catch(e=>{
            console.warn('saveDbConfig failed', e);
            if (window.osNotify){ window.osNotify('–û—à–∏–±–∫–∞','–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'); }
          });
        }catch(e){ console.warn('saveDbConfig failed', e); }
      }

      const crumbs = document.getElementById('db_breadcrumbs');
      const cards = document.getElementById('db_cards');
      const fab = document.getElementById('db_fab_add');

      if (!crumbs || !cards) return;

      const regionColors = {
        '–•–æ–∫–∫–∞–π–¥–æ':'bg-blue-100 text-blue-800',
        '–¢–æ—Ö–æ–∫—É':'bg-green-100 text-green-800',
        '–ö–∞–Ω—Ç–æ':'bg-indigo-100 text-indigo-800',
        '–¢—é–±—É':'bg-yellow-100 text-yellow-800',
        '–ö–∞–Ω—Å–∞–π':'bg-purple-100 text-purple-800',
        '–¢—é–≥–æ–∫—É':'bg-pink-100 text-pink-800',
        '–°–∏–∫–æ–∫—É':'bg-teal-100 text-teal-800',
        '–ö—é—Å—é':'bg-red-100 text-red-800',
        '–û–∫–∏–Ω–∞–≤–∞':'bg-cyan-100 text-cyan-800'
      };

      // State (in-memory for UI only). –ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã ‚Äî Airtable
      let regions = [];
      let citiesByRegion = {}; // regionId -> [ { id, name, type: 'city'|'location', parentCityId? } ]
      let poisByCity = {};     // cityId -> [ {id,name,type} ]
      let ticketsByPoi = {};   // poiId -> [ {id,category,price,currency,note} ]

      // Persisted cache so –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –ø—Ä–æ–ø–∞–¥–∞—é—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä–∏ —Å–±–æ—è—Ö —Å–µ—Ç–∏/—Å–µ—Ä–≤–µ—Ä–æ–≤
      const LS_REGIONS_KEY = 'konstructour_regions_cache_v1';
      
      function loadRegionsCache(){ 
        try{ 
          const s=localStorage.getItem(LS_REGIONS_KEY); 
          const parsed = s ? JSON.parse(s) : [];
          console.log('üì¶ loadRegionsCache: –∑–∞–≥—Ä—É–∂–µ–Ω–æ', parsed.length, '—Ä–µ–≥–∏–æ–Ω–æ–≤ –∏–∑ –∫—ç—à–∞');
          return parsed;
        } catch(_e){ 
          console.error('‚ùå loadRegionsCache –æ—à–∏–±–∫–∞:', _e);
          return []; 
        } 
      }
      
      function saveRegionsCache(list){ 
        try{ 
          if (!Array.isArray(list)) {
            console.warn('‚ö†Ô∏è saveRegionsCache: list –Ω–µ –º–∞—Å—Å–∏–≤', typeof list);
            return;
          }
          const jsonStr = JSON.stringify(list);
          localStorage.setItem(LS_REGIONS_KEY, jsonStr); 
          console.log('üíæ saveRegionsCache: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', list.length, '—Ä–µ–≥–∏–æ–Ω–æ–≤ –≤ –∫—ç—à');
          console.log('üíæ –†–∞–∑–º–µ—Ä –∫—ç—à–∞:', (jsonStr.length / 1024).toFixed(2), 'KB');
        } catch(_e){ 
          console.error('‚ùå saveRegionsCache –æ—à–∏–±–∫–∞:', _e);
        } 
      }

      let level = 'regions';
      let selectedRegion = null;
      let selectedCity = null;
      let selectedPoi = null;
      let preloadInProgress = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫

      // History helpers
      async function renderFromState(state){
        console.log('renderFromState called with state:', state);
        
        if (!state || !state.level) { 
          level = 'regions';
          selectedRegion = null;
          selectedCity = null;
          selectedPoi = null;
          renderCrumbs();
          setMappingHeader('region');
          renderRegions(); 
          return; 
        }
        
        level = state.level;
        
        if (level === 'regions') { 
          selectedRegion = null;
          selectedCity = null;
          selectedPoi = null;
          renderCrumbs();
          setMappingHeader('region');
          renderRegions(); 
          return; 
        }
        
        if (level === 'cities') {
          selectedRegion = regions.find(r=>r.business_id===state.regionId) || null;
          selectedCity = null;
          selectedPoi = null;
          renderCrumbs();
          setMappingHeader('city');
          
          if (selectedRegion) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (!citiesByRegion[selectedRegion.business_id] || citiesByRegion[selectedRegion.business_id].length === 0) {
              await loadCitiesForRegion(selectedRegion);
            }
            await preloadPoisCountsForRegion(selectedRegion);
          }
          renderCities(); 
          return;
        }
        
        if (level === 'pois') {
          selectedRegion = regions.find(r=>r.business_id===state.regionId) || null;
          if (selectedRegion) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (!citiesByRegion[selectedRegion.business_id] || citiesByRegion[selectedRegion.business_id].length === 0) {
              await loadCitiesForRegion(selectedRegion);
            }
            
            const list = citiesByRegion[selectedRegion.business_id] || [];
          selectedCity = list.find(c=>c.business_id===state.cityId) || null;
            selectedPoi = null;
            renderCrumbs();
            setMappingHeader('poi');
            
            if (selectedCity) {
              // –ó–∞–≥—Ä—É–∂–∞–µ–º POI –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
              if (!poisByCity[selectedCity.business_id] || poisByCity[selectedCity.business_id].length === 0) {
                await loadPoisForCity(selectedCity);
              }
              renderPois(); 
            } else {
              console.error('City not found in renderFromState');
              cards.innerHTML = '<div class="text-center text-red-500 py-12">–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
            }
          } else {
            console.error('Region not found in renderFromState');
            cards.innerHTML = '<div class="text-center text-red-500 py-12">–†–µ–≥–∏–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
          }
          return;
        }
        
        // poi-details level —É–¥–∞–ª—ë–Ω - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–ø–∏—Å–æ–∫ POI
        if (level === 'poi-details') {
          level = 'pois';
          selectedRegion = regions.find(r=>r.business_id===state.regionId) || null;
          if (selectedRegion) {
            if (!citiesByRegion[selectedRegion.business_id] || citiesByRegion[selectedRegion.business_id].length === 0) {
              await loadCitiesForRegion(selectedRegion);
            }
            const listC = citiesByRegion[selectedRegion.business_id] || [];
            selectedCity = listC.find(c=>c.business_id===state.cityId) || null;
            if (selectedCity) {
              if (!poisByCity[selectedCity.business_id] || poisByCity[selectedCity.business_id].length === 0) {
                await loadPoisForCity(selectedCity);
            }
              renderPois();
          }
          }
          return;
        }
        
        if (level === 'tickets') {
          selectedRegion = regions.find(r=>r.business_id===state.regionId) || null;
          if (selectedRegion) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (!citiesByRegion[selectedRegion.business_id] || citiesByRegion[selectedRegion.business_id].length === 0) {
              await loadCitiesForRegion(selectedRegion);
            }
            
            const listC = citiesByRegion[selectedRegion.business_id] || [];
          selectedCity = listC.find(c=>c.business_id===state.cityId) || null;
            if (selectedCity) {
              // –ó–∞–≥—Ä—É–∂–∞–µ–º POI –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
              if (!poisByCity[selectedCity.business_id] || poisByCity[selectedCity.business_id].length === 0) {
                await loadPoisForCity(selectedCity);
              }
              const listP = poisByCity[selectedCity.business_id] || [];
          selectedPoi = listP.find(p=>p.business_id===state.poiId) || null;
            }
          }
          renderCrumbs();
          setMappingHeader('ticket');
          renderTickets(); 
          return;
        }
        
        // Fallback
        level = 'regions';
        selectedRegion = null;
        selectedCity = null;
        selectedPoi = null;
        renderCrumbs();
        setMappingHeader('region');
        renderRegions();
      }
      function push(level, ids){
        const state = Object.assign({ level }, ids||{});
        history.pushState(state, '');
      }

      function renderCrumbs(){
        const parts = [];
        // Root
        if (level === 'regions'){
          parts.push('<span class="text-gray-800">–†–µ–≥–∏–æ–Ω—ã</span>');
        } else {
          parts.push('<a href="#" data-level="regions" class="text-indigo-600 hover:underline">–†–µ–≥–∏–æ–Ω—ã</a>');
        }
        // Region
        if (selectedRegion){
          parts.push('<span class="mx-2">/</span>');
          if (level === 'cities'){
            parts.push('<span class="text-gray-800">'+selectedRegion.name+'</span>');
          } else {
            parts.push('<a href="#" data-level="cities" data-region-id="'+selectedRegion.business_id+'" class="text-indigo-600 hover:underline">'+selectedRegion.name+'</a>');
          }
        }
        // City
        if (selectedCity){
          parts.push('<span class="mx-2">/</span>');
          if (level === 'pois' || level === 'poi-details'){
            parts.push('<span class="text-gray-800">'+selectedCity.name+'</span>');
          } else {
            parts.push('<a href="#" data-level="pois" data-region-id="'+(selectedRegion?selectedRegion.business_id:'')+'" data-city-id="'+selectedCity.business_id+'" class="text-indigo-600 hover:underline">'+selectedCity.name+'</a>');
          }
        }
        // POI
        if (selectedPoi){
          parts.push('<span class="mx-2">/</span>');
          if (level === 'poi-details' || level === 'tickets'){
            parts.push('<span class="text-gray-800">'+selectedPoi.name+'</span>');
          } else {
            parts.push('<a href="#" data-level="poi-details" data-region-id="'+(selectedRegion?selectedRegion.business_id:'')+'" data-city-id="'+(selectedCity?selectedCity.business_id:'')+'" data-poi-id="'+(selectedPoi.poi_id || selectedPoi.business_id)+'" class="text-indigo-600 hover:underline">'+selectedPoi.name+'</a>');
          }
        }
        crumbs.innerHTML = parts.join('');
      }

      function card(actionsHtml, innerHtml){
        const actionsBlock = actionsHtml && actionsHtml.trim() ? '<div class="absolute top-2 right-2 flex items-center gap-2 opacity-70">'+actionsHtml+'</div>' : '';
        return '<div class="relative bg-white rounded-lg border border-gray-200 p-4 hover:shadow transition">'+actionsBlock+innerHtml+'</div>';
      }

      function renderRegions(){
        console.log('üé® renderRegions() –≤—ã–∑–≤–∞–Ω–∞');
        console.log('üé® regions.length =', regions.length);
        console.log('üé® cards —ç–ª–µ–º–µ–Ω—Ç:', cards);
        
        level='regions'; selectedRegion=null; selectedCity=null; selectedPoi=null; renderCrumbs(); setMappingHeader('region');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º grid –∫–ª–∞—Å—Å—ã –¥–ª—è —Ä–µ–≥–∏–æ–Ω–æ–≤
        cards.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
        
        if (!regions.length){
          console.log('‚ö†Ô∏è –†–µ–≥–∏–æ–Ω—ã –ø—É—Å—Ç—ã, —Ä–µ–Ω–¥–µ—Ä–∏–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
          cards.innerHTML = '<div class="text-gray-500">–ù–µ—Ç —Ä–µ–≥–∏–æ–Ω–æ–≤. –ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>';
          return;
        }
        
        console.log('üé® –†–µ–Ω–¥–µ—Ä–∏–º', regions.length, '—Ä–µ–≥–∏–æ–Ω–æ–≤...');
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–≥–∏–æ–Ω—ã –ø–æ business_id (rid) –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è (—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤)
        const sortedRegions = [...regions].sort((a, b) => {
          // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å –∏–∑ business_id (–Ω–∞–ø—Ä–∏–º–µ—Ä, REG-001 -> 1)
          const getNumericId = (id) => {
            const match = id.match(/(\d+)$/);
            return match ? parseInt(match[1], 10) : 0;
          };
          return getNumericId(a.rid) - getNumericId(b.rid);
        });
        
        // –†–µ–Ω–¥–µ—Ä–∏–º —Ä–µ–≥–∏–æ–Ω—ã —Å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Å—á–µ—Ç—á–∏–∫–∞–º–∏ (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û)
        const regionsHTML = sortedRegions.map((r, idx)=>{
          const count = (r.citiesCount ?? 0) + (r.poisCount ?? 0); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
          dlog('region-card', {id:r.id, name:r.name, count, cities: r.citiesCount, pois: r.poisCount});
          const inlineActions = '<div class="flex items-center gap-2 opacity-80">\
              '+(r.rid ? '<span class="ml-2 px-3 py-1 text-sm rounded border bg-gray-50 text-gray-600">'+r.rid+'</span>' : '')+'\
              <button data-act="edit-region" data-id="'+r.id+'" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>\
              <button data-act="del-region" data-id="'+r.id+'" title="–£–¥–∞–ª–∏—Ç—å" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>\
            </div>';
          const inner = '<div class="flex items-center justify-between">\
              <div class="flex items-center gap-2">\
                <svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" class="text-indigo-600"><path d="M3.5 6.5 9 4.5l6 2 5.5-2v13l-5.5 2-6-2-5.5 2v-13z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>\
                <div class="text-lg text-gray-800">'+r.name+'</div>\
              </div>\
              '+inlineActions+'\
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">\
                <div class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-50 border border-indigo-100 shadow-sm region-count-badge" style="animation-delay: '+(idx*50)+'ms">\
                  <i class=\"fas fa-map-marker-alt text-indigo-600\"></i>\
                  <span class=\"text-xs font-medium text-indigo-700\">'+count+'</span>\
                </div>\
              </div>\
            </div>';
          return '<a href="#" role="button" class="block fade-in" data-go="cities" data-id="'+r.business_id+'" style="animation-delay: '+(idx*50)+'ms">'+card('', inner)+'</a>';
        }).join('');
        
        console.log('Rendering regions HTML:', regionsHTML.substring(0, 200) + '...');
        cards.innerHTML = regionsHTML;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ–Ω–¥–µ—Ä–∏–ª–∏—Å—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏
        const renderedCards = document.querySelectorAll('#db_cards [data-go="cities"]');
        console.log('Rendered region cards with data-go="cities":', renderedCards.length);
        
        // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        setupUnifiedClickHandler();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—á–µ—Ç—á–∏–∫–∏ –≥–æ—Ä–æ–¥–æ–≤ –≤ —Ñ–æ–Ω–µ
        loadRegionCounts();
        
        console.log('‚úÖ renderRegions() –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:', renderedCards.length);
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –ë–î (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û)
      async function syncRegionsFromAirtable(){
        try{
          console.log('‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤...');
          const res = await fetch('/api/data-api.php?action=regions', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          const j = await res.json();
          const items = j.ok ? (j.items || []) : [];
          
          regions = items.map((it, idx) => ({
            id: it.id,
            name: it.name_ru || ('–†–µ–≥–∏–æ–Ω ' + (idx + 1)),
            rid: it.business_id || ('REG-' + String(idx + 1).padStart(3, '0')),
            business_id: it.business_id || ('REG-' + String(idx + 1).padStart(3, '0')),
            code: it.business_id || ('REG-' + String(idx + 1).padStart(3, '0'))
          }));
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
          saveRegionsCache(regions);
          console.log('‚úÖ –†–µ–≥–∏–æ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫—ç—à');
          
          // –°–Ω–∞—á–∞–ª–∞ –±—ã—Å—Ç—Ä—ã–π —Ä–µ–Ω–¥–µ—Ä —Å placeholder'–∞–º–∏
          citiesByRegion = {};
          renderRegions();
          console.log('‚úÖ –†–µ–≥–∏–æ–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã');
          
          // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—á–µ—Ç—á–∏–∫–∏ (–±—ã—Å—Ç—Ä–æ!)
          try {
            const countsRes = await fetch('/api/region-counts.php');
            const countsData = await countsRes.json();
            
            if (countsData.ok) {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –∏–∑ –±—ã—Å—Ç—Ä–æ–≥–æ API
              regions.forEach(r => {
                const count = countsData.counts[r.id];
                if (count) {
                  r.citiesCount = count.cities;
                  r.poisCount = count.pois;
                }
              });
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤ –∫—ç—à
              localStorage.setItem('region_counts_cache', JSON.stringify({
                timestamp: Date.now(),
                counts: countsData.counts
              }));
              
              console.log('‚úÖ –°—á–µ—Ç—á–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', countsData.counts);
              renderRegions(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ —Å—á–µ—Ç—á–∏–∫–∞–º–∏
            }
          } catch (_e) { console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏:', _e); }
        } catch(e){ 
          console.error('syncRegionsFromAirtable failed', e);
          console.error('Error details:', e.message);
          console.error('Error stack:', e.stack);
          // Fallback: –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ test-proxy –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ä–µ–µ—Å—Ç—Ä–∞
          try{
              let baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || '';
              let regTbl = (window.airtableReg && window.airtableReg.tables && (window.airtableReg.tables.region?.tableId || window.airtableReg.tables.region?.table_id)) || '';
            // –ñ—ë—Å—Ç–∫–∏–µ –¥–µ—Ñ–æ–ª—Ç—ã, –µ—Å–ª–∏ —Ä–µ–µ—Å—Ç—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
              if (!baseId) baseId = window.AIRTABLE_BASE_ID;
              if (!regTbl) regTbl = window.AIRTABLE_REGIONS_TABLE_ID;
            if (!baseId || !regTbl) return;
            const u = '/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId)+'&table='+encodeURIComponent(regTbl);
            const r2 = await fetch(u);
            const j2 = await r2.json();
            const recs = (j2 && j2.body && (j2.body.records || j2.body.items)) || j2.records || j2.items || [];
            regions = recs.map((rec, idx)=>{
              const fields = rec.fields || {};
              const name = fields['Name (RU)'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ (RU)'] || fields['Name'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ'] || ('–†–µ–≥–∏–æ–Ω '+(idx+1));
              const rid = fields['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä'] || fields['Region ID'] || fields['ID'] || fields['–†–µ–≥–∏–æ–Ω ID'] || '';
              return { id: rec.id || ('REG-'+String(idx+1).padStart(3,'0')), name, rid };
            });
            citiesByRegion = {};
            renderRegions();
            saveRegionsCache(regions);
          }catch(e2){ console.warn('fallback regions failed', e2); }
        }
      }

      async function deleteRegionOnServer(region){
        try{
          let recordId = region && region.id ? region.id : '';
          if (!/^rec/i.test(recordId)){
            // –ù–∞–π–¥—ë–º –∑–∞–ø–∏—Å—å –ø–æ –ø–æ–ª—é Region ID –∏–ª–∏ –∏–º–µ–Ω–∏
            const res = await fetch('/api/db-sync.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ scope:'regions', action:'list' })
            });
            const j = await res.json();
            if (j && j.ok && Array.isArray(j.items)){
              const found = j.items.find(it => (it.fields && (it.fields['Region ID']===region.id || it.fields['–†–µ–≥–∏–æ–Ω ID']===region.id)) || it.name===region.name);
              if (found && found.id) recordId = found.id;
            }
          }
          if (recordId && /^rec/i.test(recordId)){
            await fetch('/api/db-sync.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ scope:'regions', action:'delete', data:{ id: recordId } })
            });
          }
        }catch(e){ console.warn('deleteRegionOnServer failed', e); }
      }

      async function renderCities(){
        level='cities'; /* keep selectedCity */ selectedPoi=null; renderCrumbs(); setMappingHeader('city');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º grid –∫–ª–∞—Å—Å—ã –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤
        cards.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
        
        if (!selectedRegion || !selectedRegion.business_id) {
          console.error('renderCities: No selected region');
          cards.innerHTML = '<div class="text-center text-red-500 py-12">–†–µ–≥–∏–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω</div>';
          return;
        }
        
        let list = citiesByRegion[selectedRegion.business_id] || [];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
        await checkDataFreshness();
        
        // –ï—Å–ª–∏ –≥–æ—Ä–æ–¥–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö —Å—Ä–∞–∑—É
        if (list.length === 0) {
          console.log('–ì–æ—Ä–æ–¥–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞:', selectedRegion.name);
          await loadCitiesForRegion(selectedRegion);
          list = citiesByRegion[selectedRegion.business_id] || [];
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—á–µ—Ç—á–∏–∫–∏ POI –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤ –≤ —Ñ–æ–Ω–µ
        if (list.length > 0 && !preloadInProgress) {
          console.log('Loading POI counts for cities in region:', selectedRegion.name);
          preloadInProgress = true;
          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—á–µ—Ç—á–∏–∫–∏ –≤ —Ñ–æ–Ω–µ
          loadCityCounts(selectedRegion.business_id).finally(() => {
            preloadInProgress = false;
          });
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥–æ—Ä–æ–¥–∞ –ø–æ business_id (code) –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è (—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤)
        const sortedCities = [...list].sort((a, b) => {
          // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å –∏–∑ business_id (–Ω–∞–ø—Ä–∏–º–µ—Ä, CTY-001 -> 1)
          const getNumericId = (id) => {
            const match = id.match(/(\d+)$/);
            return match ? parseInt(match[1], 10) : 0;
          };
          return getNumericId(a.code) - getNumericId(b.code);
        });
        
        // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ç—É –∂–µ +
        function findCityNameById(id){ const x=(sortedCities||[]).find(v=>v.business_id===id); return x?x.name:''; }
        cards.innerHTML = sortedCities.map(c=>{
          const count = (poisByCity[c.business_id]||[]).length;
          console.log(`City ${c.name} (${c.business_id}) pill count: ${count}, poisByCity[${c.business_id}]:`, poisByCity[c.business_id]);
          const inlineActions = '<div class="flex items-center gap-2 opacity-80">'+
              (c.code ? '<span class="ml-2 px-2 py-0.5 text-xs rounded border bg-gray-50 text-gray-600">'+c.code+'</span>' : '')+
              '<button data-act="edit-city" data-id="'+c.business_id+'" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
              '<button data-act="del-city" data-id="'+c.business_id+'" title="–£–¥–∞–ª–∏—Ç—å" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>'+
            '</div>';
          const inner = '<div class="flex items-center justify-between">\
              <div class="flex items-center gap-2">\
                <svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" class="text-green-600"><path d="M3.5 6.5 9 4.5l6 2 5.5-2v13l-5.5 2-6-2-5.5 2v-13z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>\
                <div class="text-lg text-gray-800">'+c.name+'</div>\
              </div>\
              '+inlineActions+'\
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">\
                <div class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-50 border border-green-100 shadow-sm">\
                  <i class=\"fas fa-map-marker-alt text-green-600\"></i>\
                  <span class=\"text-xs font-medium text-green-700\">'+count+'</span>\
                </div>\
              </div>\
            </div>';
          return '<div class="cursor-pointer" data-go="pois" data-id="'+c.business_id+'">'+card('', inner)+'</div>';
        }).join('') || '<div class="text-gray-500">–ù–µ—Ç –≥–æ—Ä–æ–¥–æ–≤. –ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>';
        
        // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        setupUnifiedClickHandler();
      }

      async function renderPois(){
        level='pois'; /* keep selectedPoi */ renderCrumbs(); setMappingHeader('poi');
        
        if (!selectedCity || !selectedCity.business_id) {
          console.error('renderPois: No selected city');
          cards.innerHTML = '<div class="text-center text-red-500 py-12">–ì–æ—Ä–æ–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω</div>';
          return;
        }
        
        // –í–ê–ñ–ù–û: –£–±–∏—Ä–∞–µ–º grid –∫–ª–∞—Å—Å—ã —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è POI
        cards.className = 'w-full';
        
        console.log('renderPois called for city:', selectedCity);
        console.log('poisByCity keys:', Object.keys(poisByCity));
        console.log('Looking for POI in poisByCity[' + selectedCity.business_id + ']:', poisByCity[selectedCity.business_id]);
        let list = poisByCity[selectedCity.business_id] || [];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
        await checkDataFreshness();
        
        // –ï—Å–ª–∏ POI –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
        if (list.length === 0) {
          console.log('POI list is empty for city:', selectedCity.name, '- loading...');
          await loadPoisForCity(selectedCity);
          list = poisByCity[selectedCity.business_id] || [];
        }
        
        console.log('POI list for city:', list);
        const parentTypeLabel = selectedCity && selectedCity.type==='location' ? '–õ–æ–∫–∞—Ü–∏—è' : '–ì–æ—Ä–æ–¥';
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º POI –ø–æ business_id (poi_id) –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è (—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤)
        const sortedPois = [...list].sort((a, b) => {
          // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å –∏–∑ business_id (–Ω–∞–ø—Ä–∏–º–µ—Ä, POI-001 -> 1)
          const getNumericId = (id) => {
            const match = id.match(/(\d+)$/);
            return match ? parseInt(match[1], 10) : 0;
          };
          return getNumericId(a.poi_id) - getNumericId(b.poi_id);
        });
          
        // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
        const uniqueCategories = [...new Set(sortedPois.map(p => p.type).filter(Boolean))].sort();
        
        // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
        const filterBlock = `
          <div class="mb-6 bg-white rounded-lg shadow-sm border p-4">
            <div class="flex flex-col md:flex-row gap-4">
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-search mr-2 text-gray-400"></i>–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
                </label>
                <input 
                  type="text" 
                  id="poi-search-input" 
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (RU –∏–ª–∏ EN)..."
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                />
              </div>
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-filter mr-2 text-gray-400"></i>–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                </label>
                <select 
                  id="poi-category-filter" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                >
                  <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                  ${uniqueCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                </select>
              </div>
            </div>
            <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
              <span id="poi-count-label">–í—Å–µ–≥–æ POI: ${sortedPois.length}</span>
              <button 
                id="reset-filters-btn" 
                class="text-indigo-600 hover:text-indigo-800 font-medium hidden"
              >
                <i class="fas fa-times-circle mr-1"></i>–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
              </button>
            </div>
          </div>
        `;
        
        const poiCardsHTML = sortedPois.map(p=>{
          // –ü–æ–ª—É—á–∞–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ POI
          const categoryIcon = window.getPOICategoryIcon(p.type);
          const categoryColor = {
            '–°–∏–Ω—Ç–æ–∏—Å—Ç—Å–∫–æ–µ —Å–≤—è—Ç–∏–ª–∏—â–µ': 'text-red-600',
            '–ë—É–¥–¥–∏–π—Å–∫–∏–π —Ö—Ä–∞–º': 'text-orange-600', 
            '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±—ä–µ–∫—Ç': 'text-gray-600',
            '–ú—É–∑–µ–π': 'text-blue-600',
            '–ê—Ä—Ç-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ / –ì–∞–ª–µ—Ä–µ—è': 'text-purple-600',
            '–°–º–æ—Ç—Ä–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞': 'text-green-600',
            '–õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–π —Å–∞–¥ / –ü–∞—Ä–∫': 'text-green-500',
            '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å': 'text-yellow-600',
            '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ': 'text-brown-600',
            '–Ø–ø–æ–Ω—Å–∫–∏–π –æ—Ç–µ–ª—å': 'text-indigo-600',
            '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è': 'text-pink-600',
            '–®–æ–ø–ø–∏–Ω–≥': 'text-emerald-600',
            '–¢–µ—Ä–º–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫': 'text-blue-500',
            '–°–ü–ê': 'text-teal-600'
          }[p.type] || 'text-gray-500';
          
          const bgColor = categoryColor.replace('text-', 'bg-').replace('-600', '-50').replace('-500', '-50');
          const borderColor = categoryColor.replace('text-', 'border-').replace('-600', '-200').replace('-500', '-200');
          
          return `
            <div 
              class="poi-card bg-white rounded-lg shadow-sm border-2 ${borderColor} hover:shadow-lg transition-all duration-300 overflow-hidden"
              data-id="${p.id}"
              data-name-ru="${(p.name || '').toLowerCase()}"
              data-name-en="${(p.name_en || '').toLowerCase()}"
              data-category="${p.type || ''}"
            >
              <!-- –í–µ—Ä—Ö–Ω—è—è —Ü–≤–µ—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ -->
              <div class="${bgColor} h-2"></div>
              
              <div class="p-5">
                <!-- –•–µ–¥–µ—Ä —Å –∏–∫–æ–Ω–∫–æ–π –∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ -->
                <div class="flex items-start justify-between mb-3">
                  <div class="flex items-center gap-3 flex-1">
                    <div class="w-12 h-12 ${bgColor} rounded-lg flex items-center justify-center ${categoryColor} flex-shrink-0 shadow-sm">
                      ${categoryIcon.replace('w-6 h-6', 'w-6 h-6')}
                    </div>
                    <div class="flex-1 min-w-0">
                      <h3 class="text-lg font-semibold text-gray-900 truncate">${p.name || '‚Äî'}</h3>
                      <p class="text-sm text-gray-500 truncate">${p.name_en || '‚Äî'}</p>
                    </div>
                  </div>
                  
                  <div class="flex items-center gap-2 ml-3 poi-actions">
                    <button 
                      data-act="edit-poi" 
                      data-id="${p.poi_id || p.business_id}" 
                      title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" 
                      class="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                    >
                      <i class="fas fa-pen"></i>
                    </button>
                    <button 
                      data-act="del-poi" 
                      data-id="${p.poi_id || p.business_id}" 
                      title="–£–¥–∞–ª–∏—Ç—å" 
                      class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ POI -->
                <div class="space-y-2">
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600 font-medium">
                      <i class="fas fa-tag mr-2 text-gray-400"></i>–ö–∞—Ç–µ–≥–æ—Ä–∏—è
                    </span>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${bgColor} ${categoryColor}">
                      ${p.type || '‚Äî'}
                    </span>
                  </div>
                  
                  <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                    <span class="text-sm text-gray-600 font-medium">
                      <i class="fas fa-fingerprint mr-2 text-gray-400"></i>POI ID
                    </span>
                    <span class="text-sm font-mono font-semibold text-gray-900 bg-gray-100 px-3 py-1 rounded-md">
                      ${p.poi_id || '‚Äî'}
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- –ù–∏–∂–Ω–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä (–ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏) -->
              <div class="h-1 ${bgColor} opacity-0 hover:opacity-100 transition-opacity"></div>
            </div>
          `;
        }).join('');
          
        // –û–±—ë—Ä—Ç—ã–≤–∞–µ–º –≤ flex-col –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è
        cards.innerHTML = '<div class="flex flex-col w-full">' + 
          filterBlock + 
          '<div id="poi-cards-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">' + 
          (poiCardsHTML || '<div class="col-span-full text-center text-gray-500 py-12">–ù–µ—Ç POI. –ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>') +
          '</div>' +
            '</div>';
          
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        const searchInput = document.getElementById('poi-search-input');
        const categoryFilter = document.getElementById('poi-category-filter');
        const resetBtn = document.getElementById('reset-filters-btn');
        const countLabel = document.getElementById('poi-count-label');
        const poiCards = document.querySelectorAll('.poi-card');
        
        function applyFilters() {
          const searchTerm = searchInput.value.toLowerCase().trim();
          const selectedCategory = categoryFilter.value;
          
          let visibleCount = 0;
          
          poiCards.forEach(card => {
            const nameRu = card.getAttribute('data-name-ru') || '';
            const nameEn = card.getAttribute('data-name-en') || '';
            const category = card.getAttribute('data-category') || '';
            
            const matchesSearch = !searchTerm || nameRu.includes(searchTerm) || nameEn.includes(searchTerm);
            const matchesCategory = !selectedCategory || category === selectedCategory;
            
            if (matchesSearch && matchesCategory) {
              card.style.display = '';
              visibleCount++;
            } else {
              card.style.display = 'none';
            }
          });
          
          countLabel.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ POI: ${visibleCount} –∏–∑ ${sortedPois.length}`;
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
          if (searchTerm || selectedCategory) {
            resetBtn.classList.remove('hidden');
          } else {
            resetBtn.classList.add('hidden');
          }
        }
        
        if (searchInput && categoryFilter) {
          searchInput.addEventListener('input', applyFilters);
          categoryFilter.addEventListener('change', applyFilters);
        }
        
        if (resetBtn) {
          resetBtn.addEventListener('click', () => {
            searchInput.value = '';
            categoryFilter.value = '';
            applyFilters();
          });
        }
        
        // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        setupUnifiedClickHandler();
      }

      // –£–î–ê–õ–ï–ù–û: –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä POI –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
      // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ POI –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
      
      /*
      function renderPOIDetails(){
        level='poi-details'; renderCrumbs(); setMappingHeader('poi-details');
        
        // –£–±–∏—Ä–∞–µ–º grid –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        cards.className = 'w-full';
        
        if (!selectedPoi) {
          cards.innerHTML = '<div class="text-gray-500">POI –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
          return;
        }
        
        const poi = selectedPoi;
        const categoryIcon = window.getPOICategoryIcon(poi.type);
        const categoryColor = {
          '–°–∏–Ω—Ç–æ–∏—Å—Ç—Å–∫–æ–µ —Å–≤—è—Ç–∏–ª–∏—â–µ': 'text-red-600',
          '–ë—É–¥–¥–∏–π—Å–∫–∏–π —Ö—Ä–∞–º': 'text-orange-600', 
          '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±—ä–µ–∫—Ç': 'text-gray-600',
          '–ú—É–∑–µ–π': 'text-blue-600',
          '–ê—Ä—Ç-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ / –ì–∞–ª–µ—Ä–µ—è': 'text-purple-600',
          '–°–º–æ—Ç—Ä–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞': 'text-green-600',
          '–õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–π —Å–∞–¥ / –ü–∞—Ä–∫': 'text-green-500',
          '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å': 'text-yellow-600',
          '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ': 'text-brown-600',
          '–Ø–ø–æ–Ω—Å–∫–∏–π –æ—Ç–µ–ª—å': 'text-indigo-600',
          '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è': 'text-pink-600',
          '–®–æ–ø–ø–∏–Ω–≥': 'text-emerald-600',
          '–¢–µ—Ä–º–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫': 'text-blue-500',
          '–°–ü–ê': 'text-teal-600'
        }[poi.type] || 'text-gray-500';
        
        const details = `
          <div class="bg-white rounded-lg shadow-sm border p-6">
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 flex items-center justify-center ${categoryColor}">
                  ${categoryIcon.replace('w-6 h-6', 'w-6 h-6')}
                </div>
                <div>
                  <h2 class="text-xl font-semibold text-gray-800">${poi.name}</h2>
                  <p class="text-sm text-gray-600">${poi.name_en || ''}</p>
                </div>
              </div>
              <div class="flex gap-2">
                <button class="btn-japanese" data-act="edit-poi" data-id="${poi.poi_id || poi.business_id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn-japanese accent" data-act="view-tickets" data-id="${poi.poi_id || poi.business_id}">–ë–∏–ª–µ—Ç—ã</button>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <h3 class="font-medium text-gray-700 mb-2">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <div class="space-y-2 text-sm">
                  <div><span class="font-medium">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span> <span class="${categoryColor}">${poi.type}</span></div>
                  <div><span class="font-medium">–ü—Ä–µ—Ñ–µ–∫—Ç—É—Ä–∞:</span> ${poi.prefecture_ru || ''} / ${poi.prefecture_en || ''}</div>
                  <div><span class="font-medium">POI ID:</span> <code class="bg-gray-100 px-1 rounded">${poi.poi_id || '‚Äî'}</code></div>
                  <div><span class="font-medium">Place ID:</span> <code class="bg-gray-100 px-1 rounded">${poi.place_id || '‚Äî'}</code></div>
                </div>
              </div>
              
              <div>
                <h3 class="font-medium text-gray-700 mb-2">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <div class="space-y-2 text-sm">
                  <div><span class="font-medium">–°–∞–π—Ç:</span> ${poi.website ? `<a href="${poi.website}" target="_blank" class="text-blue-600 hover:underline">${poi.website}</a>` : '‚Äî'}</div>
                  <div><span class="font-medium">–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:</span> ${poi.hours || '‚Äî'}</div>
                  <div><span class="font-medium">–°—Ç–∞—Ç—É—Å:</span> <span class="px-2 py-1 rounded text-xs ${poi.published ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${poi.published ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω' : '–ß–µ—Ä–Ω–æ–≤–∏–∫'}</span></div>
                </div>
              </div>
            </div>
            
            ${poi.description_ru || poi.description_en ? `
              <div class="mb-4">
                <h3 class="font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                <div class="text-sm text-gray-600 space-y-2">
                  ${poi.description_ru ? `<div><strong>RU:</strong> ${poi.description_ru}</div>` : ''}
                  ${poi.description_en ? `<div><strong>EN:</strong> ${poi.description_en}</div>` : ''}
                </div>
              </div>
            ` : ''}
            
            ${poi.notes ? `
              <div class="mb-4">
                <h3 class="font-medium text-gray-700 mb-2">–ó–∞–º–µ—Ç–∫–∏</h3>
                <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded">${poi.notes}</div>
              </div>
            ` : ''}
          </div>
        `;
        
        cards.innerHTML = details;
      }
      */

      // –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
      async function loadRegionCounts(){
        try{
          console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—á–µ—Ç—á–∏–∫–∏ —Ä–µ–≥–∏–æ–Ω–æ–≤');
          const res = await fetch('/api/data-api.php?action=stats', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          const j = await res.json();
          if (j.ok && j.stats) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
            regions.forEach(region => {
              const cityCount = j.stats.cities_by_region[region.business_id] || 0;
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ UI –µ—Å–ª–∏ –º—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–µ–≥–∏–æ–Ω–æ–≤
              if (level === 'regions') {
                const regionElement = document.querySelector(`[data-go="cities"][data-id="${region.business_id}"]`);
                if (regionElement) {
                  const countElement = regionElement.querySelector('.text-xs.font-medium');
                  if (countElement) {
                    countElement.textContent = cityCount;
                  }
                }
              }
            });
            console.log('–°—á–µ—Ç—á–∏–∫–∏ —Ä–µ–≥–∏–æ–Ω–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
          }
        }catch(e){
          console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤ —Ä–µ–≥–∏–æ–Ω–æ–≤:', e);
        }
      }

      async function loadCityCounts(regionId){
        try{
          console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ POI –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤ —Ä–µ–≥–∏–æ–Ω–∞ ${regionId}`);
          const res = await fetch(`/api/data-api.php?action=city-stats&region_id=${regionId}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          const j = await res.json();
          if (j.ok && j.stats) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ POI –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Ä–æ–¥–∞
            Object.keys(j.stats).forEach(cityId => {
              const poiCount = j.stats[cityId] || 0;
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ UI –µ—Å–ª–∏ –º—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –≥–æ—Ä–æ–¥–æ–≤
              if (level === 'cities') {
                const cityElement = document.querySelector(`[data-go="pois"][data-id="${cityId}"]`);
                if (cityElement) {
                  const countElement = cityElement.querySelector('.text-xs.font-medium');
                  if (countElement) {
                    countElement.textContent = poiCount;
                  }
                }
              }
            });
            console.log('–°—á–µ—Ç—á–∏–∫–∏ –≥–æ—Ä–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
          }
        }catch(e){
          console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤ –≥–æ—Ä–æ–¥–æ–≤:', e);
        }
      }

      // Server database loaders for each level
      async function loadCitiesForRegion(region, forceRefresh = false){
        try{
          console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –¥–ª—è ${region.name} –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –ë–î`);
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º business_id –≤–º–µ—Å—Ç–æ Airtable ID —Å–æ–≥–ª–∞—Å–Ω–æ Filtering.md
          const regionBusinessId = region.business_id || region.code;
          console.log('Using region business_id:', regionBusinessId);
          const res = await fetch(`/api/data-api.php?action=cities&region_id=${regionBusinessId}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          const j = await res.json();
          const items = j.ok ? (j.items||[]) : [];
          const cities = items.map(it=>({ 
            id: it.id, 
            name: it.name_ru || '‚Äî', 
            code: it.business_id || '', 
            business_id: it.business_id || '',
            type: it.type === 'location' ? 'location' : 'city' 
          }));
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥–æ—Ä–æ–¥–∞ –ø–æ ID –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è (—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤)
          const sortedCities = [...cities].sort((a, b) => {
            const getNumericId = (id) => {
              const match = id.match(/(\d+)$/);
              return match ? parseInt(match[1], 10) : 0;
            };
            return getNumericId(a.id) - getNumericId(b.id);
          });
          
          citiesByRegion[region.business_id] = sortedCities;
          console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è ${region.name}:`, cities.length);
        }catch(e){ 
          citiesByRegion[region.business_id] = []; 
          console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤:', e);
        }
      }

      async function loadPoisForCity(city, forceRefresh = false){
        console.log('=== LOAD POIS FOR CITY DEBUG ===');
        console.log('City:', city.name, 'ID:', city.id);
        console.log('Current poisByCity keys:', Object.keys(poisByCity));
        console.log('Current poisByCity[city.business_id]:', poisByCity[city.business_id]);
        
        // –ï—Å–ª–∏ POI —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –∏ –Ω–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
        if (!forceRefresh && poisByCity[city.business_id] && poisByCity[city.business_id].length > 0) {
          console.log('POI already loaded for city:', city.name, 'count:', poisByCity[city.business_id].length);
          return;
        }
        
        try{
          console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º POI –¥–ª—è ${city.name} –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –ë–î`);
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º business_id –≤–º–µ—Å—Ç–æ Airtable ID —Å–æ–≥–ª–∞—Å–Ω–æ Filtering.md
          const cityBusinessId = city.business_id || city.code;
          console.log('Using city business_id:', cityBusinessId);
          const res = await fetch(`/api/data-api.php?action=pois&city_id=${cityBusinessId}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          const j = await res.json();
          const items = j.ok ? (j.items || []) : [];
          
          const pois = items.map(record => ({
            id: record.id,
            name: record.name_ru || '‚Äî',
            type: record.category || '',
            name_en: record.name_en || '',
            place_id: record.place_id || '',
            published: record.published || false,
            poi_id: record.business_id || '',
            region: record.region_id ? [record.region_id] : []
          }));
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º POI –ø–æ ID –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è (—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤)
          const sortedPois = [...pois].sort((a, b) => {
            const getNumericId = (id) => {
              const match = id.match(/(\d+)$/);
              return match ? parseInt(match[1], 10) : 0;
            };
            return getNumericId(a.id) - getNumericId(b.id);
          });
          
          poisByCity[city.business_id] = sortedPois;
          console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ POI –¥–ª—è ${city.name}:`, pois.length);
        } catch(e){ 
          console.error('Error loading POIs for city:', city.name, e);
          poisByCity[city.business_id] = []; 
        }
      }

        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ POI –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞ - –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ
      async function preloadPoisCountsForRegion(region){
        try{
          const list = citiesByRegion[region.business_id] || [];
          if (!list.length) return;
          
          // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ poisByCity –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è "–ø–µ—Ä–µ—Ç–µ–∫–∞–Ω–∏—è" POI –º–µ–∂–¥—É —Ä–µ–≥–∏–æ–Ω–∞–º–∏
          Object.keys(poisByCity).forEach(key => {
            delete poisByCity[key];
          });
          
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
          list.forEach(city => {
            poisByCity[city.business_id] = [];
          });
            
          console.log('Loading POI for region:', region.name, 'Total cities:', list.length);
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º POI –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤
          const loadPromises = list.map(async (city) => {
            try {
              const res = await fetch(`/api/data-api.php?action=pois&city_id=${city.id}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
              });
              const j = await res.json();
              const items = j.ok ? (j.items || []) : [];
              
              const pois = items.map(record => ({
                id: record.id,
                name: record.name_ru || '‚Äî',
                type: record.category || '',
                name_en: record.name_en || '',
                place_id: record.place_id || '',
                published: record.published || false,
                poi_id: record.business_id || '',
                region: record.region_id ? [record.region_id] : []
              }));
              
              // –°–æ—Ä—Ç–∏—Ä—É–µ–º POI –ø–æ ID –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è (—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤)
              const sortedPois = [...pois].sort((a, b) => {
                const getNumericId = (id) => {
                  const match = id.match(/(\d+)$/);
                  return match ? parseInt(match[1], 10) : 0;
                };
                return getNumericId(a.id) - getNumericId(b.id);
              });
              
              poisByCity[city.business_id] = sortedPois;
              console.log(`Loaded ${pois.length} POI for city ${city.name}`);
              
              // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–∂–¥–æ–≥–æ –≥–æ—Ä–æ–¥–∞
              if (level === 'cities') {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—á–µ—Ç—á–∏–∫ –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞
                const cityElement = document.querySelector(`[data-go="pois"][data-id="${city.business_id}"]`);
                if (cityElement) {
                  const countElement = cityElement.querySelector('.text-xs.font-medium');
                  if (countElement) {
                    countElement.textContent = pois.length;
                  }
                }
              }
              
              return pois.length;
            } catch (e) {
              console.warn(`Error loading POI for city ${city.name}:`, e);
              poisByCity[city.business_id] = [];
              return 0;
            }
          });
          
          // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∑–æ–∫ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
          await Promise.all(loadPromises);
          
          console.log('All POI loaded for region:', region.name);
          
        }catch(e){
            console.error('Error preloading POI for region:', region.name, e);
          }
      }

      function renderTickets(){
        level='tickets'; renderCrumbs();
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º grid –¥–ª—è –±–∏–ª–µ—Ç–æ–≤
        cards.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
        
        const list = ticketsByPoi[selectedPoi.id] || [];
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–ª–µ—Ç—ã –ø–æ ID –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è (—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤)
        const sortedTickets = [...list].sort((a, b) => {
          // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å –∏–∑ ID (–Ω–∞–ø—Ä–∏–º–µ—Ä, T-001 -> 1)
          const getNumericId = (id) => {
            const match = id.match(/(\d+)$/);
            return match ? parseInt(match[1], 10) : 0;
          };
          return getNumericId(a.id) - getNumericId(b.id);
        });
        
        cards.innerHTML = sortedTickets.map(t=>{
          const actions = '<button data-act="edit-ticket" data-id="'+t.id+'" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
                          '<button data-act="del-ticket" data-id="'+t.id+'" title="–£–¥–∞–ª–∏—Ç—å" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>';
          const inner = '<div class="flex items-center justify-between">\
              <div class="text-gray-800"><span class="text-xs bg-gray-100 text-gray-700 inline-block px-2 py-0.5 rounded mr-2">üéü</span>'+t.category+'</div>\
              <div class="text-gray-700">'+t.price+'¬•</div>\
            </div>';
          return card(actions, inner);
        }).join('') || '<div class="text-gray-500">–ù–µ—Ç –±–∏–ª–µ—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>';
      }

      // –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–ª–∏–∫–æ–≤ –¥–ª—è —Ö–ª–µ–±–Ω—ã—Ö –∫—Ä–æ—à–µ–∫
      function setupBreadcrumbHandler() {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –µ—Å–ª–∏ –æ–Ω –±—ã–ª
        if (window.breadcrumbHandler) {
          document.removeEventListener('click', window.breadcrumbHandler);
        }
        
        window.breadcrumbHandler = function(e) {
          if (e.target.matches('[data-level]')) {
            e.preventDefault();
            e.stopPropagation();
            
            const targetLevel = e.target.getAttribute('data-level');
            const regionId = e.target.getAttribute('data-region-id');
            const cityId = e.target.getAttribute('data-city-id');
            const poiId = e.target.getAttribute('data-poi-id');
            
            console.log('Breadcrumb navigation:', { targetLevel, regionId, cityId, poiId });
            
            // –°–æ–∑–¥–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            const state = { level: targetLevel };
            if (regionId) state.regionId = regionId;
            if (cityId) state.cityId = cityId;
            if (poiId) state.poiId = poiId;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
            history.pushState(state, '');
            renderFromState(state);
          }
        };
        
        document.addEventListener('click', window.breadcrumbHandler);
      }

      // –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –¥–µ–π—Å—Ç–≤–∏–π
      function setupUnifiedClickHandler() {
        console.log('Setting up unified click handler...');
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        if (window.unifiedClickHandler) {
          document.removeEventListener('click', window.unifiedClickHandler);
        }
        
        window.unifiedClickHandler = async function(e) {
          console.log('Click detected on:', e.target, 'tagName:', e.target.tagName, 'className:', e.target.className);
          
          // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
          const actionBtn = e.target.closest('button[data-act]');
          if (actionBtn) {
            e.preventDefault();
            e.stopPropagation();
            await handleActionButton(actionBtn);
            return; 
          }
          
          // 2. –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
          const navElement = e.target.closest('[data-go]');
          if (navElement && navElement.closest('#db_cards')) {
            e.preventDefault();
            await handleNavigation(navElement);
            return;
          }
          
          // 3. –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Ö–ª–µ–±–Ω—ã–º –∫—Ä–æ—à–∫–∞–º (–æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
          if (e.target.closest('[data-level]')) {
            return;
          }
        };
        
        document.addEventListener('click', window.unifiedClickHandler);
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
      async function handleActionButton(btn) {
        const act = btn.getAttribute('data-act');
        const id = btn.getAttribute('data-id');
        
        console.log('Action button clicked:', { act, id });
        
        if (act === 'edit-region') {
          const r = regions.find(x=>x.business_id===id); 
          if(!r) return; 
          const n=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞:', r.name); 
          if(n){
            const old = r.name; 
            r.name=n.trim(); 
            renderRegions();
            try{
              await fetch('/api/db-sync.php',{
                method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
                body: JSON.stringify({ scope:'regions', action:'update', data:{ id: r.id, name: r.name } })
              }).then(async res=>{ if(!res.ok){ throw new Error('HTTP '+res.status); } const j=await res.json(); if(!j.ok) throw new Error(j.error||'Airtable'); });
              if (window.osNotify) window.osNotify('–û–±–Ω–æ–≤–ª–µ–Ω–æ','–†–µ–≥–∏–æ–Ω –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω');
            }catch(e){ r.name = old; renderRegions(); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: '+(e && e.message ? e.message : '')); }
          }
        } else if (act === 'del-region') {
          const r = regions.find(x=>x.business_id===id);
          regions = regions.filter(x=>x.business_id!==id); 
          delete citiesByRegion[selectedRegion.business_id]; 
          renderRegions();
          if (r) deleteRegionOnServer(r);
        } else if (act === 'edit-city') {
          const list = citiesByRegion[selectedRegion.business_id]||[]; 
          const c=list.find(x=>x.business_id===id); 
          if(!c) return; 
          const n=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞/–ª–æ–∫–∞—Ü–∏–∏:', c.name); 
          if(n){
            const old=c.name; 
            c.name=n.trim(); 
            await renderCities();
            try{
              await fetch('/api/db-sync.php',{
                method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
                body: JSON.stringify({ scope:'cities', action:'update', data:{ id: c.id, name: c.name } })
              }).then(async res=>{ if(!res.ok){ throw new Error('HTTP '+res.status); } const j=await res.json(); if(!j.ok) throw new Error(j.error||'Airtable'); });
              if (window.osNotify) window.osNotify('–û–±–Ω–æ–≤–ª–µ–Ω–æ','–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            }catch(e){ c.name=old; await renderCities(); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: '+(e && e.message ? e.message : '')); }
          }
        } else if (act === 'del-city') {
          const list = citiesByRegion[selectedRegion.business_id]||[]; 
          citiesByRegion[selectedRegion.business_id] = list.filter(x=>x.business_id!==id); 
          delete poisByCity[selectedCity.business_id]; 
          await renderCities();
        } else if (act === 'edit-poi') {
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è POI
          const list = poisByCity[selectedCity.business_id]||[];
          const poi = list.find(x=>x.business_id===id);
          if (!poi) return;
          
          const formData = await openCreatePOIModal(poi);
          if (!formData) return;
          
          try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            cards.innerHTML = '<div class="flex items-center justify-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i><span class="ml-3 text-gray-600">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ POI...</span></div>';
            
            // –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ë–î –ò AIRTABLE —á–µ—Ä–µ–∑ API
            console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ POI —á–µ—Ä–µ–∑ API...', formData);
            
            const saveResponse = await fetch('/api/save-poi.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id: poi.id,
                airtable_id: poi.airtable_id,
                business_id: poi.poi_id || poi.business_id,
                name_ru: formData.name_ru,
                name_en: formData.name_en,
                prefecture_ru: formData.pref_ru,
                prefecture_en: formData.pref_en,
                categories_ru: formData.cats_ru,
                categories_en: formData.cats_en,
                place_id: formData.place_id,
                website: formData.website,
                working_hours: formData.hours,
                description_ru: formData.desc_ru,
                description_en: formData.desc_en,
                notes: formData.notes,
                published: formData.published,
                tickets: formData.tickets,
                city_id: selectedCity.id,
                region_id: selectedRegion.id
              })
            });
            
            const result = await saveResponse.json();
            console.log('üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', result);
            
            if (!result.ok) {
              throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î');
            }
            
            // –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            Object.assign(poi, {
              name: formData.name_ru,
              name_en: formData.name_en,
              type: formData.cats_ru[0] || poi.type,
              categories_ru: formData.cats_ru,
              categories_en: formData.cats_en,
              prefecture_ru: formData.pref_ru,
              prefecture_en: formData.pref_en,
              place_id: formData.place_id,
              website: formData.website,
              hours: formData.hours,
              description_ru: formData.desc_ru,
              description_en: formData.desc_en,
              published: formData.published,
              notes: formData.notes,
              tickets: formData.tickets
            });
            
            console.log('‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
              await renderPois();
            
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            if (window.osNotify) window.osNotify('‚úÖ –£—Å–ø–µ—à–Ω–æ', 'POI –æ–±–Ω–æ–≤–ª–µ–Ω');
            
          } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è POI:', e);
            alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å POI: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            await renderPois();
          }
        } else if (act === 'del-poi') {
          const list = poisByCity[selectedCity.business_id]||[]; 
          poisByCity[selectedCity.business_id] = list.filter(x=>x.business_id!==id); 
          delete ticketsByPoi[selectedPoi.business_id]; 
          await renderPois();
        } else if (act === 'view-tickets') {
          // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –±–∏–ª–µ—Ç–∞–º POI
          const list = poisByCity[selectedCity.business_id]||[];
          selectedPoi = list.find(x=>x.business_id===id) || null;
          if (selectedPoi) {
            push('tickets', { regionId: (selectedRegion ? selectedRegion.business_id : null), cityId: (selectedCity ? selectedCity.business_id : null), poiId: (selectedPoi ? selectedPoi.business_id : null) });
            renderTickets();
          }
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      async function handleNavigation(navElement) {
        const id = navElement.getAttribute('data-id');
        const to = navElement.getAttribute('data-go');
        
        console.log('Navigation triggered:', {to, id, element: navElement});
        
        try {
          if (to === 'cities') {
            await navigateToCities(id);
          } else if (to === 'pois') {
            await navigateToPOIs(id);
          } else if (to === 'tickets') {
            await navigateToTickets(id);
          }
        } catch (error) {
          console.error('Navigation error:', error);
          showErrorState('–û—à–∏–±–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: ' + error.message);
        }
      }
      
      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ –≥–æ—Ä–æ–¥–∞–º —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
      async function navigateToCities(regionId) {
        console.log('Navigating to cities for region:', regionId);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ä–µ–≥–∏–æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–∏—â–µ–º –ø–æ business_id)
        const region = regions.find(r => r.business_id === regionId);
        if (!region) {
          console.error('Region not found:', regionId);
          showErrorState('–†–µ–≥–∏–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
          
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        selectedRegion = region;
        selectedCity = null;
        selectedPoi = null;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        level = 'cities';
        renderCrumbs();
        setMappingHeader('city');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loading
        showLoadingState('–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤...');
        
        try {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          if (!citiesByRegion[region.business_id] || citiesByRegion[region.business_id].length === 0) {
            await loadCitiesForRegion(region);
          }
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ POI –≤ —Ñ–æ–Ω–µ
          loadCityCounts(region.business_id);
          
          // –†–µ–Ω–¥–µ—Ä–∏–º –≥–æ—Ä–æ–¥–∞
          renderCities();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
          push('cities', { regionId });
          
        } catch (error) {
          console.error('Error loading cities:', error);
          showErrorState('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤');
        }
      }
      
      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ POI —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
      async function navigateToPOIs(cityId) {
        console.log('Navigating to POIs for city:', cityId);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ä–µ–≥–∏–æ–Ω –≤—ã–±—Ä–∞–Ω
        if (!selectedRegion) {
          console.error('No region selected');
          showErrorState('–†–µ–≥–∏–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω');
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≥–æ—Ä–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        const city = citiesByRegion[selectedRegion.business_id]?.find(c => c.business_id === cityId);
        if (!city) {
          console.error('City not found:', cityId);
          showErrorState('–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        selectedCity = city;
        selectedPoi = null;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        level = 'pois';
        renderCrumbs();
        setMappingHeader('poi');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loading
        showLoadingState('–ó–∞–≥—Ä—É–∑–∫–∞ POI...');
        
        try {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º POI –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          if (!poisByCity[cityId] || poisByCity[cityId].length === 0) {
            await loadPoisForCity(city);
          }
          
          // –†–µ–Ω–¥–µ—Ä–∏–º POI
          renderPois();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
          push('pois', { regionId: selectedRegion.business_id, cityId });
          
        } catch (error) {
          console.error('Error loading POIs:', error);
          showErrorState('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ POI');
        }
      }
      
      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ –±–∏–ª–µ—Ç–∞–º —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
      async function navigateToTickets(poiId) {
        console.log('Navigating to tickets for POI:', poiId);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≥–æ—Ä–æ–¥ –≤—ã–±—Ä–∞–Ω
        if (!selectedCity) {
          console.error('No city selected');
          showErrorState('–ì–æ—Ä–æ–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω');
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ POI —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        const poi = poisByCity[selectedCity.business_id]?.find(p => p.business_id === poiId);
        if (!poi) {
          console.error('POI not found:', poiId);
          showErrorState('POI –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        selectedPoi = poi;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        level = 'tickets';
        renderCrumbs();
        setMappingHeader('ticket');
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –±–∏–ª–µ—Ç—ã
        renderTickets();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        push('tickets', { regionId: selectedRegion.business_id, cityId: selectedCity.business_id, poiId });
      }
      
      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è UI —Å–æ—Å—Ç–æ—è–Ω–∏–π
      function showLoadingState(message = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
        cards.innerHTML = `
          <div class="flex items-center justify-center py-12">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
            <span class="ml-3 text-gray-600">${message}</span>
          </div>
        `;
      }
      
      function showErrorState(message) {
        cards.innerHTML = `
          <div class="text-center text-red-500 py-12">
            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
            <div>${message}</div>
            <button onclick="location.reload()" class="mt-4 btn-japanese">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
          </div>
        `;
      }

      // –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π (Edit/Delete)
      function setupActionButtonsHandler() {
        console.log('Setting up action buttons handler...');
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –µ—Å–ª–∏ –æ–Ω –±—ã–ª
        if (window.actionButtonsHandler) {
          document.removeEventListener('click', window.actionButtonsHandler);
        }
        
        window.actionButtonsHandler = async function(e) {
          // –ò—â–µ–º –∫–Ω–æ–ø–∫—É —Å data-act
          const btn = e.target.closest('button[data-act]');
          if (!btn) return;
          
        e.preventDefault();
          e.stopPropagation();
          
          const act = btn.getAttribute('data-act');
          const id = btn.getAttribute('data-id');
          
          console.log('Action button clicked:', { act, id });
          
          if (act === 'edit-region') {
            await editRegion(id);
          } else if (act === 'del-region') {
            await deleteRegion(id);
          } else if (act === 'edit-city') {
            await editCity(id);
          } else if (act === 'del-city') {
            await deleteCity(id);
          } else if (act === 'edit-poi') {
            await editPoi(id);
          } else if (act === 'del-poi') {
            await deletePoi(id);
          } else if (act === 'edit-ticket') {
            await editTicket(id);
          } else if (act === 'del-ticket') {
            await deleteTicket(id);
          }
        };
        
        document.addEventListener('click', window.actionButtonsHandler);
      } // –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ setupActionButtonsHandler

      // Breadcrumbs –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è setupBreadcrumbHandler

      // Back button
      document.getElementById('db_back')?.addEventListener('click', async function(){
        if (level==='cities') return renderRegions();
        if (level==='pois') return await renderCities();
        if (level==='poi-details') return await renderPois();
        if (level==='tickets') return await renderPois();
      });

      // Card action buttons
      cards.addEventListener('click', async function(e){
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        e.stopPropagation();
        const act = btn.getAttribute('data-act');
        const id = btn.getAttribute('data-id');
        if (act==='edit-region'){
          const r = regions.find(x=>x.business_id===id); if(!r) return; const n=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞:', r.name); if(n){
            const old = r.name; r.name=n.trim(); renderRegions();
            try{
              await fetch('/api/db-sync.php',{
                method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
                body: JSON.stringify({ scope:'regions', action:'update', data:{ id: r.id, name: r.name } })
              }).then(async res=>{ if(!res.ok){ throw new Error('HTTP '+res.status); } const j=await res.json(); if(!j.ok) throw new Error(j.error||'Airtable'); });
              if (window.osNotify) window.osNotify('–û–±–Ω–æ–≤–ª–µ–Ω–æ','–†–µ–≥–∏–æ–Ω –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω');
            }catch(e){ r.name = old; renderRegions(); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: '+(e && e.message ? e.message : '')); }
          }
        } else if (act==='del-region'){
          const r = regions.find(x=>x.business_id===id);
          regions = regions.filter(x=>x.business_id!==id); delete citiesByRegion[selectedRegion.business_id]; renderRegions();
          if (r) deleteRegionOnServer(r);
        } else if (act==='edit-city'){
          const list = citiesByRegion[selectedRegion.business_id]||[]; const c=list.find(x=>x.business_id===id); if(!c) return; const n=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞/–ª–æ–∫–∞—Ü–∏–∏:', c.name); if(n){
            const old=c.name; c.name=n.trim(); await renderCities();
            try{
              await fetch('/api/db-sync.php',{
                method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
                body: JSON.stringify({ scope:'cities', action:'update', data:{ id: c.id, name: c.name } })
              }).then(async res=>{ if(!res.ok){ throw new Error('HTTP '+res.status); } const j=await res.json(); if(!j.ok) throw new Error(j.error||'Airtable'); });
              if (window.osNotify) window.osNotify('–û–±–Ω–æ–≤–ª–µ–Ω–æ','–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            }catch(e){ c.name=old; await renderCities(); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: '+(e && e.message ? e.message : '')); }
          }
        } else if (act==='del-city'){
          const list = citiesByRegion[selectedRegion.business_id]||[]; citiesByRegion[selectedRegion.business_id] = list.filter(x=>x.business_id!==id); delete poisByCity[selectedCity.business_id]; await renderCities();
        } else if (act==='edit-poi'){
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è POI
            const list = poisByCity[selectedCity.business_id]||[];
            const poi = list.find(x=>x.business_id===id);
            if (!poi) return;
            
            const formData = await openCreatePOIModal(poi);
            if (!formData) return;
            
            try {
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
              cards.innerHTML = '<div class="flex items-center justify-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i><span class="ml-3 text-gray-600">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ POI...</span></div>';
              
              // –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ë–î –ò AIRTABLE —á–µ—Ä–µ–∑ API
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ POI —á–µ—Ä–µ–∑ API...', formData);
              
              const saveResponse = await fetch('/api/save-poi.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  id: poi.id,
                  airtable_id: poi.airtable_id,
                  business_id: poi.poi_id || poi.business_id,
                  name_ru: formData.name_ru,
                  name_en: formData.name_en,
                  prefecture_ru: formData.pref_ru,
                  prefecture_en: formData.pref_en,
                  categories_ru: formData.cats_ru,
                  categories_en: formData.cats_en,
                  place_id: formData.place_id,
                  website: formData.website,
                  working_hours: formData.hours,
                  description_ru: formData.desc_ru,
                  description_en: formData.desc_en,
                  notes: formData.notes,
                  published: formData.published,
                  tickets: formData.tickets,
                  city_id: selectedCity.id,
                  region_id: selectedRegion.id
                })
              });
              
              const result = await saveResponse.json();
              console.log('üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', result);
              
              if (!result.ok) {
                throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î');
              }
              
              // –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
              Object.assign(poi, {
                name: formData.name_ru,
                name_en: formData.name_en,
                type: formData.cats_ru[0] || poi.type,
                categories_ru: formData.cats_ru,
                categories_en: formData.cats_en,
                prefecture_ru: formData.pref_ru,
                prefecture_en: formData.pref_en,
                place_id: formData.place_id,
                website: formData.website,
                hours: formData.hours,
                description_ru: formData.desc_ru,
                description_en: formData.desc_en,
                published: formData.published,
                notes: formData.notes,
                tickets: formData.tickets
              });
              
              console.log('‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
              
              // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
                await renderPois();
              
              // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
              if (window.osNotify) {
                const syncStatus = result.airtable_synced ? '–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å Airtable' : '';
                window.osNotify('‚úÖ POI —Å–æ—Ö—Ä–∞–Ω—ë–Ω', `${formData.name_ru} –æ–±–Ω–æ–≤–ª—ë–Ω –≤ –ë–î ${syncStatus}`);
              } else {
                alert(`‚úÖ POI "${formData.name_ru}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!\n\n` +
                      `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n` +
                      `- –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î: –î–∞\n` +
                      `- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å Airtable: ${result.airtable_synced ? '–î–∞' : '–ù–µ—Ç'}\n` +
                      `- –ë–∏–ª–µ—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${result.tickets_saved || 0}`);
              }
              
            } catch(e) {
              console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è POI:', e);
              alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å POI: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
              // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
              await renderPois();
            }
            return;
        } else if (act==='view-tickets'){
          // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –±–∏–ª–µ—Ç–∞–º POI
          const list = poisByCity[selectedCity.business_id]||[];
          selectedPoi = list.find(x=>x.business_id===id) || null;
          if (selectedPoi) {
            push('tickets', { regionId: (selectedRegion ? selectedRegion.business_id : null), cityId: (selectedCity ? selectedCity.business_id : null), poiId: (selectedPoi ? selectedPoi.business_id : null) });
            renderTickets();
          }
        } else if (act==='del-poi'){
          const list = poisByCity[selectedCity.business_id]||[]; poisByCity[selectedCity.business_id] = list.filter(x=>x.business_id!==id); delete ticketsByPoi[selectedPoi.business_id]; await renderPois();
        } else if (act==='edit-ticket'){
          const list = ticketsByPoi[selectedPoi.business_id]||[]; const t = list.find(x=>x.business_id===id); if(!t) return; const c=prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è:', t.category)||t.category; const p=prompt('–¶–µ–Ω–∞ (¬•):', String(t.price))||String(t.price); const n=prompt('–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:', t.note||'')||t.note; t.category=c.trim(); t.price=parseInt(p,10)||t.price; t.note=n.trim(); renderTickets();
        } else if (act==='del-ticket'){
          const list = ticketsByPoi[selectedPoi.business_id]||[]; ticketsByPoi[selectedPoi.business_id] = list.filter(x=>x.business_id!==id); renderTickets();
        }
      });

      // Floating add button
      function genId(prefix, n){ return prefix+'-'+String(n).padStart(3,'0'); }

      // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–∞ (RU/EN)
      function openCreateRegionModal(){
        return new Promise(resolve=>{
          const wrap = document.createElement('div');
          wrap.className = 'fixed inset-0 z-50 flex items-center justify-center';
          wrap.innerHTML = '\
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
            <div class="relative bg-white rounded-lg shadow-xl p-6 w-96">\
              <div class="text-lg text-gray-800 mb-4">–ù–æ–≤—ã–π —Ä–µ–≥–∏–æ–Ω</div>\
              <div class="space-y-3">\
                <input id="cr_ru" class="input-japanese w-full" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (RU)"/>\
                <input id="cr_en" class="input-japanese w-full" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (EN)"/>\
              </div>\
              <div class="mt-5 flex justify-end gap-2">\
                <button id="cr_cancel" class="btn-japanese">–û—Ç–º–µ–Ω–∞</button>\
                <button id="cr_ok" class="btn-japanese accent">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>\
              </div>\
            </div>';
          document.body.appendChild(wrap);
          function done(val){ try{ document.body.removeChild(wrap); }catch{} resolve(val||null); }
          wrap.addEventListener('click', e=>{ if (e.target===wrap.firstChild) done(null); });
          wrap.querySelector('#cr_cancel').addEventListener('click', ()=>done(null));
          wrap.querySelector('#cr_ok').addEventListener('click', ()=>{
            const ru = wrap.querySelector('#cr_ru').value.trim();
            const en = wrap.querySelector('#cr_en').value.trim();
            if (!ru || !en){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è'); return; }
            done({ ru, en });
          });
          wrap.querySelector('#cr_ru').focus();
        });
      }
        
      // –î–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ POI –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–∑–∞–º–µ–Ω–µ–Ω–∞ –ø—Ä—è–º—ã–º –≤—Ö–æ–¥–æ–º –≤ —Ñ–æ—Ä–º—É)
      function showPOIDetailsModal(poi) {
        console.warn('showPOIDetailsModal is deprecated. Opening edit modal instead.');
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ä–∞–∑—É —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        openCreatePOIModal(poi);
        return;
      }
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –±–∏–ª–µ—Ç–æ–≤ POI
      window.showTicketsForPOI = function(poiId) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.querySelector('.fixed')?.remove();
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –±–∏–ª–µ—Ç–∞–º
        const list = poisByCity[selectedCity.business_id] || [];
        selectedPoi = list.find(p=>p.business_id===poiId) || null;
        push('tickets', { regionId: (selectedRegion ? selectedRegion.business_id : null), cityId: (selectedCity ? selectedCity.business_id : null), poiId: (selectedPoi ? selectedPoi.business_id : null) });
        renderTickets();
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ POI (—ç–∫—Å–ø–æ—Ä—Ç –≤ JSON)
      window.savePOIRecord = function(poiId) {
        const list = poisByCity[selectedCity.business_id] || [];
        const poi = list.find(p=>p.business_id===poiId) || null;
        if (!poi) return;
        
        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
        const exportData = {
          poi_id: poi.poi_id || poi.id,
          name_ru: poi.name,
          name_en: poi.name_en,
          category: poi.type,
          place_id: poi.place_id,
          website: poi.website,
          hours: poi.hours,
          description_ru: poi.description_ru,
          description_en: poi.description_en,
          published: poi.published,
          city: selectedCity.name,
          region: selectedRegion.name,
          exported_at: new Date().toISOString()
        };
        
        // –°–∫–∞—á–∏–≤–∞–µ–º –∫–∞–∫ JSON —Ñ–∞–π–ª
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `poi-${poi.poi_id || poi.id}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        if (window.osNotify) {
          window.osNotify('–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', `–§–∞–π–ª poi-${poi.poi_id || poi.id}.json —Å–∫–∞—á–∞–Ω`);
        }
      };

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è POI –æ—Ç–∫–ª—é—á–µ–Ω–∞ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
      window.editPOI = async function() {
        console.log('editPOI disabled: use dedicated create/edit modal from toolbar');
        return;
      };

      // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è POI
      function openCreatePOIModal(editData = null){
          return new Promise(resolve=>{
            const isEdit = !!editData;
            const wrap = document.createElement('div');
            wrap.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 overflow-y-auto';
            wrap.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            // –í—Å–µ 47 –ø—Ä–µ—Ñ–µ–∫—Ç—É—Ä –Ø–ø–æ–Ω–∏–∏
            const prefectures = [
              // –•–æ–∫–∫–∞–π–¥–æ
              {value: 'hokkaido', ru: '–•–æ–∫–∫–∞–π–¥–æ', en: 'Hokkaido'},
              // –¢–æ—Ö–æ–∫—É
              {value: 'aomori', ru: '–ê–æ–º–æ—Ä–∏', en: 'Aomori'},
              {value: 'iwate', ru: '–ò–≤–∞—Ç—ç', en: 'Iwate'},
              {value: 'miyagi', ru: '–ú–∏—è–≥–∏', en: 'Miyagi'},
              {value: 'akita', ru: '–ê–∫–∏—Ç–∞', en: 'Akita'},
              {value: 'yamagata', ru: '–Ø–º–∞–≥–∞—Ç–∞', en: 'Yamagata'},
              {value: 'fukushima', ru: '–§—É–∫—É—Å–∏–º–∞', en: 'Fukushima'},
              // –ö–∞–Ω—Ç–æ
              {value: 'ibaraki', ru: '–ò–±–∞—Ä–∞–∫–∏', en: 'Ibaraki'},
              {value: 'tochigi', ru: '–¢–æ—Ç–∏–≥–∏', en: 'Tochigi'},
              {value: 'gunma', ru: '–ì—É–º–º–∞', en: 'Gunma'},
              {value: 'saitama', ru: '–°–∞–π—Ç–∞–º–∞', en: 'Saitama'},
              {value: 'chiba', ru: '–¢–∏–±–∞', en: 'Chiba'},
              {value: 'tokyo', ru: '–¢–æ–∫–∏–æ', en: 'Tokyo'},
              {value: 'kanagawa', ru: '–ö–∞–Ω–∞–≥–∞–≤–∞', en: 'Kanagawa'},
              // –¢—é–±—É
              {value: 'niigata', ru: '–ù–∏–∏–≥–∞—Ç–∞', en: 'Niigata'},
              {value: 'toyama', ru: '–¢–æ—è–º–∞', en: 'Toyama'},
              {value: 'ishikawa', ru: '–ò—Å–∏–∫–∞–≤–∞', en: 'Ishikawa'},
              {value: 'fukui', ru: '–§—É–∫—É–∏', en: 'Fukui'},
              {value: 'yamanashi', ru: '–Ø–º–∞–Ω–∞—Å–∏', en: 'Yamanashi'},
              {value: 'nagano', ru: '–ù–∞–≥–∞–Ω–æ', en: 'Nagano'},
              {value: 'gifu', ru: '–ì–∏—Ñ—É', en: 'Gifu'},
              {value: 'shizuoka', ru: '–°–∏–¥–∑—É–æ–∫–∞', en: 'Shizuoka'},
              {value: 'aichi', ru: '–ê–π—Ç–∏', en: 'Aichi'},
              // –ö–∞–Ω—Å–∞–π
              {value: 'mie', ru: '–ú–∏—ç', en: 'Mie'},
              {value: 'shiga', ru: '–°–∏–≥–∞', en: 'Shiga'},
              {value: 'kyoto', ru: '–ö–∏–æ—Ç–æ', en: 'Kyoto'},
              {value: 'osaka', ru: '–û—Å–∞–∫–∞', en: 'Osaka'},
              {value: 'hyogo', ru: '–•—ë–≥–æ', en: 'Hyogo'},
              {value: 'nara', ru: '–ù–∞—Ä–∞', en: 'Nara'},
              {value: 'wakayama', ru: '–í–∞–∫–∞—è–º–∞', en: 'Wakayama'},
              // –¢—é–≥–æ–∫—É
              {value: 'tottori', ru: '–¢–æ—Ç—Ç–æ—Ä–∏', en: 'Tottori'},
              {value: 'shimane', ru: '–°–∏–º–∞–Ω—ç', en: 'Shimane'},
              {value: 'okayama', ru: '–û–∫–∞—è–º–∞', en: 'Okayama'},
              {value: 'hiroshima', ru: '–•–∏—Ä–æ—Å–∏–º–∞', en: 'Hiroshima'},
              {value: 'yamaguchi', ru: '–Ø–º–∞–≥—É—Ç–∏', en: 'Yamaguchi'},
              // –°–∏–∫–æ–∫—É
              {value: 'tokushima', ru: '–¢–æ–∫—É—Å–∏–º–∞', en: 'Tokushima'},
              {value: 'kagawa', ru: '–ö–∞–≥–∞–≤–∞', en: 'Kagawa'},
              {value: 'ehime', ru: '–≠—Ö–∏–º—ç', en: 'Ehime'},
              {value: 'kochi', ru: '–ö–æ—Ç–∏', en: 'Kochi'},
              // –ö—é—Å—é
              {value: 'fukuoka', ru: '–§—É–∫—É–æ–∫–∞', en: 'Fukuoka'},
              {value: 'saga', ru: '–°–∞–≥–∞', en: 'Saga'},
              {value: 'nagasaki', ru: '–ù–∞–≥–∞—Å–∞–∫–∏', en: 'Nagasaki'},
              {value: 'kumamoto', ru: '–ö—É–º–∞–º–æ—Ç–æ', en: 'Kumamoto'},
              {value: 'oita', ru: '–û–∏—Ç–∞', en: 'Oita'},
              {value: 'miyazaki', ru: '–ú–∏—è–¥–∑–∞–∫–∏', en: 'Miyazaki'},
              {value: 'kagoshima', ru: '–ö–∞–≥–æ—Å–∏–º–∞', en: 'Kagoshima'},
              // –û–∫–∏–Ω–∞–≤–∞
              {value: 'okinawa', ru: '–û–∫–∏–Ω–∞–≤–∞', en: 'Okinawa'}
            ];
            
            const categories_ru = ['–°–∏–Ω—Ç–æ–∏—Å—Ç—Å–∫–æ–µ —Å–≤—è—Ç–∏–ª–∏—â–µ', '–ë—É–¥–¥–∏–π—Å–∫–∏–π —Ö—Ä–∞–º', '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±—ä–µ–∫—Ç', '–ú—É–∑–µ–π', '–ê—Ä—Ç-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ / –ì–∞–ª–µ—Ä–µ—è', '–°–º–æ—Ç—Ä–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞', '–õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–π —Å–∞–¥ / –ü–∞—Ä–∫', '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ', '–Ø–ø–æ–Ω—Å–∫–∏–π –æ—Ç–µ–ª—å', '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', '–®–æ–ø–ø–∏–Ω–≥', '–¢–µ—Ä–º–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫', '–°–ü–ê'];
            const categories_en = ['Shinto Shrine', 'Buddhist Temple', 'Architectural Object', 'Museum', 'Art Venue', 'Viewing Spot', 'Park/Garden', 'City Attraction', 'Historical Location', 'Restaurant', 'Amusement', 'Shopping', 'Hot Spring', 'SPA'];
            
            wrap.innerHTML = `
              <div class="absolute inset-0" onclick="this.parentElement.querySelector('#poi_cancel').click()"></div>
              <div class="relative bg-white rounded-xl shadow-2xl p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-lg font-medium text-gray-800">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å POI' : '–ù–æ–≤—ã–π POI'}</h3>
                  <button id="poi_close" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                
                <form id="poi_form" class="space-y-3">
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                    <div class="space-y-3">
                      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2 flex items-center">
                          <i class="fas fa-info-circle mr-1 text-blue-600 text-xs"></i>
                          –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </h4>
                        <div class="grid grid-cols-1 gap-2">
                          <div>
                            <label class="block text-xs font-medium text-gray-700">
                              –ù–∞–∑–≤–∞–Ω–∏–µ (RU) <span class="text-red-500">*</span>
                            </label>
                            <input id="poi_name_ru" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="–ù–∞ —Ä—É—Å—Å–∫–æ–º" required
                                  value="${editData ? editData.name : ''}">
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">
                              Name (EN) <span class="text-red-500">*</span>
                            </label>
                            <input id="poi_name_en" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="In English" required
                                  value="${editData ? editData.name_en || '' : ''}">
                          </div>
                          <div class="grid grid-cols-2 gap-2">
                            <div>
                              <label class="block text-xs font-medium text-gray-700">
                                –ü—Ä–µ—Ñ–µ–∫—Ç—É—Ä–∞ <span class="text-red-500">*</span>
                              </label>
                              <select id="poi_pref_ru" class="input-japanese w-full text-sm py-1" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                                ${prefectures.map(p => `<option value="${p.value}">${p.ru}</option>`).join('')}
                              </select>
                            </div>
                            <div>
                              <label class="block text-xs font-medium text-gray-700">
                                Prefecture <span class="text-red-500">*</span>
                              </label>
                              <select id="poi_pref_en" class="input-japanese w-full text-sm py-1" required>
                                <option value="">Select</option>
                                ${prefectures.map(p => `<option value="${p.value}">${p.en}</option>`).join('')}
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Google –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –∫–æ–Ω—Ç–µ–Ω—Ç -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2">
                          <i class="fab fa-google mr-1 text-blue-600 text-xs"></i>
                          Google & –ö–æ–Ω—Ç–µ–Ω—Ç
                        </h4>
                        <div class="space-y-2">
                          <div>
                            <label class="block text-xs font-medium text-gray-700">Google Place ID</label>
                            <input id="poi_place_id" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="ChIJ..." pattern="^[A-Za-z0-9_-]{25,}$">
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">–°–∞–π—Ç</label>
                            <input id="poi_website" type="url" class="input-japanese w-full text-sm py-1" 
                                  placeholder="https://...">
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã</label>
                            <input id="poi_hours" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="09:00-17:00">
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                    <div class="space-y-3">
                      <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2">
                          <i class="fas fa-tags mr-1 text-purple-600 text-xs"></i>
                          –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ <span class="text-red-500">*</span>
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                          <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">RU</label>
                            <div class="space-y-1 border border-gray-200 rounded p-2 bg-white" style="max-height: 400px; overflow-y: auto;">
                              ${categories_ru.map((cat) => `
                                <label class="flex items-center text-xs hover:bg-gray-50 px-1 py-0.5 rounded cursor-pointer">
                                  <input type="checkbox" name="cats_ru" value="${cat}" class="mr-2">
                                  <span>${cat}</span>
                                </label>
                              `).join('')}
                            </div>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">EN</label>
                            <div class="space-y-1 border border-gray-200 rounded p-2 bg-white" style="max-height: 400px; overflow-y: auto;">
                              ${categories_en.map((cat) => `
                                <label class="flex items-center text-xs hover:bg-gray-50 px-1 py-0.5 rounded cursor-pointer">
                                  <input type="checkbox" name="cats_en" value="${cat}" class="mr-2">
                                  <span>${cat}</span>
                                </label>
                              `).join('')}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- –û–ø–∏—Å–∞–Ω–∏—è -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2">
                          <i class="fas fa-align-left mr-1 text-green-600 text-xs"></i>
                          –û–ø–∏—Å–∞–Ω–∏—è
                        </h4>
                        <div class="space-y-2">
                          <div>
                            <label class="block text-xs font-medium text-gray-700">–û–ø–∏—Å–∞–Ω–∏–µ (RU)</label>
                            <textarea id="poi_desc_ru" class="input-japanese w-full text-sm py-1" rows="3"
                                      placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">Description (EN)</label>
                            <textarea id="poi_desc_en" class="input-japanese w-full text-sm py-1" rows="3"
                                      placeholder="Brief description"></textarea>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- –ë–∏–ª–µ—Ç—ã - –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É -->
                  <div class="bg-gray-50 rounded p-3">
                    <div class="flex items-center justify-between mb-2">
                      <h4 class="text-xs font-medium text-gray-700 flex items-center">
                        <i class="fas fa-ticket-alt mr-1 text-indigo-600 text-xs"></i>
                        –ë–∏–ª–µ—Ç—ã
                        <span class="ml-2 text-xs text-gray-500 font-normal">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ - –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏–π –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º)</span>
                      </h4>
                      <button type="button" id="add-ticket-btn" class="btn-japanese text-xs py-1 px-2">
                        <i class="fas fa-plus mr-1"></i>–î–æ–±–∞–≤–∏—Ç—å –±–∏–ª–µ—Ç
                      </button>
                    </div>
                    <div id="tickets-container" class="space-y-2"></div>
                  </div>
                  
                  <!-- –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∏ –∑–∞–º–µ—Ç–∫–∏ - –≤–Ω–∏–∑—É –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É -->
                  <div class="bg-gray-50 rounded p-3">
                    <div class="flex items-center justify-between">
                      <label class="flex items-center">
                        <input id="poi_published" type="checkbox" class="mr-2">
                        <span class="text-sm text-gray-700">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</span>
                      </label>
                      <div class="flex-1 ml-4">
                        <input id="poi_notes" type="text" class="input-japanese w-full text-sm py-1" 
                              placeholder="–ó–∞–º–µ—Ç–∫–∏ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ)">
                      </div>
                    </div>
                  </div>
                </form>
                
                <div class="mt-4 flex justify-end gap-2">
                  <button id="poi_cancel" class="btn-japanese text-sm py-1 px-3">–û—Ç–º–µ–Ω–∞</button>
                  <button id="poi_save" class="btn-japanese accent text-sm py-1 px-3">
                    <i class="fas fa-save mr-1"></i>
                    ${isEdit ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å'}
                  </button>
                </div>
              </div>
            `;
            
            document.body.appendChild(wrap);
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ñ–µ–∫—Ç—É—Ä RU ‚Üî EN
            const prefRu = wrap.querySelector('#poi_pref_ru');
            const prefEn = wrap.querySelector('#poi_pref_en');
            prefRu.addEventListener('change', () => { prefEn.value = prefRu.value; });
            prefEn.addEventListener('change', () => { prefRu.value = prefEn.value; });
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π RU ‚Üî EN (–ø–∞—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞)
            const catsRu = wrap.querySelectorAll('input[name="cats_ru"]');
            const catsEn = wrap.querySelectorAll('input[name="cats_en"]');
            
            catsRu.forEach((cbRu, index) => {
              cbRu.addEventListener('change', () => {
                if (catsEn[index]) {
                  catsEn[index].checked = cbRu.checked;
                }
              });
            });
            
            catsEn.forEach((cbEn, index) => {
              cbEn.addEventListener('change', () => {
                if (catsRu[index]) {
                  catsRu[index].checked = cbEn.checked;
                }
              });
            });
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–∞–º–∏
            const ticketsContainer = wrap.querySelector('#tickets-container');
            const addTicketBtn = wrap.querySelector('#add-ticket-btn');
            let ticketCounter = 0;
            
            const ticketTypes = [
              {value: 'infant', label: 'Infant 0-5', label_ru: '–ú–ª–∞–¥–µ–Ω–µ—Ü 0-5'},
              {value: 'primary', label: 'Primary School 6-11', label_ru: '–ù–∞—á–∞–ª—å–Ω–∞—è —à–∫–æ–ª–∞ 6-11'},
              {value: 'middle', label: 'Middle School 13-15', label_ru: '–°—Ä–µ–¥–Ω—è—è —à–∫–æ–ª–∞ 13-15'},
              {value: 'adult_16_60', label: 'Adult 16-60', label_ru: '–í–∑—Ä–æ—Å–ª—ã–π 16-60'},
              {value: 'adult_16_64', label: 'Adult 16-64', label_ru: '–í–∑—Ä–æ—Å–ª—ã–π 16-64'},
              {value: 'senior60', label: 'Senior 60+', label_ru: '–ü–æ–∂–∏–ª–æ–π 60+'},
              {value: 'senior65', label: 'Senior 65+', label_ru: '–ü–æ–∂–∏–ª–æ–π 65+'},
              {value: 'general', label: 'General Admission', label_ru: '–û–±—â–∏–π –≤—Ö–æ–¥'}
            ];
            
            function addTicketRow(data = null) {
              const ticketId = ticketCounter++;
              const ticketRow = document.createElement('div');
              ticketRow.className = 'ticket-row bg-white border border-gray-200 rounded p-2 flex items-center gap-2';
              ticketRow.dataset.ticketId = ticketId;
              
              ticketRow.innerHTML = `
                <div class="flex-1 grid grid-cols-3 gap-2">
                  <div>
                    <select class="ticket-type input-japanese w-full text-xs py-1" required>
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                      ${ticketTypes.map(t => `<option value="${t.value}">${t.label_ru} / ${t.label}</option>`).join('')}
                    </select>
                  </div>
                  <div>
                    <input type="number" class="ticket-price input-japanese w-full text-xs py-1" 
                           placeholder="–¶–µ–Ω–∞" min="0" step="100" required>
                  </div>
                  <div class="flex items-center gap-2">
                    <select class="ticket-currency input-japanese w-full text-xs py-1">
                      <option value="JPY">¬• JPY</option>
                      <option value="USD">$ USD</option>
                      <option value="EUR">‚Ç¨ EUR</option>
                    </select>
                    <button type="button" class="remove-ticket text-red-500 hover:text-red-700 p-1" 
                            onclick="this.closest('.ticket-row').remove()">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              `;
              
              ticketsContainer.appendChild(ticketRow);
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
              if (data) {
                ticketRow.querySelector('.ticket-type').value = data.category || '';
                ticketRow.querySelector('.ticket-price').value = data.price || '';
                ticketRow.querySelector('.ticket-currency').value = data.currency || 'JPY';
              }
            }
            
            addTicketBtn.addEventListener('click', () => addTicketRow());
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –±–∏–ª–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            addTicketRow();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            function done(val){ 
              try{ document.body.removeChild(wrap); }catch{} 
              resolve(val||null); 
            }
            
            wrap.querySelector('#poi_close').addEventListener('click', ()=>done(null));
            wrap.querySelector('#poi_cancel').addEventListener('click', ()=>done(null));
            
            wrap.querySelector('#poi_save').addEventListener('click', ()=>{
              const form = wrap.querySelector('#poi_form');
              if (!form.checkValidity()) {
                form.reportValidity();
                return;
              }
              
              const cats_ru = Array.from(wrap.querySelectorAll('input[name="cats_ru"]:checked')).map(cb => cb.value);
              const cats_en = Array.from(wrap.querySelectorAll('input[name="cats_en"]:checked')).map(cb => cb.value);
              
              if (cats_ru.length === 0 || cats_en.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —è–∑—ã–∫–∞');
                return;
              }
              
              // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ –±–∏–ª–µ—Ç–∞—Ö (–ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
              const ticketRows = wrap.querySelectorAll('.ticket-row');
              const tickets = [];
              
              ticketRows.forEach(row => {
                const type = row.querySelector('.ticket-type').value;
                const price = row.querySelector('.ticket-price').value;
                const currency = row.querySelector('.ticket-currency').value;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –±–∏–ª–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —Ç–∏–ø –∏ —Ü–µ–Ω–∞
                if (type && price) {
                  tickets.push({
                    category: type,
                    price: parseInt(price),
                    currency: currency
                  });
                }
              });
              
              // –ë–∏–ª–µ—Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã - –Ω–∏–∫–∞–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
              
              const data = {
                name_ru: wrap.querySelector('#poi_name_ru').value.trim(),
                name_en: wrap.querySelector('#poi_name_en').value.trim(),
                pref_ru: prefRu.value,
                pref_en: prefEn.value,
                cats_ru: cats_ru,
                cats_en: cats_en,
                place_id: wrap.querySelector('#poi_place_id').value.trim(),
                website: wrap.querySelector('#poi_website').value.trim(),
                hours: wrap.querySelector('#poi_hours').value.trim(),
                desc_ru: wrap.querySelector('#poi_desc_ru').value.trim(),
                desc_en: wrap.querySelector('#poi_desc_en').value.trim(),
                published: wrap.querySelector('#poi_published').checked,
                notes: wrap.querySelector('#poi_notes').value.trim(),
                tickets: tickets
              };
              
              done(data);
            });
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
            wrap.querySelector('#poi_name_ru').focus();
            
            // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            if (isEdit && editData) {
              // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—è –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
              if (editData.type) {
                // –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤—ã–±—Ä–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                const typeMap = {
                  '–∫—É–ª—å—Ç—É—Ä–∞': '–ö—É–ª—å—Ç—É—Ä–∞',
                  '–ø—Ä–∏—Ä–æ–¥–∞': '–ü—Ä–∏—Ä–æ–¥–Ω–∞—è –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
                  '–≥–∞—Å—Ç—Ä–æ': '–ì–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è',
                  '—Ö—Ä–∞–º': '–•—Ä–∞–º',
                  '–∑–∞–º–æ–∫': '–ó–∞–º–æ–∫',
                  '–º—É–∑–µ–π': '–ú—É–∑–µ–π'
                };
                const catRu = typeMap[editData.type.toLowerCase()] || editData.type;
                const catCheckbox = wrap.querySelector(`input[name="cats_ru"][value="${catRu}"]`);
                if (catCheckbox) catCheckbox.checked = true;
              }
            }
        });
      }

      // –í—ã–±–æ—Ä —Ç–∏–ø–∞ (–ì–æ—Ä–æ–¥/–õ–æ–∫–∞—Ü–∏—è) ‚Äî –º–æ–¥–∞–ª–∫–∞ —Å 2 –∫–Ω–æ–ø–∫–∞–º–∏
      function chooseCityType(){
        if (level !== 'cities') { return Promise.resolve(null); }
        return new Promise((resolve)=>{
          const wrap = document.createElement('div');
          wrap.className = 'fixed inset-0 z-50 flex items-center justify-center';
          wrap.innerHTML = '\
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
            <div class="relative bg-white rounded-lg shadow-xl p-6 w-80">\
              <div class="text-lg text-gray-800 mb-4">–¢–∏–ø –∑–∞–ø–∏—Å–∏</div>\
              <div class="grid grid-cols-2 gap-3">\
                <button id="btn_type_city" class="btn-japanese w-full text-center">–ì–æ—Ä–æ–¥</button>\
                <button id="btn_type_location" class="btn-japanese w-full text-center">–õ–æ–∫–∞—Ü–∏—è</button>\
              </div>\
              <div class="mt-4 text-xs text-gray-500 text-center">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–ø–∏—Å–∏</div>\
            </div>';
          document.body.appendChild(wrap);
          function done(val){
            document.body.removeChild(wrap);
            resolve(val);
          }
          wrap.querySelector('#btn_type_city').addEventListener('click', function(){ done('city'); });
          wrap.querySelector('#btn_type_location').addEventListener('click', function(){ done('location'); });
          wrap.addEventListener('click', function(e){ if (e.target===wrap.firstChild) { done(null); } });
          document.addEventListener('keydown', function onEsc(ev){ if (ev.key==='Escape'){ document.removeEventListener('keydown', onEsc); try{ document.body.removeChild(wrap); }catch{} resolve(null); } });
        });
      }

      if (fab) fab.addEventListener('click', async function(){
        if (level==='regions'){
          const data = await openCreateRegionModal();
          if (!data) return;
          try{
            const res = await fetch('/api/regions-create.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({ 
                  name_ru: data.ru, 
                  name_en: data.en,
                  base_id: window.AIRTABLE_BASE_ID,
                  table_id: window.AIRTABLE_REGIONS_TABLE_ID
                })
            });
            const j = await res.json().catch(()=>({}));
            if (!res.ok || !j.ok){
              const detailsMsg = (j && (j.details?.error?.message || j.details?.message || j.error)) || ('HTTP '+res.status);
              console.error('REGION_CREATE_ERR', j);
              throw new Error(detailsMsg);
            }
            if (window.osNotify){ window.osNotify('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ','ID: '+j.region_id); } else { alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: '+j.region_id); }
            await syncRegionsFromAirtable();
          }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–≥–∏–æ–Ω: '+(e && e.message ? e.message : '')); }
        } else if (level==='cities'){
          // –º–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ + –≤–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è
          const picked = await chooseCityType(); if (!picked) return;
          const wrap = await new Promise(res=>{
            const w = document.createElement('div');
            w.className='fixed inset-0 z-50 flex items-center justify-center';
            w.innerHTML='\
              <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
              <div class="relative bg-white rounded-lg shadow-xl p-6 w-96">\
                <div class="text-lg text-gray-800 mb-4">'+(picked==='location'?'–ù–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è':'–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥')+'</div>\
                <div class="space-y-3">\
                  <input id="nm_ru" class="input-japanese w-full" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (RU)"/>\
                  <input id="nm_en" class="input-japanese w-full" placeholder="Name (EN)"/>\
                </div>\
                <div class="mt-5 flex justify-end gap-2">\
                  <button id="c" class="btn-japanese">–û—Ç–º–µ–Ω–∞</button>\
                  <button id="o" class="btn-japanese accent">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>\
                </div>\
              </div>';
            document.body.appendChild(w);
            w.querySelector('#c').onclick=()=>{ try{document.body.removeChild(w);}catch{}; res(null); };
            w.querySelector('#o').onclick=()=>{ const ru=w.querySelector('#nm_ru').value.trim(); const en=w.querySelector('#nm_en').value.trim(); if(!ru){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ RU');return;} try{document.body.removeChild(w);}catch{}; res({ru,en}); };
            w.addEventListener('click',e=>{ if(e.target===w.firstChild){ try{document.body.removeChild(w);}catch{}; res(null);} });
          });
          if (!wrap) return; const name_ru = wrap.ru; const name_en = wrap.en || wrap.ru;
          try{
            const res = await fetch('/api/cities-create.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({ 
                  name_ru: name_ru, 
                  name_en: name_en, 
                  type: picked, 
                  region_rec_id: selectedRegion.id, 
                  region_name: selectedRegion.name, 
                  region_rid: (selectedRegion.rid||''),
                  base_id: window.AIRTABLE_BASE_ID,
                  table_id: window.AIRTABLE_CITIES_TABLE_ID
                })
            });
            const j = await res.json();
            if (!res.ok || !j.ok) throw new Error((j && (j.error || j.details?.error?.message)) || ('HTTP '+res.status));
            if (window.osNotify){ window.osNotify('–ì–æ—Ä–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω', (j.linked? '–°–≤—è–∑—å —Å —Ä–µ–≥–∏–æ–Ω–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' : '–°–æ–∑–¥–∞–Ω –±–µ–∑ —Å–≤—è–∑–∏: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ —Å–≤—è–∑–∏')); }
            await loadCitiesForRegion(selectedRegion); await preloadPoisCountsForRegion(selectedRegion); await renderCities();
          }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: '+(e && e.message ? e.message : '')); }
        } else if (level==='pois'){
            const data = await openCreatePOIModal();
            if (!data) return;
            
            try {
              // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –¥–ª—è –Ω–æ–≤–æ–≥–æ POI –≤ —Ñ–æ—Ä–º–∞—Ç–µ POI-00000x
          const list = poisByCity[selectedCity.business_id] || (poisByCity[selectedCity.business_id]=[]);
              const nextNumber = list.length + 1;
              const id = 'POI-' + String(nextNumber).padStart(6, '0');
              
              // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç POI —Å –ø–æ–ª–Ω–æ–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
              const newPoi = {
                id: id,
                name: data.name_ru,
                name_en: data.name_en,
                type: data.cats_ru[0] || '–î—Ä—É–≥–æ–µ', // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–∞–∫ —Ç–∏–ø
                categories_ru: data.cats_ru,
                categories_en: data.cats_en,
                prefecture_ru: data.pref_ru,
                prefecture_en: data.pref_en,
                place_id: data.place_id,
                website: data.website,
                hours: data.hours,
                description_ru: data.desc_ru,
                description_en: data.desc_en,
                published: data.published,
                notes: data.notes,
                city_id: selectedCity.id,
                region_id: selectedRegion.id
              };
              
              // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
              list.push(newPoi);
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ window.airtableReg, –µ—Å–ª–∏ –Ω–µ—Ç - –∑–∞–≥—Ä—É–∂–∞–µ–º
              if (!window.airtableReg) {
                await loadDbConfig();
              }
              
              // –ü–æ–ª—É—á–∞–µ–º base_id –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
              const baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || window.AIRTABLE_BASE_ID;
              
              // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
              console.log('Creating POI with:', {
                baseId: baseId,
                tableId: window.AIRTABLE_POI_TABLE_ID,
                dataExists: !!data,
                constants: {
                  base: window.AIRTABLE_BASE_ID,
                  poi_table: window.AIRTABLE_POI_TABLE_ID
                }
              });
              
              // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Airtable —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
              const airtableFields = {
                'POI ID': id,
                'POI Name (RU)': data.name_ru,
                'POI Name (EN)': data.name_en,
                'Regions': [selectedCity.id], // Link to parental Locations/Cities
                'Prefecture (RU)': data.pref_ru,
                'Prefecture (EN)': data.pref_en,
                'Place ID': data.place_id,
                'POI Category (RU)': data.cats_ru,
                'POI Category (EN)': data.cats_en,
                'Working Hours': data.hours,
                'Website': data.website,
                'Description (RU)': data.desc_ru,
                'Description (EN)': data.desc_en,
                'Published': data.published,
                'Notes': data.notes,
                'Tickets': [] // –ë–∏–ª–µ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Å–≤—è–∑—å —Å —Ç–∞–±–ª–∏—Ü–µ–π Tickets
              };
              
              // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π API
              const res = await fetch('/api/save-poi.php', {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  name_ru: data.name_ru,
                  name_en: data.name_en,
                  prefecture_ru: data.pref_ru,
                  prefecture_en: data.pref_en,
                  categories_ru: data.cats_ru,
                  categories_en: data.cats_en,
                  description_ru: data.desc_ru,
                  description_en: data.desc_en,
                  website: data.website,
                  working_hours: data.hours,
                  notes: data.notes,
                  place_id: data.place_id,
                  city_id: selectedCity.id,
                  region_id: selectedRegion.id
                })
              });
              
              const j = await res.json();
              if (!res.ok || !j.ok) {
                throw new Error((j && j.error) || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
              }
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ ID
              if (j.id) {
                newPoi.id = j.id;
              }
              if (j.business_id) {
                newPoi.business_id = j.business_id;
              }
              
              if (window.osNotify) {
                window.osNotify('POI —Å–æ–∑–¥–∞–Ω', data.name_ru);
              }
              
          await renderPois();
            } catch(e) {
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å POI: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
              // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
              const list = poisByCity[selectedCity.business_id] || [];
              poisByCity[selectedCity.business_id] = list.filter(p => p.id !== id);
              await renderPois();
            }
        } else if (level==='tickets'){
          const category = prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è (Adult/Child/Infant/Senior/Special):','Adult')||'Adult';
          const price = parseInt(prompt('–¶–µ–Ω–∞ (¬•):','1000')||'1000',10)||0;
          const note = prompt('–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:','')||'';
          const list = ticketsByPoi[selectedPoi.id] || (ticketsByPoi[selectedPoi.id]=[]);
          const id = genId('TKT', list.length+1);
          list.push({ id, category, price, currency:'¬•', note });
          renderTickets();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      const syncBtn = document.getElementById('db_fab_sync');
      if (syncBtn) {
        syncBtn.addEventListener('click', async function() {
          this.disabled = true;
          this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          
          try {
            console.log('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Airtable...');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            const currentLevel = level;
            const currentRegion = selectedRegion;
            const currentCity = selectedCity;
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å Airtable (–∏—Å–ø–æ–ª—å–∑—É–µ–º Filtering.md –ø—Ä–∏–Ω—Ü–∏–ø—ã)
            const syncRes = await fetch('/api/sync-airtable-filtering.php', {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' }
            });
            const syncData = await syncRes.json();
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', syncData);
            
            // –û—á–∏—â–∞–µ–º –∫—ç—à –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            if (syncData.ok) {
              clearAllCache();
              console.log('–ö—ç—à –æ—á–∏—â–µ–Ω –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
            }
            
            if (currentLevel === 'cities' && currentRegion) {
              console.log(`üìç –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ—Ä–æ–¥–∞ –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞: ${currentRegion.name}`);
              
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –ë–î
              await loadCitiesForRegion(currentRegion, true);
              
              // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º POI –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –≤ –ø–∏–ª—é–ª—è—Ö
              const cities = citiesByRegion[currentRegion.business_id] || [];
              for (const city of cities) {
                await loadPoisForCity(city, true);
              }
              
              // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
              selectedRegion = currentRegion;
              await renderCities();
              console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${cities.length} –≥–æ—Ä–æ–¥–æ–≤`);
              
            } else if (currentLevel === 'pois' && currentCity) {
              console.log(`üìç –û–±–Ω–æ–≤–ª—è–µ–º POI –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${currentCity.name}`);
              
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º POI –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –ë–î
              await loadPoisForCity(currentCity, true);
              
              // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
              selectedRegion = currentRegion;
              selectedCity = currentCity;
              await renderPois();
              
              const poiCount = poisByCity[currentCity.id]?.length || 0;
              console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ POI –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${poiCount} POI`);
              
            } else {
              console.log('üåç –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö...');
              
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –ë–î
              await syncRegionsFromAirtable();
              console.log(`‚úÖ –†–µ–≥–∏–æ–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${regions.length}`);
              
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
              for (const region of regions) {
                await loadCitiesForRegion(region, true);
                const cities = citiesByRegion[region.business_id] || [];
                console.log(`‚úÖ –ì–æ—Ä–æ–¥–∞ –¥–ª—è ${region.name}: ${cities.length}`);
              }
              
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º POI –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤
              let totalPOI = 0;
              for (const region of regions) {
                const cities = citiesByRegion[region.business_id] || [];
                for (const city of cities) {
                  await loadPoisForCity(city, true);
                  const poiCount = poisByCity[city.business_id]?.length || 0;
                  totalPOI += poiCount;
                }
              }
              
              // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
              if (currentLevel === 'cities' && currentRegion) {
                selectedRegion = currentRegion;
                await renderCities();
              } else if (currentLevel === 'pois' && currentCity && currentRegion) {
                selectedRegion = currentRegion;
                selectedCity = currentCity;
                await renderPois();
              } else {
                renderRegions();
              }
              console.log(`‚úÖ –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${totalPOI} POI –≤—Å–µ–≥–æ`);
            }
            
            // –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
            this.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
              this.innerHTML = '<i class="fas fa-sync-alt"></i>';
            }, 2000);
            
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
            this.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            setTimeout(() => {
              this.innerHTML = '<i class="fas fa-sync-alt"></i>';
            }, 3000);
          } finally {
            this.disabled = false;
          }
        });
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      window.checkDataFreshness = async function() {
        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö...');
        
        try {
          // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ Airtable
          const res = await fetch('/api/db-sync.php?v=' + Date.now(), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              scope: 'pois', 
              action: 'list', 
              data: { 
                filter: {},
                limit: 1 // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
              } 
            })
          });
          
          const j = await res.json();
          if (j.ok && j.items && j.items.length > 0) {
            const lastRecord = j.items[0];
            const lastModified = lastRecord.createdTime || lastRecord.fields?.LastModified || Date.now();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à
            const cacheTime = localStorage.getItem('konstructour_last_sync');
            const shouldRefresh = !cacheTime || (Date.now() - parseInt(cacheTime)) > (30 * 60 * 1000); // 30 –º–∏–Ω—É—Ç
            
            if (shouldRefresh) {
              console.log('–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏, –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à...');
              clearAllCache();
              localStorage.setItem('konstructour_last_sync', Date.now().toString());
              
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
              await syncRegionsFromAirtable();
              for (const region of regions) {
                await loadCitiesForRegion(region);
                const cities = citiesByRegion[region.business_id] || [];
                for (const city of cities) {
                  await loadPoisForCity(city);
                }
              }
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
              if (level === 'regions') {
                renderRegions();
              } else if (level === 'cities' && selectedRegion) {
                await renderCities();
              } else if (level === 'pois' && selectedCity) {
                await renderPois();
              }
              
              console.log('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
            } else {
              console.log('–î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à');
            }
          }
        } catch (error) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:', error);
        }
      };

      // –ü–æ–ª—è –≤–≤–æ–¥–∞ –∏ –∏–∫–æ–Ω–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã, –±–∏–Ω–¥—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è

      // History: handle back/forward
      window.addEventListener('popstate', async function(ev){ await renderFromState(ev.state); });
      // Initial state
      history.replaceState({ level: 'regions' }, '');
      
      // –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–ª–∏–∫–æ–≤
      console.log('Testing click handler...');
      setTimeout(() => {
        console.log('Click handler test - simulating click on document');
        const testEvent = new MouseEvent('click', { bubbles: true });
        document.dispatchEvent(testEvent);
      }, 1000);
      
      // –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –∑–∞–≥—Ä—É–∑–∫–∞ - —Å–Ω–∞—á–∞–ª–∞ –∫—ç—à, –ø–æ—Ç–æ–º API
      (async function(){
        console.log('‚ö° –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...');
        console.log('‚ö° DOM —ç–ª–µ–º–µ–Ω—Ç cards:', cards);
        console.log('‚ö° DOM —ç–ª–µ–º–µ–Ω—Ç crumbs:', crumbs);
        
        // –®–ê–ì 1: –ú–ì–ù–û–í–ï–ù–ù–û –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –∫—ç—à–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
        console.log('‚ö° –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ localStorage...');
        console.log('‚ö° LS_REGIONS_KEY:', LS_REGIONS_KEY);
        const cacheData = localStorage.getItem(LS_REGIONS_KEY);
        console.log('‚ö° –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞:', cacheData ? cacheData.substring(0, 100) + '...' : 'null');
        
        const cachedRegions = loadRegionsCache();
        console.log('‚ö° –ü–æ—Å–ª–µ loadRegionsCache():', cachedRegions);
        console.log('‚ö° cachedRegions.length:', cachedRegions ? cachedRegions.length : 'null/undefined');
        
        if (cachedRegions && cachedRegions.length > 0) {
          console.log('‚úÖ –ú–ì–ù–û–í–ï–ù–ù–û: –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –∫—ç—à–∞:', cachedRegions.length, '—Ä–µ–≥–∏–æ–Ω–æ–≤');
          regions = cachedRegions;
          console.log('‚úÖ regions –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞, –¥–ª–∏–Ω–∞:', regions.length);
          renderRegions(); // –ú–ì–ù–û–í–ï–ù–ù–´–ô —Ä–µ–Ω–¥–µ—Ä –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          console.log('‚úÖ –ú–ì–ù–û–í–ï–ù–ù–´–ô —Ä–µ–Ω–¥–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω!');
        } else {
          console.log('‚ö†Ô∏è –ö—ç—à –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, —Ä–µ–Ω–¥–µ—Ä–∏–º loading state');
          console.log('‚ö†Ô∏è –ü—Ä–∏—á–∏–Ω–∞: cachedRegions =', cachedRegions);
          cards.innerHTML = '<div class="flex items-center justify-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i><span class="ml-3 text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤...</span></div>';
        }
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å—Ä–∞–∑—É
        setupUnifiedClickHandler();
        setupBreadcrumbHandler();
        
        // –®–ê–ì 2: –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API –≤ –§–û–ù–ï
        try {
          console.log('üîÑ –§–û–ù–û–í–ê–Ø –∑–∞–≥—Ä—É–∑–∫–∞: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ë–î...');
          await syncRegionsFromAirtable(); // –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–≤–∞–µ—Ç
          
          console.log('‚ö° –ü–æ—Å–ª–µ syncRegionsFromAirtable: regions.length =', regions.length);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–∑–∞
          if (regions.length > 0) {
            saveRegionsCache(regions);
            console.log('‚úÖ –°–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫—ç—à');
          }
          
          if (!regions.length) {
            console.log('‚ö†Ô∏è –†–µ–≥–∏–æ–Ω—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ë–î, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ proxy...');
            await loadRegionsViaProxy();
          }
          
          if (!regions.length && !cachedRegions.length) {
            console.log('‚ö†Ô∏è –†–µ–≥–∏–æ–Ω—ã –≤—Å–µ –µ—â–µ –ø—É—Å—Ç—ã, —Ä–µ–Ω–¥–µ—Ä–∏–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
            renderRegions();
            return;
          }
          
          console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ (—Ä–µ–≥–∏–æ–Ω—ã:', regions.length, ')');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:', error);
          console.error('‚ùå Error stack:', error.stack);
          // –ï—Å–ª–∏ –µ—Å—Ç—å –∫—ç—à - –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          if (!cachedRegions || cachedRegions.length === 0) {
          renderRegions();
          }
        }
        
        console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        console.log('‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: regions.length =', regions.length);
      })();

      // Deploy button placeholder removed per requirements
    })();
      // –£–¥–∞–ª—ë–Ω legacy-—Å–ø–∏—Å–æ–∫ ¬´–ö–∞—Ç–∞–ª–æ–≥ —Ä–µ–≥–∏–æ–Ω–æ–≤¬ª (—Ç–∞–±–ª–∏—á–Ω—ã–π)

    // –ö–∞—Ç–∞–ª–æ–≥ –≥–æ—Ä–æ–¥–æ–≤/–ª–æ–∫–∞—Ü–∏–π ‚Äî UI-–∑–∞–≥–ª—É—à–∫–∞ –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ —Ä–µ–∞–ª—å–Ω—ã–º API
    (function(){
      const table = document.getElementById('cities_table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const addBtn = document.getElementById('cities_add');

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–≥–∏–æ–Ω—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –≤—ã—à–µ –∫–∞–∫ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
      function getRegionList(){
        const rows = document.querySelectorAll('#regions_table tbody tr');
        const list = [];
        rows.forEach(r=>{
          const id = r.querySelector('td:nth-child(1)')?.textContent?.trim();
          const name = r.querySelector('td:nth-child(2)')?.textContent?.trim();
          if (id && name && !id.startsWith('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')) list.push({id,name});
        });
        return list;
      }

      let items = [];

      function generateId(){
        const n = items.length + 1;
        return 'CL-' + String(n).padStart(4, '0');
      }

      function render(){
        tbody.innerHTML = '';
        if (items.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.className = 'px-4 py-4 text-gray-500';
          td.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å—å.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        items.forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-gray-800">${it.id}</td>
            <td class="px-4 py-2 text-gray-800">${it.name}</td>
            <td class="px-4 py-2 text-gray-800">${it.regionName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.type}</td>
            <td class="px-4 py-2 text-gray-800">${it.coords || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.parentCity || ''}</td>
            <td class="px-4 py-2 text-right">
              <button data-action="edit" data-id="${it.id}" class="text-xs text-gray-700 hover:text-gray-900 mr-3"><i class="fas fa-pen mr-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button data-action="delete" data-id="${it.id}" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      function addOne(){
        const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ (–≥–æ—Ä–æ–¥/–ª–æ–∫–∞—Ü–∏—è):');
        if (!name) return;
        const type = prompt('–¢–∏–ø –∑–∞–ø–∏—Å–∏ (–ì–æ—Ä–æ–¥|–õ–æ–∫–∞—Ü–∏—è):', '–ì–æ—Ä–æ–¥');
        if (!type) return;
        let parentCity = '';
        if (type.trim().toLowerCase() === '–ª–æ–∫–∞—Ü–∏—è'){
          parentCity = prompt('–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –≥–æ—Ä–æ–¥:') || '';
        }
        const coords = prompt('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 35.6895,139.6917):') || '';
        const r = getRegionList();
        let regionName = '';
        if (r.length){
          const names = r.map(x=>x.name).join(', ');
          const picked = prompt('–†–µ–≥–∏–æ–Ω ('+names+'):') || '';
          const found = r.find(x=>x.name===picked.trim());
          regionName = found ? found.name : (r[0]?.name || '');
        }
        items.push({ id: generateId(), name: name.trim(), type: (type||'').trim(), parentCity: parentCity.trim(), coords: coords.trim(), regionName });
        render();
      }

      tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'delete'){
          items = items.filter(r=>r.id !== id);
          render();
        } else if (action === 'edit'){
          const it = items.find(x=>x.business_id===id);
          if (!it) return;
          const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', it.name) || it.name;
          const newType = prompt('–¢–∏–ø –∑–∞–ø–∏—Å–∏ (–ì–æ—Ä–æ–¥|–õ–æ–∫–∞—Ü–∏—è):', it.type) || it.type;
          const newCoords = prompt('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', it.coords) || it.coords;
          let newParent = it.parentCity;
          if ((newType||'').trim().toLowerCase()==='–ª–æ–∫–∞—Ü–∏—è'){
            newParent = prompt('–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –≥–æ—Ä–æ–¥:', it.parentCity||'') || it.parentCity || '';
          } else {
            newParent = '';
          }
          it.name = newName.trim();
          it.type = newType.trim();
          it.coords = newCoords.trim();
          it.parentCity = newParent.trim();
          render();
        }
      });

      addBtn && addBtn.addEventListener('click', addOne);

      render();
    })();

    // POIs ‚Äî UI-–∑–∞–≥–ª—É—à–∫–∞ (—Å –±–∏–ª–µ—Ç—ã –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞)
    (function(){
      const table = document.getElementById('pois_table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const addBtn = document.getElementById('pois_add');
      const ticketsTitle = document.getElementById('poi_tickets_title');
      const ticketsTable = document.getElementById('tickets_table');
      const ticketsTbody = ticketsTable ? ticketsTable.querySelector('tbody') : null;
      const ticketsAddBtn = document.getElementById('tickets_add');

      function getCities(){
        const rows = document.querySelectorAll('#cities_table tbody tr');
        const list = [];
        rows.forEach(r=>{
          const id = r.querySelector('td:nth-child(1)')?.textContent?.trim();
          const name = r.querySelector('td:nth-child(2)')?.textContent?.trim();
          const region = r.querySelector('td:nth-child(3)')?.textContent?.trim();
          if (id && name && !id.startsWith('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')) list.push({id,name,region});
        });
        return list;
      }

      let items = [];
      let selectedPoiId = '';

      function genId(){ return 'POI-' + String(items.length+1).padStart(4,'0'); }

      function render(){
        tbody.innerHTML = '';
        if (items.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.className = 'px-4 py-4 text-gray-500';
          td.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ POI.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          updateTicketsPanel();
          return;
        }
        items.forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-gray-800">${it.id}</td>
            <td class="px-4 py-2 text-gray-800">${it.name}</td>
            <td class="px-4 py-2 text-gray-800">${it.cityName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.regionName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.type || ''}</td>
            <td class="px-4 py-2 text-gray-800">${(it.tickets||[]).length}</td>
            <td class="px-4 py-2 text-right">
              <button data-action="tickets" data-id="${it.id}" class="text-xs text-indigo-600 hover:text-indigo-800 mr-3"><i class="fas fa-ticket mr-1"></i>–ë–∏–ª–µ—Ç—ã</button>
              <button data-action="edit" data-id="${it.id}" class="text-xs text-gray-700 hover:text-gray-900 mr-3"><i class="fas fa-pen mr-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button data-action="delete" data-id="${it.id}" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å</button>
            </td>`;
          tbody.appendChild(tr);
        });
        updateTicketsPanel();
      }

      function addOne(){
        const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ POI:');
        if (!name) return;
        const type = prompt('–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ (–∫—É–ª—å—Ç—É—Ä–∞, –ø—Ä–∏—Ä–æ–¥–∞, –≥–∞—Å—Ç—Ä–æ, ‚Ä¶):', '–∫—É–ª—å—Ç—É—Ä–∞') || '';
        const cities = getCities();
        let cityName = '';
        let regionName = '';
        if (cities.length){
          const names = cities.map(x=>x.name).join(', ');
          const picked = prompt('–ì–æ—Ä–æ–¥/–õ–æ–∫–∞—Ü–∏—è ('+names+'):') || '';
          const found = cities.find(x=>x.name===picked.trim());
          cityName = found ? found.name : (cities[0]?.name || '');
          regionName = found ? (found.region || '') : (cities[0]?.region || '');
        }
        items.push({ id: genId(), name: name.trim(), type: type.trim(), cityName, regionName, tickets: []});
        render();
      }

      tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'delete'){
          items = items.filter(r=>r.id !== id);
          if (selectedPoiId === id) selectedPoiId = '';
          render();
        } else if (action === 'edit'){
          const it = items.find(x=>x.business_id===id);
          if (!it) return;
          const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', it.name) || it.name;
          const newType = prompt('–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:', it.type) || it.type;
          it.name = newName.trim();
          it.type = newType.trim();
          render();
        } else if (action === 'tickets'){
          selectedPoiId = id;
          updateTicketsPanel();
        }
      });

      addBtn && addBtn.addEventListener('click', addOne);

      // –ë–∏–ª–µ—Ç—ã –≤–Ω—É—Ç—Ä–∏ POI
      let tickets = {};// { poiId: [ {id,category,price,currency,note} ] }
      function ensureArr(poiId){ if (!tickets[poiId]) tickets[poiId] = []; return tickets[poiId]; }

      function updateTicketsPanel(){
        if (!ticketsTbody || !ticketsTitle) return;
        const poi = items.find(x=>x.business_id===selectedPoiId);
        ticketsTitle.textContent = poi ? poi.name : '‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî';
        const list = poi ? ensureArr(poi.business_id) : [];
        ticketsTbody.innerHTML = '';
        if (!poi){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className='px-4 py-4 text-gray-500';
          td.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ POI (–∫–Ω–æ–ø–∫–∞ ¬´–ë–∏–ª–µ—Ç—ã¬ª)';
          tr.appendChild(td); ticketsTbody.appendChild(tr); return;
        }
        if (list.length===0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className='px-4 py-4 text-gray-500';
          td.textContent = '–ù–µ—Ç –±–∏–ª–µ—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –±–∏–ª–µ—Ç.';
          tr.appendChild(td); ticketsTbody.appendChild(tr); return;
        }
        list.forEach((t, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class=\"px-4 py-2 text-gray-800\">${t.id}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.category}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.price}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.currency}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.note||''}</td>
            <td class=\"px-4 py-2 text-right\">\n              <button data-action=\"t-edit\" data-id=\"${t.id}\" class=\"text-xs text-gray-700 hover:text-gray-900 mr-3\"><i class=\"fas fa-pen mr-1\"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>\n              <button data-action=\"t-delete\" data-id=\"${t.id}\" class=\"text-xs text-red-600 hover:text-red-800\"><i class="fas fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å</button>
            </td>`;
          ticketsTbody.appendChild(tr);
        });
      }

      function genTicketId(poiId){
        const n = ensureArr(poiId).length + 1;
        return poiId.replace('POI-','TKT-') + '-' + String(n).padStart(2,'0');
        }

      ticketsAddBtn && ticketsAddBtn.addEventListener('click', function(){
        if (!selectedPoiId) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POI (–∫–Ω–æ–ø–∫–∞ ¬´–ë–∏–ª–µ—Ç—ã¬ª).'); return; }
        const category = prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è (Adult / Child / Infant / Senior / Special):', 'Adult') || 'Adult';
        const priceStr = prompt('–¶–µ–Ω–∞ (¬•):', '1000') || '0';
        const price = parseInt(priceStr, 10) || 0;
        const currency = '¬•';
        const note = prompt('–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:', '') || '';
        const arr = ensureArr(selectedPoiId);
        arr.push({ id: genTicketId(selectedPoiId), category, price, currency, note });
        updateTicketsPanel();
      });

      ticketsTbody && ticketsTbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn || !selectedPoiId) return;
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        const arr = ensureArr(selectedPoiId);
        if (action==='t-delete'){
          const idx = arr.findIndex(x=>x.business_id===id);
          if (idx>=0){ arr.splice(idx,1); updateTicketsPanel(); }
        } else if (action==='t-edit'){
          const t = arr.find(x=>x.business_id===id); if (!t) return;
          const newCategory = prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è:', t.category) || t.category;
          const newPriceStr = prompt('–¶–µ–Ω–∞ (¬•):', String(t.price)) || String(t.price);
          const newNote = prompt('–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:', t.note||'') || t.note;
          t.category = newCategory.trim();
          t.price = parseInt(newPriceStr, 10) || t.price;
          t.note = newNote.trim();
          updateTicketsPanel();
        }
      });

      render();
    })();
    </script>
  </body>
</html>


