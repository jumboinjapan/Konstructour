<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Konstructour — Базы данных</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../styles/admin-japanese.css" rel="stylesheet">
    <style>
      body{ background: rgb(var(--color-washi)); min-height:100vh; }
      .tab{ padding:14px 20px; font-size:16px; border-radius:10px; cursor:pointer; flex:1 1 0%; text-align:center; }
      .tab.active{ background:#fff; border:1px solid rgba(139,90,43,.15); }
      .tab-content{ display:none; }
      .tab-content.active{ display:block; }
      
      /* Плавная анимация появления карточек */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .fade-in {
        animation: fadeInUp 0.4s ease-out forwards;
        opacity: 0;
      }
      
      .region-count-badge {
        animation: fadeInUp 0.3s ease-out forwards;
        opacity: 0;
      }
      /* Fixed sizes to keep API action row stable */
      .api-select{ width: 180px; }
      .api-base-label{ display:inline-block; width: 120px; }
      .api-base-input{ width: 280px; }
      .api-table-label{ display:inline-block; width: 140px; }
      .api-table-input{ width: 220px; }
      
      /* Дополнительные цвета для категорий POI */
      .text-brown-600 { color: #8B4513; }
      
      /* Стили для POI карточек */
      .poi-card {
        position: relative;
        transform: translateY(0);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .poi-card:hover {
        transform: translateY(-4px);
      }
      
      .poi-card:active {
        transform: translateY(-2px);
      }
      
      /* Анимация появления карточек */
      .poi-card {
        animation: fadeInCard 0.4s ease-out forwards;
        opacity: 0;
      }
      
      @keyframes fadeInCard {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* Задержка анимации для каждой карточки */
      .poi-card:nth-child(1) { animation-delay: 0.05s; }
      .poi-card:nth-child(2) { animation-delay: 0.1s; }
      .poi-card:nth-child(3) { animation-delay: 0.15s; }
      .poi-card:nth-child(4) { animation-delay: 0.2s; }
      .poi-card:nth-child(5) { animation-delay: 0.25s; }
      .poi-card:nth-child(6) { animation-delay: 0.3s; }
      .poi-card:nth-child(n+7) { animation-delay: 0.35s; }
      
      /* Стили для фильтров */
      #poi-search-input:focus,
      #poi-category-filter:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }
      
      /* Плавная анимация для счетчика */
      #poi-count-label {
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body data-no-redirect="true">
    <div class="dashboard-grid">
      <aside class="sidebar texture-wood">
        <div class="p-6">
          <div class="flex items-center mb-8">
            <div class="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center mr-3">
              <svg class="w-8 h-8 text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
            </div>
            <div>
              <h1 class="text-xl font-light text-gray-800">Konstructour</h1>
              <p class="text-xs text-gray-600">Site Admin</p>
            </div>
          </div>
          <nav class="space-y-2">
            <a href="dashboard.html" class="sidebar-link"><i class="fas fa-th-large mr-3 text-indigo-600"></i>Обзор</a>
            <a href="api-catalog.html" class="sidebar-link"><i class="fas fa-list mr-3 text-gray-600"></i>Каталог API</a>
            <a href="databases.html" class="menu-item active sidebar-link"><i class="fas fa-database mr-3 text-green-600"></i>Базы данных</a>
            <a href="health-dashboard.html" class="sidebar-link"><i class="fas fa-heartbeat mr-3 text-red-600"></i>Health Dashboard</a>
          </nav>
        </div>
      </aside>
      <main class="p-8">
        <header class="mb-6">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h2 class="text-3xl font-light text-gray-800 mb-1">Базы данных</h2>
              <p class="text-gray-600">Выберите базу и управляйте данными через интеграции API</p>
            </div>
            <div class="flex items-center gap-3">
              <button id="clear-cache-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2" title="Очистить кэш">
                <i class="fas fa-trash"></i>
                <span>Очистить кэш</span>
              </button>
            </div>
          </div>
        </header>

        <div class="glass-panel p-8 rounded-lg mb-6">
          <div class="flex items-center gap-3">
            <button class="tab active" data-tab="regions"><i class="fas fa-globe-asia mr-2 text-blue-600"></i>Регионы</button>
            <button class="tab" data-tab="tours"><i class="fas fa-route mr-2 text-green-600"></i>Туры</button>
            <button class="tab" data-tab="templates"><i class="fas fa-layer-group mr-2 text-purple-600"></i>Шаблоны</button>
          </div>
        </div>

        <!-- Регионы (иерархия карточек) -->
        <section id="tab-regions" class="tab-content active">
          <div class="glass-panel p-6 rounded-lg relative">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-globe-asia mr-2 text-blue-600"></i>Регионы</h3>
            </div>

            <!-- Хлебные крошки -->
            <div class="mb-4 -mt-1">
              <div id="db_breadcrumbs" class="flex items-center flex-wrap text-base text-gray-600"></div>
            </div>

            <!-- Контейнер карточек уровня (динамически) -->
            <div id="db_cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

            <!-- Кнопки управления под сеткой -->
            <div class="mt-6 flex justify-center gap-4">
              <button id="db_fab_add" class="btn-japanese rounded-full w-12 h-12 flex items-center justify-center shadow-lg" title="Добавить">
                <i class="fas fa-plus"></i>
              </button>
              <button id="db_fab_sync" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg transition-colors" title="Синхронизировать с Airtable">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>
        </section>

        <!-- Туры -->
        <section id="tab-tours" class="tab-content">
          <div class="glass-panel p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-route mr-2 text-green-600"></i>Туры</h3>
            </div>
            <div id="tours_schema" class="text-sm text-gray-600">
              Структура берётся из Project Description.md. Настройка схемы будет подключена.
            </div>
            <div class="mt-4">
              <div class="text-xs text-gray-500 mb-2">Предпросмотр данных</div>
              <div id="tours_preview" class="japanese-table w-full rounded-lg overflow-hidden">
                <div class="p-4 text-gray-500">Нет данных. Нажмите «Синхронизировать».</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Шаблоны -->
        <section id="tab-templates" class="tab-content">
          <div class="glass-panel p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-layer-group mr-2 text-purple-600"></i>Шаблоны</h3>
            </div>
            <div id="templates_schema" class="text-sm text-gray-600">
              Структура настраивается индивидуально.
            </div>
            <div class="mt-4">
              <div class="text-xs text-gray-500 mb-2">Предпросмотр данных</div>
              <div id="templates_preview" class="japanese-table w-full rounded-lg overflow-hidden">
                <div class="p-4 text-gray-500">Нет данных. Нажмите «Синхронизировать».</div>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>

    <script>
      // Airtable table IDs - определяем глобально в самом начале
      window.AIRTABLE_BASE_ID = 'apppwhjFN82N9zNqm';
      window.AIRTABLE_COUNTRY_TABLE_ID = 'tble0eh9mstZeBKxM';
      window.AIRTABLE_REGIONS_TABLE_ID = 'tblbSajWkzI8X7M4U';
      window.AIRTABLE_CITIES_TABLE_ID = 'tblHaHc9NV0mA8bSa';
      window.AIRTABLE_POI_TABLE_ID = 'tblVCmFcHRpXUT24y';
      window.AIRTABLE_TICKETS_TABLE_ID = 'tblKOLhiHMihpWsVl';
      
      
      // Локальная фильтрация по DOM карточкам
      window.getLocalRegionIds = function() {
        const regionCards = document.querySelectorAll('[data-go="cities"]');
        const regions = [];
        
        // Правильные названия регионов из кода
        const regionNames = ['Хоккайдо', 'Тохоку', 'Канто', 'Тюбу', 'Кансай', 'Тюгоку', 'Сикоку', 'Кюсю', 'Окинава'];
        
        regionCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const ridElement = card.querySelector('.text-xs');
          
          // Используем правильное название региона
          const correctName = regionNames[idx] || `Регион ${idx+1}`;
          
          regions.push({
            id: id || `recREG${String(idx+1).padStart(3,'0')}`,
            name: nameElement ? nameElement.textContent.trim() : correctName,
            rid: ridElement ? ridElement.textContent.trim() : `REG-${String(idx+1).padStart(3,'0')}`,
            element: card
          });
        });
        
        console.log('Локальные ID регионов:', regions);
        return regions;
      };

      window.getLocalCityIds = function(regionId) {
        // Находим все карточки городов для конкретного региона
        const cityCards = document.querySelectorAll('[data-go="pois"]');
        const cities = [];
        
        cityCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const codeElement = card.querySelector('.text-xs');
          
          cities.push({
            id: id || `recCITY${String(idx+1).padStart(3,'0')}`,
            name: nameElement ? nameElement.textContent.trim() : `Город ${idx+1}`,
            code: codeElement ? codeElement.textContent.trim() : `CTY-${String(idx+1).padStart(3,'0')}`,
            element: card
          });
        });
        
        console.log(`Локальные ID городов для региона ${regionId}:`, cities);
        return cities;
      };

      window.getLocalPoiIds = function(cityId) {
        // Находим все карточки POI для конкретного города
        const poiCards = document.querySelectorAll('[data-go="poi-details"]');
        const pois = [];
        
        poiCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const poiIdElement = card.querySelector('.text-xs');
          
          pois.push({
            id: id || `recPOI${String(idx+1).padStart(3,'0')}`,
            name: nameElement ? nameElement.textContent.trim() : `POI ${idx+1}`,
            poi_id: poiIdElement ? poiIdElement.textContent.trim() : `POI-${String(idx+1).padStart(3,'0')}`,
            element: card
          });
        });
        
        console.log(`Локальные ID POI для города ${cityId}:`, pois);
        return pois;
      };

      // Функция для получения ID регионов из Airtable
      window.getRegionIds = async function() {
        try {
          const baseId = window.AIRTABLE_BASE_ID;
          const regTbl = window.AIRTABLE_REGIONS_TABLE_ID;
          const url = `/api/test-proxy.php?provider=airtable&base_id=${encodeURIComponent(baseId)}&table=${encodeURIComponent(regTbl)}`;
          
          console.log('Загружаем ID регионов из Airtable...');
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.ok && data.body && data.body.records) {
            console.log('=== ID РЕГИОНОВ ИЗ AIRTABLE ===');
            data.body.records.forEach((record, idx) => {
              const fields = record.fields || {};
              const name = fields['Name (RU)'] || fields['Название (RU)'] || fields['Name'] || fields['Название'] || `Регион ${idx + 1}`;
              const rid = fields['Идентификатор'] || fields['Region ID'] || fields['ID'] || fields['Регион ID'] || '';
              
              console.log(`${name}:`, {
                id: record.id,
                name: name,
                rid: rid || 'нет',
                fields: Object.keys(fields)
              });
            });
            console.log('=== КОНЕЦ СПИСКА ID РЕГИОНОВ ===');
            return data.body.records;
          } else {
            console.error('Ошибка загрузки регионов:', data);
            return [];
          }
        } catch (error) {
          console.error('Ошибка при загрузке ID регионов:', error);
          return [];
        }
      };

      // Функция для получения ID городов из Airtable
      window.getCityIds = async function(regionId) {
        try {
          const baseId = window.AIRTABLE_BASE_ID;
          const cityTbl = window.AIRTABLE_CITIES_TABLE_ID;
          const url = `/api/test-proxy.php?provider=airtable&base_id=${encodeURIComponent(baseId)}&table=${encodeURIComponent(cityTbl)}`;
          
          console.log(`Загружаем ID городов для региона ${regionId}...`);
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.ok && data.body && data.body.records) {
            console.log('=== ID ГОРОДОВ ИЗ AIRTABLE ===');
            data.body.records.forEach((record, idx) => {
              const fields = record.fields || {};
              const name = fields['Name (RU)'] || fields['Название (RU)'] || fields['Name'] || fields['Название'] || `Город ${idx + 1}`;
              const rid = fields['Идентификатор'] || fields['City ID'] || fields['ID'] || fields['Город ID'] || '';
              const regions = fields['Regions'] || fields['Регионы'] || fields['Region'] || fields['Регион'] || [];
              
              console.log(`${name}:`, {
                id: record.id,
                name: name,
                rid: rid || 'нет',
                regions: regions,
                fields: Object.keys(fields)
              });
            });
            console.log('=== КОНЕЦ СПИСКА ID ГОРОДОВ ===');
            return data.body.records;
          } else {
            console.error('Ошибка загрузки городов:', data);
            return [];
          }
        } catch (error) {
          console.error('Ошибка при загрузке ID городов:', error);
          return [];
        }
      };

      // Функция для получения ID POI из Airtable
      window.getPoiIds = async function() {
        try {
          const baseId = window.AIRTABLE_BASE_ID;
          const poiTbl = window.AIRTABLE_POI_TABLE_ID;
          const url = `/api/test-proxy.php?provider=airtable&base_id=${encodeURIComponent(baseId)}&table=${encodeURIComponent(poiTbl)}`;
          
          console.log('Загружаем ID POI из Airtable...');
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.ok && data.body && data.body.records) {
            console.log('=== ID POI ИЗ AIRTABLE ===');
            data.body.records.forEach((record, idx) => {
              const fields = record.fields || {};
              const name = fields['POI Name (RU)'] || fields['Название (RU)'] || fields['POI Name (EN)'] || fields['Name'] || `POI ${idx + 1}`;
              const rid = fields['Идентификатор'] || fields['POI ID'] || fields['ID'] || fields['POI ID'] || '';
              const cities = fields['City'] || fields['Город'] || fields['Cities'] || fields['Города'] || [];
              const regions = fields['Regions'] || fields['Регионы'] || fields['Region'] || fields['Регион'] || [];
              
              console.log(`${name}:`, {
                id: record.id,
                name: name,
                rid: rid || 'нет',
                cities: cities,
                regions: regions,
                fields: Object.keys(fields)
              });
            });
            console.log('=== КОНЕЦ СПИСКА ID POI ===');
            return data.body.records;
          } else {
            console.error('Ошибка загрузки POI:', data);
            return [];
          }
        } catch (error) {
          console.error('Ошибка при загрузке ID POI:', error);
          return [];
        }
      };

      // Функция для отображения всех ID в системе
      window.showAllIds = function() {
        console.log('=== ВСЕ ID В СИСТЕМЕ ===');
        console.log('Base ID:', window.AIRTABLE_BASE_ID);
        console.log('Regions Table ID:', window.AIRTABLE_REGIONS_TABLE_ID);
        console.log('Cities Table ID:', window.AIRTABLE_CITIES_TABLE_ID);
        console.log('POI Table ID:', window.AIRTABLE_POI_TABLE_ID);
        console.log('Tickets Table ID:', window.AIRTABLE_TICKETS_TABLE_ID);
        
        console.log('\n=== РЕГИОНЫ ===');
        if (window.regions) {
          window.regions.forEach((region, idx) => {
            console.log(`Регион ${idx + 1}:`, {
              id: region.id,
              name: region.name,
              rid: region.rid || 'нет'
            });
          });
        } else {
          console.log('Регионы не загружены');
        }
        
        console.log('\n=== ГОРОДА ПО РЕГИОНАМ ===');
        if (window.citiesByRegion) {
          Object.keys(window.citiesByRegion).forEach(regionId => {
            const region = window.regions?.find(r => r.business_id === regionId);
            console.log(`Регион ${region?.name || regionId}:`);
            window.citiesByRegion[regionId].forEach((city, idx) => {
              console.log(`  Город ${idx + 1}:`, {
                id: city.id,
                name: city.name,
                code: city.code || 'нет',
                type: city.type
              });
            });
          });
        } else {
          console.log('Города не загружены');
        }
        
        console.log('\n=== POI ПО ГОРОДАМ ===');
        if (window.poisByCity) {
          Object.keys(window.poisByCity).forEach(cityId => {
            const city = Object.values(window.citiesByRegion || {}).flat().find(c => c.business_id === cityId);
            console.log(`Город ${city?.name || cityId}:`);
            window.poisByCity[cityId].forEach((poi, idx) => {
              console.log(`  POI ${idx + 1}:`, {
                id: poi.id,
                name: poi.name,
                poi_id: poi.poi_id || 'нет',
                category: poi.category || 'нет'
              });
            });
          });
        } else {
          console.log('POI не загружены');
        }
        
        console.log('=== КОНЕЦ СПИСКА ID ===');
      };

      // Система локального кэширования ID
      const CACHE_KEYS = {
        regions: 'konstructour_regions_cache_v2',
        cities: 'konstructour_cities_cache_v2', 
        pois: 'konstructour_pois_cache_v2'
      };

      // Сохранение ID в localStorage
      window.saveIdsToCache = function(scope, data) {
        try {
          const key = CACHE_KEYS[scope];
          if (key && data) {
            localStorage.setItem(key, JSON.stringify({
              timestamp: Date.now(),
              data: data
            }));
            console.log(`Сохранено в кэш ${scope}:`, data.length, 'записей');
          }
        } catch (e) {
          console.warn('Ошибка сохранения в кэш:', e);
        }
      };

      // Загрузка ID из localStorage
      window.loadIdsFromCache = function(scope) {
        try {
          const key = CACHE_KEYS[scope];
          if (!key) return null;
          
          const cached = localStorage.getItem(key);
          if (!cached) return null;
          
          const parsed = JSON.parse(cached);
          const age = Date.now() - parsed.timestamp;
          
          // Кэш действителен 24 часа
          if (age > 24 * 60 * 60 * 1000) {
            localStorage.removeItem(key);
            return null;
          }
          
          console.log(`Загружено из кэша ${scope}:`, parsed.data.length, 'записей');
          return parsed.data;
        } catch (e) {
          console.warn('Ошибка загрузки из кэша:', e);
          return null;
        }
      };

      // Проверка необходимости обновления
      window.shouldRefreshData = function() {
        const lastRefresh = localStorage.getItem('konstructour_last_refresh');
        if (!lastRefresh) return true;
        
        const age = Date.now() - parseInt(lastRefresh);
        const maxAge = 6 * 60 * 60 * 1000; // 6 часов
        
        return age > maxAge;
      };

      // Автоматическое обновление при необходимости
      window.autoRefreshIfNeeded = async function() {
        if (shouldRefreshData()) {
          console.log('Автоматическое обновление данных...');
          await refreshAllData();
          localStorage.setItem('konstructour_last_refresh', Date.now().toString());
        }
      };

      // Очистка всего кэша
      window.clearAllCache = function() {
        // Очищаем localStorage
        Object.values(CACHE_KEYS).forEach(key => {
          localStorage.removeItem(key);
        });
        
        // Очищаем переменные в памяти
        regions = [];
        citiesByRegion = {};
        poisByCity = {};
        ticketsByPoi = {};
        
        // Сбрасываем выбранные элементы
        selectedRegion = null;
        selectedCity = null;
        selectedPoi = null;
        
        console.log('Весь кэш очищен (localStorage + память)');
      };

      // Принудительное обновление кэша (игнорирует кэш)
      window.forceRefreshCache = async function() {
        console.log('Принудительное обновление кэша...');
        clearAllCache();
        await syncRegionsFromAirtable();
        console.log('Кэш обновлен');
      };

      // Обновление конкретного региона
      window.refreshRegionData = async function(regionId) {
        console.log('Обновление данных региона:', regionId);
        const region = regions.find(r => r.business_id === regionId);
        if (!region) return;
        
        // Очищаем кэш для этого региона
        localStorage.removeItem(`cities_${regionId}`);
        localStorage.removeItem(`pois_${regionId}`);
        
        // Перезагружаем данные
        await loadCitiesForRegion(region);
        console.log('Данные региона обновлены');
      };

      // Обновление конкретного города
      window.refreshCityData = async function(cityId) {
        console.log('Обновление данных города:', cityId);
        const city = Object.values(citiesByRegion).flat().find(c => c.business_id === cityId);
        if (!city) return;
        
        // Очищаем кэш для этого города
        localStorage.removeItem(`pois_${cityId}`);
        
        // Перезагружаем данные
        await loadPoisForCity(city);
        console.log('Данные города обновлены');
      };

      // Полное обновление всех данных
      window.refreshAllData = async function() {
        console.log('Полное обновление всех данных...');
        clearAllCache();
        
        // Перезагружаем регионы
        await syncRegionsFromAirtable();
        
        // Перезагружаем города для всех регионов
        for (const region of regions) {
          await loadCitiesForRegion(region);
        }
        
        // Перезагружаем POI для всех городов
        for (const region of regions) {
          const cities = citiesByRegion[region.business_id] || [];
          for (const city of cities) {
            await loadPoisForCity(city);
          }
        }
        
        console.log('Все данные обновлены');
      };

      // Показать статус кэша
      window.showCacheStatus = function() {
        console.log('=== СТАТУС КЭША ===');
        Object.entries(CACHE_KEYS).forEach(([scope, key]) => {
          const cached = localStorage.getItem(key);
          if (cached) {
            try {
              const parsed = JSON.parse(cached);
              const age = Math.round((Date.now() - parsed.timestamp) / 1000 / 60); // минуты
              console.log(`${scope}: ${parsed.data.length} записей, возраст: ${age} мин`);
            } catch (e) {
              console.log(`${scope}: поврежден`);
            }
          } else {
            console.log(`${scope}: пуст`);
          }
        });
      };

      // Обработчик кнопки очистки кэша
      document.addEventListener('DOMContentLoaded', function() {
        const clearCacheBtn = document.getElementById('clear-cache-btn');
        
        if (clearCacheBtn) {
          clearCacheBtn.addEventListener('click', function() {
            if (confirm('Очистить весь кэш? Это заставит загрузить все данные заново.')) {
              clearAllCache();
              alert('Кэш очищен!');
            }
          });
        }
      });

      // Функция для отображения реальных ID из массива regions
      window.showRealRegionIds = function() {
        console.log('=== РЕАЛЬНЫЕ ID РЕГИОНОВ ИЗ МАССИВА ===');
        
        if (window.regions && window.regions.length > 0) {
          window.regions.forEach((region, idx) => {
            console.log(`Регион ${idx + 1}:`, {
              id: region.id || 'НЕТ ID',
              name: region.name || 'НЕТ НАЗВАНИЯ',
              rid: region.rid || 'НЕТ RID'
            });
          });
        } else {
          console.log('Массив regions пуст или не загружен');
        }
      };

      // Функция для отображения реальных ID из DOM карточек
      window.showRealIdsFromCards = function() {
        console.log('=== РЕАЛЬНЫЕ ID ИЗ DOM КАРТОЧЕК ===');
        
        // Регионы
        const regionCards = document.querySelectorAll('[data-go="cities"]');
        console.log('\n=== РЕГИОНЫ (из DOM) ===');
        regionCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const ridElement = card.querySelector('.text-xs');
          
          console.log(`Регион ${idx + 1}:`, {
            id: id || 'НЕТ ID',
            name: nameElement ? nameElement.textContent.trim() : 'НЕТ НАЗВАНИЯ',
            rid: ridElement ? ridElement.textContent.trim() : 'НЕТ RID'
          });
        });
        
        // Города
        const cityCards = document.querySelectorAll('[data-go="pois"]');
        console.log('\n=== ГОРОДА (из DOM) ===');
        cityCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const codeElement = card.querySelector('.text-xs');
          
          console.log(`Город ${idx + 1}:`, {
            id: id || 'НЕТ ID',
            name: nameElement ? nameElement.textContent.trim() : 'НЕТ НАЗВАНИЯ',
            code: codeElement ? codeElement.textContent.trim() : 'НЕТ CODE'
          });
        });
        
        // POI
        const poiCards = document.querySelectorAll('[data-go="poi-details"]');
        console.log('\n=== POI (из DOM) ===');
        poiCards.forEach((card, idx) => {
          const id = card.getAttribute('data-id');
          const nameElement = card.querySelector('.text-lg');
          const poiIdElement = card.querySelector('.text-xs');
          
          console.log(`POI ${idx + 1}:`, {
            id: id || 'НЕТ ID',
            name: nameElement ? nameElement.textContent.trim() : 'НЕТ НАЗВАНИЯ',
            poi_id: poiIdElement ? poiIdElement.textContent.trim() : 'НЕТ POI_ID'
          });
        });
      };
      
      // SVG иконки для категорий POI
      window.POI_CATEGORY_ICONS = {
        'Синтоистское святилище': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L14 6H20V8H18V20H16V8H8V20H6V8H4V6H10L12 2ZM10 10H14V12H10V10ZM10 14H14V16H10V14Z"/>
        </svg>`,
        'Буддийский храм': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L13.5 5.5H18V7H16V11H18.5L20 14H4L5.5 11H8V7H6V5.5H10.5L12 2ZM10 9H14V13H10V9Z"/>
        </svg>`,
        'Архитектурный объект': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M6 20V9L12 4L18 9V20H16V11.5L12 8.5L8 11.5V20H6ZM10 15H14V17H10V15Z"/>
        </svg>`,
        'Музей': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 1L21 6V8H3V6L12 1ZM5 10H7V18H5V10ZM9 10H11V18H9V10ZM13 10H15V18H13V10ZM17 10H19V18H17V10ZM3 20V22H21V20H3Z"/>
        </svg>`,
        'Арт-пространство / Галерея': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M9 10V8L7 6L9 4V2H15V4L17 6L15 8V10H9ZM12 5.5L13.5 4H10.5L12 5.5ZM4 12H20V20H4V12ZM6 14V18H18V14H6Z"/>
        </svg>`,
        'Смотровая площадка': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2C15.31 2 18 4.69 18 8C18 11.54 12 22 12 22S6 11.54 6 8C6 4.69 8.69 2 12 2ZM12 6C10.9 6 10 6.9 10 8S10.9 10 12 10 14 9.1 14 8 13.1 6 12 6ZM12 9C11.45 9 11 8.55 11 8S11.45 7 12 7 13 7.45 13 8 12.55 9 12 9Z"/>
        </svg>`,
        'Ландшафтный сад / Парк': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M17 8C8 10 5.9 16.17 3.82 21.34L5.71 22L6.66 19.7C7.14 19.87 7.64 20 8 20C8.36 20 8.86 19.87 9.34 19.7L10.29 22L12.18 21.34C10.1 16.17 8 10 17 8ZM3 3L12 2L21 3V6H3V3Z"/>
        </svg>`,
        'Достопримечательность': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2ZM12 6.5L11.5 8.5L9.5 9L11.5 9.5L12 11.5L12.5 9.5L14.5 9L12.5 8.5L12 6.5Z"/>
        </svg>`,
        'Историческое место': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L22 6V8H2V6L12 2ZM4 10H20V18H16V20H8V18H4V10ZM6 12V16H18V12H6ZM8 13H16V15H8V13Z"/>
        </svg>`,
        'Японский отель': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M7 13C7.55 13 8 12.55 8 12S7.55 11 7 11 6 11.45 6 12 6.45 13 7 13ZM12 13C12.55 13 13 12.55 13 12S12.55 11 12 11 11 11.45 11 12 11.45 13 12 13ZM17 13C17.55 13 18 12.55 18 12S17.55 11 17 11 16 11.45 16 12 16.45 13 17 13ZM19 7H5V5H19V7ZM19 9H5V19H19V9ZM21 3H3V21H21V3Z"/>
        </svg>`,
        'Развлечения': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"/>
        </svg>`,
        'Шоппинг': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M7 18C5.9 18 5 18.9 5 20S5.9 22 7 22 9 21.1 9 20 8.1 18 7 18ZM1 2V4H3L6.6 11.59L5.25 14.04C5.09 14.32 5 14.65 5 15C5 16.1 5.9 17 7 17H19V15H7.42C7.28 15 7.17 14.89 7.17 14.75L7.2 14.63L8.1 13H15.55C16.3 13 16.96 12.59 17.3 11.97L20.88 5H5.21L4.27 3H1ZM17 18C15.9 18 15 18.9 15 20S15.9 22 17 22 19 21.1 19 20 18.1 18 17 18Z"/>
        </svg>`,
        'Термальный источник': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M9 17C9 15.34 10.34 14 12 14S15 15.34 15 17 13.66 20 12 20 9 18.66 9 17ZM12 2C10.89 2 10 2.89 10 4S10.89 6 12 6 14 5.11 14 4 13.11 2 12 2ZM6 6C4.89 6 4 6.89 4 8S4.89 10 6 10 8 9.11 8 8 7.11 6 6 6ZM18 6C16.89 6 16 6.89 16 8S16.89 10 18 10 20 9.11 20 8 19.11 6 18 6Z"/>
        </svg>`,
        'СПА': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M19 12C19 8.13 15.87 5 12 5S5 8.13 5 12C5 15.87 8.13 19 12 19S19 15.87 19 12ZM12 7C14.76 7 17 9.24 17 12S14.76 17 12 17 7 14.76 7 12 9.24 7 12 7ZM12 9C10.34 9 9 10.34 9 12S10.34 15 12 15 15 13.66 15 12 13.66 9 12 9Z"/>
        </svg>`
      };
      
      // Функция получения иконки по категории
      window.getPOICategoryIcon = function(category) {
        return window.POI_CATEGORY_ICONS[category] || `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"/>
        </svg>`;
      };
      
    // Глобальный перехват ошибок — пишем в серверный лог
    (function(){
      function postError(payload){
        try{ fetch('/api/error-log.php?action=add',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }); }catch(_e){}
      }
      window.addEventListener('error', function(e){
        postError({ type:'js-error', page:'databases.html', msg: String(e.message||'error'), file: e.filename||'', line: e.lineno||0, col: e.colno||0, stack: e.error && e.error.stack ? String(e.error.stack) : '' });
      });
      window.addEventListener('unhandledrejection', function(e){
        const r = e && (e.reason||e.detail||{});
        postError({ type:'js-unhandled', page:'databases.html', msg: (r && (r.message||r)) ? String(r.message||r) : 'unhandled', stack: r && r.stack ? String(r.stack) : '' });
      });
    })();
    // Простые вкладки без сторонних зависимостей
    (function(){
      window.__ADMIN_DB_DEBUG = /(^|[?&])debug=1(&|$)/.test(location.search) || (localStorage.getItem('debug_admin_db')==='1');
      window.dlog = function(){ if (window.__ADMIN_DB_DEBUG) { try{ console.log.apply(console, ['[DB]'].concat(Array.from(arguments))); }catch(_e){} } };
      const tabs = document.querySelectorAll('.tab');
      const sections = {
        regions: document.getElementById('tab-regions'),
        tours: document.getElementById('tab-tours'),
        templates: document.getElementById('tab-templates')
      };
      tabs.forEach(btn=>{
        btn.addEventListener('click', function(e){
          e.preventDefault();
          tabs.forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          Object.values(sections).forEach(s=> s && s.classList.remove('active'));
          const key = this.getAttribute('data-tab');
          if (sections[key]) sections[key].classList.add('active');
        });
      });

      // Fake sync state toggling for icon demo (replace with real sync hooks)
      function setSyncing(scope, isSyncing){
        const el = document.getElementById(scope+'_sync_icon');
        if (!el) return;
        if (isSyncing) el.classList.add('animate-spin'); else el.classList.remove('animate-spin');
      }

      // Remove placeholder spinner handler to avoid side-effects on clicks

      // Base label auto-switch for API type
      function bindApiLabel(){ /* удалено вместе с UI */ }

      // Load saved config from server and populate fields
        window.airtableReg = null; // cache for mapping header - делаем глобальной
        
        
      async function loadDbConfig(){
        try{
          const res = await fetch('/api/config-read.php', { headers: { 'X-Admin-Token': (window.ADMIN_TOKEN||'') } });
          if (!res.ok) return;
          const data = await res.json();
          const db = (data && data.databases) || {};
          const reg = (data && data.airtable_registry) || null;
            window.airtableReg = reg;
          function fill(){ /* UI удалён */ }
          fill('regions', db.regions);
          fill('tours', db.tours);
          fill('templates', db.templates);
          // Fill Airtable Mapping UI
          if (reg){
            const baseId = reg.baseId || reg.base_id || '';
            const t = reg.tables || {};
            document.getElementById('am_base_id') && (document.getElementById('am_base_id').value = baseId);
            function setv(id, val){ const el = document.getElementById(id); if (el && typeof val==='string') el.value = val; }
            setv('am_country_label', t.country?.label||''); setv('am_country_table', t.country?.tableId||''); setv('am_country_view', t.country?.viewId||'');
            setv('am_region_label',  t.region?.label||'');  setv('am_region_table',  t.region?.tableId||'');  setv('am_region_view',  t.region?.viewId||'');
            setv('am_city_label',    t.city?.label||'');    setv('am_city_table',    t.city?.tableId||'');    setv('am_city_view',    t.city?.viewId||'');
            setv('am_poi_label',     t.poi?.label||'');     setv('am_poi_table',     t.poi?.tableId||'');     setv('am_poi_view',     t.poi?.viewId||'');
            // Render mapping header for Regions
            // initial header will be set by render functions
          }
        }catch(e){ console.warn('loadDbConfig failed', e); }
      }
      loadDbConfig();

      function setMappingHeader(){ /* бейдж перенесён — здесь ничего не рендерим */ }
      // Сделаем доступной для других модулей на странице
      window.setMappingHeader = setMappingHeader;

      // Fallback: прямой список регионов через test-proxy, читая реестр с сервера при необходимости
      async function loadRegionsViaProxy(){
        try{
            let baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || '';
            let regTbl = (window.airtableReg && window.airtableReg.tables && (window.airtableReg.tables.region?.tableId || window.airtableReg.tables.region?.table_id)) || '';
          if (!baseId || !regTbl){
            const cfg = await fetch('/api/config-read.php').then(r=>r.ok?r.json():null).catch(()=>null);
            const reg = cfg && (cfg.airtable_registry||{});
            if (reg){
              baseId = baseId || reg.baseId || reg.base_id || '';
              const t = reg.tables||{}; regTbl = regTbl || t.region?.tableId || t.region?.table_id || '';
            }
          }
          // Жёсткие дефолты (если реестр недоступен): Regions table
            if (!baseId) baseId = window.AIRTABLE_BASE_ID;
            if (!regTbl) regTbl = window.AIRTABLE_REGIONS_TABLE_ID;
          if (!baseId || !regTbl) return false;
          const u = '/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId)+'&table='+encodeURIComponent(regTbl);
          const r2 = await fetch(u); if(!r2.ok) return false; const j2 = await r2.json();
          console.log('Airtable API response for regions:', j2);
          const recs = (j2 && j2.body && (j2.body.records || j2.body.items)) || j2.records || j2.items || [];
          console.log('Parsed records from Airtable:', recs);
          regions = recs.map((rec, idx)=>{
            const fields = rec.fields || {};
            const name = fields['Name (RU)'] || fields['Название (RU)'] || fields['Name'] || fields['Название'] || ('Регион '+(idx+1));
            const rid = fields['Идентификатор'] || fields['Region ID'] || fields['ID'] || fields['Регион ID'] || '';
            // Генерируем правильный код региона если в Airtable неправильный
            const correctRid = rid && rid.match(/^REG-\d{3}$/) ? rid : ('REG-'+String(idx+1).padStart(3,'0'));
            return { 
              id: rec.id || ('REG-'+String(idx+1).padStart(3,'0')), 
              name, 
              rid: correctRid
            };
          });
          console.log('Final regions array:', regions);
          citiesByRegion = {};
          renderRegions();
          return regions.length>0;
        }catch(e){ 
          console.warn('loadRegionsViaProxy failed', e); 
          return false;
        }
      }

      // Save Airtable Mapping
      async function saveAirtableRegistry(){
        const reg = {
          baseId: document.getElementById('am_base_id')?.value || '',
          tables: {
            country: { label: document.getElementById('am_country_label')?.value || '', tableId: document.getElementById('am_country_table')?.value || '', viewId: document.getElementById('am_country_view')?.value || '' },
            region:  { label: document.getElementById('am_region_label')?.value  || '', tableId: document.getElementById('am_region_table')?.value  || '', viewId: document.getElementById('am_region_view')?.value  || '' },
            city:    { label: document.getElementById('am_city_label')?.value    || '', tableId: document.getElementById('am_city_table')?.value    || '', viewId: document.getElementById('am_city_view')?.value    || '' },
            poi:     { label: document.getElementById('am_poi_label')?.value     || '', tableId: document.getElementById('am_poi_table')?.value     || '', viewId: document.getElementById('am_poi_view')?.value     || '' }
          }
        };
        try{
          await fetch('/api/config-store.php',{
            method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
            body: JSON.stringify({ airtable_registry: reg })
          });
        }catch(e){ console.warn('save registry failed', e); }
      }
      document.getElementById('am_save')?.addEventListener('click', saveAirtableRegistry);

      // Test Base / Table
      document.getElementById('am_test_base')?.addEventListener('click', async function(){
        const baseId = document.getElementById('am_base_id')?.value || '';
        const key = ''; // сервер возьмёт PAT из server keys
        const res = await fetch('/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId));
        const t = await res.json();
        const label = document.getElementById('am_base_status');
        if (label) label.textContent = t.ok ? 'OK' : ('Ошибка: '+(t.error||''));
      });
      document.querySelectorAll('.am_test_table').forEach(btn=>{
        btn.addEventListener('click', async function(){
          const entity = this.getAttribute('data-entity');
          const baseId = document.getElementById('am_base_id')?.value || '';
          const tableId = document.getElementById('am_'+entity+'_table')?.value || '';
          const viewId = document.getElementById('am_'+entity+'_view')?.value || '';
          const url = '/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId)+'&table='+encodeURIComponent(tableId)+(viewId?('&view='+encodeURIComponent(viewId)):'');
          const res = await fetch(url);
          const t = await res.json();
          const label = document.getElementById('am_'+entity+'_status');
          if (label) label.textContent = t.ok ? 'OK' : ('Ошибка: '+(t.error||''));
        });
      });
    })();

    // Иерархия карточек: регионы → города → POI → билеты (UI, без API)
    (function(){
      // helper: save to server as server key
      async function saveDbConfig(scope){
        try{
          // UI полей удалён — функция оставлена на будущее, сейчас no-op
          await fetch('/api/config-store.php',{
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
            body: JSON.stringify({})
          }).then(r=>{
            if (!r.ok) throw new Error('HTTP '+r.status);
            if (window.osNotify){ window.osNotify('Сохранено','Конфигурация обновлена'); }
          }).catch(e=>{
            console.warn('saveDbConfig failed', e);
            if (window.osNotify){ window.osNotify('Ошибка','Не удалось сохранить'); }
          });
        }catch(e){ console.warn('saveDbConfig failed', e); }
      }

      const crumbs = document.getElementById('db_breadcrumbs');
      const cards = document.getElementById('db_cards');
      const fab = document.getElementById('db_fab_add');

      if (!crumbs || !cards) return;

      const regionColors = {
        'Хоккайдо':'bg-blue-100 text-blue-800',
        'Тохоку':'bg-green-100 text-green-800',
        'Канто':'bg-indigo-100 text-indigo-800',
        'Тюбу':'bg-yellow-100 text-yellow-800',
        'Кансай':'bg-purple-100 text-purple-800',
        'Тюгоку':'bg-pink-100 text-pink-800',
        'Сикоку':'bg-teal-100 text-teal-800',
        'Кюсю':'bg-red-100 text-red-800',
        'Окинава':'bg-cyan-100 text-cyan-800'
      };

      // State (in-memory for UI only). Источник правды — Airtable
      let regions = [];
      let citiesByRegion = {}; // regionId -> [ { id, name, type: 'city'|'location', parentCityId? } ]
      let poisByCity = {};     // cityId -> [ {id,name,type} ]
      let ticketsByPoi = {};   // poiId -> [ {id,category,price,currency,note} ]

      // Persisted cache so карточки не пропадают визуально при сбоях сети/серверов
      const LS_REGIONS_KEY = 'konstructour_regions_cache_v1';
      
      function loadRegionsCache(){ 
        try{ 
          const s=localStorage.getItem(LS_REGIONS_KEY); 
          const parsed = s ? JSON.parse(s) : [];
          console.log('📦 loadRegionsCache: загружено', parsed.length, 'регионов из кэша');
          return parsed;
        } catch(_e){ 
          console.error('❌ loadRegionsCache ошибка:', _e);
          return []; 
        } 
      }
      
      function saveRegionsCache(list){ 
        try{ 
          if (!Array.isArray(list)) {
            console.warn('⚠️ saveRegionsCache: list не массив', typeof list);
            return;
          }
          const jsonStr = JSON.stringify(list);
          localStorage.setItem(LS_REGIONS_KEY, jsonStr); 
          console.log('💾 saveRegionsCache: сохранено', list.length, 'регионов в кэш');
          console.log('💾 Размер кэша:', (jsonStr.length / 1024).toFixed(2), 'KB');
        } catch(_e){ 
          console.error('❌ saveRegionsCache ошибка:', _e);
        } 
      }

      let level = 'regions';
      let selectedRegion = null;
      let selectedCity = null;
      let selectedPoi = null;
      let preloadInProgress = false; // Флаг для предотвращения повторных загрузок

      // History helpers
      async function renderFromState(state){
        console.log('renderFromState called with state:', state);
        
        if (!state || !state.level) { 
          level = 'regions';
          selectedRegion = null;
          selectedCity = null;
          selectedPoi = null;
          renderCrumbs();
          setMappingHeader('region');
          renderRegions(); 
          return; 
        }
        
        level = state.level;
        
        if (level === 'regions') { 
          selectedRegion = null;
          selectedCity = null;
          selectedPoi = null;
          renderCrumbs();
          setMappingHeader('region');
          renderRegions(); 
          return; 
        }
        
        if (level === 'cities') {
          selectedRegion = regions.find(r=>r.business_id===state.regionId) || null;
          selectedCity = null;
          selectedPoi = null;
          renderCrumbs();
          setMappingHeader('city');
          
          if (selectedRegion) {
            // Загружаем города если еще не загружены
            if (!citiesByRegion[selectedRegion.business_id] || citiesByRegion[selectedRegion.business_id].length === 0) {
              await loadCitiesForRegion(selectedRegion);
            }
            await preloadPoisCountsForRegion(selectedRegion);
          }
          renderCities(); 
          return;
        }
        
        if (level === 'pois') {
          selectedRegion = regions.find(r=>r.business_id===state.regionId) || null;
          if (selectedRegion) {
            // Загружаем города если еще не загружены
            if (!citiesByRegion[selectedRegion.business_id] || citiesByRegion[selectedRegion.business_id].length === 0) {
              await loadCitiesForRegion(selectedRegion);
            }
            
            const list = citiesByRegion[selectedRegion.business_id] || [];
          selectedCity = list.find(c=>c.business_id===state.cityId) || null;
            selectedPoi = null;
            renderCrumbs();
            setMappingHeader('poi');
            
            if (selectedCity) {
              // Загружаем POI если еще не загружены
              if (!poisByCity[selectedCity.business_id] || poisByCity[selectedCity.business_id].length === 0) {
                await loadPoisForCity(selectedCity);
              }
              renderPois(); 
            } else {
              console.error('City not found in renderFromState');
              cards.innerHTML = '<div class="text-center text-red-500 py-12">Город не найден</div>';
            }
          } else {
            console.error('Region not found in renderFromState');
            cards.innerHTML = '<div class="text-center text-red-500 py-12">Регион не найден</div>';
          }
          return;
        }
        
        // poi-details level удалён - перенаправляем на список POI
        if (level === 'poi-details') {
          level = 'pois';
          selectedRegion = regions.find(r=>r.business_id===state.regionId) || null;
          if (selectedRegion) {
            if (!citiesByRegion[selectedRegion.business_id] || citiesByRegion[selectedRegion.business_id].length === 0) {
              await loadCitiesForRegion(selectedRegion);
            }
            const listC = citiesByRegion[selectedRegion.business_id] || [];
            selectedCity = listC.find(c=>c.business_id===state.cityId) || null;
            if (selectedCity) {
              if (!poisByCity[selectedCity.business_id] || poisByCity[selectedCity.business_id].length === 0) {
                await loadPoisForCity(selectedCity);
            }
              renderPois();
          }
          }
          return;
        }
        
        if (level === 'tickets') {
          selectedRegion = regions.find(r=>r.business_id===state.regionId) || null;
          if (selectedRegion) {
            // Загружаем города если еще не загружены
            if (!citiesByRegion[selectedRegion.business_id] || citiesByRegion[selectedRegion.business_id].length === 0) {
              await loadCitiesForRegion(selectedRegion);
            }
            
            const listC = citiesByRegion[selectedRegion.business_id] || [];
          selectedCity = listC.find(c=>c.business_id===state.cityId) || null;
            if (selectedCity) {
              // Загружаем POI если еще не загружены
              if (!poisByCity[selectedCity.business_id] || poisByCity[selectedCity.business_id].length === 0) {
                await loadPoisForCity(selectedCity);
              }
              const listP = poisByCity[selectedCity.business_id] || [];
          selectedPoi = listP.find(p=>p.business_id===state.poiId) || null;
            }
          }
          renderCrumbs();
          setMappingHeader('ticket');
          renderTickets(); 
          return;
        }
        
        // Fallback
        level = 'regions';
        selectedRegion = null;
        selectedCity = null;
        selectedPoi = null;
        renderCrumbs();
        setMappingHeader('region');
        renderRegions();
      }
      function push(level, ids){
        const state = Object.assign({ level }, ids||{});
        history.pushState(state, '');
      }

      function renderCrumbs(){
        const parts = [];
        // Root
        if (level === 'regions'){
          parts.push('<span class="text-gray-800">Регионы</span>');
        } else {
          parts.push('<a href="#" data-level="regions" class="text-indigo-600 hover:underline">Регионы</a>');
        }
        // Region
        if (selectedRegion){
          parts.push('<span class="mx-2">/</span>');
          if (level === 'cities'){
            parts.push('<span class="text-gray-800">'+selectedRegion.name+'</span>');
          } else {
            parts.push('<a href="#" data-level="cities" data-region-id="'+selectedRegion.business_id+'" class="text-indigo-600 hover:underline">'+selectedRegion.name+'</a>');
          }
        }
        // City
        if (selectedCity){
          parts.push('<span class="mx-2">/</span>');
          if (level === 'pois' || level === 'poi-details'){
            parts.push('<span class="text-gray-800">'+selectedCity.name+'</span>');
          } else {
            parts.push('<a href="#" data-level="pois" data-region-id="'+(selectedRegion?selectedRegion.business_id:'')+'" data-city-id="'+selectedCity.business_id+'" class="text-indigo-600 hover:underline">'+selectedCity.name+'</a>');
          }
        }
        // POI
        if (selectedPoi){
          parts.push('<span class="mx-2">/</span>');
          if (level === 'poi-details' || level === 'tickets'){
            parts.push('<span class="text-gray-800">'+selectedPoi.name+'</span>');
          } else {
            parts.push('<a href="#" data-level="poi-details" data-region-id="'+(selectedRegion?selectedRegion.business_id:'')+'" data-city-id="'+(selectedCity?selectedCity.business_id:'')+'" data-poi-id="'+(selectedPoi.poi_id || selectedPoi.business_id)+'" class="text-indigo-600 hover:underline">'+selectedPoi.name+'</a>');
          }
        }
        crumbs.innerHTML = parts.join('');
      }

      function card(actionsHtml, innerHtml){
        const actionsBlock = actionsHtml && actionsHtml.trim() ? '<div class="absolute top-2 right-2 flex items-center gap-2 opacity-70">'+actionsHtml+'</div>' : '';
        return '<div class="relative bg-white rounded-lg border border-gray-200 p-4 hover:shadow transition">'+actionsBlock+innerHtml+'</div>';
      }

      function renderRegions(){
        console.log('🎨 renderRegions() вызвана');
        console.log('🎨 regions.length =', regions.length);
        console.log('🎨 cards элемент:', cards);
        
        level='regions'; selectedRegion=null; selectedCity=null; selectedPoi=null; renderCrumbs(); setMappingHeader('region');
        
        // Восстанавливаем grid классы для регионов
        cards.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
        
        if (!regions.length){
          console.log('⚠️ Регионы пусты, рендерим пустое состояние');
          cards.innerHTML = '<div class="text-gray-500">Нет регионов. Нажмите + чтобы добавить.</div>';
          return;
        }
        
        console.log('🎨 Рендерим', regions.length, 'регионов...');
        
        // Сортируем регионы по business_id (rid) в порядке возрастания (создаем новый массив)
        const sortedRegions = [...regions].sort((a, b) => {
          // Извлекаем числовую часть из business_id (например, REG-001 -> 1)
          const getNumericId = (id) => {
            const match = id.match(/(\d+)$/);
            return match ? parseInt(match[1], 10) : 0;
          };
          return getNumericId(a.rid) - getNumericId(b.rid);
        });
        
        // Рендерим регионы с предзагруженными счетчиками (ОПТИМИЗИРОВАНО)
        const regionsHTML = sortedRegions.map((r, idx)=>{
          const count = (r.citiesCount ?? 0) + (r.poisCount ?? 0); // Используем предзагруженные счетчики
          dlog('region-card', {id:r.id, name:r.name, count, cities: r.citiesCount, pois: r.poisCount});
          const inlineActions = '<div class="flex items-center gap-2 opacity-80">\
              '+(r.rid ? '<span class="ml-2 px-3 py-1 text-sm rounded border bg-gray-50 text-gray-600">'+r.rid+'</span>' : '')+'\
              <button data-act="edit-region" data-id="'+r.id+'" title="Редактировать" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>\
              <button data-act="del-region" data-id="'+r.id+'" title="Удалить" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>\
            </div>';
          const inner = '<div class="flex items-center justify-between">\
              <div class="flex items-center gap-2">\
                <svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" class="text-indigo-600"><path d="M3.5 6.5 9 4.5l6 2 5.5-2v13l-5.5 2-6-2-5.5 2v-13z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>\
                <div class="text-lg text-gray-800">'+r.name+'</div>\
              </div>\
              '+inlineActions+'\
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">\
                <div class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-50 border border-indigo-100 shadow-sm region-count-badge" style="animation-delay: '+(idx*50)+'ms">\
                  <i class=\"fas fa-map-marker-alt text-indigo-600\"></i>\
                  <span class=\"text-xs font-medium text-indigo-700\">'+count+'</span>\
                </div>\
              </div>\
            </div>';
          return '<a href="#" role="button" class="block fade-in" data-go="cities" data-id="'+r.business_id+'" style="animation-delay: '+(idx*50)+'ms">'+card('', inner)+'</a>';
        }).join('');
        
        console.log('Rendering regions HTML:', regionsHTML.substring(0, 200) + '...');
        cards.innerHTML = regionsHTML;
        
        // Проверяем, что карточки рендерились с правильными атрибутами
        const renderedCards = document.querySelectorAll('#db_cards [data-go="cities"]');
        console.log('Rendered region cards with data-go="cities":', renderedCards.length);
        
        // Переустанавливаем обработчик кликов после рендеринга
        setupUnifiedClickHandler();
        
        // Загружаем только счетчики городов в фоне
        loadRegionCounts();
        
        console.log('✅ renderRegions() завершена, карточек на странице:', renderedCards.length);
      }

      // Загрузка регионов из серверной БД (ОПТИМИЗИРОВАНО)
      async function syncRegionsFromAirtable(){
        try{
          console.log('⚡ Быстрая загрузка регионов...');
          const res = await fetch('/api/data-api.php?action=regions', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          const j = await res.json();
          const items = j.ok ? (j.items || []) : [];
          
          regions = items.map((it, idx) => ({
            id: it.id,
            name: it.name_ru || ('Регион ' + (idx + 1)),
            rid: it.business_id || ('REG-' + String(idx + 1).padStart(3, '0')),
            business_id: it.business_id || ('REG-' + String(idx + 1).padStart(3, '0')),
            code: it.business_id || ('REG-' + String(idx + 1).padStart(3, '0'))
          }));
          
          // Сохраняем в кэш сразу после загрузки
          saveRegionsCache(regions);
          console.log('✅ Регионы сохранены в кэш');
          
          // Сначала быстрый рендер с placeholder'ами
          citiesByRegion = {};
          renderRegions();
          console.log('✅ Регионы отображены');
          
          // Затем загружаем только счетчики (быстро!)
          try {
            const countsRes = await fetch('/api/region-counts.php');
            const countsData = await countsRes.json();
            
            if (countsData.ok) {
              // Обновляем счетчики из быстрого API
              regions.forEach(r => {
                const count = countsData.counts[r.id];
                if (count) {
                  r.citiesCount = count.cities;
                  r.poisCount = count.pois;
                }
              });
              
              // Сохраняем счетчики в кэш
              localStorage.setItem('region_counts_cache', JSON.stringify({
                timestamp: Date.now(),
                counts: countsData.counts
              }));
              
              console.log('✅ Счетчики загружены:', countsData.counts);
              renderRegions(); // Обновляем отображение со счетчиками
            }
          } catch (_e) { console.warn('Не удалось загрузить счетчики:', _e); }
        } catch(e){ 
          console.error('syncRegionsFromAirtable failed', e);
          console.error('Error details:', e.message);
          console.error('Error stack:', e.stack);
          // Fallback: прямой запрос через test-proxy при наличии реестра
          try{
              let baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || '';
              let regTbl = (window.airtableReg && window.airtableReg.tables && (window.airtableReg.tables.region?.tableId || window.airtableReg.tables.region?.table_id)) || '';
            // Жёсткие дефолты, если реестр недоступен
              if (!baseId) baseId = window.AIRTABLE_BASE_ID;
              if (!regTbl) regTbl = window.AIRTABLE_REGIONS_TABLE_ID;
            if (!baseId || !regTbl) return;
            const u = '/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId)+'&table='+encodeURIComponent(regTbl);
            const r2 = await fetch(u);
            const j2 = await r2.json();
            const recs = (j2 && j2.body && (j2.body.records || j2.body.items)) || j2.records || j2.items || [];
            regions = recs.map((rec, idx)=>{
              const fields = rec.fields || {};
              const name = fields['Name (RU)'] || fields['Название (RU)'] || fields['Name'] || fields['Название'] || ('Регион '+(idx+1));
              const rid = fields['Идентификатор'] || fields['Region ID'] || fields['ID'] || fields['Регион ID'] || '';
              return { id: rec.id || ('REG-'+String(idx+1).padStart(3,'0')), name, rid };
            });
            citiesByRegion = {};
            renderRegions();
            saveRegionsCache(regions);
          }catch(e2){ console.warn('fallback regions failed', e2); }
        }
      }

      async function deleteRegionOnServer(region){
        try{
          let recordId = region && region.id ? region.id : '';
          if (!/^rec/i.test(recordId)){
            // Найдём запись по полю Region ID или имени
            const res = await fetch('/api/db-sync.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ scope:'regions', action:'list' })
            });
            const j = await res.json();
            if (j && j.ok && Array.isArray(j.items)){
              const found = j.items.find(it => (it.fields && (it.fields['Region ID']===region.id || it.fields['Регион ID']===region.id)) || it.name===region.name);
              if (found && found.id) recordId = found.id;
            }
          }
          if (recordId && /^rec/i.test(recordId)){
            await fetch('/api/db-sync.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ scope:'regions', action:'delete', data:{ id: recordId } })
            });
          }
        }catch(e){ console.warn('deleteRegionOnServer failed', e); }
      }

      async function renderCities(){
        level='cities'; /* keep selectedCity */ selectedPoi=null; renderCrumbs(); setMappingHeader('city');
        
        // Восстанавливаем grid классы для городов
        cards.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
        
        if (!selectedRegion || !selectedRegion.business_id) {
          console.error('renderCities: No selected region');
          cards.innerHTML = '<div class="text-center text-red-500 py-12">Регион не выбран</div>';
          return;
        }
        
        let list = citiesByRegion[selectedRegion.business_id] || [];
        
        // Проверяем актуальность данных перед загрузкой
        await checkDataFreshness();
        
        // Если города не загружены, загружаем их сразу
        if (list.length === 0) {
          console.log('Города не загружены, загружаем для региона:', selectedRegion.name);
          await loadCitiesForRegion(selectedRegion);
          list = citiesByRegion[selectedRegion.business_id] || [];
        }
        
        // Загружаем только счетчики POI для городов в фоне
        if (list.length > 0 && !preloadInProgress) {
          console.log('Loading POI counts for cities in region:', selectedRegion.name);
          preloadInProgress = true;
          // Загружаем только счетчики в фоне
          loadCityCounts(selectedRegion.business_id).finally(() => {
            preloadInProgress = false;
          });
        }
        
        // Сортируем города по business_id (code) в порядке возрастания (создаем новый массив)
        const sortedCities = [...list].sort((a, b) => {
          // Извлекаем числовую часть из business_id (например, CTY-001 -> 1)
          const getNumericId = (id) => {
            const match = id.match(/(\d+)$/);
            return match ? parseInt(match[1], 10) : 0;
          };
          return getNumericId(a.code) - getNumericId(b.code);
        });
        
        // Если список пуст — показываем кнопку добавления через ту же +
        function findCityNameById(id){ const x=(sortedCities||[]).find(v=>v.business_id===id); return x?x.name:''; }
        cards.innerHTML = sortedCities.map(c=>{
          const count = (poisByCity[c.business_id]||[]).length;
          console.log(`City ${c.name} (${c.business_id}) pill count: ${count}, poisByCity[${c.business_id}]:`, poisByCity[c.business_id]);
          const inlineActions = '<div class="flex items-center gap-2 opacity-80">'+
              (c.code ? '<span class="ml-2 px-2 py-0.5 text-xs rounded border bg-gray-50 text-gray-600">'+c.code+'</span>' : '')+
              '<button data-act="edit-city" data-id="'+c.business_id+'" title="Редактировать" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
              '<button data-act="del-city" data-id="'+c.business_id+'" title="Удалить" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>'+
            '</div>';
          const inner = '<div class="flex items-center justify-between">\
              <div class="flex items-center gap-2">\
                <svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" class="text-green-600"><path d="M3.5 6.5 9 4.5l6 2 5.5-2v13l-5.5 2-6-2-5.5 2v-13z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>\
                <div class="text-lg text-gray-800">'+c.name+'</div>\
              </div>\
              '+inlineActions+'\
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">\
                <div class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-50 border border-green-100 shadow-sm">\
                  <i class=\"fas fa-map-marker-alt text-green-600\"></i>\
                  <span class=\"text-xs font-medium text-green-700\">'+count+'</span>\
                </div>\
              </div>\
            </div>';
          return '<div class="cursor-pointer" data-go="pois" data-id="'+c.business_id+'">'+card('', inner)+'</div>';
        }).join('') || '<div class="text-gray-500">Нет городов. Нажмите + чтобы добавить.</div>';
        
        // Переустанавливаем обработчик кликов после рендеринга
        setupUnifiedClickHandler();
      }

      async function renderPois(){
        level='pois'; /* keep selectedPoi */ renderCrumbs(); setMappingHeader('poi');
        
        if (!selectedCity || !selectedCity.business_id) {
          console.error('renderPois: No selected city');
          cards.innerHTML = '<div class="text-center text-red-500 py-12">Город не выбран</div>';
          return;
        }
        
        // ВАЖНО: Убираем grid классы с родительского контейнера для POI
        cards.className = 'w-full';
        
        console.log('renderPois called for city:', selectedCity);
        console.log('poisByCity keys:', Object.keys(poisByCity));
        console.log('Looking for POI in poisByCity[' + selectedCity.business_id + ']:', poisByCity[selectedCity.business_id]);
        let list = poisByCity[selectedCity.business_id] || [];
        
        // Проверяем актуальность данных перед загрузкой
        await checkDataFreshness();
        
        // Если POI не загружены, загружаем их
        if (list.length === 0) {
          console.log('POI list is empty for city:', selectedCity.name, '- loading...');
          await loadPoisForCity(selectedCity);
          list = poisByCity[selectedCity.business_id] || [];
        }
        
        console.log('POI list for city:', list);
        const parentTypeLabel = selectedCity && selectedCity.type==='location' ? 'Локация' : 'Город';
        
        // Сортируем POI по business_id (poi_id) в порядке возрастания (создаем новый массив)
        const sortedPois = [...list].sort((a, b) => {
          // Извлекаем числовую часть из business_id (например, POI-001 -> 1)
          const getNumericId = (id) => {
            const match = id.match(/(\d+)$/);
            return match ? parseInt(match[1], 10) : 0;
          };
          return getNumericId(a.poi_id) - getNumericId(b.poi_id);
        });
          
        // Получаем уникальные категории для фильтра
        const uniqueCategories = [...new Set(sortedPois.map(p => p.type).filter(Boolean))].sort();
        
        // Создаем блок с фильтрами и карточками
        const filterBlock = `
          <div class="mb-6 bg-white rounded-lg shadow-sm border p-4">
            <div class="flex flex-col md:flex-row gap-4">
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-search mr-2 text-gray-400"></i>Поиск по названию
                </label>
                <input 
                  type="text" 
                  id="poi-search-input" 
                  placeholder="Введите название (RU или EN)..."
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                />
              </div>
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-filter mr-2 text-gray-400"></i>Фильтр по категории
                </label>
                <select 
                  id="poi-category-filter" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                >
                  <option value="">Все категории</option>
                  ${uniqueCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                </select>
              </div>
            </div>
            <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
              <span id="poi-count-label">Всего POI: ${sortedPois.length}</span>
              <button 
                id="reset-filters-btn" 
                class="text-indigo-600 hover:text-indigo-800 font-medium hidden"
              >
                <i class="fas fa-times-circle mr-1"></i>Сбросить фильтры
              </button>
            </div>
          </div>
        `;
        
        const poiCardsHTML = sortedPois.map(p=>{
          // Получаем иконку для категории POI
          const categoryIcon = window.getPOICategoryIcon(p.type);
          const categoryColor = {
            'Синтоистское святилище': 'text-red-600',
            'Буддийский храм': 'text-orange-600', 
            'Архитектурный объект': 'text-gray-600',
            'Музей': 'text-blue-600',
            'Арт-пространство / Галерея': 'text-purple-600',
            'Смотровая площадка': 'text-green-600',
            'Ландшафтный сад / Парк': 'text-green-500',
            'Достопримечательность': 'text-yellow-600',
            'Историческое место': 'text-brown-600',
            'Японский отель': 'text-indigo-600',
            'Развлечения': 'text-pink-600',
            'Шоппинг': 'text-emerald-600',
            'Термальный источник': 'text-blue-500',
            'СПА': 'text-teal-600'
          }[p.type] || 'text-gray-500';
          
          const bgColor = categoryColor.replace('text-', 'bg-').replace('-600', '-50').replace('-500', '-50');
          const borderColor = categoryColor.replace('text-', 'border-').replace('-600', '-200').replace('-500', '-200');
          
          return `
            <div 
              class="poi-card bg-white rounded-lg shadow-sm border-2 ${borderColor} hover:shadow-lg transition-all duration-300 overflow-hidden"
              data-id="${p.id}"
              data-name-ru="${(p.name || '').toLowerCase()}"
              data-name-en="${(p.name_en || '').toLowerCase()}"
              data-category="${p.type || ''}"
            >
              <!-- Верхняя цветная полоска -->
              <div class="${bgColor} h-2"></div>
              
              <div class="p-5">
                <!-- Хедер с иконкой и действиями -->
                <div class="flex items-start justify-between mb-3">
                  <div class="flex items-center gap-3 flex-1">
                    <div class="w-12 h-12 ${bgColor} rounded-lg flex items-center justify-center ${categoryColor} flex-shrink-0 shadow-sm">
                      ${categoryIcon.replace('w-6 h-6', 'w-6 h-6')}
                    </div>
                    <div class="flex-1 min-w-0">
                      <h3 class="text-lg font-semibold text-gray-900 truncate">${p.name || '—'}</h3>
                      <p class="text-sm text-gray-500 truncate">${p.name_en || '—'}</p>
                    </div>
                  </div>
                  
                  <div class="flex items-center gap-2 ml-3 poi-actions">
                    <button 
                      data-act="edit-poi" 
                      data-id="${p.poi_id || p.business_id}" 
                      title="Редактировать" 
                      class="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                    >
                      <i class="fas fa-pen"></i>
                    </button>
                    <button 
                      data-act="del-poi" 
                      data-id="${p.poi_id || p.business_id}" 
                      title="Удалить" 
                      class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                
                <!-- Информация о POI -->
                <div class="space-y-2">
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600 font-medium">
                      <i class="fas fa-tag mr-2 text-gray-400"></i>Категория
                    </span>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${bgColor} ${categoryColor}">
                      ${p.type || '—'}
                    </span>
                  </div>
                  
                  <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                    <span class="text-sm text-gray-600 font-medium">
                      <i class="fas fa-fingerprint mr-2 text-gray-400"></i>POI ID
                    </span>
                    <span class="text-sm font-mono font-semibold text-gray-900 bg-gray-100 px-3 py-1 rounded-md">
                      ${p.poi_id || '—'}
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- Нижний индикатор (при наведении) -->
              <div class="h-1 ${bgColor} opacity-0 hover:opacity-100 transition-opacity"></div>
            </div>
          `;
        }).join('');
          
        // Обёртываем в flex-col контейнер для вертикального расположения
        cards.innerHTML = '<div class="flex flex-col w-full">' + 
          filterBlock + 
          '<div id="poi-cards-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">' + 
          (poiCardsHTML || '<div class="col-span-full text-center text-gray-500 py-12">Нет POI. Нажмите + чтобы добавить.</div>') +
          '</div>' +
            '</div>';
          
        // Добавляем обработчики для фильтров
        const searchInput = document.getElementById('poi-search-input');
        const categoryFilter = document.getElementById('poi-category-filter');
        const resetBtn = document.getElementById('reset-filters-btn');
        const countLabel = document.getElementById('poi-count-label');
        const poiCards = document.querySelectorAll('.poi-card');
        
        function applyFilters() {
          const searchTerm = searchInput.value.toLowerCase().trim();
          const selectedCategory = categoryFilter.value;
          
          let visibleCount = 0;
          
          poiCards.forEach(card => {
            const nameRu = card.getAttribute('data-name-ru') || '';
            const nameEn = card.getAttribute('data-name-en') || '';
            const category = card.getAttribute('data-category') || '';
            
            const matchesSearch = !searchTerm || nameRu.includes(searchTerm) || nameEn.includes(searchTerm);
            const matchesCategory = !selectedCategory || category === selectedCategory;
            
            if (matchesSearch && matchesCategory) {
              card.style.display = '';
              visibleCount++;
            } else {
              card.style.display = 'none';
            }
          });
          
          countLabel.textContent = `Показано POI: ${visibleCount} из ${sortedPois.length}`;
          
          // Показываем кнопку сброса если есть активные фильтры
          if (searchTerm || selectedCategory) {
            resetBtn.classList.remove('hidden');
          } else {
            resetBtn.classList.add('hidden');
          }
        }
        
        if (searchInput && categoryFilter) {
          searchInput.addEventListener('input', applyFilters);
          categoryFilter.addEventListener('change', applyFilters);
        }
        
        if (resetBtn) {
          resetBtn.addEventListener('click', () => {
            searchInput.value = '';
            categoryFilter.value = '';
            applyFilters();
          });
        }
        
        // Переустанавливаем обработчик кликов после рендеринга
        setupUnifiedClickHandler();
      }

      // УДАЛЕНО: Детальный просмотр POI больше не используется
      // Используйте кнопку "Редактировать" на карточке POI для просмотра деталей
      
      /*
      function renderPOIDetails(){
        level='poi-details'; renderCrumbs(); setMappingHeader('poi-details');
        
        // Убираем grid для детального просмотра
        cards.className = 'w-full';
        
        if (!selectedPoi) {
          cards.innerHTML = '<div class="text-gray-500">POI не найден</div>';
          return;
        }
        
        const poi = selectedPoi;
        const categoryIcon = window.getPOICategoryIcon(poi.type);
        const categoryColor = {
          'Синтоистское святилище': 'text-red-600',
          'Буддийский храм': 'text-orange-600', 
          'Архитектурный объект': 'text-gray-600',
          'Музей': 'text-blue-600',
          'Арт-пространство / Галерея': 'text-purple-600',
          'Смотровая площадка': 'text-green-600',
          'Ландшафтный сад / Парк': 'text-green-500',
          'Достопримечательность': 'text-yellow-600',
          'Историческое место': 'text-brown-600',
          'Японский отель': 'text-indigo-600',
          'Развлечения': 'text-pink-600',
          'Шоппинг': 'text-emerald-600',
          'Термальный источник': 'text-blue-500',
          'СПА': 'text-teal-600'
        }[poi.type] || 'text-gray-500';
        
        const details = `
          <div class="bg-white rounded-lg shadow-sm border p-6">
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 flex items-center justify-center ${categoryColor}">
                  ${categoryIcon.replace('w-6 h-6', 'w-6 h-6')}
                </div>
                <div>
                  <h2 class="text-xl font-semibold text-gray-800">${poi.name}</h2>
                  <p class="text-sm text-gray-600">${poi.name_en || ''}</p>
                </div>
              </div>
              <div class="flex gap-2">
                <button class="btn-japanese" data-act="edit-poi" data-id="${poi.poi_id || poi.business_id}">Редактировать</button>
                <button class="btn-japanese accent" data-act="view-tickets" data-id="${poi.poi_id || poi.business_id}">Билеты</button>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <h3 class="font-medium text-gray-700 mb-2">Основная информация</h3>
                <div class="space-y-2 text-sm">
                  <div><span class="font-medium">Категория:</span> <span class="${categoryColor}">${poi.type}</span></div>
                  <div><span class="font-medium">Префектура:</span> ${poi.prefecture_ru || ''} / ${poi.prefecture_en || ''}</div>
                  <div><span class="font-medium">POI ID:</span> <code class="bg-gray-100 px-1 rounded">${poi.poi_id || '—'}</code></div>
                  <div><span class="font-medium">Place ID:</span> <code class="bg-gray-100 px-1 rounded">${poi.place_id || '—'}</code></div>
                </div>
              </div>
              
              <div>
                <h3 class="font-medium text-gray-700 mb-2">Контактная информация</h3>
                <div class="space-y-2 text-sm">
                  <div><span class="font-medium">Сайт:</span> ${poi.website ? `<a href="${poi.website}" target="_blank" class="text-blue-600 hover:underline">${poi.website}</a>` : '—'}</div>
                  <div><span class="font-medium">Часы работы:</span> ${poi.hours || '—'}</div>
                  <div><span class="font-medium">Статус:</span> <span class="px-2 py-1 rounded text-xs ${poi.published ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${poi.published ? 'Опубликован' : 'Черновик'}</span></div>
                </div>
              </div>
            </div>
            
            ${poi.description_ru || poi.description_en ? `
              <div class="mb-4">
                <h3 class="font-medium text-gray-700 mb-2">Описание</h3>
                <div class="text-sm text-gray-600 space-y-2">
                  ${poi.description_ru ? `<div><strong>RU:</strong> ${poi.description_ru}</div>` : ''}
                  ${poi.description_en ? `<div><strong>EN:</strong> ${poi.description_en}</div>` : ''}
                </div>
              </div>
            ` : ''}
            
            ${poi.notes ? `
              <div class="mb-4">
                <h3 class="font-medium text-gray-700 mb-2">Заметки</h3>
                <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded">${poi.notes}</div>
              </div>
            ` : ''}
          </div>
        `;
        
        cards.innerHTML = details;
      }
      */

      // Ленивая загрузка - загружаем только счетчики для текущего уровня
      async function loadRegionCounts(){
        try{
          console.log('Загружаем только счетчики регионов');
          const res = await fetch('/api/data-api.php?action=stats', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          const j = await res.json();
          if (j.ok && j.stats) {
            // Обновляем счетчики городов для всех регионов
            regions.forEach(region => {
              const cityCount = j.stats.cities_by_region[region.business_id] || 0;
              // Обновляем счетчик в UI если мы на уровне регионов
              if (level === 'regions') {
                const regionElement = document.querySelector(`[data-go="cities"][data-id="${region.business_id}"]`);
                if (regionElement) {
                  const countElement = regionElement.querySelector('.text-xs.font-medium');
                  if (countElement) {
                    countElement.textContent = cityCount;
                  }
                }
              }
            });
            console.log('Счетчики регионов обновлены');
          }
        }catch(e){
          console.warn('Ошибка загрузки счетчиков регионов:', e);
        }
      }

      async function loadCityCounts(regionId){
        try{
          console.log(`Загружаем счетчики POI для городов региона ${regionId}`);
          const res = await fetch(`/api/data-api.php?action=city-stats&region_id=${regionId}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          const j = await res.json();
          if (j.ok && j.stats) {
            // Обновляем счетчики POI для каждого города
            Object.keys(j.stats).forEach(cityId => {
              const poiCount = j.stats[cityId] || 0;
              // Обновляем счетчик в UI если мы на уровне городов
              if (level === 'cities') {
                const cityElement = document.querySelector(`[data-go="pois"][data-id="${cityId}"]`);
                if (cityElement) {
                  const countElement = cityElement.querySelector('.text-xs.font-medium');
                  if (countElement) {
                    countElement.textContent = poiCount;
                  }
                }
              }
            });
            console.log('Счетчики городов обновлены');
          }
        }catch(e){
          console.warn('Ошибка загрузки счетчиков городов:', e);
        }
      }

      // Server database loaders for each level
      async function loadCitiesForRegion(region, forceRefresh = false){
        try{
          console.log(`Загружаем города для ${region.name} из серверной БД`);
          // Используем business_id вместо Airtable ID согласно Filtering.md
          const regionBusinessId = region.business_id || region.code;
          console.log('Using region business_id:', regionBusinessId);
          const res = await fetch(`/api/data-api.php?action=cities&region_id=${regionBusinessId}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          const j = await res.json();
          const items = j.ok ? (j.items||[]) : [];
          const cities = items.map(it=>({ 
            id: it.id, 
            name: it.name_ru || '—', 
            code: it.business_id || '', 
            business_id: it.business_id || '',
            type: it.type === 'location' ? 'location' : 'city' 
          }));
          
          // Сортируем города по ID в порядке возрастания (создаем новый массив)
          const sortedCities = [...cities].sort((a, b) => {
            const getNumericId = (id) => {
              const match = id.match(/(\d+)$/);
              return match ? parseInt(match[1], 10) : 0;
            };
            return getNumericId(a.id) - getNumericId(b.id);
          });
          
          citiesByRegion[region.business_id] = sortedCities;
          console.log(`Загружено городов для ${region.name}:`, cities.length);
        }catch(e){ 
          citiesByRegion[region.business_id] = []; 
          console.warn('Ошибка загрузки городов:', e);
        }
      }

      async function loadPoisForCity(city, forceRefresh = false){
        console.log('=== LOAD POIS FOR CITY DEBUG ===');
        console.log('City:', city.name, 'ID:', city.id);
        console.log('Current poisByCity keys:', Object.keys(poisByCity));
        console.log('Current poisByCity[city.business_id]:', poisByCity[city.business_id]);
        
        // Если POI уже загружены для этого города и не принудительное обновление, не перезагружаем
        if (!forceRefresh && poisByCity[city.business_id] && poisByCity[city.business_id].length > 0) {
          console.log('POI already loaded for city:', city.name, 'count:', poisByCity[city.business_id].length);
          return;
        }
        
        try{
          console.log(`Загружаем POI для ${city.name} из серверной БД`);
          // Используем business_id вместо Airtable ID согласно Filtering.md
          const cityBusinessId = city.business_id || city.code;
          console.log('Using city business_id:', cityBusinessId);
          const res = await fetch(`/api/data-api.php?action=pois&city_id=${cityBusinessId}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          const j = await res.json();
          const items = j.ok ? (j.items || []) : [];
          
          const pois = items.map(record => ({
            id: record.id,
            name: record.name_ru || '—',
            type: record.category || '',
            name_en: record.name_en || '',
            place_id: record.place_id || '',
            published: record.published || false,
            poi_id: record.business_id || '',
            region: record.region_id ? [record.region_id] : []
          }));
          
          // Сортируем POI по ID в порядке возрастания (создаем новый массив)
          const sortedPois = [...pois].sort((a, b) => {
            const getNumericId = (id) => {
              const match = id.match(/(\d+)$/);
              return match ? parseInt(match[1], 10) : 0;
            };
            return getNumericId(a.id) - getNumericId(b.id);
          });
          
          poisByCity[city.business_id] = sortedPois;
          console.log(`Загружено POI для ${city.name}:`, pois.length);
        } catch(e){ 
          console.error('Error loading POIs for city:', city.name, e);
          poisByCity[city.business_id] = []; 
        }
      }

        // Предзагрузка POI для региона - загружаем параллельно и неблокирующе
      async function preloadPoisCountsForRegion(region){
        try{
          const list = citiesByRegion[region.business_id] || [];
          if (!list.length) return;
          
          // Полная очистка poisByCity для предотвращения "перетекания" POI между регионами
          Object.keys(poisByCity).forEach(key => {
            delete poisByCity[key];
          });
          
          // Инициализируем пустые массивы для всех городов текущего региона
          list.forEach(city => {
            poisByCity[city.business_id] = [];
          });
            
          console.log('Loading POI for region:', region.name, 'Total cities:', list.length);
          
          // Загружаем POI параллельно для всех городов
          const loadPromises = list.map(async (city) => {
            try {
              const res = await fetch(`/api/data-api.php?action=pois&city_id=${city.id}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
              });
              const j = await res.json();
              const items = j.ok ? (j.items || []) : [];
              
              const pois = items.map(record => ({
                id: record.id,
                name: record.name_ru || '—',
                type: record.category || '',
                name_en: record.name_en || '',
                place_id: record.place_id || '',
                published: record.published || false,
                poi_id: record.business_id || '',
                region: record.region_id ? [record.region_id] : []
              }));
              
              // Сортируем POI по ID в порядке возрастания (создаем новый массив)
              const sortedPois = [...pois].sort((a, b) => {
                const getNumericId = (id) => {
                  const match = id.match(/(\d+)$/);
                  return match ? parseInt(match[1], 10) : 0;
                };
                return getNumericId(a.id) - getNumericId(b.id);
              });
              
              poisByCity[city.business_id] = sortedPois;
              console.log(`Loaded ${pois.length} POI for city ${city.name}`);
              
              // Обновляем UI после загрузки каждого города
              if (level === 'cities') {
                // Обновляем только счетчик для этого города
                const cityElement = document.querySelector(`[data-go="pois"][data-id="${city.business_id}"]`);
                if (cityElement) {
                  const countElement = cityElement.querySelector('.text-xs.font-medium');
                  if (countElement) {
                    countElement.textContent = pois.length;
                  }
                }
              }
              
              return pois.length;
            } catch (e) {
              console.warn(`Error loading POI for city ${city.name}:`, e);
              poisByCity[city.business_id] = [];
              return 0;
            }
          });
          
          // Ждем завершения всех загрузок параллельно
          await Promise.all(loadPromises);
          
          console.log('All POI loaded for region:', region.name);
          
        }catch(e){
            console.error('Error preloading POI for region:', region.name, e);
          }
      }

      function renderTickets(){
        level='tickets'; renderCrumbs();
        
        // Восстанавливаем grid для билетов
        cards.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
        
        const list = ticketsByPoi[selectedPoi.id] || [];
        
        // Сортируем билеты по ID в порядке возрастания (создаем новый массив)
        const sortedTickets = [...list].sort((a, b) => {
          // Извлекаем числовую часть из ID (например, T-001 -> 1)
          const getNumericId = (id) => {
            const match = id.match(/(\d+)$/);
            return match ? parseInt(match[1], 10) : 0;
          };
          return getNumericId(a.id) - getNumericId(b.id);
        });
        
        cards.innerHTML = sortedTickets.map(t=>{
          const actions = '<button data-act="edit-ticket" data-id="'+t.id+'" title="Редактировать" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
                          '<button data-act="del-ticket" data-id="'+t.id+'" title="Удалить" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>';
          const inner = '<div class="flex items-center justify-between">\
              <div class="text-gray-800"><span class="text-xs bg-gray-100 text-gray-700 inline-block px-2 py-0.5 rounded mr-2">🎟</span>'+t.category+'</div>\
              <div class="text-gray-700">'+t.price+'¥</div>\
            </div>';
          return card(actions, inner);
        }).join('') || '<div class="text-gray-500">Нет билетов. Нажмите + чтобы добавить.</div>';
      }

      // Функция настройки обработчика кликов для хлебных крошек
      function setupBreadcrumbHandler() {
        // Удаляем предыдущий обработчик если он был
        if (window.breadcrumbHandler) {
          document.removeEventListener('click', window.breadcrumbHandler);
        }
        
        window.breadcrumbHandler = function(e) {
          if (e.target.matches('[data-level]')) {
            e.preventDefault();
            e.stopPropagation();
            
            const targetLevel = e.target.getAttribute('data-level');
            const regionId = e.target.getAttribute('data-region-id');
            const cityId = e.target.getAttribute('data-city-id');
            const poiId = e.target.getAttribute('data-poi-id');
            
            console.log('Breadcrumb navigation:', { targetLevel, regionId, cityId, poiId });
            
            // Создаем состояние для навигации
            const state = { level: targetLevel };
            if (regionId) state.regionId = regionId;
            if (cityId) state.cityId = cityId;
            if (poiId) state.poiId = poiId;
            
            // Обновляем историю и рендерим
            history.pushState(state, '');
            renderFromState(state);
          }
        };
        
        document.addEventListener('click', window.breadcrumbHandler);
      }

      // Объединённый обработчик событий для навигации и действий
      function setupUnifiedClickHandler() {
        console.log('Setting up unified click handler...');
        
        // Удаляем предыдущие обработчики
        if (window.unifiedClickHandler) {
          document.removeEventListener('click', window.unifiedClickHandler);
        }
        
        window.unifiedClickHandler = async function(e) {
          console.log('Click detected on:', e.target, 'tagName:', e.target.tagName, 'className:', e.target.className);
          
          // 1. Сначала проверяем кнопки действий
          const actionBtn = e.target.closest('button[data-act]');
          if (actionBtn) {
            e.preventDefault();
            e.stopPropagation();
            await handleActionButton(actionBtn);
            return; 
          }
          
          // 2. Затем проверяем навигацию
          const navElement = e.target.closest('[data-go]');
          if (navElement && navElement.closest('#db_cards')) {
            e.preventDefault();
            await handleNavigation(navElement);
            return;
          }
          
          // 3. Игнорируем клики по хлебным крошкам (они обрабатываются отдельно)
          if (e.target.closest('[data-level]')) {
            return;
          }
        };
        
        document.addEventListener('click', window.unifiedClickHandler);
      }
      
      // Обработчик кнопок действий
      async function handleActionButton(btn) {
        const act = btn.getAttribute('data-act');
        const id = btn.getAttribute('data-id');
        
        console.log('Action button clicked:', { act, id });
        
        if (act === 'edit-region') {
          const r = regions.find(x=>x.business_id===id); 
          if(!r) return; 
          const n=prompt('Название региона:', r.name); 
          if(n){
            const old = r.name; 
            r.name=n.trim(); 
            renderRegions();
            try{
              await fetch('/api/db-sync.php',{
                method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
                body: JSON.stringify({ scope:'regions', action:'update', data:{ id: r.id, name: r.name } })
              }).then(async res=>{ if(!res.ok){ throw new Error('HTTP '+res.status); } const j=await res.json(); if(!j.ok) throw new Error(j.error||'Airtable'); });
              if (window.osNotify) window.osNotify('Обновлено','Регион переименован');
            }catch(e){ r.name = old; renderRegions(); alert('Не удалось сохранить: '+(e && e.message ? e.message : '')); }
          }
        } else if (act === 'del-region') {
          const r = regions.find(x=>x.business_id===id);
          regions = regions.filter(x=>x.business_id!==id); 
          delete citiesByRegion[selectedRegion.business_id]; 
          renderRegions();
          if (r) deleteRegionOnServer(r);
        } else if (act === 'edit-city') {
          const list = citiesByRegion[selectedRegion.business_id]||[]; 
          const c=list.find(x=>x.business_id===id); 
          if(!c) return; 
          const n=prompt('Название города/локации:', c.name); 
          if(n){
            const old=c.name; 
            c.name=n.trim(); 
            await renderCities();
            try{
              await fetch('/api/db-sync.php',{
                method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
                body: JSON.stringify({ scope:'cities', action:'update', data:{ id: c.id, name: c.name } })
              }).then(async res=>{ if(!res.ok){ throw new Error('HTTP '+res.status); } const j=await res.json(); if(!j.ok) throw new Error(j.error||'Airtable'); });
              if (window.osNotify) window.osNotify('Обновлено','Название сохранено');
            }catch(e){ c.name=old; await renderCities(); alert('Не удалось сохранить: '+(e && e.message ? e.message : '')); }
          }
        } else if (act === 'del-city') {
          const list = citiesByRegion[selectedRegion.business_id]||[]; 
          citiesByRegion[selectedRegion.business_id] = list.filter(x=>x.business_id!==id); 
          delete poisByCity[selectedCity.business_id]; 
          await renderCities();
        } else if (act === 'edit-poi') {
          // Открываем форму редактирования POI
          const list = poisByCity[selectedCity.business_id]||[];
          const poi = list.find(x=>x.business_id===id);
          if (!poi) return;
          
          const formData = await openCreatePOIModal(poi);
          if (!formData) return;
          
          try {
            // Показываем индикатор сохранения
            cards.innerHTML = '<div class="flex items-center justify-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i><span class="ml-3 text-gray-600">Сохранение POI...</span></div>';
            
            // СОХРАНЕНИЕ В БД И AIRTABLE через API
            console.log('💾 Сохранение POI через API...', formData);
            
            const saveResponse = await fetch('/api/save-poi.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id: poi.id,
                airtable_id: poi.airtable_id,
                business_id: poi.poi_id || poi.business_id,
                name_ru: formData.name_ru,
                name_en: formData.name_en,
                prefecture_ru: formData.pref_ru,
                prefecture_en: formData.pref_en,
                categories_ru: formData.cats_ru,
                categories_en: formData.cats_en,
                place_id: formData.place_id,
                website: formData.website,
                working_hours: formData.hours,
                description_ru: formData.desc_ru,
                description_en: formData.desc_en,
                notes: formData.notes,
                published: formData.published,
                tickets: formData.tickets,
                city_id: selectedCity.id,
                region_id: selectedRegion.id
              })
            });
            
            const result = await saveResponse.json();
            console.log('💾 Результат сохранения:', result);
            
            if (!result.ok) {
              throw new Error(result.error || 'Ошибка сохранения в БД');
            }
            
            // ПОСЛЕ успешного сохранения обновляем локальные данные
            Object.assign(poi, {
              name: formData.name_ru,
              name_en: formData.name_en,
              type: formData.cats_ru[0] || poi.type,
              categories_ru: formData.cats_ru,
              categories_en: formData.cats_en,
              prefecture_ru: formData.pref_ru,
              prefecture_en: formData.pref_en,
              place_id: formData.place_id,
              website: formData.website,
              hours: formData.hours,
              description_ru: formData.desc_ru,
              description_en: formData.desc_en,
              published: formData.published,
              notes: formData.notes,
              tickets: formData.tickets
            });
            
            console.log('✅ Локальные данные обновлены');
            
            // Перерисовываем карточки
              await renderPois();
            
            // Уведомление об успехе
            if (window.osNotify) window.osNotify('✅ Успешно', 'POI обновлен');
            
          } catch (e) {
            console.error('❌ Ошибка сохранения POI:', e);
            alert('❌ Не удалось сохранить POI: ' + (e.message || 'Неизвестная ошибка'));
            // Перерисовываем с исходными данными
            await renderPois();
          }
        } else if (act === 'del-poi') {
          const list = poisByCity[selectedCity.business_id]||[]; 
          poisByCity[selectedCity.business_id] = list.filter(x=>x.business_id!==id); 
          delete ticketsByPoi[selectedPoi.business_id]; 
          await renderPois();
        } else if (act === 'view-tickets') {
          // Переходим к билетам POI
          const list = poisByCity[selectedCity.business_id]||[];
          selectedPoi = list.find(x=>x.business_id===id) || null;
          if (selectedPoi) {
            push('tickets', { regionId: (selectedRegion ? selectedRegion.business_id : null), cityId: (selectedCity ? selectedCity.business_id : null), poiId: (selectedPoi ? selectedPoi.business_id : null) });
            renderTickets();
          }
        }
      }
      
      // Обработчик навигации с проверками состояния
      async function handleNavigation(navElement) {
        const id = navElement.getAttribute('data-id');
        const to = navElement.getAttribute('data-go');
        
        console.log('Navigation triggered:', {to, id, element: navElement});
        
        try {
          if (to === 'cities') {
            await navigateToCities(id);
          } else if (to === 'pois') {
            await navigateToPOIs(id);
          } else if (to === 'tickets') {
            await navigateToTickets(id);
          }
        } catch (error) {
          console.error('Navigation error:', error);
          showErrorState('Ошибка навигации: ' + error.message);
        }
      }
      
      // Навигация к городам с проверками
      async function navigateToCities(regionId) {
        console.log('Navigating to cities for region:', regionId);
        
        // Проверяем что регион существует (ищем по business_id)
        const region = regions.find(r => r.business_id === regionId);
        if (!region) {
          console.error('Region not found:', regionId);
          showErrorState('Регион не найден');
          return;
        }
          
        // Обновляем состояние
        selectedRegion = region;
        selectedCity = null;
        selectedPoi = null;
        
        // Обновляем UI
        level = 'cities';
        renderCrumbs();
        setMappingHeader('city');
        
        // Показываем loading
        showLoadingState('Загрузка городов...');
        
        try {
          // Загружаем города если нужно
          if (!citiesByRegion[region.business_id] || citiesByRegion[region.business_id].length === 0) {
            await loadCitiesForRegion(region);
          }
          
          // Загружаем счетчики POI в фоне
          loadCityCounts(region.business_id);
          
          // Рендерим города
          renderCities();
          
          // Обновляем историю
          push('cities', { regionId });
          
        } catch (error) {
          console.error('Error loading cities:', error);
          showErrorState('Ошибка загрузки городов');
        }
      }
      
      // Навигация к POI с проверками
      async function navigateToPOIs(cityId) {
        console.log('Navigating to POIs for city:', cityId);
        
        // Проверяем что регион выбран
        if (!selectedRegion) {
          console.error('No region selected');
          showErrorState('Регион не выбран');
          return;
        }
        
        // Проверяем что город существует
        const city = citiesByRegion[selectedRegion.business_id]?.find(c => c.business_id === cityId);
        if (!city) {
          console.error('City not found:', cityId);
          showErrorState('Город не найден');
          return;
        }
        
        // Обновляем состояние
        selectedCity = city;
        selectedPoi = null;
        
        // Обновляем UI
        level = 'pois';
        renderCrumbs();
        setMappingHeader('poi');
        
        // Показываем loading
        showLoadingState('Загрузка POI...');
        
        try {
          // Загружаем POI если нужно
          if (!poisByCity[cityId] || poisByCity[cityId].length === 0) {
            await loadPoisForCity(city);
          }
          
          // Рендерим POI
          renderPois();
          
          // Обновляем историю
          push('pois', { regionId: selectedRegion.business_id, cityId });
          
        } catch (error) {
          console.error('Error loading POIs:', error);
          showErrorState('Ошибка загрузки POI');
        }
      }
      
      // Навигация к билетам с проверками
      async function navigateToTickets(poiId) {
        console.log('Navigating to tickets for POI:', poiId);
        
        // Проверяем что город выбран
        if (!selectedCity) {
          console.error('No city selected');
          showErrorState('Город не выбран');
          return;
        }
        
        // Проверяем что POI существует
        const poi = poisByCity[selectedCity.business_id]?.find(p => p.business_id === poiId);
        if (!poi) {
          console.error('POI not found:', poiId);
          showErrorState('POI не найден');
          return;
        }
        
        // Обновляем состояние
        selectedPoi = poi;
        
        // Обновляем UI
        level = 'tickets';
        renderCrumbs();
        setMappingHeader('ticket');
        
        // Рендерим билеты
        renderTickets();
        
        // Обновляем историю
        push('tickets', { regionId: selectedRegion.business_id, cityId: selectedCity.business_id, poiId });
      }
      
      // Вспомогательные функции для UI состояний
      function showLoadingState(message = 'Загрузка...') {
        cards.innerHTML = `
          <div class="flex items-center justify-center py-12">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
            <span class="ml-3 text-gray-600">${message}</span>
          </div>
        `;
      }
      
      function showErrorState(message) {
        cards.innerHTML = `
          <div class="text-center text-red-500 py-12">
            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
            <div>${message}</div>
            <button onclick="location.reload()" class="mt-4 btn-japanese">Перезагрузить</button>
          </div>
        `;
      }

      // Функция настройки обработчика кнопок действий (Edit/Delete)
      function setupActionButtonsHandler() {
        console.log('Setting up action buttons handler...');
        
        // Удаляем предыдущий обработчик если он был
        if (window.actionButtonsHandler) {
          document.removeEventListener('click', window.actionButtonsHandler);
        }
        
        window.actionButtonsHandler = async function(e) {
          // Ищем кнопку с data-act
          const btn = e.target.closest('button[data-act]');
          if (!btn) return;
          
        e.preventDefault();
          e.stopPropagation();
          
          const act = btn.getAttribute('data-act');
          const id = btn.getAttribute('data-id');
          
          console.log('Action button clicked:', { act, id });
          
          if (act === 'edit-region') {
            await editRegion(id);
          } else if (act === 'del-region') {
            await deleteRegion(id);
          } else if (act === 'edit-city') {
            await editCity(id);
          } else if (act === 'del-city') {
            await deleteCity(id);
          } else if (act === 'edit-poi') {
            await editPoi(id);
          } else if (act === 'del-poi') {
            await deletePoi(id);
          } else if (act === 'edit-ticket') {
            await editTicket(id);
          } else if (act === 'del-ticket') {
            await deleteTicket(id);
          }
        };
        
        document.addEventListener('click', window.actionButtonsHandler);
      } // Конец функции setupActionButtonsHandler

      // Breadcrumbs обработчик удален - теперь используется setupBreadcrumbHandler

      // Back button
      document.getElementById('db_back')?.addEventListener('click', async function(){
        if (level==='cities') return renderRegions();
        if (level==='pois') return await renderCities();
        if (level==='poi-details') return await renderPois();
        if (level==='tickets') return await renderPois();
      });

      // Card action buttons
      cards.addEventListener('click', async function(e){
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        e.stopPropagation();
        const act = btn.getAttribute('data-act');
        const id = btn.getAttribute('data-id');
        if (act==='edit-region'){
          const r = regions.find(x=>x.business_id===id); if(!r) return; const n=prompt('Название региона:', r.name); if(n){
            const old = r.name; r.name=n.trim(); renderRegions();
            try{
              await fetch('/api/db-sync.php',{
                method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
                body: JSON.stringify({ scope:'regions', action:'update', data:{ id: r.id, name: r.name } })
              }).then(async res=>{ if(!res.ok){ throw new Error('HTTP '+res.status); } const j=await res.json(); if(!j.ok) throw new Error(j.error||'Airtable'); });
              if (window.osNotify) window.osNotify('Обновлено','Регион переименован');
            }catch(e){ r.name = old; renderRegions(); alert('Не удалось сохранить: '+(e && e.message ? e.message : '')); }
          }
        } else if (act==='del-region'){
          const r = regions.find(x=>x.business_id===id);
          regions = regions.filter(x=>x.business_id!==id); delete citiesByRegion[selectedRegion.business_id]; renderRegions();
          if (r) deleteRegionOnServer(r);
        } else if (act==='edit-city'){
          const list = citiesByRegion[selectedRegion.business_id]||[]; const c=list.find(x=>x.business_id===id); if(!c) return; const n=prompt('Название города/локации:', c.name); if(n){
            const old=c.name; c.name=n.trim(); await renderCities();
            try{
              await fetch('/api/db-sync.php',{
                method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
                body: JSON.stringify({ scope:'cities', action:'update', data:{ id: c.id, name: c.name } })
              }).then(async res=>{ if(!res.ok){ throw new Error('HTTP '+res.status); } const j=await res.json(); if(!j.ok) throw new Error(j.error||'Airtable'); });
              if (window.osNotify) window.osNotify('Обновлено','Название сохранено');
            }catch(e){ c.name=old; await renderCities(); alert('Не удалось сохранить: '+(e && e.message ? e.message : '')); }
          }
        } else if (act==='del-city'){
          const list = citiesByRegion[selectedRegion.business_id]||[]; citiesByRegion[selectedRegion.business_id] = list.filter(x=>x.business_id!==id); delete poisByCity[selectedCity.business_id]; await renderCities();
        } else if (act==='edit-poi'){
            // Открываем форму редактирования POI
            const list = poisByCity[selectedCity.business_id]||[];
            const poi = list.find(x=>x.business_id===id);
            if (!poi) return;
            
            const formData = await openCreatePOIModal(poi);
            if (!formData) return;
            
            try {
              // Показываем индикатор сохранения
              cards.innerHTML = '<div class="flex items-center justify-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i><span class="ml-3 text-gray-600">Сохранение POI...</span></div>';
              
              // СОХРАНЕНИЕ В БД И AIRTABLE через API
              console.log('💾 Сохранение POI через API...', formData);
              
              const saveResponse = await fetch('/api/save-poi.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  id: poi.id,
                  airtable_id: poi.airtable_id,
                  business_id: poi.poi_id || poi.business_id,
                  name_ru: formData.name_ru,
                  name_en: formData.name_en,
                  prefecture_ru: formData.pref_ru,
                  prefecture_en: formData.pref_en,
                  categories_ru: formData.cats_ru,
                  categories_en: formData.cats_en,
                  place_id: formData.place_id,
                  website: formData.website,
                  working_hours: formData.hours,
                  description_ru: formData.desc_ru,
                  description_en: formData.desc_en,
                  notes: formData.notes,
                  published: formData.published,
                  tickets: formData.tickets,
                  city_id: selectedCity.id,
                  region_id: selectedRegion.id
                })
              });
              
              const result = await saveResponse.json();
              console.log('💾 Результат сохранения:', result);
              
              if (!result.ok) {
                throw new Error(result.error || 'Ошибка сохранения в БД');
              }
              
              // ПОСЛЕ успешного сохранения обновляем локальные данные
              Object.assign(poi, {
                name: formData.name_ru,
                name_en: formData.name_en,
                type: formData.cats_ru[0] || poi.type,
                categories_ru: formData.cats_ru,
                categories_en: formData.cats_en,
                prefecture_ru: formData.pref_ru,
                prefecture_en: formData.pref_en,
                place_id: formData.place_id,
                website: formData.website,
                hours: formData.hours,
                description_ru: formData.desc_ru,
                description_en: formData.desc_en,
                published: formData.published,
                notes: formData.notes,
                tickets: formData.tickets
              });
              
              console.log('✅ Локальные данные обновлены');
              
              // Перерисовываем карточки
                await renderPois();
              
              // Уведомление об успешном сохранении
              if (window.osNotify) {
                const syncStatus = result.airtable_synced ? 'и синхронизирован с Airtable' : '';
                window.osNotify('✅ POI сохранён', `${formData.name_ru} обновлён в БД ${syncStatus}`);
              } else {
                alert(`✅ POI "${formData.name_ru}" успешно сохранён!\n\n` +
                      `📊 Статистика:\n` +
                      `- Сохранено в локальную БД: Да\n` +
                      `- Синхронизировано с Airtable: ${result.airtable_synced ? 'Да' : 'Нет'}\n` +
                      `- Билетов сохранено: ${result.tickets_saved || 0}`);
              }
              
            } catch(e) {
              console.error('❌ Ошибка сохранения POI:', e);
              alert('❌ Не удалось сохранить POI: ' + (e.message || 'Неизвестная ошибка'));
              // Перерисовываем с исходными данными
              await renderPois();
            }
            return;
        } else if (act==='view-tickets'){
          // Переходим к билетам POI
          const list = poisByCity[selectedCity.business_id]||[];
          selectedPoi = list.find(x=>x.business_id===id) || null;
          if (selectedPoi) {
            push('tickets', { regionId: (selectedRegion ? selectedRegion.business_id : null), cityId: (selectedCity ? selectedCity.business_id : null), poiId: (selectedPoi ? selectedPoi.business_id : null) });
            renderTickets();
          }
        } else if (act==='del-poi'){
          const list = poisByCity[selectedCity.business_id]||[]; poisByCity[selectedCity.business_id] = list.filter(x=>x.business_id!==id); delete ticketsByPoi[selectedPoi.business_id]; await renderPois();
        } else if (act==='edit-ticket'){
          const list = ticketsByPoi[selectedPoi.business_id]||[]; const t = list.find(x=>x.business_id===id); if(!t) return; const c=prompt('Категория:', t.category)||t.category; const p=prompt('Цена (¥):', String(t.price))||String(t.price); const n=prompt('Примечание:', t.note||'')||t.note; t.category=c.trim(); t.price=parseInt(p,10)||t.price; t.note=n.trim(); renderTickets();
        } else if (act==='del-ticket'){
          const list = ticketsByPoi[selectedPoi.business_id]||[]; ticketsByPoi[selectedPoi.business_id] = list.filter(x=>x.business_id!==id); renderTickets();
        }
      });

      // Floating add button
      function genId(prefix, n){ return prefix+'-'+String(n).padStart(3,'0'); }

      // Модальное окно создания региона (RU/EN)
      function openCreateRegionModal(){
        return new Promise(resolve=>{
          const wrap = document.createElement('div');
          wrap.className = 'fixed inset-0 z-50 flex items-center justify-center';
          wrap.innerHTML = '\
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
            <div class="relative bg-white rounded-lg shadow-xl p-6 w-96">\
              <div class="text-lg text-gray-800 mb-4">Новый регион</div>\
              <div class="space-y-3">\
                <input id="cr_ru" class="input-japanese w-full" placeholder="Название (RU)"/>\
                <input id="cr_en" class="input-japanese w-full" placeholder="Название (EN)"/>\
              </div>\
              <div class="mt-5 flex justify-end gap-2">\
                <button id="cr_cancel" class="btn-japanese">Отмена</button>\
                <button id="cr_ok" class="btn-japanese accent">Сохранить</button>\
              </div>\
            </div>';
          document.body.appendChild(wrap);
          function done(val){ try{ document.body.removeChild(wrap); }catch{} resolve(val||null); }
          wrap.addEventListener('click', e=>{ if (e.target===wrap.firstChild) done(null); });
          wrap.querySelector('#cr_cancel').addEventListener('click', ()=>done(null));
          wrap.querySelector('#cr_ok').addEventListener('click', ()=>{
            const ru = wrap.querySelector('#cr_ru').value.trim();
            const en = wrap.querySelector('#cr_en').value.trim();
            if (!ru || !en){ alert('Заполните оба поля'); return; }
            done({ ru, en });
          });
          wrap.querySelector('#cr_ru').focus();
        });
      }
        
      // Детальная карточка POI больше не используется (заменена прямым входом в форму)
      function showPOIDetailsModal(poi) {
        console.warn('showPOIDetailsModal is deprecated. Opening edit modal instead.');
        // Открываем сразу форму редактирования
        openCreatePOIModal(poi);
        return;
      }
      
      // Функция для показа билетов POI
      window.showTicketsForPOI = function(poiId) {
        // Закрываем текущее модальное окно
        document.querySelector('.fixed')?.remove();
        
        // Переходим к билетам
        const list = poisByCity[selectedCity.business_id] || [];
        selectedPoi = list.find(p=>p.business_id===poiId) || null;
        push('tickets', { regionId: (selectedRegion ? selectedRegion.business_id : null), cityId: (selectedCity ? selectedCity.business_id : null), poiId: (selectedPoi ? selectedPoi.business_id : null) });
        renderTickets();
      };
      
      // Функция для сохранения записи POI (экспорт в JSON)
      window.savePOIRecord = function(poiId) {
        const list = poisByCity[selectedCity.business_id] || [];
        const poi = list.find(p=>p.business_id===poiId) || null;
        if (!poi) return;
        
        // Создаем объект для экспорта
        const exportData = {
          poi_id: poi.poi_id || poi.id,
          name_ru: poi.name,
          name_en: poi.name_en,
          category: poi.type,
          place_id: poi.place_id,
          website: poi.website,
          hours: poi.hours,
          description_ru: poi.description_ru,
          description_en: poi.description_en,
          published: poi.published,
          city: selectedCity.name,
          region: selectedRegion.name,
          exported_at: new Date().toISOString()
        };
        
        // Скачиваем как JSON файл
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `poi-${poi.poi_id || poi.id}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        if (window.osNotify) {
          window.osNotify('Запись сохранена', `Файл poi-${poi.poi_id || poi.id}.json скачан`);
        }
      };

      // Функция для редактирования POI отключена — редактирование только через отдельное создание/редактирование
      window.editPOI = async function() {
        console.log('editPOI disabled: use dedicated create/edit modal from toolbar');
        return;
      };

      // Модальное окно создания/редактирования POI
      function openCreatePOIModal(editData = null){
          return new Promise(resolve=>{
            const isEdit = !!editData;
            const wrap = document.createElement('div');
            wrap.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 overflow-y-auto';
            wrap.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            // Все 47 префектур Японии
            const prefectures = [
              // Хоккайдо
              {value: 'hokkaido', ru: 'Хоккайдо', en: 'Hokkaido'},
              // Тохоку
              {value: 'aomori', ru: 'Аомори', en: 'Aomori'},
              {value: 'iwate', ru: 'Иватэ', en: 'Iwate'},
              {value: 'miyagi', ru: 'Мияги', en: 'Miyagi'},
              {value: 'akita', ru: 'Акита', en: 'Akita'},
              {value: 'yamagata', ru: 'Ямагата', en: 'Yamagata'},
              {value: 'fukushima', ru: 'Фукусима', en: 'Fukushima'},
              // Канто
              {value: 'ibaraki', ru: 'Ибараки', en: 'Ibaraki'},
              {value: 'tochigi', ru: 'Тотиги', en: 'Tochigi'},
              {value: 'gunma', ru: 'Гумма', en: 'Gunma'},
              {value: 'saitama', ru: 'Сайтама', en: 'Saitama'},
              {value: 'chiba', ru: 'Тиба', en: 'Chiba'},
              {value: 'tokyo', ru: 'Токио', en: 'Tokyo'},
              {value: 'kanagawa', ru: 'Канагава', en: 'Kanagawa'},
              // Тюбу
              {value: 'niigata', ru: 'Ниигата', en: 'Niigata'},
              {value: 'toyama', ru: 'Тояма', en: 'Toyama'},
              {value: 'ishikawa', ru: 'Исикава', en: 'Ishikawa'},
              {value: 'fukui', ru: 'Фукуи', en: 'Fukui'},
              {value: 'yamanashi', ru: 'Яманаси', en: 'Yamanashi'},
              {value: 'nagano', ru: 'Нагано', en: 'Nagano'},
              {value: 'gifu', ru: 'Гифу', en: 'Gifu'},
              {value: 'shizuoka', ru: 'Сидзуока', en: 'Shizuoka'},
              {value: 'aichi', ru: 'Айти', en: 'Aichi'},
              // Кансай
              {value: 'mie', ru: 'Миэ', en: 'Mie'},
              {value: 'shiga', ru: 'Сига', en: 'Shiga'},
              {value: 'kyoto', ru: 'Киото', en: 'Kyoto'},
              {value: 'osaka', ru: 'Осака', en: 'Osaka'},
              {value: 'hyogo', ru: 'Хёго', en: 'Hyogo'},
              {value: 'nara', ru: 'Нара', en: 'Nara'},
              {value: 'wakayama', ru: 'Вакаяма', en: 'Wakayama'},
              // Тюгоку
              {value: 'tottori', ru: 'Тоттори', en: 'Tottori'},
              {value: 'shimane', ru: 'Симанэ', en: 'Shimane'},
              {value: 'okayama', ru: 'Окаяма', en: 'Okayama'},
              {value: 'hiroshima', ru: 'Хиросима', en: 'Hiroshima'},
              {value: 'yamaguchi', ru: 'Ямагути', en: 'Yamaguchi'},
              // Сикоку
              {value: 'tokushima', ru: 'Токусима', en: 'Tokushima'},
              {value: 'kagawa', ru: 'Кагава', en: 'Kagawa'},
              {value: 'ehime', ru: 'Эхимэ', en: 'Ehime'},
              {value: 'kochi', ru: 'Коти', en: 'Kochi'},
              // Кюсю
              {value: 'fukuoka', ru: 'Фукуока', en: 'Fukuoka'},
              {value: 'saga', ru: 'Сага', en: 'Saga'},
              {value: 'nagasaki', ru: 'Нагасаки', en: 'Nagasaki'},
              {value: 'kumamoto', ru: 'Кумамото', en: 'Kumamoto'},
              {value: 'oita', ru: 'Оита', en: 'Oita'},
              {value: 'miyazaki', ru: 'Миядзаки', en: 'Miyazaki'},
              {value: 'kagoshima', ru: 'Кагосима', en: 'Kagoshima'},
              // Окинава
              {value: 'okinawa', ru: 'Окинава', en: 'Okinawa'}
            ];
            
            const categories_ru = ['Синтоистское святилище', 'Буддийский храм', 'Архитектурный объект', 'Музей', 'Арт-пространство / Галерея', 'Смотровая площадка', 'Ландшафтный сад / Парк', 'Достопримечательность', 'Историческое место', 'Японский отель', 'Развлечения', 'Шоппинг', 'Термальный источник', 'СПА'];
            const categories_en = ['Shinto Shrine', 'Buddhist Temple', 'Architectural Object', 'Museum', 'Art Venue', 'Viewing Spot', 'Park/Garden', 'City Attraction', 'Historical Location', 'Restaurant', 'Amusement', 'Shopping', 'Hot Spring', 'SPA'];
            
            wrap.innerHTML = `
              <div class="absolute inset-0" onclick="this.parentElement.querySelector('#poi_cancel').click()"></div>
              <div class="relative bg-white rounded-xl shadow-2xl p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-lg font-medium text-gray-800">${isEdit ? 'Редактировать POI' : 'Новый POI'}</h3>
                  <button id="poi_close" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                
                <form id="poi_form" class="space-y-3">
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    <!-- Левая колонка -->
                    <div class="space-y-3">
                      <!-- Основная информация -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2 flex items-center">
                          <i class="fas fa-info-circle mr-1 text-blue-600 text-xs"></i>
                          Основная информация
                        </h4>
                        <div class="grid grid-cols-1 gap-2">
                          <div>
                            <label class="block text-xs font-medium text-gray-700">
                              Название (RU) <span class="text-red-500">*</span>
                            </label>
                            <input id="poi_name_ru" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="На русском" required
                                  value="${editData ? editData.name : ''}">
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">
                              Name (EN) <span class="text-red-500">*</span>
                            </label>
                            <input id="poi_name_en" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="In English" required
                                  value="${editData ? editData.name_en || '' : ''}">
                          </div>
                          <div class="grid grid-cols-2 gap-2">
                            <div>
                              <label class="block text-xs font-medium text-gray-700">
                                Префектура <span class="text-red-500">*</span>
                              </label>
                              <select id="poi_pref_ru" class="input-japanese w-full text-sm py-1" required>
                                <option value="">Выберите</option>
                                ${prefectures.map(p => `<option value="${p.value}">${p.ru}</option>`).join('')}
                              </select>
                            </div>
                            <div>
                              <label class="block text-xs font-medium text-gray-700">
                                Prefecture <span class="text-red-500">*</span>
                              </label>
                              <select id="poi_pref_en" class="input-japanese w-full text-sm py-1" required>
                                <option value="">Select</option>
                                ${prefectures.map(p => `<option value="${p.value}">${p.en}</option>`).join('')}
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Google интеграция и контент -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2">
                          <i class="fab fa-google mr-1 text-blue-600 text-xs"></i>
                          Google & Контент
                        </h4>
                        <div class="space-y-2">
                          <div>
                            <label class="block text-xs font-medium text-gray-700">Google Place ID</label>
                            <input id="poi_place_id" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="ChIJ..." pattern="^[A-Za-z0-9_-]{25,}$">
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">Сайт</label>
                            <input id="poi_website" type="url" class="input-japanese w-full text-sm py-1" 
                                  placeholder="https://...">
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">Часы работы</label>
                            <input id="poi_hours" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="09:00-17:00">
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Правая колонка -->
                    <div class="space-y-3">
                      <!-- Категории -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2">
                          <i class="fas fa-tags mr-1 text-purple-600 text-xs"></i>
                          Категории <span class="text-red-500">*</span>
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                          <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">RU</label>
                            <div class="space-y-1 border border-gray-200 rounded p-2 bg-white" style="max-height: 400px; overflow-y: auto;">
                              ${categories_ru.map((cat) => `
                                <label class="flex items-center text-xs hover:bg-gray-50 px-1 py-0.5 rounded cursor-pointer">
                                  <input type="checkbox" name="cats_ru" value="${cat}" class="mr-2">
                                  <span>${cat}</span>
                                </label>
                              `).join('')}
                            </div>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">EN</label>
                            <div class="space-y-1 border border-gray-200 rounded p-2 bg-white" style="max-height: 400px; overflow-y: auto;">
                              ${categories_en.map((cat) => `
                                <label class="flex items-center text-xs hover:bg-gray-50 px-1 py-0.5 rounded cursor-pointer">
                                  <input type="checkbox" name="cats_en" value="${cat}" class="mr-2">
                                  <span>${cat}</span>
                                </label>
                              `).join('')}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Описания -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2">
                          <i class="fas fa-align-left mr-1 text-green-600 text-xs"></i>
                          Описания
                        </h4>
                        <div class="space-y-2">
                          <div>
                            <label class="block text-xs font-medium text-gray-700">Описание (RU)</label>
                            <textarea id="poi_desc_ru" class="input-japanese w-full text-sm py-1" rows="3"
                                      placeholder="Краткое описание"></textarea>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">Description (EN)</label>
                            <textarea id="poi_desc_en" class="input-japanese w-full text-sm py-1" rows="3"
                                      placeholder="Brief description"></textarea>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Билеты - на всю ширину -->
                  <div class="bg-gray-50 rounded p-3">
                    <div class="flex items-center justify-between mb-2">
                      <h4 class="text-xs font-medium text-gray-700 flex items-center">
                        <i class="fas fa-ticket-alt mr-1 text-indigo-600 text-xs"></i>
                        Билеты
                        <span class="ml-2 text-xs text-gray-500 font-normal">(необязательно - для бесплатных локаций оставьте пустым)</span>
                      </h4>
                      <button type="button" id="add-ticket-btn" class="btn-japanese text-xs py-1 px-2">
                        <i class="fas fa-plus mr-1"></i>Добавить билет
                      </button>
                    </div>
                    <div id="tickets-container" class="space-y-2"></div>
                  </div>
                  
                  <!-- Публикация и заметки - внизу на всю ширину -->
                  <div class="bg-gray-50 rounded p-3">
                    <div class="flex items-center justify-between">
                      <label class="flex items-center">
                        <input id="poi_published" type="checkbox" class="mr-2">
                        <span class="text-sm text-gray-700">Опубликовать</span>
                      </label>
                      <div class="flex-1 ml-4">
                        <input id="poi_notes" type="text" class="input-japanese w-full text-sm py-1" 
                              placeholder="Заметки (внутренние)">
                      </div>
                    </div>
                  </div>
                </form>
                
                <div class="mt-4 flex justify-end gap-2">
                  <button id="poi_cancel" class="btn-japanese text-sm py-1 px-3">Отмена</button>
                  <button id="poi_save" class="btn-japanese accent text-sm py-1 px-3">
                    <i class="fas fa-save mr-1"></i>
                    ${isEdit ? 'Обновить' : 'Создать'}
                  </button>
                </div>
              </div>
            `;
            
            document.body.appendChild(wrap);
            
            // Синхронизация префектур RU ↔ EN
            const prefRu = wrap.querySelector('#poi_pref_ru');
            const prefEn = wrap.querySelector('#poi_pref_en');
            prefRu.addEventListener('change', () => { prefEn.value = prefRu.value; });
            prefEn.addEventListener('change', () => { prefRu.value = prefEn.value; });
            
            // Синхронизация категорий RU ↔ EN (парная логика)
            const catsRu = wrap.querySelectorAll('input[name="cats_ru"]');
            const catsEn = wrap.querySelectorAll('input[name="cats_en"]');
            
            catsRu.forEach((cbRu, index) => {
              cbRu.addEventListener('change', () => {
                if (catsEn[index]) {
                  catsEn[index].checked = cbRu.checked;
                }
              });
            });
            
            catsEn.forEach((cbEn, index) => {
              cbEn.addEventListener('change', () => {
                if (catsRu[index]) {
                  catsRu[index].checked = cbEn.checked;
                }
              });
            });
            
            // Управление билетами
            const ticketsContainer = wrap.querySelector('#tickets-container');
            const addTicketBtn = wrap.querySelector('#add-ticket-btn');
            let ticketCounter = 0;
            
            const ticketTypes = [
              {value: 'infant', label: 'Infant 0-5', label_ru: 'Младенец 0-5'},
              {value: 'primary', label: 'Primary School 6-11', label_ru: 'Начальная школа 6-11'},
              {value: 'middle', label: 'Middle School 13-15', label_ru: 'Средняя школа 13-15'},
              {value: 'adult_16_60', label: 'Adult 16-60', label_ru: 'Взрослый 16-60'},
              {value: 'adult_16_64', label: 'Adult 16-64', label_ru: 'Взрослый 16-64'},
              {value: 'senior60', label: 'Senior 60+', label_ru: 'Пожилой 60+'},
              {value: 'senior65', label: 'Senior 65+', label_ru: 'Пожилой 65+'},
              {value: 'general', label: 'General Admission', label_ru: 'Общий вход'}
            ];
            
            function addTicketRow(data = null) {
              const ticketId = ticketCounter++;
              const ticketRow = document.createElement('div');
              ticketRow.className = 'ticket-row bg-white border border-gray-200 rounded p-2 flex items-center gap-2';
              ticketRow.dataset.ticketId = ticketId;
              
              ticketRow.innerHTML = `
                <div class="flex-1 grid grid-cols-3 gap-2">
                  <div>
                    <select class="ticket-type input-japanese w-full text-xs py-1" required>
                      <option value="">Выберите тип</option>
                      ${ticketTypes.map(t => `<option value="${t.value}">${t.label_ru} / ${t.label}</option>`).join('')}
                    </select>
                  </div>
                  <div>
                    <input type="number" class="ticket-price input-japanese w-full text-xs py-1" 
                           placeholder="Цена" min="0" step="100" required>
                  </div>
                  <div class="flex items-center gap-2">
                    <select class="ticket-currency input-japanese w-full text-xs py-1">
                      <option value="JPY">¥ JPY</option>
                      <option value="USD">$ USD</option>
                      <option value="EUR">€ EUR</option>
                    </select>
                    <button type="button" class="remove-ticket text-red-500 hover:text-red-700 p-1" 
                            onclick="this.closest('.ticket-row').remove()">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              `;
              
              ticketsContainer.appendChild(ticketRow);
              
              // Заполняем данные если редактирование
              if (data) {
                ticketRow.querySelector('.ticket-type').value = data.category || '';
                ticketRow.querySelector('.ticket-price').value = data.price || '';
                ticketRow.querySelector('.ticket-currency').value = data.currency || 'JPY';
              }
            }
            
            addTicketBtn.addEventListener('click', () => addTicketRow());
            
            // Добавляем минимум один билет по умолчанию
            addTicketRow();
            
            // Обработчики кнопок
            function done(val){ 
              try{ document.body.removeChild(wrap); }catch{} 
              resolve(val||null); 
            }
            
            wrap.querySelector('#poi_close').addEventListener('click', ()=>done(null));
            wrap.querySelector('#poi_cancel').addEventListener('click', ()=>done(null));
            
            wrap.querySelector('#poi_save').addEventListener('click', ()=>{
              const form = wrap.querySelector('#poi_form');
              if (!form.checkValidity()) {
                form.reportValidity();
                return;
              }
              
              const cats_ru = Array.from(wrap.querySelectorAll('input[name="cats_ru"]:checked')).map(cb => cb.value);
              const cats_en = Array.from(wrap.querySelectorAll('input[name="cats_en"]:checked')).map(cb => cb.value);
              
              if (cats_ru.length === 0 || cats_en.length === 0) {
                alert('Выберите хотя бы одну категорию для каждого языка');
                return;
              }
              
              // Сбор данных о билетах (полностью необязательно)
              const ticketRows = wrap.querySelectorAll('.ticket-row');
              const tickets = [];
              
              ticketRows.forEach(row => {
                const type = row.querySelector('.ticket-type').value;
                const price = row.querySelector('.ticket-price').value;
                const currency = row.querySelector('.ticket-currency').value;
                
                // Добавляем билет только если заполнены тип и цена
                if (type && price) {
                  tickets.push({
                    category: type,
                    price: parseInt(price),
                    currency: currency
                  });
                }
              });
              
              // Билеты полностью необязательны - никакой валидации
              
              const data = {
                name_ru: wrap.querySelector('#poi_name_ru').value.trim(),
                name_en: wrap.querySelector('#poi_name_en').value.trim(),
                pref_ru: prefRu.value,
                pref_en: prefEn.value,
                cats_ru: cats_ru,
                cats_en: cats_en,
                place_id: wrap.querySelector('#poi_place_id').value.trim(),
                website: wrap.querySelector('#poi_website').value.trim(),
                hours: wrap.querySelector('#poi_hours').value.trim(),
                desc_ru: wrap.querySelector('#poi_desc_ru').value.trim(),
                desc_en: wrap.querySelector('#poi_desc_en').value.trim(),
                published: wrap.querySelector('#poi_published').checked,
                notes: wrap.querySelector('#poi_notes').value.trim(),
                tickets: tickets
              };
              
              done(data);
            });
            
            // Фокус на первое поле
            wrap.querySelector('#poi_name_ru').focus();
            
            // Если редактирование - заполнить данные
            if (isEdit && editData) {
              // Здесь можно заполнить поля данными для редактирования
              if (editData.type) {
                // Попытаться выбрать соответствующую категорию
                const typeMap = {
                  'культура': 'Культура',
                  'природа': 'Природная достопримечательность',
                  'гастро': 'Гастрономия',
                  'храм': 'Храм',
                  'замок': 'Замок',
                  'музей': 'Музей'
                };
                const catRu = typeMap[editData.type.toLowerCase()] || editData.type;
                const catCheckbox = wrap.querySelector(`input[name="cats_ru"][value="${catRu}"]`);
                if (catCheckbox) catCheckbox.checked = true;
              }
            }
        });
      }

      // Выбор типа (Город/Локация) — модалка с 2 кнопками
      function chooseCityType(){
        if (level !== 'cities') { return Promise.resolve(null); }
        return new Promise((resolve)=>{
          const wrap = document.createElement('div');
          wrap.className = 'fixed inset-0 z-50 flex items-center justify-center';
          wrap.innerHTML = '\
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
            <div class="relative bg-white rounded-lg shadow-xl p-6 w-80">\
              <div class="text-lg text-gray-800 mb-4">Тип записи</div>\
              <div class="grid grid-cols-2 gap-3">\
                <button id="btn_type_city" class="btn-japanese w-full text-center">Город</button>\
                <button id="btn_type_location" class="btn-japanese w-full text-center">Локация</button>\
              </div>\
              <div class="mt-4 text-xs text-gray-500 text-center">Выберите тип записи</div>\
            </div>';
          document.body.appendChild(wrap);
          function done(val){
            document.body.removeChild(wrap);
            resolve(val);
          }
          wrap.querySelector('#btn_type_city').addEventListener('click', function(){ done('city'); });
          wrap.querySelector('#btn_type_location').addEventListener('click', function(){ done('location'); });
          wrap.addEventListener('click', function(e){ if (e.target===wrap.firstChild) { done(null); } });
          document.addEventListener('keydown', function onEsc(ev){ if (ev.key==='Escape'){ document.removeEventListener('keydown', onEsc); try{ document.body.removeChild(wrap); }catch{} resolve(null); } });
        });
      }

      if (fab) fab.addEventListener('click', async function(){
        if (level==='regions'){
          const data = await openCreateRegionModal();
          if (!data) return;
          try{
            const res = await fetch('/api/regions-create.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({ 
                  name_ru: data.ru, 
                  name_en: data.en,
                  base_id: window.AIRTABLE_BASE_ID,
                  table_id: window.AIRTABLE_REGIONS_TABLE_ID
                })
            });
            const j = await res.json().catch(()=>({}));
            if (!res.ok || !j.ok){
              const detailsMsg = (j && (j.details?.error?.message || j.details?.message || j.error)) || ('HTTP '+res.status);
              console.error('REGION_CREATE_ERR', j);
              throw new Error(detailsMsg);
            }
            if (window.osNotify){ window.osNotify('Сохранено','ID: '+j.region_id); } else { alert('Сохранено: '+j.region_id); }
            await syncRegionsFromAirtable();
          }catch(e){ alert('Не удалось сохранить регион: '+(e && e.message ? e.message : '')); }
        } else if (level==='cities'){
          // модалка выбора типа + ввод названия
          const picked = await chooseCityType(); if (!picked) return;
          const wrap = await new Promise(res=>{
            const w = document.createElement('div');
            w.className='fixed inset-0 z-50 flex items-center justify-center';
            w.innerHTML='\
              <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
              <div class="relative bg-white rounded-lg shadow-xl p-6 w-96">\
                <div class="text-lg text-gray-800 mb-4">'+(picked==='location'?'Новая локация':'Новый город')+'</div>\
                <div class="space-y-3">\
                  <input id="nm_ru" class="input-japanese w-full" placeholder="Название (RU)"/>\
                  <input id="nm_en" class="input-japanese w-full" placeholder="Name (EN)"/>\
                </div>\
                <div class="mt-5 flex justify-end gap-2">\
                  <button id="c" class="btn-japanese">Отмена</button>\
                  <button id="o" class="btn-japanese accent">Сохранить</button>\
                </div>\
              </div>';
            document.body.appendChild(w);
            w.querySelector('#c').onclick=()=>{ try{document.body.removeChild(w);}catch{}; res(null); };
            w.querySelector('#o').onclick=()=>{ const ru=w.querySelector('#nm_ru').value.trim(); const en=w.querySelector('#nm_en').value.trim(); if(!ru){alert('Введите название RU');return;} try{document.body.removeChild(w);}catch{}; res({ru,en}); };
            w.addEventListener('click',e=>{ if(e.target===w.firstChild){ try{document.body.removeChild(w);}catch{}; res(null);} });
          });
          if (!wrap) return; const name_ru = wrap.ru; const name_en = wrap.en || wrap.ru;
          try{
            const res = await fetch('/api/cities-create.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({ 
                  name_ru: name_ru, 
                  name_en: name_en, 
                  type: picked, 
                  region_rec_id: selectedRegion.id, 
                  region_name: selectedRegion.name, 
                  region_rid: (selectedRegion.rid||''),
                  base_id: window.AIRTABLE_BASE_ID,
                  table_id: window.AIRTABLE_CITIES_TABLE_ID
                })
            });
            const j = await res.json();
            if (!res.ok || !j.ok) throw new Error((j && (j.error || j.details?.error?.message)) || ('HTTP '+res.status));
            if (window.osNotify){ window.osNotify('Город сохранён', (j.linked? 'Связь с регионом установлена' : 'Создан без связи: проверьте поле связи')); }
            await loadCitiesForRegion(selectedRegion); await preloadPoisCountsForRegion(selectedRegion); await renderCities();
          }catch(e){ alert('Не удалось сохранить: '+(e && e.message ? e.message : '')); }
        } else if (level==='pois'){
            const data = await openCreatePOIModal();
            if (!data) return;
            
            try {
              // Генерируем ID для нового POI в формате POI-00000x
          const list = poisByCity[selectedCity.business_id] || (poisByCity[selectedCity.business_id]=[]);
              const nextNumber = list.length + 1;
              const id = 'POI-' + String(nextNumber).padStart(6, '0');
              
              // Создаем объект POI с полной спецификацией
              const newPoi = {
                id: id,
                name: data.name_ru,
                name_en: data.name_en,
                type: data.cats_ru[0] || 'Другое', // Используем первую категорию как тип
                categories_ru: data.cats_ru,
                categories_en: data.cats_en,
                prefecture_ru: data.pref_ru,
                prefecture_en: data.pref_en,
                place_id: data.place_id,
                website: data.website,
                hours: data.hours,
                description_ru: data.desc_ru,
                description_en: data.desc_en,
                published: data.published,
                notes: data.notes,
                city_id: selectedCity.id,
                region_id: selectedRegion.id
              };
              
              // Добавляем в локальный список
              list.push(newPoi);
              
              // Проверяем, загружен ли window.airtableReg, если нет - загружаем
              if (!window.airtableReg) {
                await loadDbConfig();
              }
              
              // Получаем base_id из конфигурации
              const baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || window.AIRTABLE_BASE_ID;
              
              // Отладочная информация
              console.log('Creating POI with:', {
                baseId: baseId,
                tableId: window.AIRTABLE_POI_TABLE_ID,
                dataExists: !!data,
                constants: {
                  base: window.AIRTABLE_BASE_ID,
                  poi_table: window.AIRTABLE_POI_TABLE_ID
                }
              });
              
              // Подготавливаем данные для Airtable согласно спецификации
              const airtableFields = {
                'POI ID': id,
                'POI Name (RU)': data.name_ru,
                'POI Name (EN)': data.name_en,
                'Regions': [selectedCity.id], // Link to parental Locations/Cities
                'Prefecture (RU)': data.pref_ru,
                'Prefecture (EN)': data.pref_en,
                'Place ID': data.place_id,
                'POI Category (RU)': data.cats_ru,
                'POI Category (EN)': data.cats_en,
                'Working Hours': data.hours,
                'Website': data.website,
                'Description (RU)': data.desc_ru,
                'Description (EN)': data.desc_en,
                'Published': data.published,
                'Notes': data.notes,
                'Tickets': [] // Билеты будут добавляться отдельно через связь с таблицей Tickets
              };
              
              // Отправляем на сервер через новый API
              const res = await fetch('/api/save-poi.php', {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  name_ru: data.name_ru,
                  name_en: data.name_en,
                  prefecture_ru: data.pref_ru,
                  prefecture_en: data.pref_en,
                  categories_ru: data.cats_ru,
                  categories_en: data.cats_en,
                  description_ru: data.desc_ru,
                  description_en: data.desc_en,
                  website: data.website,
                  working_hours: data.hours,
                  notes: data.notes,
                  place_id: data.place_id,
                  city_id: selectedCity.id,
                  region_id: selectedRegion.id
                })
              });
              
              const j = await res.json();
              if (!res.ok || !j.ok) {
                throw new Error((j && j.error) || 'Ошибка сохранения');
              }
              
              // Обновляем локальные данные с полученными ID
              if (j.id) {
                newPoi.id = j.id;
              }
              if (j.business_id) {
                newPoi.business_id = j.business_id;
              }
              
              if (window.osNotify) {
                window.osNotify('POI создан', data.name_ru);
              }
              
          await renderPois();
            } catch(e) {
              alert('Не удалось сохранить POI: ' + (e.message || 'Неизвестная ошибка'));
              // Откатываем изменения
              const list = poisByCity[selectedCity.business_id] || [];
              poisByCity[selectedCity.business_id] = list.filter(p => p.id !== id);
              await renderPois();
            }
        } else if (level==='tickets'){
          const category = prompt('Категория (Adult/Child/Infant/Senior/Special):','Adult')||'Adult';
          const price = parseInt(prompt('Цена (¥):','1000')||'1000',10)||0;
          const note = prompt('Примечание:','')||'';
          const list = ticketsByPoi[selectedPoi.id] || (ticketsByPoi[selectedPoi.id]=[]);
          const id = genId('TKT', list.length+1);
          list.push({ id, category, price, currency:'¥', note });
          renderTickets();
        }
      });

      // Обработчик кнопки синхронизации
      const syncBtn = document.getElementById('db_fab_sync');
      if (syncBtn) {
        syncBtn.addEventListener('click', async function() {
          this.disabled = true;
          this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          
          try {
            console.log('🔄 Синхронизация с Airtable...');
            
            // Сохраняем текущее состояние
            const currentLevel = level;
            const currentRegion = selectedRegion;
            const currentCity = selectedCity;
            
            // Запускаем синхронизацию с Airtable (используем Filtering.md принципы)
            const syncRes = await fetch('/api/sync-airtable-filtering.php', {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' }
            });
            const syncData = await syncRes.json();
            console.log('Результат синхронизации:', syncData);
            
            // Очищаем кэш после успешной синхронизации
            if (syncData.ok) {
              clearAllCache();
              console.log('Кэш очищен после синхронизации');
            }
            
            if (currentLevel === 'cities' && currentRegion) {
              console.log(`📍 Обновляем города для региона: ${currentRegion.name}`);
              
              // Перезагружаем города из серверной БД
              await loadCitiesForRegion(currentRegion, true);
              
              // Предзагружаем POI для подсчета в пилюлях
              const cities = citiesByRegion[currentRegion.business_id] || [];
              for (const city of cities) {
                await loadPoisForCity(city, true);
              }
              
              // Восстанавливаем состояние
              selectedRegion = currentRegion;
              await renderCities();
              console.log(`✅ Обновление городов завершено: ${cities.length} городов`);
              
            } else if (currentLevel === 'pois' && currentCity) {
              console.log(`📍 Обновляем POI для города: ${currentCity.name}`);
              
              // Перезагружаем POI из серверной БД
              await loadPoisForCity(currentCity, true);
              
              // Восстанавливаем состояние
              selectedRegion = currentRegion;
              selectedCity = currentCity;
              await renderPois();
              
              const poiCount = poisByCity[currentCity.id]?.length || 0;
              console.log(`✅ Обновление POI завершено: ${poiCount} POI`);
              
            } else {
              console.log('🌍 Полная синхронизация всех данных...');
              
              // Перезагружаем все данные из серверной БД
              await syncRegionsFromAirtable();
              console.log(`✅ Регионы загружены: ${regions.length}`);
              
              // Перезагружаем города для всех регионов
              for (const region of regions) {
                await loadCitiesForRegion(region, true);
                const cities = citiesByRegion[region.business_id] || [];
                console.log(`✅ Города для ${region.name}: ${cities.length}`);
              }
              
              // Перезагружаем POI для всех городов
              let totalPOI = 0;
              for (const region of regions) {
                const cities = citiesByRegion[region.business_id] || [];
                for (const city of cities) {
                  await loadPoisForCity(city, true);
                  const poiCount = poisByCity[city.business_id]?.length || 0;
                  totalPOI += poiCount;
                }
              }
              
              // Восстанавливаем состояние после полной синхронизации
              if (currentLevel === 'cities' && currentRegion) {
                selectedRegion = currentRegion;
                await renderCities();
              } else if (currentLevel === 'pois' && currentCity && currentRegion) {
                selectedRegion = currentRegion;
                selectedCity = currentCity;
                await renderPois();
              } else {
                renderRegions();
              }
              console.log(`✅ Полная синхронизация завершена: ${totalPOI} POI всего`);
            }
            
            // Успешное завершение
            this.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
              this.innerHTML = '<i class="fas fa-sync-alt"></i>';
            }, 2000);
            
          } catch (error) {
            console.error('❌ Ошибка синхронизации:', error);
            this.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            setTimeout(() => {
              this.innerHTML = '<i class="fas fa-sync-alt"></i>';
            }, 3000);
          } finally {
            this.disabled = false;
          }
        });
      }

      // Автоматическая проверка актуальности данных при загрузке
      window.checkDataFreshness = async function() {
        console.log('Проверка актуальности данных...');
        
        try {
          // Получаем время последнего обновления из Airtable
          const res = await fetch('/api/db-sync.php?v=' + Date.now(), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              scope: 'pois', 
              action: 'list', 
              data: { 
                filter: {},
                limit: 1 // Получаем только одну запись для проверки времени
              } 
            })
          });
          
          const j = await res.json();
          if (j.ok && j.items && j.items.length > 0) {
            const lastRecord = j.items[0];
            const lastModified = lastRecord.createdTime || lastRecord.fields?.LastModified || Date.now();
            
            // Проверяем, нужно ли обновить кэш
            const cacheTime = localStorage.getItem('konstructour_last_sync');
            const shouldRefresh = !cacheTime || (Date.now() - parseInt(cacheTime)) > (30 * 60 * 1000); // 30 минут
            
            if (shouldRefresh) {
              console.log('Данные устарели, обновляем кэш...');
              clearAllCache();
              localStorage.setItem('konstructour_last_sync', Date.now().toString());
              
              // Перезагружаем все данные
              await syncRegionsFromAirtable();
              for (const region of regions) {
                await loadCitiesForRegion(region);
                const cities = citiesByRegion[region.business_id] || [];
                for (const city of cities) {
                  await loadPoisForCity(city);
                }
              }
              
              // Обновляем отображение
              if (level === 'regions') {
                renderRegions();
              } else if (level === 'cities' && selectedRegion) {
                await renderCities();
              } else if (level === 'pois' && selectedCity) {
                await renderPois();
              }
              
              console.log('Данные обновлены автоматически');
            } else {
              console.log('Данные актуальны, используем кэш');
            }
          }
        } catch (error) {
          console.warn('Не удалось проверить актуальность данных:', error);
        }
      };

      // Поля ввода и иконки синхронизации удалены, бинды не требуются

      // History: handle back/forward
      window.addEventListener('popstate', async function(ev){ await renderFromState(ev.state); });
      // Initial state
      history.replaceState({ level: 'regions' }, '');
      
      // Тест обработчика кликов
      console.log('Testing click handler...');
      setTimeout(() => {
        console.log('Click handler test - simulating click on document');
        const testEvent = new MouseEvent('click', { bubbles: true });
        document.dispatchEvent(testEvent);
      }, 1000);
      
      // МГНОВЕННАЯ загрузка - сначала кэш, потом API
      (async function(){
        console.log('⚡ МГНОВЕННАЯ инициализация системы...');
        console.log('⚡ DOM элемент cards:', cards);
        console.log('⚡ DOM элемент crumbs:', crumbs);
        
        // ШАГ 1: МГНОВЕННО загружаем из кэша и рендерим
        console.log('⚡ Проверка кэша localStorage...');
        console.log('⚡ LS_REGIONS_KEY:', LS_REGIONS_KEY);
        const cacheData = localStorage.getItem(LS_REGIONS_KEY);
        console.log('⚡ Сырые данные из кэша:', cacheData ? cacheData.substring(0, 100) + '...' : 'null');
        
        const cachedRegions = loadRegionsCache();
        console.log('⚡ После loadRegionsCache():', cachedRegions);
        console.log('⚡ cachedRegions.length:', cachedRegions ? cachedRegions.length : 'null/undefined');
        
        if (cachedRegions && cachedRegions.length > 0) {
          console.log('✅ МГНОВЕННО: Загружено из кэша:', cachedRegions.length, 'регионов');
          regions = cachedRegions;
          console.log('✅ regions переменная обновлена, длина:', regions.length);
          renderRegions(); // МГНОВЕННЫЙ рендер кэшированных данных
          console.log('✅ МГНОВЕННЫЙ рендер завершён!');
        } else {
          console.log('⚠️ Кэш пуст или невалиден, рендерим loading state');
          console.log('⚠️ Причина: cachedRegions =', cachedRegions);
          cards.innerHTML = '<div class="flex items-center justify-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i><span class="ml-3 text-gray-600">Загрузка регионов...</span></div>';
        }
        
        // Настраиваем обработчики сразу
        setupUnifiedClickHandler();
        setupBreadcrumbHandler();
        
        // ШАГ 2: Загружаем свежие данные из API в ФОНЕ
        try {
          console.log('🔄 ФОНОВАЯ загрузка: обновление из БД...');
          await syncRegionsFromAirtable(); // Загружает свежие данные и перерендеривает
          
          console.log('⚡ После syncRegionsFromAirtable: regions.length =', regions.length);
          
          // Сохраняем свежие данные в кэш для следующего раза
          if (regions.length > 0) {
            saveRegionsCache(regions);
            console.log('✅ Свежие данные сохранены в кэш');
          }
          
          if (!regions.length) {
            console.log('⚠️ Регионы не загружены из БД, пробуем через proxy...');
            await loadRegionsViaProxy();
          }
          
          if (!regions.length && !cachedRegions.length) {
            console.log('⚠️ Регионы все еще пусты, рендерим пустое состояние');
            renderRegions();
            return;
          }
          
          console.log('✅ Система готова (регионы:', regions.length, ')');
        } catch (error) {
          console.error('❌ Ошибка фоновой загрузки:', error);
          console.error('❌ Error stack:', error.stack);
          // Если есть кэш - оставляем его, иначе рендерим пустое состояние
          if (!cachedRegions || cachedRegions.length === 0) {
          renderRegions();
          }
        }
        
        console.log('✅ Инициализация завершена');
        console.log('✅ Финальное состояние: regions.length =', regions.length);
      })();

      // Deploy button placeholder removed per requirements
    })();
      // Удалён legacy-список «Каталог регионов» (табличный)

    // Каталог городов/локаций — UI-заглушка без обращений к реальным API
    (function(){
      const table = document.getElementById('cities_table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const addBtn = document.getElementById('cities_add');

      // Используем регионы из раздела выше как справочник
      function getRegionList(){
        const rows = document.querySelectorAll('#regions_table tbody tr');
        const list = [];
        rows.forEach(r=>{
          const id = r.querySelector('td:nth-child(1)')?.textContent?.trim();
          const name = r.querySelector('td:nth-child(2)')?.textContent?.trim();
          if (id && name && !id.startsWith('Нет данных')) list.push({id,name});
        });
        return list;
      }

      let items = [];

      function generateId(){
        const n = items.length + 1;
        return 'CL-' + String(n).padStart(4, '0');
      }

      function render(){
        tbody.innerHTML = '';
        if (items.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.className = 'px-4 py-4 text-gray-500';
          td.textContent = 'Нет данных. Добавьте запись.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        items.forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-gray-800">${it.id}</td>
            <td class="px-4 py-2 text-gray-800">${it.name}</td>
            <td class="px-4 py-2 text-gray-800">${it.regionName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.type}</td>
            <td class="px-4 py-2 text-gray-800">${it.coords || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.parentCity || ''}</td>
            <td class="px-4 py-2 text-right">
              <button data-action="edit" data-id="${it.id}" class="text-xs text-gray-700 hover:text-gray-900 mr-3"><i class="fas fa-pen mr-1"></i>Редактировать</button>
              <button data-action="delete" data-id="${it.id}" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-trash mr-1"></i>Удалить</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      function addOne(){
        const name = prompt('Название (город/локация):');
        if (!name) return;
        const type = prompt('Тип записи (Город|Локация):', 'Город');
        if (!type) return;
        let parentCity = '';
        if (type.trim().toLowerCase() === 'локация'){
          parentCity = prompt('Родительский город:') || '';
        }
        const coords = prompt('Координаты (опционально, например: 35.6895,139.6917):') || '';
        const r = getRegionList();
        let regionName = '';
        if (r.length){
          const names = r.map(x=>x.name).join(', ');
          const picked = prompt('Регион ('+names+'):') || '';
          const found = r.find(x=>x.name===picked.trim());
          regionName = found ? found.name : (r[0]?.name || '');
        }
        items.push({ id: generateId(), name: name.trim(), type: (type||'').trim(), parentCity: parentCity.trim(), coords: coords.trim(), regionName });
        render();
      }

      tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'delete'){
          items = items.filter(r=>r.id !== id);
          render();
        } else if (action === 'edit'){
          const it = items.find(x=>x.business_id===id);
          if (!it) return;
          const newName = prompt('Новое название:', it.name) || it.name;
          const newType = prompt('Тип записи (Город|Локация):', it.type) || it.type;
          const newCoords = prompt('Координаты:', it.coords) || it.coords;
          let newParent = it.parentCity;
          if ((newType||'').trim().toLowerCase()==='локация'){
            newParent = prompt('Родительский город:', it.parentCity||'') || it.parentCity || '';
          } else {
            newParent = '';
          }
          it.name = newName.trim();
          it.type = newType.trim();
          it.coords = newCoords.trim();
          it.parentCity = newParent.trim();
          render();
        }
      });

      addBtn && addBtn.addEventListener('click', addOne);

      render();
    })();

    // POIs — UI-заглушка (с билеты внутри блока)
    (function(){
      const table = document.getElementById('pois_table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const addBtn = document.getElementById('pois_add');
      const ticketsTitle = document.getElementById('poi_tickets_title');
      const ticketsTable = document.getElementById('tickets_table');
      const ticketsTbody = ticketsTable ? ticketsTable.querySelector('tbody') : null;
      const ticketsAddBtn = document.getElementById('tickets_add');

      function getCities(){
        const rows = document.querySelectorAll('#cities_table tbody tr');
        const list = [];
        rows.forEach(r=>{
          const id = r.querySelector('td:nth-child(1)')?.textContent?.trim();
          const name = r.querySelector('td:nth-child(2)')?.textContent?.trim();
          const region = r.querySelector('td:nth-child(3)')?.textContent?.trim();
          if (id && name && !id.startsWith('Нет данных')) list.push({id,name,region});
        });
        return list;
      }

      let items = [];
      let selectedPoiId = '';

      function genId(){ return 'POI-' + String(items.length+1).padStart(4,'0'); }

      function render(){
        tbody.innerHTML = '';
        if (items.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.className = 'px-4 py-4 text-gray-500';
          td.textContent = 'Нет данных. Добавьте POI.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          updateTicketsPanel();
          return;
        }
        items.forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-gray-800">${it.id}</td>
            <td class="px-4 py-2 text-gray-800">${it.name}</td>
            <td class="px-4 py-2 text-gray-800">${it.cityName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.regionName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.type || ''}</td>
            <td class="px-4 py-2 text-gray-800">${(it.tickets||[]).length}</td>
            <td class="px-4 py-2 text-right">
              <button data-action="tickets" data-id="${it.id}" class="text-xs text-indigo-600 hover:text-indigo-800 mr-3"><i class="fas fa-ticket mr-1"></i>Билеты</button>
              <button data-action="edit" data-id="${it.id}" class="text-xs text-gray-700 hover:text-gray-900 mr-3"><i class="fas fa-pen mr-1"></i>Редактировать</button>
              <button data-action="delete" data-id="${it.id}" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-trash mr-1"></i>Удалить</button>
            </td>`;
          tbody.appendChild(tr);
        });
        updateTicketsPanel();
      }

      function addOne(){
        const name = prompt('Название POI:');
        if (!name) return;
        const type = prompt('Тип объекта (культура, природа, гастро, …):', 'культура') || '';
        const cities = getCities();
        let cityName = '';
        let regionName = '';
        if (cities.length){
          const names = cities.map(x=>x.name).join(', ');
          const picked = prompt('Город/Локация ('+names+'):') || '';
          const found = cities.find(x=>x.name===picked.trim());
          cityName = found ? found.name : (cities[0]?.name || '');
          regionName = found ? (found.region || '') : (cities[0]?.region || '');
        }
        items.push({ id: genId(), name: name.trim(), type: type.trim(), cityName, regionName, tickets: []});
        render();
      }

      tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'delete'){
          items = items.filter(r=>r.id !== id);
          if (selectedPoiId === id) selectedPoiId = '';
          render();
        } else if (action === 'edit'){
          const it = items.find(x=>x.business_id===id);
          if (!it) return;
          const newName = prompt('Новое название:', it.name) || it.name;
          const newType = prompt('Тип объекта:', it.type) || it.type;
          it.name = newName.trim();
          it.type = newType.trim();
          render();
        } else if (action === 'tickets'){
          selectedPoiId = id;
          updateTicketsPanel();
        }
      });

      addBtn && addBtn.addEventListener('click', addOne);

      // Билеты внутри POI
      let tickets = {};// { poiId: [ {id,category,price,currency,note} ] }
      function ensureArr(poiId){ if (!tickets[poiId]) tickets[poiId] = []; return tickets[poiId]; }

      function updateTicketsPanel(){
        if (!ticketsTbody || !ticketsTitle) return;
        const poi = items.find(x=>x.business_id===selectedPoiId);
        ticketsTitle.textContent = poi ? poi.name : '— не выбран —';
        const list = poi ? ensureArr(poi.business_id) : [];
        ticketsTbody.innerHTML = '';
        if (!poi){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className='px-4 py-4 text-gray-500';
          td.textContent = 'Выберите POI (кнопка «Билеты»)';
          tr.appendChild(td); ticketsTbody.appendChild(tr); return;
        }
        if (list.length===0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className='px-4 py-4 text-gray-500';
          td.textContent = 'Нет билетов. Добавьте билет.';
          tr.appendChild(td); ticketsTbody.appendChild(tr); return;
        }
        list.forEach((t, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class=\"px-4 py-2 text-gray-800\">${t.id}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.category}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.price}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.currency}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.note||''}</td>
            <td class=\"px-4 py-2 text-right\">\n              <button data-action=\"t-edit\" data-id=\"${t.id}\" class=\"text-xs text-gray-700 hover:text-gray-900 mr-3\"><i class=\"fas fa-pen mr-1\"></i>Редактировать</button>\n              <button data-action=\"t-delete\" data-id=\"${t.id}\" class=\"text-xs text-red-600 hover:text-red-800\"><i class="fas fa-trash mr-1"></i>Удалить</button>
            </td>`;
          ticketsTbody.appendChild(tr);
        });
      }

      function genTicketId(poiId){
        const n = ensureArr(poiId).length + 1;
        return poiId.replace('POI-','TKT-') + '-' + String(n).padStart(2,'0');
        }

      ticketsAddBtn && ticketsAddBtn.addEventListener('click', function(){
        if (!selectedPoiId) { alert('Сначала выберите POI (кнопка «Билеты»).'); return; }
        const category = prompt('Категория (Adult / Child / Infant / Senior / Special):', 'Adult') || 'Adult';
        const priceStr = prompt('Цена (¥):', '1000') || '0';
        const price = parseInt(priceStr, 10) || 0;
        const currency = '¥';
        const note = prompt('Примечание:', '') || '';
        const arr = ensureArr(selectedPoiId);
        arr.push({ id: genTicketId(selectedPoiId), category, price, currency, note });
        updateTicketsPanel();
      });

      ticketsTbody && ticketsTbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn || !selectedPoiId) return;
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        const arr = ensureArr(selectedPoiId);
        if (action==='t-delete'){
          const idx = arr.findIndex(x=>x.business_id===id);
          if (idx>=0){ arr.splice(idx,1); updateTicketsPanel(); }
        } else if (action==='t-edit'){
          const t = arr.find(x=>x.business_id===id); if (!t) return;
          const newCategory = prompt('Категория:', t.category) || t.category;
          const newPriceStr = prompt('Цена (¥):', String(t.price)) || String(t.price);
          const newNote = prompt('Примечание:', t.note||'') || t.note;
          t.category = newCategory.trim();
          t.price = parseInt(newPriceStr, 10) || t.price;
          t.note = newNote.trim();
          updateTicketsPanel();
        }
      });

      render();
    })();
    </script>
  </body>
</html>


