<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Konstructour ‚Äî –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../styles/admin-japanese.css" rel="stylesheet">
    <style>
      body{ background: rgb(var(--color-washi)); min-height:100vh; }
      .tab{ padding:14px 20px; font-size:16px; border-radius:10px; cursor:pointer; flex:1 1 0%; text-align:center; }
      .tab.active{ background:#fff; border:1px solid rgba(139,90,43,.15); }
      .tab-content{ display:none; }
      .tab-content.active{ display:block; }
      /* Fixed sizes to keep API action row stable */
      .api-select{ width: 180px; }
      .api-base-label{ display:inline-block; width: 120px; }
      .api-base-input{ width: 280px; }
      .api-table-label{ display:inline-block; width: 140px; }
      .api-table-input{ width: 220px; }
      
      /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π POI */
      .text-brown-600 { color: #8B4513; }
    </style>
  </head>
  <body data-no-redirect="true">
    <div class="dashboard-grid">
      <aside class="sidebar texture-wood">
        <div class="p-6">
          <div class="flex items-center mb-8">
            <div class="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center mr-3">
              <svg class="w-8 h-8 text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
            </div>
            <div>
              <h1 class="text-xl font-light text-gray-800">Konstructour</h1>
              <p class="text-xs text-gray-600">Site Admin</p>
            </div>
          </div>
          <nav class="space-y-2">
            <a href="dashboard.html" class="sidebar-link"><i class="fas fa-th-large mr-3 text-indigo-600"></i>–û–±–∑–æ—Ä</a>
            <a href="api-catalog.html" class="sidebar-link"><i class="fas fa-list mr-3 text-gray-600"></i>–ö–∞—Ç–∞–ª–æ–≥ API</a>
            <a href="databases.html" class="menu-item active sidebar-link"><i class="fas fa-database mr-3 text-green-600"></i>–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</a>
          </nav>
        </div>
      </aside>
      <main class="p-8">
        <header class="mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-light text-gray-800 mb-1">–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>
              <p class="text-gray-600">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –¥–∞–Ω–Ω—ã–º–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ API</p>
            </div>
          </div>
        </header>

        <div class="glass-panel p-8 rounded-lg mb-6">
          <div class="flex items-center gap-3">
            <button class="tab active" data-tab="regions"><i class="fas fa-globe-asia mr-2 text-blue-600"></i>–†–µ–≥–∏–æ–Ω—ã</button>
            <button class="tab" data-tab="tours"><i class="fas fa-route mr-2 text-green-600"></i>–¢—É—Ä—ã</button>
            <button class="tab" data-tab="templates"><i class="fas fa-layer-group mr-2 text-purple-600"></i>–®–∞–±–ª–æ–Ω—ã</button>
          </div>
        </div>

        <!-- –†–µ–≥–∏–æ–Ω—ã (–∏–µ—Ä–∞—Ä—Ö–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫) -->
        <section id="tab-regions" class="tab-content active">
          <div class="glass-panel p-6 rounded-lg relative">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-globe-asia mr-2 text-blue-600"></i>–†–µ–≥–∏–æ–Ω—ã</h3>
            </div>

            <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
            <div class="mb-4 -mt-1">
              <div id="db_breadcrumbs" class="flex items-center flex-wrap text-base text-gray-600"></div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ —É—Ä–æ–≤–Ω—è (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) -->
            <div id="db_cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥ —Å–µ—Ç–∫–æ–π -->
            <div class="mt-6 flex justify-center">
              <button id="db_fab_add" class="btn-japanese rounded-full w-12 h-12 flex items-center justify-center shadow-lg" title="–î–æ–±–∞–≤–∏—Ç—å">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
        </section>

        <!-- –¢—É—Ä—ã -->
        <section id="tab-tours" class="tab-content">
          <div class="glass-panel p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-route mr-2 text-green-600"></i>–¢—É—Ä—ã</h3>
            </div>
            <div id="tours_schema" class="text-sm text-gray-600">
              –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ Project Description.md. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ö–µ–º—ã –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.
            </div>
            <div class="mt-4">
              <div class="text-xs text-gray-500 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö</div>
              <div id="tours_preview" class="japanese-table w-full rounded-lg overflow-hidden">
                <div class="p-4 text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞–∂–º–∏—Ç–µ ¬´–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª.</div>
              </div>
            </div>
          </div>
        </section>

        <!-- –®–∞–±–ª–æ–Ω—ã -->
        <section id="tab-templates" class="tab-content">
          <div class="glass-panel p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-layer-group mr-2 text-purple-600"></i>–®–∞–±–ª–æ–Ω—ã</h3>
            </div>
            <div id="templates_schema" class="text-sm text-gray-600">
              –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ.
            </div>
            <div class="mt-4">
              <div class="text-xs text-gray-500 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö</div>
              <div id="templates_preview" class="japanese-table w-full rounded-lg overflow-hidden">
                <div class="p-4 text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞–∂–º–∏—Ç–µ ¬´–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª.</div>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>

    <script>
      // Airtable table IDs - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ
      window.AIRTABLE_BASE_ID = 'apppwhjFN82N9zNqm';
      window.AIRTABLE_COUNTRY_TABLE_ID = 'tble0eh9mstZeBKxM';
      window.AIRTABLE_REGIONS_TABLE_ID = 'tblbSajWkzI8X7M4U';
      window.AIRTABLE_CITIES_TABLE_ID = 'tblHaHc9NV0mA8bSa';
      window.AIRTABLE_POI_TABLE_ID = 'tblVCmFcHRpXUT24y';
      window.AIRTABLE_TICKETS_TABLE_ID = 'tblKOLhiHMihpWsVl';
      
      // SVG –∏–∫–æ–Ω–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π POI
      window.POI_CATEGORY_ICONS = {
        '–°–∏–Ω—Ç–æ–∏—Å—Ç—Å–∫–æ–µ —Å–≤—è—Ç–∏–ª–∏—â–µ': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L14 6H20V8H18V20H16V8H8V20H6V8H4V6H10L12 2ZM10 10H14V12H10V10ZM10 14H14V16H10V14Z"/>
        </svg>`,
        '–ë—É–¥–¥–∏–π—Å–∫–∏–π —Ö—Ä–∞–º': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L13.5 5.5H18V7H16V11H18.5L20 14H4L5.5 11H8V7H6V5.5H10.5L12 2ZM10 9H14V13H10V9Z"/>
        </svg>`,
        '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±—ä–µ–∫—Ç': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M6 20V9L12 4L18 9V20H16V11.5L12 8.5L8 11.5V20H6ZM10 15H14V17H10V15Z"/>
        </svg>`,
        '–ú—É–∑–µ–π': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 1L21 6V8H3V6L12 1ZM5 10H7V18H5V10ZM9 10H11V18H9V10ZM13 10H15V18H13V10ZM17 10H19V18H17V10ZM3 20V22H21V20H3Z"/>
        </svg>`,
        '–ê—Ä—Ç-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ / –ì–∞–ª–µ—Ä–µ—è': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M9 10V8L7 6L9 4V2H15V4L17 6L15 8V10H9ZM12 5.5L13.5 4H10.5L12 5.5ZM4 12H20V20H4V12ZM6 14V18H18V14H6Z"/>
        </svg>`,
        '–°–º–æ—Ç—Ä–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2C15.31 2 18 4.69 18 8C18 11.54 12 22 12 22S6 11.54 6 8C6 4.69 8.69 2 12 2ZM12 6C10.9 6 10 6.9 10 8S10.9 10 12 10 14 9.1 14 8 13.1 6 12 6ZM12 9C11.45 9 11 8.55 11 8S11.45 7 12 7 13 7.45 13 8 12.55 9 12 9Z"/>
        </svg>`,
        '–õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–π —Å–∞–¥ / –ü–∞—Ä–∫': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M17 8C8 10 5.9 16.17 3.82 21.34L5.71 22L6.66 19.7C7.14 19.87 7.64 20 8 20C8.36 20 8.86 19.87 9.34 19.7L10.29 22L12.18 21.34C10.1 16.17 8 10 17 8ZM3 3L12 2L21 3V6H3V3Z"/>
        </svg>`,
        '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2ZM12 6.5L11.5 8.5L9.5 9L11.5 9.5L12 11.5L12.5 9.5L14.5 9L12.5 8.5L12 6.5Z"/>
        </svg>`,
        '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2L22 6V8H2V6L12 2ZM4 10H20V18H16V20H8V18H4V10ZM6 12V16H18V12H6ZM8 13H16V15H8V13Z"/>
        </svg>`,
        '–Ø–ø–æ–Ω—Å–∫–∏–π –æ—Ç–µ–ª—å': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M7 13C7.55 13 8 12.55 8 12S7.55 11 7 11 6 11.45 6 12 6.45 13 7 13ZM12 13C12.55 13 13 12.55 13 12S12.55 11 12 11 11 11.45 11 12 11.45 13 12 13ZM17 13C17.55 13 18 12.55 18 12S17.55 11 17 11 16 11.45 16 12 16.45 13 17 13ZM19 7H5V5H19V7ZM19 9H5V19H19V9ZM21 3H3V21H21V3Z"/>
        </svg>`,
        '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"/>
        </svg>`,
        '–®–æ–ø–ø–∏–Ω–≥': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M7 18C5.9 18 5 18.9 5 20S5.9 22 7 22 9 21.1 9 20 8.1 18 7 18ZM1 2V4H3L6.6 11.59L5.25 14.04C5.09 14.32 5 14.65 5 15C5 16.1 5.9 17 7 17H19V15H7.42C7.28 15 7.17 14.89 7.17 14.75L7.2 14.63L8.1 13H15.55C16.3 13 16.96 12.59 17.3 11.97L20.88 5H5.21L4.27 3H1ZM17 18C15.9 18 15 18.9 15 20S15.9 22 17 22 19 21.1 19 20 18.1 18 17 18Z"/>
        </svg>`,
        '–¢–µ—Ä–º–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M9 17C9 15.34 10.34 14 12 14S15 15.34 15 17 13.66 20 12 20 9 18.66 9 17ZM12 2C10.89 2 10 2.89 10 4S10.89 6 12 6 14 5.11 14 4 13.11 2 12 2ZM6 6C4.89 6 4 6.89 4 8S4.89 10 6 10 8 9.11 8 8 7.11 6 6 6ZM18 6C16.89 6 16 6.89 16 8S16.89 10 18 10 20 9.11 20 8 19.11 6 18 6Z"/>
        </svg>`,
        '–°–ü–ê': `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M19 12C19 8.13 15.87 5 12 5S5 8.13 5 12C5 15.87 8.13 19 12 19S19 15.87 19 12ZM12 7C14.76 7 17 9.24 17 12S14.76 17 12 17 7 14.76 7 12 9.24 7 12 7ZM12 9C10.34 9 9 10.34 9 12S10.34 15 12 15 15 13.66 15 12 13.66 9 12 9Z"/>
        </svg>`
      };
      
      // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      window.getPOICategoryIcon = function(category) {
        return window.POI_CATEGORY_ICONS[category] || `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"/>
        </svg>`;
      };
      
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫ ‚Äî –ø–∏—à–µ–º –≤ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ª–æ–≥
    (function(){
      function postError(payload){
        try{ fetch('/api/error-log.php?action=add',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }); }catch(_e){}
      }
      window.addEventListener('error', function(e){
        postError({ type:'js-error', page:'databases.html', msg: String(e.message||'error'), file: e.filename||'', line: e.lineno||0, col: e.colno||0, stack: e.error && e.error.stack ? String(e.error.stack) : '' });
      });
      window.addEventListener('unhandledrejection', function(e){
        const r = e && (e.reason||e.detail||{});
        postError({ type:'js-unhandled', page:'databases.html', msg: (r && (r.message||r)) ? String(r.message||r) : 'unhandled', stack: r && r.stack ? String(r.stack) : '' });
      });
    })();
    // –ü—Ä–æ—Å—Ç—ã–µ –≤–∫–ª–∞–¥–∫–∏ –±–µ–∑ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    (function(){
      window.__ADMIN_DB_DEBUG = /(^|[?&])debug=1(&|$)/.test(location.search) || (localStorage.getItem('debug_admin_db')==='1');
      window.dlog = function(){ if (window.__ADMIN_DB_DEBUG) { try{ console.log.apply(console, ['[DB]'].concat(Array.from(arguments))); }catch(_e){} } };
      const tabs = document.querySelectorAll('.tab');
      const sections = {
        regions: document.getElementById('tab-regions'),
        tours: document.getElementById('tab-tours'),
        templates: document.getElementById('tab-templates')
      };
      tabs.forEach(btn=>{
        btn.addEventListener('click', function(e){
          e.preventDefault();
          tabs.forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          Object.values(sections).forEach(s=> s && s.classList.remove('active'));
          const key = this.getAttribute('data-tab');
          if (sections[key]) sections[key].classList.add('active');
        });
      });

      // Fake sync state toggling for icon demo (replace with real sync hooks)
      function setSyncing(scope, isSyncing){
        const el = document.getElementById(scope+'_sync_icon');
        if (!el) return;
        if (isSyncing) el.classList.add('animate-spin'); else el.classList.remove('animate-spin');
      }

      // Remove placeholder spinner handler to avoid side-effects on clicks

      // Base label auto-switch for API type
      function bindApiLabel(){ /* —É–¥–∞–ª–µ–Ω–æ –≤–º–µ—Å—Ç–µ —Å UI */ }

      // Load saved config from server and populate fields
        window.airtableReg = null; // cache for mapping header - –¥–µ–ª–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–π
        
        
      async function loadDbConfig(){
        try{
          const res = await fetch('/api/config-read.php', { headers: { 'X-Admin-Token': (window.ADMIN_TOKEN||'') } });
          if (!res.ok) return;
          const data = await res.json();
          const db = (data && data.databases) || {};
          const reg = (data && data.airtable_registry) || null;
            window.airtableReg = reg;
          function fill(){ /* UI —É–¥–∞–ª—ë–Ω */ }
          fill('regions', db.regions);
          fill('tours', db.tours);
          fill('templates', db.templates);
          // Fill Airtable Mapping UI
          if (reg){
            const baseId = reg.baseId || reg.base_id || '';
            const t = reg.tables || {};
            document.getElementById('am_base_id') && (document.getElementById('am_base_id').value = baseId);
            function setv(id, val){ const el = document.getElementById(id); if (el && typeof val==='string') el.value = val; }
            setv('am_country_label', t.country?.label||''); setv('am_country_table', t.country?.tableId||''); setv('am_country_view', t.country?.viewId||'');
            setv('am_region_label',  t.region?.label||'');  setv('am_region_table',  t.region?.tableId||'');  setv('am_region_view',  t.region?.viewId||'');
            setv('am_city_label',    t.city?.label||'');    setv('am_city_table',    t.city?.tableId||'');    setv('am_city_view',    t.city?.viewId||'');
            setv('am_poi_label',     t.poi?.label||'');     setv('am_poi_table',     t.poi?.tableId||'');     setv('am_poi_view',     t.poi?.viewId||'');
            // Render mapping header for Regions
            // initial header will be set by render functions
          }
        }catch(e){ console.warn('loadDbConfig failed', e); }
      }
      loadDbConfig();

      function setMappingHeader(){ /* –±–µ–π–¥–∂ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω ‚Äî –∑–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º */ }
      // –°–¥–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–π –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      window.setMappingHeader = setMappingHeader;

      // Fallback: –ø—Ä—è–º–æ–π —Å–ø–∏—Å–æ–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤ —á–µ—Ä–µ–∑ test-proxy, —á–∏—Ç–∞—è —Ä–µ–µ—Å—Ç—Ä —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      async function loadRegionsViaProxy(){
        try{
            let baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || '';
            let regTbl = (window.airtableReg && window.airtableReg.tables && (window.airtableReg.tables.region?.tableId || window.airtableReg.tables.region?.table_id)) || '';
          if (!baseId || !regTbl){
            const cfg = await fetch('/api/config-read.php').then(r=>r.ok?r.json():null).catch(()=>null);
            const reg = cfg && (cfg.airtable_registry||{});
            if (reg){
              baseId = baseId || reg.baseId || reg.base_id || '';
              const t = reg.tables||{}; regTbl = regTbl || t.region?.tableId || t.region?.table_id || '';
            }
          }
          // –ñ—ë—Å—Ç–∫–∏–µ –¥–µ—Ñ–æ–ª—Ç—ã (–µ—Å–ª–∏ —Ä–µ–µ—Å—Ç—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω): Regions table
            if (!baseId) baseId = window.AIRTABLE_BASE_ID;
            if (!regTbl) regTbl = window.AIRTABLE_REGIONS_TABLE_ID;
          if (!baseId || !regTbl) return false;
          const u = '/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId)+'&table='+encodeURIComponent(regTbl);
          const r2 = await fetch(u); if(!r2.ok) return false; const j2 = await r2.json();
          const recs = (j2 && j2.body && (j2.body.records || j2.body.items)) || j2.records || j2.items || [];
          regions = recs.map((rec, idx)=>{
            const fields = rec.fields || {};
            const name = fields['Name (RU)'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ (RU)'] || fields['Name'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ'] || ('–†–µ–≥–∏–æ–Ω '+(idx+1));
            const rid = fields['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä'] || fields['Region ID'] || fields['ID'] || fields['–†–µ–≥–∏–æ–Ω ID'] || '';
            return { id: rec.id || ('REG-'+String(idx+1).padStart(3,'0')), name, rid };
          });
          citiesByRegion = {};
          renderRegions();
          return regions.length>0;
        }catch(e){ console.warn('loadRegionsViaProxy failed', e); return false; }
      }

      // Save Airtable Mapping
      async function saveAirtableRegistry(){
        const reg = {
          baseId: document.getElementById('am_base_id')?.value || '',
          tables: {
            country: { label: document.getElementById('am_country_label')?.value || '', tableId: document.getElementById('am_country_table')?.value || '', viewId: document.getElementById('am_country_view')?.value || '' },
            region:  { label: document.getElementById('am_region_label')?.value  || '', tableId: document.getElementById('am_region_table')?.value  || '', viewId: document.getElementById('am_region_view')?.value  || '' },
            city:    { label: document.getElementById('am_city_label')?.value    || '', tableId: document.getElementById('am_city_table')?.value    || '', viewId: document.getElementById('am_city_view')?.value    || '' },
            poi:     { label: document.getElementById('am_poi_label')?.value     || '', tableId: document.getElementById('am_poi_table')?.value     || '', viewId: document.getElementById('am_poi_view')?.value     || '' }
          }
        };
        try{
          await fetch('/api/config-store.php',{
            method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
            body: JSON.stringify({ airtable_registry: reg })
          });
        }catch(e){ console.warn('save registry failed', e); }
      }
      document.getElementById('am_save')?.addEventListener('click', saveAirtableRegistry);

      // Test Base / Table
      document.getElementById('am_test_base')?.addEventListener('click', async function(){
        const baseId = document.getElementById('am_base_id')?.value || '';
        const key = ''; // —Å–µ—Ä–≤–µ—Ä –≤–æ–∑—å–º—ë—Ç PAT –∏–∑ server keys
        const res = await fetch('/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId));
        const t = await res.json();
        const label = document.getElementById('am_base_status');
        if (label) label.textContent = t.ok ? 'OK' : ('–û—à–∏–±–∫–∞: '+(t.error||''));
      });
      document.querySelectorAll('.am_test_table').forEach(btn=>{
        btn.addEventListener('click', async function(){
          const entity = this.getAttribute('data-entity');
          const baseId = document.getElementById('am_base_id')?.value || '';
          const tableId = document.getElementById('am_'+entity+'_table')?.value || '';
          const viewId = document.getElementById('am_'+entity+'_view')?.value || '';
          const url = '/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId)+'&table='+encodeURIComponent(tableId)+(viewId?('&view='+encodeURIComponent(viewId)):'');
          const res = await fetch(url);
          const t = await res.json();
          const label = document.getElementById('am_'+entity+'_status');
          if (label) label.textContent = t.ok ? 'OK' : ('–û—à–∏–±–∫–∞: '+(t.error||''));
        });
      });
    })();

    // –ò–µ—Ä–∞—Ä—Ö–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫: —Ä–µ–≥–∏–æ–Ω—ã ‚Üí –≥–æ—Ä–æ–¥–∞ ‚Üí POI ‚Üí –±–∏–ª–µ—Ç—ã (UI, –±–µ–∑ API)
    (function(){
      // helper: save to server as server key
      async function saveDbConfig(scope){
        try{
          // UI –ø–æ–ª–µ–π —É–¥–∞–ª—ë–Ω ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –Ω–∞ –±—É–¥—É—â–µ–µ, —Å–µ–π—á–∞—Å no-op
          await fetch('/api/config-store.php',{
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
            body: JSON.stringify({})
          }).then(r=>{
            if (!r.ok) throw new Error('HTTP '+r.status);
            if (window.osNotify){ window.osNotify('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ','–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞'); }
          }).catch(e=>{
            console.warn('saveDbConfig failed', e);
            if (window.osNotify){ window.osNotify('–û—à–∏–±–∫–∞','–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'); }
          });
        }catch(e){ console.warn('saveDbConfig failed', e); }
      }

      const crumbs = document.getElementById('db_breadcrumbs');
      const cards = document.getElementById('db_cards');
      const fab = document.getElementById('db_fab_add');

      if (!crumbs || !cards) return;

      const regionColors = {
        '–•–æ–∫–∫–∞–π–¥–æ':'bg-blue-100 text-blue-800',
        '–¢–æ—Ö–æ–∫—É':'bg-green-100 text-green-800',
        '–ö–∞–Ω—Ç–æ':'bg-indigo-100 text-indigo-800',
        '–¢—é–±—É':'bg-yellow-100 text-yellow-800',
        '–ö–∞–Ω—Å–∞–π':'bg-purple-100 text-purple-800',
        '–¢—é–≥–æ–∫—É':'bg-pink-100 text-pink-800',
        '–°–∏–∫–æ–∫—É':'bg-teal-100 text-teal-800',
        '–ö—é—Å—é':'bg-red-100 text-red-800',
        '–û–∫–∏–Ω–∞–≤–∞':'bg-cyan-100 text-cyan-800'
      };

      // State (in-memory for UI only). –ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã ‚Äî Airtable
      let regions = [];
      let citiesByRegion = {}; // regionId -> [ { id, name, type: 'city'|'location', parentCityId? } ]
      let poisByCity = {};     // cityId -> [ {id,name,type} ]
      let ticketsByPoi = {};   // poiId -> [ {id,category,price,currency,note} ]

      // Persisted cache so –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –ø—Ä–æ–ø–∞–¥–∞—é—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä–∏ —Å–±–æ—è—Ö —Å–µ—Ç–∏/—Å–µ—Ä–≤–µ—Ä–æ–≤
      const LS_REGIONS_KEY = 'konstructour_regions_cache_v1';
      function loadRegionsCache(){ try{ const s=localStorage.getItem(LS_REGIONS_KEY); return s?JSON.parse(s):[]; }catch(_e){ return []; } }
      function saveRegionsCache(list){ try{ localStorage.setItem(LS_REGIONS_KEY, JSON.stringify(Array.isArray(list)?list:[])); }catch(_e){} }

      let level = 'regions';
      let selectedRegion = null;
      let selectedCity = null;
      let selectedPoi = null;

      // History helpers
      function renderFromState(state){
        if (!state || !state.level) { renderRegions(); return; }
        level = state.level;
        if (level === 'regions') { renderRegions(); return; }
        if (level === 'cities') {
          selectedRegion = regions.find(r=>r.id===state.regionId) || null;
          renderCities(); return;
        }
        if (level === 'pois') {
          selectedRegion = regions.find(r=>r.id===state.regionId) || null;
          const list = selectedRegion ? (citiesByRegion[selectedRegion.id]||[]) : [];
          selectedCity = list.find(c=>c.id===state.cityId) || null;
          renderPois(); return;
        }
        if (level === 'tickets') {
          selectedRegion = regions.find(r=>r.id===state.regionId) || null;
          const listC = selectedRegion ? (citiesByRegion[selectedRegion.id]||[]) : [];
          selectedCity = listC.find(c=>c.id===state.cityId) || null;
          const listP = selectedCity ? (poisByCity[selectedCity.id]||[]) : [];
          selectedPoi = listP.find(p=>p.id===state.poiId) || null;
          renderTickets(); return;
        }
        renderRegions();
      }
      function push(level, ids){
        const state = Object.assign({ level }, ids||{});
        history.pushState(state, '');
      }

      function renderCrumbs(){
        const parts = [];
        // Root
        if (level === 'regions'){
          parts.push('<span class="text-gray-800">–†–µ–≥–∏–æ–Ω—ã</span>');
        } else {
          parts.push('<a href="#" data-level="regions" class="text-indigo-600 hover:underline">–†–µ–≥–∏–æ–Ω—ã</a>');
        }
        // Region
        if (selectedRegion){
          parts.push('<span class="mx-2">/</span>');
          if (level === 'cities'){
            parts.push('<span class="text-gray-800">'+selectedRegion.name+'</span>');
          } else {
            parts.push('<a href="#" data-level="cities" data-region-id="'+selectedRegion.id+'" class="text-indigo-600 hover:underline">'+selectedRegion.name+'</a>');
          }
        }
        // City
        if (selectedCity){
          parts.push('<span class="mx-2">/</span>');
          if (level === 'pois'){
            parts.push('<span class="text-gray-800">'+selectedCity.name+'</span>');
          } else {
            parts.push('<a href="#" data-level="pois" data-region-id="'+(selectedRegion?selectedRegion.id:'')+'" data-city-id="'+selectedCity.id+'" class="text-indigo-600 hover:underline">'+selectedCity.name+'</a>');
          }
        }
        // POI (always last visible item is plain text)
        if (selectedPoi){
          parts.push('<span class="mx-2">/</span><span class="text-gray-800">'+selectedPoi.name+'</span>');
        }
        crumbs.innerHTML = parts.join('');
      }

      function card(actionsHtml, innerHtml){
        const actionsBlock = actionsHtml && actionsHtml.trim() ? '<div class="absolute top-2 right-2 flex items-center gap-2 opacity-70">'+actionsHtml+'</div>' : '';
        return '<div class="relative bg-white rounded-lg border border-gray-200 p-4 hover:shadow transition">'+actionsBlock+innerHtml+'</div>';
      }

      function renderRegions(){
        level='regions'; selectedRegion=null; selectedCity=null; selectedPoi=null; renderCrumbs(); setMappingHeader('region');
        if (!regions.length){
          cards.innerHTML = '<div class="text-gray-500">–ù–µ—Ç —Ä–µ–≥–∏–æ–Ω–æ–≤. –ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>';
          return;
        }
        cards.innerHTML = regions.map(r=>{
          const count = (citiesByRegion[r.id]||[]).length;
          dlog('region-card', {id:r.id, name:r.name, count});
          const inlineActions = '<div class="flex items-center gap-2 opacity-80">\
              '+(r.rid ? '<span class="ml-2 px-2 py-0.5 text-xs rounded border bg-gray-50 text-gray-600">'+r.rid+'</span>' : '')+'\
              <button data-act="edit-region" data-id="'+r.id+'" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>\
              <button data-act="del-region" data-id="'+r.id+'" title="–£–¥–∞–ª–∏—Ç—å" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>\
            </div>';
          const inner = '<div class="flex items-center justify-between">\
              <div class="flex items-center gap-2">\
                <svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" class="text-indigo-600"><path d="M3.5 6.5 9 4.5l6 2 5.5-2v13l-5.5 2-6-2-5.5 2v-13z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>\
                <div class="text-lg text-gray-800">'+r.name+'</div>\
              </div>\
              '+inlineActions+'\
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">\
                <div class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-50 border border-indigo-100 shadow-sm">\
                  <i class=\"fas fa-map-marker-alt text-indigo-600\"></i>\
                  <span class=\"text-xs font-medium text-indigo-700\">'+count+'</span>\
                </div>\
              </div>\
            </div>';
          return '<a href="#" role="button" class="block" data-go="cities" data-id="'+r.id+'">'+card('', inner)+'</a>';
        }).join('');
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏–∑ Airtable –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
      async function syncRegionsFromAirtable(){
        try{
          const res = await fetch('/api/db-sync.php',{
            method:'POST', headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ scope:'regions', action:'list' })
          });
          if (!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          if (!data.ok) throw new Error(data.error||'Airtable');
          const items = data.items || [];
          regions = items.map((it, idx)=>({
            id: it.id || ('REG-'+String(idx+1).padStart(3,'0')),
            name: (it.name || ('–†–µ–≥–∏–æ–Ω '+(idx+1))),
            rid: (it.fields && (it.fields['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä'] || it.fields['Region ID'] || it.fields['ID'] || it.fields['–†–µ–≥–∏–æ–Ω ID'])) || ''
          }));
          // –°–Ω–∞—á–∞–ª–∞ –±—ã—Å—Ç—Ä—ã–π —Ä–µ–Ω–¥–µ—Ä —Å –Ω—É–ª—è–º–∏
          citiesByRegion = {};
          renderRegions();
          saveRegionsCache(regions);
          // –ó–∞—Ç–µ–º –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Ä–æ–¥–æ–≤ –ø–æ –≤—Å–µ–º —Ä–µ–≥–∏–æ–Ω–∞–º –∏ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º
          try{
            await Promise.all(regions.map(async (r)=>{
              try{
                const rs = await fetch('/api/db-sync.php',{
                  method:'POST', headers:{ 'Content-Type':'application/json' },
                  body: JSON.stringify({ scope:'cities', action:'list', data:{ filter:{ regionId: r.id, regionName: r.name } } })
                });
                const jj = await rs.json();
                const its = jj.ok ? (jj.items||[]) : [];
                citiesByRegion[r.id] = its.map(it=>({ id: it.id, name: it.name || it.fields?.['Name (RU)'] || it.fields?.['–ù–∞–∑–≤–∞–Ω–∏–µ (RU)'] || '‚Äî', code:(it.fields?.['ID']||it.fields?.['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä']||''), type: (it.fields?.Type||'city').toLowerCase()==='location'?'location':'city' }));
              }catch(_e){ citiesByRegion[r.id] = citiesByRegion[r.id] || []; }
            }));
            renderRegions();
          }catch(_e){ /* ignore */ }
        }catch(e){
          console.warn('syncRegionsFromAirtable failed', e);
          // Fallback: –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ test-proxy –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ä–µ–µ—Å—Ç—Ä–∞
          try{
              let baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || '';
              let regTbl = (window.airtableReg && window.airtableReg.tables && (window.airtableReg.tables.region?.tableId || window.airtableReg.tables.region?.table_id)) || '';
            // –ñ—ë—Å—Ç–∫–∏–µ –¥–µ—Ñ–æ–ª—Ç—ã, –µ—Å–ª–∏ —Ä–µ–µ—Å—Ç—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
              if (!baseId) baseId = window.AIRTABLE_BASE_ID;
              if (!regTbl) regTbl = window.AIRTABLE_REGIONS_TABLE_ID;
            if (!baseId || !regTbl) return;
            const u = '/api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId)+'&table='+encodeURIComponent(regTbl);
            const r2 = await fetch(u);
            const j2 = await r2.json();
            const recs = (j2 && j2.body && (j2.body.records || j2.body.items)) || j2.records || j2.items || [];
            regions = recs.map((rec, idx)=>{
              const fields = rec.fields || {};
              const name = fields['Name (RU)'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ (RU)'] || fields['Name'] || fields['–ù–∞–∑–≤–∞–Ω–∏–µ'] || ('–†–µ–≥–∏–æ–Ω '+(idx+1));
              const rid = fields['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä'] || fields['Region ID'] || fields['ID'] || fields['–†–µ–≥–∏–æ–Ω ID'] || '';
              return { id: rec.id || ('REG-'+String(idx+1).padStart(3,'0')), name, rid };
            });
            citiesByRegion = {};
            renderRegions();
            saveRegionsCache(regions);
          }catch(e2){ console.warn('fallback regions failed', e2); }
        }
      }

      async function deleteRegionOnServer(region){
        try{
          let recordId = region && region.id ? region.id : '';
          if (!/^rec/i.test(recordId)){
            // –ù–∞–π–¥—ë–º –∑–∞–ø–∏—Å—å –ø–æ –ø–æ–ª—é Region ID –∏–ª–∏ –∏–º–µ–Ω–∏
            const res = await fetch('/api/db-sync.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ scope:'regions', action:'list' })
            });
            const j = await res.json();
            if (j && j.ok && Array.isArray(j.items)){
              const found = j.items.find(it => (it.fields && (it.fields['Region ID']===region.id || it.fields['–†–µ–≥–∏–æ–Ω ID']===region.id)) || it.name===region.name);
              if (found && found.id) recordId = found.id;
            }
          }
          if (recordId && /^rec/i.test(recordId)){
            await fetch('/api/db-sync.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ scope:'regions', action:'delete', data:{ id: recordId } })
            });
          }
        }catch(e){ console.warn('deleteRegionOnServer failed', e); }
      }

      function renderCities(){
        level='cities'; /* keep selectedCity */ selectedPoi=null; renderCrumbs(); setMappingHeader('city');
        const list = citiesByRegion[selectedRegion.id] || [];
        // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ç—É –∂–µ +
        function findCityNameById(id){ const x=(list||[]).find(v=>v.id===id); return x?x.name:''; }
        cards.innerHTML = list.map(c=>{
            const count = (poisByCity[c.id]||[]).length;
            const inlineActions = '<div class="flex items-center gap-2 opacity-80">'+
                (c.code ? '<span class="ml-2 px-2 py-0.5 text-xs rounded border bg-gray-50 text-gray-600">'+c.code+'</span>' : '')+
                '<button data-act="edit-city" data-id="'+c.id+'" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
                '<button data-act="del-city" data-id="'+c.id+'" title="–£–¥–∞–ª–∏—Ç—å" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>'+
              '</div>';
            const inner = '<div class="flex items-center justify-between">\
                <div class="flex items-center gap-2">\
                  <svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" class="text-green-600"><path d="M3.5 6.5 9 4.5l6 2 5.5-2v13l-5.5 2-6-2-5.5 2v-13z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>\
                  <div class="text-lg text-gray-800">'+c.name+'</div>\
                </div>\
                '+inlineActions+'\
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">\
                  <div class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-50 border border-green-100 shadow-sm">\
                    <i class=\"fas fa-map-marker-alt text-green-600\"></i>\
                    <span class=\"text-xs font-medium text-green-700\">'+count+'</span>\
                  </div>\
                </div>\
              </div>';
          return '<div class="cursor-pointer" data-go="pois" data-id="'+c.id+'">'+card('', inner)+'</div>';
        }).join('') || '<div class="text-gray-500">–ù–µ—Ç –≥–æ—Ä–æ–¥–æ–≤. –ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>';
      }

      function renderPois(){
        level='pois'; /* keep selectedPoi */ renderCrumbs(); setMappingHeader('poi');
        const list = poisByCity[selectedCity.id] || [];
        const parentTypeLabel = selectedCity && selectedCity.type==='location' ? '–õ–æ–∫–∞—Ü–∏—è' : '–ì–æ—Ä–æ–¥';
          
        cards.innerHTML = list.map(p=>{
          // –ü–æ–ª—É—á–∞–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ POI
          const categoryIcon = window.getPOICategoryIcon(p.type);
          const categoryColor = {
            '–°–∏–Ω—Ç–æ–∏—Å—Ç—Å–∫–æ–µ —Å–≤—è—Ç–∏–ª–∏—â–µ': 'text-red-600',
            '–ë—É–¥–¥–∏–π—Å–∫–∏–π —Ö—Ä–∞–º': 'text-orange-600', 
            '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±—ä–µ–∫—Ç': 'text-gray-600',
            '–ú—É–∑–µ–π': 'text-blue-600',
            '–ê—Ä—Ç-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ / –ì–∞–ª–µ—Ä–µ—è': 'text-purple-600',
            '–°–º–æ—Ç—Ä–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞': 'text-green-600',
            '–õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–π —Å–∞–¥ / –ü–∞—Ä–∫': 'text-green-500',
            '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å': 'text-yellow-600',
            '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ': 'text-brown-600',
            '–Ø–ø–æ–Ω—Å–∫–∏–π –æ—Ç–µ–ª—å': 'text-indigo-600',
            '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è': 'text-pink-600',
            '–®–æ–ø–ø–∏–Ω–≥': 'text-emerald-600',
            '–¢–µ—Ä–º–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫': 'text-blue-500',
            '–°–ü–ê': 'text-teal-600'
          }[p.type] || 'text-gray-500';
          
          const inlineActions = '<div class="flex items-center gap-2 opacity-80">'+
              (p.poi_id ? '<span class="ml-2 px-2 py-0.5 text-xs rounded border bg-gray-50 text-gray-600">'+p.poi_id+'</span>' : '')+
            '</div>';
          
          const inner = '<div class="flex items-center justify-between">\
              <div class="flex items-center gap-2">\
                <div class="w-5 h-5 flex items-center justify-center '+categoryColor+' flex-shrink-0">\
                  '+categoryIcon.replace('w-6 h-6', 'w-4 h-4')+'\
                </div>\
                  <div class="text-lg text-gray-800">'+p.name+'</div>\
                  </div>\
              '+inlineActions+'\
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">\
                <div class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full '+
                  (categoryColor.replace('text-', 'bg-').replace('-600', '-50')+' border border-'+categoryColor.replace('text-', '').replace('-600', '-100'))+' shadow-sm">\
                  <span class=\"text-xs font-medium '+categoryColor.replace('-600', '-700')+'\">'+p.type+'</span>\
                </div>\
              </div>\
            </div>';
          // const actions = '<button data-act="edit-poi" data-id="'+p.id+'" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
          //                 '<button data-act="del-poi" data-id="'+p.id+'" title="–£–¥–∞–ª–∏—Ç—å" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>';
          // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å –∫–∞—Ä—Ç–æ—á–µ–∫ POI - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
          return '<div class="cursor-pointer" data-go="poi-details" data-id="'+p.id+'">'+card('', inner)+'</div>';
        }).join('') || '<div class="text-gray-500">–ù–µ—Ç POI. –ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>';
      }

      // Airtable-backed loaders for each level
      async function loadCitiesForRegion(region){
        try{
          const res = await fetch('/api/db-sync.php',{
            method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
            body: JSON.stringify({ scope:'cities', action:'list', data:{ filter:{ regionId: region.id, regionName: region.name } } })
          });
          const j = await res.json();
          const items = j.ok ? (j.items||[]) : [];
          citiesByRegion[region.id] = items.map(it=>({ id: it.id, name: it.name || it.fields?.['Name (RU)'] || it.fields?.['–ù–∞–∑–≤–∞–Ω–∏–µ (RU)'] || '‚Äî', code: (it.fields?.['ID'] || it.fields?.['–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä'] || ''), type: (it.fields?.Type||'city').toLowerCase()==='location'?'location':'city' }));
        }catch(e){ citiesByRegion[region.id] = []; }
      }

      async function loadPoisForCity(city){
        try{
            const baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || window.AIRTABLE_BASE_ID;
            
            console.log('Loading POIs for city:', {
              cityId: city.id,
              cityName: city.name,
              baseId: baseId,
              tableId: window.AIRTABLE_POI_TABLE_ID
            });
            
            // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ Airtable —á–µ—Ä–µ–∑ test-proxy
            const proxyUrl = '/api/test-proxy.php?provider=airtable&base_id=' + 
              encodeURIComponent(baseId) + '&table=' + encodeURIComponent(window.AIRTABLE_POI_TABLE_ID);
            
            console.log('Direct Airtable request URL:', proxyUrl);
            
            const res = await fetch(proxyUrl);
          const j = await res.json();
            
            console.log('POI API response:', j);
            
          // test-proxy –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥—Ä—É–≥—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          const records = j.ok ? (j.body?.records || j.records || []) : [];
          console.log('Raw POI records:', records);
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          console.log('All POI records for debugging:', records);
          console.log('Current city ID we are filtering for:', city.id);
          
          if (records.length > 0) {
            console.log('Sample POI record structure:', {
              id: records[0].id,
              fields: records[0].fields,
              regions_field: records[0].fields?.['Regions']
            });
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ POI –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤ (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
          poisByCity[city.id] = records.map(record=>({ 
            id: record.id, 
            name: record.fields?.['POI Name (RU)'] || record.fields?.['POI ID'] || '‚Äî', 
            type: (record.fields?.['POI Category (RU)']?.[0] || record.fields?.Category || ''),
            name_en: record.fields?.['POI Name (EN)'] || '',
            place_id: record.fields?.['Place ID'] || '',
            published: record.fields?.['Published'] || false,
            poi_id: record.fields?.['POI ID'] || '',
            region: record.fields?.['Regions'] || []
          }));
            
            console.log('Processed POIs for city:', city.name, poisByCity[city.id]);
          }catch(e){ 
            console.error('Error loading POIs for city:', city.name, e);
            poisByCity[city.id] = []; 
          }
      }

        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ POI –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞ - –∑–∞–≥—Ä—É–∂–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –≥–æ—Ä–æ–¥–∞–º
        async function preloadPoisCountsForRegion(region){
          try{
            const list = citiesByRegion[region.id] || [];
            if (!list.length) return;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤
            list.forEach(c => {
              if (!Array.isArray(poisByCity[c.id])) {
                poisByCity[c.id] = [];
              }
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ POI –æ–¥–∏–Ω —Ä–∞–∑
            const baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || window.AIRTABLE_BASE_ID;
            const proxyUrl = '/api/test-proxy.php?provider=airtable&base_id=' + 
              encodeURIComponent(baseId) + '&table=' + encodeURIComponent(window.AIRTABLE_POI_TABLE_ID);
            
            const res = await fetch(proxyUrl);
            const j = await res.json();
            const records = j.ok ? (j.body?.records || j.records || []) : [];
            
            console.log('Loading POI for region:', region.name, 'Total POI records:', records.length);
            
            // –í—Ä–µ–º–µ–Ω–Ω–æ - –¥–∞–µ–º –ø–µ—Ä–≤–æ–º—É –≥–æ—Ä–æ–¥—É –≤—Å–µ POI, –æ—Å—Ç–∞–ª—å–Ω—ã–º –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã
            // –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —É–≤–∏–¥–µ—Ç—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∏–ª—é–ª–∏
            list.forEach((city, index) => {
              if (index === 0) {
                // –ü–µ—Ä–≤—ã–π –≥–æ—Ä–æ–¥ –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ POI
                poisByCity[city.id] = records.map(record => ({
                  id: record.id, 
                  name: record.fields?.['POI Name (RU)'] || record.fields?.['POI ID'] || '‚Äî', 
                  type: (record.fields?.['POI Category (RU)']?.[0] || ''),
                  region: record.fields?.['Regions'] || [],
                  name_en: record.fields?.['POI Name (EN)'] || '',
                  place_id: record.fields?.['Place ID'] || '',
                  published: record.fields?.['Published'] || false,
                  poi_id: record.fields?.['POI ID'] || ''
                }));
              } else {
                // –û—Å—Ç–∞–ª—å–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –ø–æ–ª—É—á–∞—é—Ç –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã
                poisByCity[city.id] = [];
              }
              
              console.log(`City ${city.name} has ${poisByCity[city.id].length} POI`);
          });
          
          // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º –≥–æ—Ä–æ–¥–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ POI —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –ø–∏–ª—é–ª–∏
          if (level === 'cities') {
            renderCities();
          }
          
        }catch(e){
            console.error('Error preloading POI for region:', region.name, e);
          }
        }

      function renderTickets(){
        level='tickets'; renderCrumbs();
        const list = ticketsByPoi[selectedPoi.id] || [];
        cards.innerHTML = list.map(t=>{
          const actions = '<button data-act="edit-ticket" data-id="'+t.id+'" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
                          '<button data-act="del-ticket" data-id="'+t.id+'" title="–£–¥–∞–ª–∏—Ç—å" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>';
          const inner = '<div class="flex items-center justify-between">\
              <div class="text-gray-800"><span class="text-xs bg-gray-100 text-gray-700 inline-block px-2 py-0.5 rounded mr-2">üéü</span>'+t.category+'</div>\
              <div class="text-gray-700">'+t.price+'¬•</div>\
            </div>';
          return card(actions, inner);
        }).join('') || '<div class="text-gray-500">–ù–µ—Ç –±–∏–ª–µ—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>';
      }

      // –ù–∞–≤–∏–≥–∞—Ü–∏—è ‚Äî –æ–¥–∏–Ω –Ω–∞–¥—ë–∂–Ω—ã–π –¥–µ–ª–µ–≥–∞—Ç –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ —Å–µ–ª–µ–∫—Ç–æ—Ä—É –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö #db_cards
      document.addEventListener('click', async function(e){
        // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º –¥–µ–π—Å—Ç–≤–∏–π –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
        if (e.target.closest('button[data-act]')) return;
        const go = e.target.closest('#db_cards [data-go]');
        if (!go) { dlog('click outside actionable', e.target); return; }
        e.preventDefault();
        const id = go.getAttribute('data-id');
        const to = go.getAttribute('data-go');
        dlog('navigate', {to,id});
        if (to==='cities'){
          selectedRegion = regions.find(r=>r.id===id) || null;
          push('cities', { regionId: (selectedRegion ? selectedRegion.id : null) });
          await loadCitiesForRegion(selectedRegion);
          await preloadPoisCountsForRegion(selectedRegion);
          renderCities(); // —Ä–µ–Ω–¥–µ—Ä–∏–º –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ POI
          return;
        }
        if (to==='pois'){
          const list = citiesByRegion[selectedRegion.id] || [];
          selectedCity = list.find(c=>c.id===id) || null;
          push('pois', { regionId: (selectedRegion ? selectedRegion.id : null), cityId: (selectedCity ? selectedCity.id : null) });
          await loadPoisForCity(selectedCity);
          renderPois();
          return;
        }
          if (to==='poi-details'){
            const list = poisByCity[selectedCity.id] || [];
            const poi = list.find(p=>p.id===id) || null;
            if (poi) {
              showPOIDetailsModal(poi);
            }
            return;
          }
        if (to==='tickets'){
          const list = poisByCity[selectedCity.id] || [];
          selectedPoi = list.find(p=>p.id===id) || null;
          push('tickets', { regionId: (selectedRegion ? selectedRegion.id : null), cityId: (selectedCity ? selectedCity.id : null), poiId: (selectedPoi ? selectedPoi.id : null) });
          renderTickets();
          return;
        }
      });

      // Breadcrumbs ‚Äî —Å—Ç—Ä–æ–≥–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å –¥–µ–ª–µ–≥–∞—Ç–∞–º–∏
      crumbs.addEventListener('click', function(e){
        const a = e.target.closest && e.target.closest('a[data-level]');
        if (!a) return;
        e.preventDefault();
        const lv = a.getAttribute('data-level');
        if (lv==='regions'){
          selectedRegion=null; selectedCity=null; selectedPoi=null;
          push('regions'); renderRegions(); return;
        }
        if (lv==='cities'){
          const regionId = a.getAttribute('data-region-id');
          selectedRegion = regions.find(r=>r.id===regionId) || selectedRegion;
          selectedCity=null; selectedPoi=null;
          push('cities', { regionId: (selectedRegion?selectedRegion.id:null) });
          renderCities(); return;
        }
        if (lv==='pois'){
          const regionId = a.getAttribute('data-region-id');
          const cityId = a.getAttribute('data-city-id');
          selectedRegion = regions.find(r=>r.id===regionId) || selectedRegion;
          const list = selectedRegion ? (citiesByRegion[selectedRegion.id]||[]) : [];
          selectedCity = list.find(c=>c.id===cityId) || selectedCity;
          selectedPoi=null;
          push('pois', { regionId: (selectedRegion?selectedRegion.id:null), cityId: (selectedCity?selectedCity.id:null) });
          renderPois(); return;
        }
      });

      // Back button
      document.getElementById('db_back')?.addEventListener('click', function(){
        if (level==='cities') return renderRegions();
        if (level==='pois') return renderCities();
        if (level==='tickets') return renderPois();
      });

      // Card action buttons
      cards.addEventListener('click', async function(e){
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        e.stopPropagation();
        const act = btn.getAttribute('data-act');
        const id = btn.getAttribute('data-id');
        if (act==='edit-region'){
          const r = regions.find(x=>x.id===id); if(!r) return; const n=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞:', r.name); if(n){
            const old = r.name; r.name=n.trim(); renderRegions();
            try{
              await fetch('/api/db-sync.php',{
                method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
                body: JSON.stringify({ scope:'regions', action:'update', data:{ id: r.id, name: r.name } })
              }).then(async res=>{ if(!res.ok){ throw new Error('HTTP '+res.status); } const j=await res.json(); if(!j.ok) throw new Error(j.error||'Airtable'); });
              if (window.osNotify) window.osNotify('–û–±–Ω–æ–≤–ª–µ–Ω–æ','–†–µ–≥–∏–æ–Ω –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω');
            }catch(e){ r.name = old; renderRegions(); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: '+(e && e.message ? e.message : '')); }
          }
        } else if (act==='del-region'){
          const r = regions.find(x=>x.id===id);
          regions = regions.filter(x=>x.id!==id); delete citiesByRegion[id]; renderRegions();
          if (r) deleteRegionOnServer(r);
        } else if (act==='edit-city'){
          const list = citiesByRegion[selectedRegion.id]||[]; const c=list.find(x=>x.id===id); if(!c) return; const n=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞/–ª–æ–∫–∞—Ü–∏–∏:', c.name); if(n){
            const old=c.name; c.name=n.trim(); renderCities();
            try{
              await fetch('/api/db-sync.php',{
                method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
                body: JSON.stringify({ scope:'cities', action:'update', data:{ id: c.id, name: c.name } })
              }).then(async res=>{ if(!res.ok){ throw new Error('HTTP '+res.status); } const j=await res.json(); if(!j.ok) throw new Error(j.error||'Airtable'); });
              if (window.osNotify) window.osNotify('–û–±–Ω–æ–≤–ª–µ–Ω–æ','–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            }catch(e){ c.name=old; renderCities(); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: '+(e && e.message ? e.message : '')); }
          }
        } else if (act==='del-city'){
          const list = citiesByRegion[selectedRegion.id]||[]; citiesByRegion[selectedRegion.id] = list.filter(x=>x.id!==id); delete poisByCity[id]; renderCities();
        } else if (act==='edit-poi'){
            // –ù–∞—Ö–æ–¥–∏–º POI –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const list = poisByCity[selectedCity.id]||[];
            const poi = list.find(x=>x.id===id);
            if (!poi) return;
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const data = await openCreatePOIModal(poi);
            if (!data) return;
            
            try {
              // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
              Object.assign(poi, {
                name: data.name_ru,
                name_en: data.name_en,
                type: data.cats_ru[0] || poi.type,
                categories_ru: data.cats_ru,
                categories_en: data.cats_en,
                prefecture_ru: data.pref_ru,
                prefecture_en: data.pref_en,
                place_id: data.place_id,
                website: data.website,
                hours: data.hours,
                description_ru: data.desc_ru,
                description_en: data.desc_en,
                published: data.published,
                notes: data.notes
              });
              
              // –ü–æ–ª—É—á–∞–µ–º base_id –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
              const baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || window.AIRTABLE_BASE_ID;
              
              // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Airtable
              const airtableFields = {
                'POI ID': poi.id,
                'POI Name (RU)': poi.name,
                'POI Name (EN)': poi.name_en,
                'Regions': [selectedRegion.id], // Link to Regions table
                'Prefecture (RU)': poi.prefecture_ru,
                'Prefecture (EN)': poi.prefecture_en,
                'POI Category (RU)': poi.categories_ru,
                'POI Category (EN)': poi.categories_en,
                'Place ID': poi.place_id,
                'Website': poi.website,
                'Working Hours': poi.hours,
                'Description (RU)': poi.description_ru,
                'Description (EN)': poi.description_en,
                'Published': poi.published,
                'Notes': poi.notes
              };
              
              // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
              const res = await fetch('/api/db-sync.php', {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'X-Admin-Token': window.ADMIN_TOKEN || ''
                },
                body: JSON.stringify({
                  scope: 'pois',
                  action: 'update',
                  data: {
                    id: poi.id,
                    base_id: baseId,
                    table_id: window.AIRTABLE_POI_TABLE_ID,
                    fields: airtableFields,
                    localData: poi
                  }
                })
              });
              
              const j = await res.json();
              if (!res.ok || !j.ok) {
                throw new Error((j && j.error) || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
              }
              
              if (window.osNotify) {
                window.osNotify('POI –æ–±–Ω–æ–≤–ª—ë–Ω', data.name_ru);
              }
              
              renderPois();
            } catch(e) {
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å POI: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
              // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            }
        } else if (act==='del-poi'){
          const list = poisByCity[selectedCity.id]||[]; poisByCity[selectedCity.id] = list.filter(x=>x.id!==id); delete ticketsByPoi[id]; renderPois();
        } else if (act==='edit-ticket'){
          const list = ticketsByPoi[selectedPoi.id]||[]; const t = list.find(x=>x.id===id); if(!t) return; const c=prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è:', t.category)||t.category; const p=prompt('–¶–µ–Ω–∞ (¬•):', String(t.price))||String(t.price); const n=prompt('–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:', t.note||'')||t.note; t.category=c.trim(); t.price=parseInt(p,10)||t.price; t.note=n.trim(); renderTickets();
        } else if (act==='del-ticket'){
          const list = ticketsByPoi[selectedPoi.id]||[]; ticketsByPoi[selectedPoi.id] = list.filter(x=>x.id!==id); renderTickets();
        }
      });

      // Floating add button
      function genId(prefix, n){ return prefix+'-'+String(n).padStart(3,'0'); }

      // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–∞ (RU/EN)
      function openCreateRegionModal(){
        return new Promise(resolve=>{
          const wrap = document.createElement('div');
          wrap.className = 'fixed inset-0 z-50 flex items-center justify-center';
          wrap.innerHTML = '\
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
            <div class="relative bg-white rounded-lg shadow-xl p-6 w-96">\
              <div class="text-lg text-gray-800 mb-4">–ù–æ–≤—ã–π —Ä–µ–≥–∏–æ–Ω</div>\
              <div class="space-y-3">\
                <input id="cr_ru" class="input-japanese w-full" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (RU)"/>\
                <input id="cr_en" class="input-japanese w-full" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (EN)"/>\
              </div>\
              <div class="mt-5 flex justify-end gap-2">\
                <button id="cr_cancel" class="btn-japanese">–û—Ç–º–µ–Ω–∞</button>\
                <button id="cr_ok" class="btn-japanese accent">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>\
              </div>\
            </div>';
          document.body.appendChild(wrap);
          function done(val){ try{ document.body.removeChild(wrap); }catch{} resolve(val||null); }
          wrap.addEventListener('click', e=>{ if (e.target===wrap.firstChild) done(null); });
          wrap.querySelector('#cr_cancel').addEventListener('click', ()=>done(null));
          wrap.querySelector('#cr_ok').addEventListener('click', ()=>{
            const ru = wrap.querySelector('#cr_ru').value.trim();
            const en = wrap.querySelector('#cr_en').value.trim();
            if (!ru || !en){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è'); return; }
            done({ ru, en });
          });
          wrap.querySelector('#cr_ru').focus();
        });
      }
        
      // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ POI
      function showPOIDetailsModal(poi) {
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
        wrap.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        
        const categoryIcon = window.getPOICategoryIcon(poi.type);
        const categoryColor = {
          '–°–∏–Ω—Ç–æ–∏—Å—Ç—Å–∫–æ–µ —Å–≤—è—Ç–∏–ª–∏—â–µ': 'text-red-600',
          '–ë—É–¥–¥–∏–π—Å–∫–∏–π —Ö—Ä–∞–º': 'text-orange-600', 
          '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±—ä–µ–∫—Ç': 'text-gray-600',
          '–ú—É–∑–µ–π': 'text-blue-600',
          '–ê—Ä—Ç-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ / –ì–∞–ª–µ—Ä–µ—è': 'text-purple-600',
          '–°–º–æ—Ç—Ä–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞': 'text-green-600',
          '–õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–π —Å–∞–¥ / –ü–∞—Ä–∫': 'text-green-500',
          '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å': 'text-yellow-600',
          '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ': 'text-brown-600',
          '–Ø–ø–æ–Ω—Å–∫–∏–π –æ—Ç–µ–ª—å': 'text-indigo-600',
          '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è': 'text-pink-600',
          '–®–æ–ø–ø–∏–Ω–≥': 'text-emerald-600',
          '–¢–µ—Ä–º–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫': 'text-blue-500',
          '–°–ü–ê': 'text-teal-600'
        }[poi.type] || 'text-gray-500';
        
        wrap.innerHTML = `
          <div class="absolute inset-0" onclick="this.parentElement.remove()"></div>
          <div class="relative bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg flex items-center justify-center ${categoryColor} shadow-sm">
                  ${categoryIcon}
                </div>
                <div>
                  <h3 class="text-xl font-medium text-gray-900">${poi.name}</h3>
                  <p class="text-sm text-gray-600">${poi.type}</p>
                </div>
              </div>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="space-y-4">
              ${poi.poi_id ? `<div class="flex items-center gap-2">
                <span class="text-sm font-medium text-gray-700">POI ID:</span>
                <span class="font-mono text-sm text-gray-600">${poi.poi_id}</span>
              </div>` : ''}
              
              ${poi.name_en ? `<div class="flex items-center gap-2">
                <span class="text-sm font-medium text-gray-700">English Name:</span>
                <span class="text-sm text-gray-600">${poi.name_en}</span>
              </div>` : ''}
              
              ${poi.place_id ? `<div class="flex items-center gap-2">
                <span class="text-sm font-medium text-gray-700">Google Place ID:</span>
                <a href="https://www.google.com/maps/search/?api=1&query=place_id:${poi.place_id}" 
                   target="_blank" class="text-sm text-blue-600 hover:underline font-mono">
                  ${poi.place_id} <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                </a>
              </div>` : ''}
              
              ${poi.website ? `<div class="flex items-center gap-2">
                <span class="text-sm font-medium text-gray-700">–°–∞–π—Ç:</span>
                <a href="${poi.website}" target="_blank" class="text-sm text-blue-600 hover:underline">
                  ${poi.website} <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                </a>
              </div>` : ''}
              
              ${poi.hours ? `<div class="flex items-center gap-2">
                <span class="text-sm font-medium text-gray-700">–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:</span>
                <span class="text-sm text-gray-600">${poi.hours}</span>
              </div>` : ''}
              
              ${poi.description_ru ? `<div>
                <span class="text-sm font-medium text-gray-700 block mb-1">–û–ø–∏—Å–∞–Ω–∏–µ:</span>
                <p class="text-sm text-gray-600 leading-relaxed">${poi.description_ru}</p>
              </div>` : ''}
              
              ${poi.description_en ? `<div>
                <span class="text-sm font-medium text-gray-700 block mb-1">Description (EN):</span>
                <p class="text-sm text-gray-600 leading-relaxed">${poi.description_en}</p>
              </div>` : ''}
              
              <div class="flex items-center justify-between pt-4 border-t">
                <div class="flex items-center gap-4">
                  ${poi.published ? '<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800"><i class="fas fa-eye mr-2"></i>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>' : '<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-600">–ù–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>'}
                  ${((ticketsByPoi[poi.id]||[]).length > 0) ? '<span class="inline-flex items-center text-sm text-blue-600"><i class="fas fa-ticket mr-2"></i>'+((ticketsByPoi[poi.id]||[]).length)+' –±–∏–ª–µ—Ç–æ–≤</span>' : ''}
                </div>
                <div class="flex gap-2">
                  <button onclick="savePOIRecord('${poi.id}')" class="btn-japanese text-sm py-1 px-2" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å">
                    <i class="fas fa-download"></i>
                  </button>
                  <button onclick="showTicketsForPOI('${poi.id}')" class="btn-japanese text-sm py-1 px-3">
                    <i class="fas fa-ticket mr-1"></i>–ë–∏–ª–µ—Ç—ã
                  </button>
                  <button onclick="this.closest('.fixed').remove(); editPOI('${poi.id}')" class="btn-japanese accent text-sm py-1 px-3">
                    <i class="fas fa-edit mr-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(wrap);
      }
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –±–∏–ª–µ—Ç–æ–≤ POI
      window.showTicketsForPOI = function(poiId) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.querySelector('.fixed')?.remove();
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –±–∏–ª–µ—Ç–∞–º
        const list = poisByCity[selectedCity.id] || [];
        selectedPoi = list.find(p=>p.id===poiId) || null;
        push('tickets', { regionId: (selectedRegion ? selectedRegion.id : null), cityId: (selectedCity ? selectedCity.id : null), poiId: (selectedPoi ? selectedPoi.id : null) });
        renderTickets();
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ POI (—ç–∫—Å–ø–æ—Ä—Ç –≤ JSON)
      window.savePOIRecord = function(poiId) {
        const list = poisByCity[selectedCity.id] || [];
        const poi = list.find(p=>p.id===poiId) || null;
        if (!poi) return;
        
        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
        const exportData = {
          poi_id: poi.poi_id || poi.id,
          name_ru: poi.name,
          name_en: poi.name_en,
          category: poi.type,
          place_id: poi.place_id,
          website: poi.website,
          hours: poi.hours,
          description_ru: poi.description_ru,
          description_en: poi.description_en,
          published: poi.published,
          city: selectedCity.name,
          region: selectedRegion.name,
          exported_at: new Date().toISOString()
        };
        
        // –°–∫–∞—á–∏–≤–∞–µ–º –∫–∞–∫ JSON —Ñ–∞–π–ª
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `poi-${poi.poi_id || poi.id}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        if (window.osNotify) {
          window.osNotify('–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', `–§–∞–π–ª poi-${poi.poi_id || poi.id}.json —Å–∫–∞—á–∞–Ω`);
        }
      };

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è POI
      window.editPOI = async function(poiId) {
        const list = poisByCity[selectedCity.id] || [];
        const poi = list.find(p=>p.id===poiId) || null;
        if (!poi) return;
        
        const data = await openCreatePOIModal(poi);
        if (!data) return;
        
        // –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è POI (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ edit-poi)
        Object.assign(poi, {
          name: data.name_ru,
          name_en: data.name_en,
          type: data.cats_ru[0] || poi.type,
          categories_ru: data.cats_ru,
          categories_en: data.cats_en,
          prefecture_ru: data.pref_ru,
          prefecture_en: data.pref_en,
          place_id: data.place_id,
          website: data.website,
          hours: data.hours,
          description_ru: data.desc_ru,
          description_en: data.desc_en,
          published: data.published,
          notes: data.notes
        });
        
        renderPois();
        if (window.osNotify) {
          window.osNotify('POI –æ–±–Ω–æ–≤–ª—ë–Ω', data.name_ru);
        }
      };

      // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è POI
      function openCreatePOIModal(editData = null){
          return new Promise(resolve=>{
            const isEdit = !!editData;
            const wrap = document.createElement('div');
            wrap.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 overflow-y-auto';
            wrap.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            // –ü—Ä–µ—Ñ–µ–∫—Ç—É—Ä—ã –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤
            const prefectures = [
              {value: 'tokyo', ru: '–¢–æ–∫–∏–æ', en: 'Tokyo'},
              {value: 'kyoto', ru: '–ö–∏–æ—Ç–æ', en: 'Kyoto'},
              {value: 'osaka', ru: '–û—Å–∞–∫–∞', en: 'Osaka'},
              {value: 'kanagawa', ru: '–ö–∞–Ω–∞–≥–∞–≤–∞', en: 'Kanagawa'},
              {value: 'aichi', ru: '–ê–π—Ç–∏', en: 'Aichi'},
              {value: 'fukuoka', ru: '–§—É–∫—É–æ–∫–∞', en: 'Fukuoka'},
              {value: 'hokkaido', ru: '–•–æ–∫–∫–∞–π–¥–æ', en: 'Hokkaido'},
              {value: 'hiroshima', ru: '–•–∏—Ä–æ—Å–∏–º–∞', en: 'Hiroshima'},
              {value: 'nara', ru: '–ù–∞—Ä–∞', en: 'Nara'},
              {value: 'okinawa', ru: '–û–∫–∏–Ω–∞–≤–∞', en: 'Okinawa'}
            ];
            
            const categories_ru = ['–°–∏–Ω—Ç–æ–∏—Å—Ç—Å–∫–æ–µ —Å–≤—è—Ç–∏–ª–∏—â–µ', '–ë—É–¥–¥–∏–π—Å–∫–∏–π —Ö—Ä–∞–º', '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±—ä–µ–∫—Ç', '–ú—É–∑–µ–π', '–ê—Ä—Ç-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ / –ì–∞–ª–µ—Ä–µ—è', '–°–º–æ—Ç—Ä–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞', '–õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–π —Å–∞–¥ / –ü–∞—Ä–∫', '–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ', '–Ø–ø–æ–Ω—Å–∫–∏–π –æ—Ç–µ–ª—å', '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', '–®–æ–ø–ø–∏–Ω–≥', '–¢–µ—Ä–º–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫', '–°–ü–ê'];
            const categories_en = ['Shinto Shrine', 'Buddhist Temple', 'Architectural Object', 'Museum', 'Art Venue', 'Viewing Spot', 'Park/Garden', 'City Attraction', 'Historical Location', 'Restaurant', 'Amusement', 'Shopping', 'Hot Spring', 'SPA'];
            
            wrap.innerHTML = `
              <div class="absolute inset-0" onclick="this.parentElement.querySelector('#poi_cancel').click()"></div>
              <div class="relative bg-white rounded-lg shadow-xl p-4 w-full max-w-5xl max-h-[95vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-lg font-medium text-gray-800">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å POI' : '–ù–æ–≤—ã–π POI'}</h3>
                  <button id="poi_close" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                
                <form id="poi_form" class="space-y-3">
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                    <div class="space-y-3">
                      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2 flex items-center">
                          <i class="fas fa-info-circle mr-1 text-blue-600 text-xs"></i>
                          –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </h4>
                        <div class="grid grid-cols-1 gap-2">
                          <div>
                            <label class="block text-xs font-medium text-gray-700">
                              –ù–∞–∑–≤–∞–Ω–∏–µ (RU) <span class="text-red-500">*</span>
                            </label>
                            <input id="poi_name_ru" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="–ù–∞ —Ä—É—Å—Å–∫–æ–º" required
                                  value="${editData ? editData.name : ''}">
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">
                              Name (EN) <span class="text-red-500">*</span>
                            </label>
                            <input id="poi_name_en" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="In English" required
                                  value="${editData ? editData.name_en || '' : ''}">
                          </div>
                          <div class="grid grid-cols-2 gap-2">
                            <div>
                              <label class="block text-xs font-medium text-gray-700">
                                –ü—Ä–µ—Ñ–µ–∫—Ç—É—Ä–∞ <span class="text-red-500">*</span>
                              </label>
                              <select id="poi_pref_ru" class="input-japanese w-full text-sm py-1" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                                ${prefectures.map(p => `<option value="${p.value}">${p.ru}</option>`).join('')}
                              </select>
                            </div>
                            <div>
                              <label class="block text-xs font-medium text-gray-700">
                                Prefecture <span class="text-red-500">*</span>
                              </label>
                              <select id="poi_pref_en" class="input-japanese w-full text-sm py-1" required>
                                <option value="">Select</option>
                                ${prefectures.map(p => `<option value="${p.value}">${p.en}</option>`).join('')}
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Google –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –∫–æ–Ω—Ç–µ–Ω—Ç -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2">
                          <i class="fab fa-google mr-1 text-blue-600 text-xs"></i>
                          Google & –ö–æ–Ω—Ç–µ–Ω—Ç
                        </h4>
                        <div class="space-y-2">
                          <div>
                            <label class="block text-xs font-medium text-gray-700">Google Place ID</label>
                            <input id="poi_place_id" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="ChIJ..." pattern="^[A-Za-z0-9_-]{25,}$">
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">–°–∞–π—Ç</label>
                            <input id="poi_website" type="url" class="input-japanese w-full text-sm py-1" 
                                  placeholder="https://...">
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã</label>
                            <input id="poi_hours" type="text" class="input-japanese w-full text-sm py-1" 
                                  placeholder="09:00-17:00">
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                    <div class="space-y-3">
                      <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2">
                          <i class="fas fa-tags mr-1 text-purple-600 text-xs"></i>
                          –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ <span class="text-red-500">*</span>
                        </h4>
                        <div class="grid grid-cols-2 gap-2">
                          <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">RU</label>
                            <div class="space-y-1 max-h-28 overflow-y-auto border border-gray-200 rounded p-1">
                              ${categories_ru.map((cat) => `
                                <label class="flex items-center text-xs">
                                  <input type="checkbox" name="cats_ru" value="${cat}" class="mr-1">
                                  <span>${cat}</span>
                                </label>
                              `).join('')}
                            </div>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">EN</label>
                            <div class="space-y-1 max-h-28 overflow-y-auto border border-gray-200 rounded p-1">
                              ${categories_en.map((cat) => `
                                <label class="flex items-center text-xs">
                                  <input type="checkbox" name="cats_en" value="${cat}" class="mr-1">
                                  <span>${cat}</span>
                                </label>
                              `).join('')}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- –û–ø–∏—Å–∞–Ω–∏—è -->
                      <div class="bg-gray-50 rounded p-3">
                        <h4 class="text-xs font-medium text-gray-700 mb-2">
                          <i class="fas fa-align-left mr-1 text-green-600 text-xs"></i>
                          –û–ø–∏—Å–∞–Ω–∏—è
                        </h4>
                        <div class="space-y-2">
                          <div>
                            <label class="block text-xs font-medium text-gray-700">–û–ø–∏—Å–∞–Ω–∏–µ (RU)</label>
                            <textarea id="poi_desc_ru" class="input-japanese w-full text-sm py-1" rows="2"
                                      placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                          </div>
                          <div>
                            <label class="block text-xs font-medium text-gray-700">Description (EN)</label>
                            <textarea id="poi_desc_en" class="input-japanese w-full text-sm py-1" rows="2"
                                      placeholder="Brief description"></textarea>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∏ –∑–∞–º–µ—Ç–∫–∏ - –≤–Ω–∏–∑—É –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É -->
                  <div class="bg-gray-50 rounded p-3">
                    <div class="flex items-center justify-between">
                      <label class="flex items-center">
                        <input id="poi_published" type="checkbox" class="mr-2">
                        <span class="text-sm text-gray-700">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</span>
                      </label>
                      <div class="flex-1 ml-4">
                        <input id="poi_notes" type="text" class="input-japanese w-full text-sm py-1" 
                              placeholder="–ó–∞–º–µ—Ç–∫–∏ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ)">
                      </div>
                    </div>
                  </div>
                </form>
                
                <div class="mt-4 flex justify-end gap-2">
                  <button id="poi_cancel" class="btn-japanese text-sm py-1 px-3">–û—Ç–º–µ–Ω–∞</button>
                  <button id="poi_save" class="btn-japanese accent text-sm py-1 px-3">
                    <i class="fas fa-save mr-1"></i>
                    ${isEdit ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å'}
                  </button>
                </div>
              </div>
            `;
            
            document.body.appendChild(wrap);
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ñ–µ–∫—Ç—É—Ä
            const prefRu = wrap.querySelector('#poi_pref_ru');
            const prefEn = wrap.querySelector('#poi_pref_en');
            prefRu.addEventListener('change', () => { prefEn.value = prefRu.value; });
            prefEn.addEventListener('change', () => { prefRu.value = prefEn.value; });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            function done(val){ 
              try{ document.body.removeChild(wrap); }catch{} 
              resolve(val||null); 
            }
            
            wrap.querySelector('#poi_close').addEventListener('click', ()=>done(null));
            wrap.querySelector('#poi_cancel').addEventListener('click', ()=>done(null));
            
            wrap.querySelector('#poi_save').addEventListener('click', ()=>{
              const form = wrap.querySelector('#poi_form');
              if (!form.checkValidity()) {
                form.reportValidity();
                return;
              }
              
              const cats_ru = Array.from(wrap.querySelectorAll('input[name="cats_ru"]:checked')).map(cb => cb.value);
              const cats_en = Array.from(wrap.querySelectorAll('input[name="cats_en"]:checked')).map(cb => cb.value);
              
              if (cats_ru.length === 0 || cats_en.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —è–∑—ã–∫–∞');
                return;
              }
              
              const data = {
                name_ru: wrap.querySelector('#poi_name_ru').value.trim(),
                name_en: wrap.querySelector('#poi_name_en').value.trim(),
                pref_ru: prefRu.value,
                pref_en: prefEn.value,
                cats_ru: cats_ru,
                cats_en: cats_en,
                place_id: wrap.querySelector('#poi_place_id').value.trim(),
                website: wrap.querySelector('#poi_website').value.trim(),
                hours: wrap.querySelector('#poi_hours').value.trim(),
                desc_ru: wrap.querySelector('#poi_desc_ru').value.trim(),
                desc_en: wrap.querySelector('#poi_desc_en').value.trim(),
                published: wrap.querySelector('#poi_published').checked,
                notes: wrap.querySelector('#poi_notes').value.trim()
              };
              
              done(data);
            });
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
            wrap.querySelector('#poi_name_ru').focus();
            
            // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            if (isEdit && editData) {
              // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—è –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
              if (editData.type) {
                // –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤—ã–±—Ä–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                const typeMap = {
                  '–∫—É–ª—å—Ç—É—Ä–∞': '–ö—É–ª—å—Ç—É—Ä–∞',
                  '–ø—Ä–∏—Ä–æ–¥–∞': '–ü—Ä–∏—Ä–æ–¥–Ω–∞—è –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
                  '–≥–∞—Å—Ç—Ä–æ': '–ì–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è',
                  '—Ö—Ä–∞–º': '–•—Ä–∞–º',
                  '–∑–∞–º–æ–∫': '–ó–∞–º–æ–∫',
                  '–º—É–∑–µ–π': '–ú—É–∑–µ–π'
                };
                const catRu = typeMap[editData.type.toLowerCase()] || editData.type;
                const catCheckbox = wrap.querySelector(`input[name="cats_ru"][value="${catRu}"]`);
                if (catCheckbox) catCheckbox.checked = true;
              }
            }
          });
        }

      // –í—ã–±–æ—Ä —Ç–∏–ø–∞ (–ì–æ—Ä–æ–¥/–õ–æ–∫–∞—Ü–∏—è) ‚Äî –º–æ–¥–∞–ª–∫–∞ —Å 2 –∫–Ω–æ–ø–∫–∞–º–∏
      function chooseCityType(){
        if (level !== 'cities') { return Promise.resolve(null); }
        return new Promise((resolve)=>{
          const wrap = document.createElement('div');
          wrap.className = 'fixed inset-0 z-50 flex items-center justify-center';
          wrap.innerHTML = '\
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
            <div class="relative bg-white rounded-lg shadow-xl p-6 w-80">\
              <div class="text-lg text-gray-800 mb-4">–¢–∏–ø –∑–∞–ø–∏—Å–∏</div>\
              <div class="grid grid-cols-2 gap-3">\
                <button id="btn_type_city" class="btn-japanese w-full text-center">–ì–æ—Ä–æ–¥</button>\
                <button id="btn_type_location" class="btn-japanese w-full text-center">–õ–æ–∫–∞—Ü–∏—è</button>\
              </div>\
              <div class="mt-4 text-xs text-gray-500 text-center">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–ø–∏—Å–∏</div>\
            </div>';
          document.body.appendChild(wrap);
          function done(val){
            document.body.removeChild(wrap);
            resolve(val);
          }
          wrap.querySelector('#btn_type_city').addEventListener('click', function(){ done('city'); });
          wrap.querySelector('#btn_type_location').addEventListener('click', function(){ done('location'); });
          wrap.addEventListener('click', function(e){ if (e.target===wrap.firstChild) { done(null); } });
          document.addEventListener('keydown', function onEsc(ev){ if (ev.key==='Escape'){ document.removeEventListener('keydown', onEsc); try{ document.body.removeChild(wrap); }catch{} resolve(null); } });
        });
      }

      if (fab) fab.addEventListener('click', async function(){
        if (level==='regions'){
          const data = await openCreateRegionModal();
          if (!data) return;
          try{
            const res = await fetch('/api/regions-create.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({ 
                  name_ru: data.ru, 
                  name_en: data.en,
                  base_id: window.AIRTABLE_BASE_ID,
                  table_id: window.AIRTABLE_REGIONS_TABLE_ID
                })
            });
            const j = await res.json().catch(()=>({}));
            if (!res.ok || !j.ok){
              const detailsMsg = (j && (j.details?.error?.message || j.details?.message || j.error)) || ('HTTP '+res.status);
              console.error('REGION_CREATE_ERR', j);
              throw new Error(detailsMsg);
            }
            if (window.osNotify){ window.osNotify('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ','ID: '+j.region_id); } else { alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: '+j.region_id); }
            await syncRegionsFromAirtable();
          }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–≥–∏–æ–Ω: '+(e && e.message ? e.message : '')); }
        } else if (level==='cities'){
          // –º–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ + –≤–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è
          const picked = await chooseCityType(); if (!picked) return;
          const wrap = await new Promise(res=>{
            const w = document.createElement('div');
            w.className='fixed inset-0 z-50 flex items-center justify-center';
            w.innerHTML='\
              <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
              <div class="relative bg-white rounded-lg shadow-xl p-6 w-96">\
                <div class="text-lg text-gray-800 mb-4">'+(picked==='location'?'–ù–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è':'–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥')+'</div>\
                <div class="space-y-3">\
                  <input id="nm_ru" class="input-japanese w-full" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (RU)"/>\
                  <input id="nm_en" class="input-japanese w-full" placeholder="Name (EN)"/>\
                </div>\
                <div class="mt-5 flex justify-end gap-2">\
                  <button id="c" class="btn-japanese">–û—Ç–º–µ–Ω–∞</button>\
                  <button id="o" class="btn-japanese accent">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>\
                </div>\
              </div>';
            document.body.appendChild(w);
            w.querySelector('#c').onclick=()=>{ try{document.body.removeChild(w);}catch{}; res(null); };
            w.querySelector('#o').onclick=()=>{ const ru=w.querySelector('#nm_ru').value.trim(); const en=w.querySelector('#nm_en').value.trim(); if(!ru){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ RU');return;} try{document.body.removeChild(w);}catch{}; res({ru,en}); };
            w.addEventListener('click',e=>{ if(e.target===w.firstChild){ try{document.body.removeChild(w);}catch{}; res(null);} });
          });
          if (!wrap) return; const name_ru = wrap.ru; const name_en = wrap.en || wrap.ru;
          try{
            const res = await fetch('/api/cities-create.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({ 
                  name_ru: name_ru, 
                  name_en: name_en, 
                  type: picked, 
                  region_rec_id: selectedRegion.id, 
                  region_name: selectedRegion.name, 
                  region_rid: (selectedRegion.rid||''),
                  base_id: window.AIRTABLE_BASE_ID,
                  table_id: window.AIRTABLE_CITIES_TABLE_ID
                })
            });
            const j = await res.json();
            if (!res.ok || !j.ok) throw new Error((j && (j.error || j.details?.error?.message)) || ('HTTP '+res.status));
            if (window.osNotify){ window.osNotify('–ì–æ—Ä–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω', (j.linked? '–°–≤—è–∑—å —Å —Ä–µ–≥–∏–æ–Ω–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' : '–°–æ–∑–¥–∞–Ω –±–µ–∑ —Å–≤—è–∑–∏: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ —Å–≤—è–∑–∏')); }
            await loadCitiesForRegion(selectedRegion); await preloadPoisCountsForRegion(selectedRegion); renderCities();
          }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: '+(e && e.message ? e.message : '')); }
        } else if (level==='pois'){
            const data = await openCreatePOIModal();
            if (!data) return;
            
            try {
              // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –¥–ª—è –Ω–æ–≤–æ–≥–æ POI –≤ —Ñ–æ—Ä–º–∞—Ç–µ POI-00000x
          const list = poisByCity[selectedCity.id] || (poisByCity[selectedCity.id]=[]);
              const nextNumber = list.length + 1;
              const id = 'POI-' + String(nextNumber).padStart(6, '0');
              
              // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç POI —Å –ø–æ–ª–Ω–æ–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
              const newPoi = {
                id: id,
                name: data.name_ru,
                name_en: data.name_en,
                type: data.cats_ru[0] || '–î—Ä—É–≥–æ–µ', // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–∞–∫ —Ç–∏–ø
                categories_ru: data.cats_ru,
                categories_en: data.cats_en,
                prefecture_ru: data.pref_ru,
                prefecture_en: data.pref_en,
                place_id: data.place_id,
                website: data.website,
                hours: data.hours,
                description_ru: data.desc_ru,
                description_en: data.desc_en,
                published: data.published,
                notes: data.notes,
                city_id: selectedCity.id,
                region_id: selectedRegion.id
              };
              
              // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
              list.push(newPoi);
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ window.airtableReg, –µ—Å–ª–∏ –Ω–µ—Ç - –∑–∞–≥—Ä—É–∂–∞–µ–º
              if (!window.airtableReg) {
                await loadDbConfig();
              }
              
              // –ü–æ–ª—É—á–∞–µ–º base_id –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
              const baseId = (window.airtableReg && (window.airtableReg.baseId || window.airtableReg.base_id)) || window.AIRTABLE_BASE_ID;
              
              // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
              console.log('Creating POI with:', {
                baseId: baseId,
                tableId: window.AIRTABLE_POI_TABLE_ID,
                dataExists: !!data,
                constants: {
                  base: window.AIRTABLE_BASE_ID,
                  poi_table: window.AIRTABLE_POI_TABLE_ID
                }
              });
              
              // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Airtable —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
              const airtableFields = {
                'POI ID': id,
                'POI Name (RU)': data.name_ru,
                'POI Name (EN)': data.name_en,
                'Regions': [selectedCity.id], // Link to parental Locations/Cities
                'Prefecture (RU)': data.pref_ru,
                'Prefecture (EN)': data.pref_en,
                'Place ID': data.place_id,
                'POI Category (RU)': data.cats_ru,
                'POI Category (EN)': data.cats_en,
                'Working Hours': data.hours,
                'Website': data.website,
                'Description (RU)': data.desc_ru,
                'Description (EN)': data.desc_en,
                'Published': data.published,
                'Notes': data.notes,
                'Tickets': [] // –ë–∏–ª–µ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Å–≤—è–∑—å —Å —Ç–∞–±–ª–∏—Ü–µ–π Tickets
              };
              
              // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
              const res = await fetch('/api/db-sync.php', {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'X-Admin-Token': window.ADMIN_TOKEN || ''
                },
                body: JSON.stringify({
                  scope: 'pois',
                  action: 'create',
                  data: {
                    base_id: baseId,
                    table_id: window.AIRTABLE_POI_TABLE_ID,
                    fields: airtableFields,
                    localData: newPoi
                  }
                })
              });
              
              const j = await res.json();
              if (!res.ok || !j.ok) {
                throw new Error((j && j.error) || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
              }
              
              if (window.osNotify) {
                window.osNotify('POI —Å–æ–∑–¥–∞–Ω', data.name_ru);
              }
              
          renderPois();
            } catch(e) {
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å POI: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
              // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
              const list = poisByCity[selectedCity.id] || [];
              poisByCity[selectedCity.id] = list.filter(p => p.id !== id);
              renderPois();
            }
        } else if (level==='tickets'){
          const category = prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è (Adult/Child/Infant/Senior/Special):','Adult')||'Adult';
          const price = parseInt(prompt('–¶–µ–Ω–∞ (¬•):','1000')||'1000',10)||0;
          const note = prompt('–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:','')||'';
          const list = ticketsByPoi[selectedPoi.id] || (ticketsByPoi[selectedPoi.id]=[]);
          const id = genId('TKT', list.length+1);
          list.push({ id, category, price, currency:'¬•', note });
          renderTickets();
        }
      });

      // –ü–æ–ª—è –≤–≤–æ–¥–∞ –∏ –∏–∫–æ–Ω–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã, –±–∏–Ω–¥—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è

      // History: handle back/forward
      window.addEventListener('popstate', function(ev){ renderFromState(ev.state); });
      // Initial state
      history.replaceState({ level: 'regions' }, '');
      // –ü–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Airtable, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ, –∏–Ω–∞—á–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
      (async function(){
        await syncRegionsFromAirtable();
        if (!regions.length){ await loadRegionsViaProxy(); }
        if (!regions.length) renderRegions();
      })();

      // Deploy button placeholder removed per requirements
    })();
      // –£–¥–∞–ª—ë–Ω legacy-—Å–ø–∏—Å–æ–∫ ¬´–ö–∞—Ç–∞–ª–æ–≥ —Ä–µ–≥–∏–æ–Ω–æ–≤¬ª (—Ç–∞–±–ª–∏—á–Ω—ã–π)

    // –ö–∞—Ç–∞–ª–æ–≥ –≥–æ—Ä–æ–¥–æ–≤/–ª–æ–∫–∞—Ü–∏–π ‚Äî UI-–∑–∞–≥–ª—É—à–∫–∞ –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ —Ä–µ–∞–ª—å–Ω—ã–º API
    (function(){
      const table = document.getElementById('cities_table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const addBtn = document.getElementById('cities_add');

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–≥–∏–æ–Ω—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –≤—ã—à–µ –∫–∞–∫ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
      function getRegionList(){
        const rows = document.querySelectorAll('#regions_table tbody tr');
        const list = [];
        rows.forEach(r=>{
          const id = r.querySelector('td:nth-child(1)')?.textContent?.trim();
          const name = r.querySelector('td:nth-child(2)')?.textContent?.trim();
          if (id && name && !id.startsWith('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')) list.push({id,name});
        });
        return list;
      }

      let items = [];

      function generateId(){
        const n = items.length + 1;
        return 'CL-' + String(n).padStart(4, '0');
      }

      function render(){
        tbody.innerHTML = '';
        if (items.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.className = 'px-4 py-4 text-gray-500';
          td.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å—å.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        items.forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-gray-800">${it.id}</td>
            <td class="px-4 py-2 text-gray-800">${it.name}</td>
            <td class="px-4 py-2 text-gray-800">${it.regionName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.type}</td>
            <td class="px-4 py-2 text-gray-800">${it.coords || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.parentCity || ''}</td>
            <td class="px-4 py-2 text-right">
              <button data-action="edit" data-id="${it.id}" class="text-xs text-gray-700 hover:text-gray-900 mr-3"><i class="fas fa-pen mr-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button data-action="delete" data-id="${it.id}" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      function addOne(){
        const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ (–≥–æ—Ä–æ–¥/–ª–æ–∫–∞—Ü–∏—è):');
        if (!name) return;
        const type = prompt('–¢–∏–ø –∑–∞–ø–∏—Å–∏ (–ì–æ—Ä–æ–¥|–õ–æ–∫–∞—Ü–∏—è):', '–ì–æ—Ä–æ–¥');
        if (!type) return;
        let parentCity = '';
        if (type.trim().toLowerCase() === '–ª–æ–∫–∞—Ü–∏—è'){
          parentCity = prompt('–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –≥–æ—Ä–æ–¥:') || '';
        }
        const coords = prompt('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 35.6895,139.6917):') || '';
        const r = getRegionList();
        let regionName = '';
        if (r.length){
          const names = r.map(x=>x.name).join(', ');
          const picked = prompt('–†–µ–≥–∏–æ–Ω ('+names+'):') || '';
          const found = r.find(x=>x.name===picked.trim());
          regionName = found ? found.name : (r[0]?.name || '');
        }
        items.push({ id: generateId(), name: name.trim(), type: (type||'').trim(), parentCity: parentCity.trim(), coords: coords.trim(), regionName });
        render();
      }

      tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'delete'){
          items = items.filter(r=>r.id !== id);
          render();
        } else if (action === 'edit'){
          const it = items.find(x=>x.id===id);
          if (!it) return;
          const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', it.name) || it.name;
          const newType = prompt('–¢–∏–ø –∑–∞–ø–∏—Å–∏ (–ì–æ—Ä–æ–¥|–õ–æ–∫–∞—Ü–∏—è):', it.type) || it.type;
          const newCoords = prompt('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', it.coords) || it.coords;
          let newParent = it.parentCity;
          if ((newType||'').trim().toLowerCase()==='–ª–æ–∫–∞—Ü–∏—è'){
            newParent = prompt('–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –≥–æ—Ä–æ–¥:', it.parentCity||'') || it.parentCity || '';
          } else {
            newParent = '';
          }
          it.name = newName.trim();
          it.type = newType.trim();
          it.coords = newCoords.trim();
          it.parentCity = newParent.trim();
          render();
        }
      });

      addBtn && addBtn.addEventListener('click', addOne);

      render();
    })();

    // POIs ‚Äî UI-–∑–∞–≥–ª—É—à–∫–∞ (—Å –±–∏–ª–µ—Ç—ã –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞)
    (function(){
      const table = document.getElementById('pois_table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const addBtn = document.getElementById('pois_add');
      const ticketsTitle = document.getElementById('poi_tickets_title');
      const ticketsTable = document.getElementById('tickets_table');
      const ticketsTbody = ticketsTable ? ticketsTable.querySelector('tbody') : null;
      const ticketsAddBtn = document.getElementById('tickets_add');

      function getCities(){
        const rows = document.querySelectorAll('#cities_table tbody tr');
        const list = [];
        rows.forEach(r=>{
          const id = r.querySelector('td:nth-child(1)')?.textContent?.trim();
          const name = r.querySelector('td:nth-child(2)')?.textContent?.trim();
          const region = r.querySelector('td:nth-child(3)')?.textContent?.trim();
          if (id && name && !id.startsWith('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')) list.push({id,name,region});
        });
        return list;
      }

      let items = [];
      let selectedPoiId = '';

      function genId(){ return 'POI-' + String(items.length+1).padStart(4,'0'); }

      function render(){
        tbody.innerHTML = '';
        if (items.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.className = 'px-4 py-4 text-gray-500';
          td.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ POI.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          updateTicketsPanel();
          return;
        }
        items.forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-gray-800">${it.id}</td>
            <td class="px-4 py-2 text-gray-800">${it.name}</td>
            <td class="px-4 py-2 text-gray-800">${it.cityName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.regionName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.type || ''}</td>
            <td class="px-4 py-2 text-gray-800">${(it.tickets||[]).length}</td>
            <td class="px-4 py-2 text-right">
              <button data-action="tickets" data-id="${it.id}" class="text-xs text-indigo-600 hover:text-indigo-800 mr-3"><i class="fas fa-ticket mr-1"></i>–ë–∏–ª–µ—Ç—ã</button>
              <button data-action="edit" data-id="${it.id}" class="text-xs text-gray-700 hover:text-gray-900 mr-3"><i class="fas fa-pen mr-1"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button data-action="delete" data-id="${it.id}" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å</button>
            </td>`;
          tbody.appendChild(tr);
        });
        updateTicketsPanel();
      }

      function addOne(){
        const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ POI:');
        if (!name) return;
        const type = prompt('–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ (–∫—É–ª—å—Ç—É—Ä–∞, –ø—Ä–∏—Ä–æ–¥–∞, –≥–∞—Å—Ç—Ä–æ, ‚Ä¶):', '–∫—É–ª—å—Ç—É—Ä–∞') || '';
        const cities = getCities();
        let cityName = '';
        let regionName = '';
        if (cities.length){
          const names = cities.map(x=>x.name).join(', ');
          const picked = prompt('–ì–æ—Ä–æ–¥/–õ–æ–∫–∞—Ü–∏—è ('+names+'):') || '';
          const found = cities.find(x=>x.name===picked.trim());
          cityName = found ? found.name : (cities[0]?.name || '');
          regionName = found ? (found.region || '') : (cities[0]?.region || '');
        }
        items.push({ id: genId(), name: name.trim(), type: type.trim(), cityName, regionName, tickets: []});
        render();
      }

      tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'delete'){
          items = items.filter(r=>r.id !== id);
          if (selectedPoiId === id) selectedPoiId = '';
          render();
        } else if (action === 'edit'){
          const it = items.find(x=>x.id===id);
          if (!it) return;
          const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', it.name) || it.name;
          const newType = prompt('–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:', it.type) || it.type;
          it.name = newName.trim();
          it.type = newType.trim();
          render();
        } else if (action === 'tickets'){
          selectedPoiId = id;
          updateTicketsPanel();
        }
      });

      addBtn && addBtn.addEventListener('click', addOne);

      // –ë–∏–ª–µ—Ç—ã –≤–Ω—É—Ç—Ä–∏ POI
      let tickets = {};// { poiId: [ {id,category,price,currency,note} ] }
      function ensureArr(poiId){ if (!tickets[poiId]) tickets[poiId] = []; return tickets[poiId]; }

      function updateTicketsPanel(){
        if (!ticketsTbody || !ticketsTitle) return;
        const poi = items.find(x=>x.id===selectedPoiId);
        ticketsTitle.textContent = poi ? poi.name : '‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî';
        const list = poi ? ensureArr(poi.id) : [];
        ticketsTbody.innerHTML = '';
        if (!poi){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className='px-4 py-4 text-gray-500';
          td.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ POI (–∫–Ω–æ–ø–∫–∞ ¬´–ë–∏–ª–µ—Ç—ã¬ª)';
          tr.appendChild(td); ticketsTbody.appendChild(tr); return;
        }
        if (list.length===0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className='px-4 py-4 text-gray-500';
          td.textContent = '–ù–µ—Ç –±–∏–ª–µ—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –±–∏–ª–µ—Ç.';
          tr.appendChild(td); ticketsTbody.appendChild(tr); return;
        }
        list.forEach((t, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class=\"px-4 py-2 text-gray-800\">${t.id}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.category}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.price}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.currency}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.note||''}</td>
            <td class=\"px-4 py-2 text-right\">\n              <button data-action=\"t-edit\" data-id=\"${t.id}\" class=\"text-xs text-gray-700 hover:text-gray-900 mr-3\"><i class=\"fas fa-pen mr-1\"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>\n              <button data-action=\"t-delete\" data-id=\"${t.id}\" class=\"text-xs text-red-600 hover:text-red-800\"><i class="fas fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å</button>
            </td>`;
          ticketsTbody.appendChild(tr);
        });
      }

      function genTicketId(poiId){
        const n = ensureArr(poiId).length + 1;
        return poiId.replace('POI-','TKT-') + '-' + String(n).padStart(2,'0');
        }

      ticketsAddBtn && ticketsAddBtn.addEventListener('click', function(){
        if (!selectedPoiId) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POI (–∫–Ω–æ–ø–∫–∞ ¬´–ë–∏–ª–µ—Ç—ã¬ª).'); return; }
        const category = prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è (Adult / Child / Infant / Senior / Special):', 'Adult') || 'Adult';
        const priceStr = prompt('–¶–µ–Ω–∞ (¬•):', '1000') || '0';
        const price = parseInt(priceStr, 10) || 0;
        const currency = '¬•';
        const note = prompt('–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:', '') || '';
        const arr = ensureArr(selectedPoiId);
        arr.push({ id: genTicketId(selectedPoiId), category, price, currency, note });
        updateTicketsPanel();
      });

      ticketsTbody && ticketsTbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn || !selectedPoiId) return;
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        const arr = ensureArr(selectedPoiId);
        if (action==='t-delete'){
          const idx = arr.findIndex(x=>x.id===id);
          if (idx>=0){ arr.splice(idx,1); updateTicketsPanel(); }
        } else if (action==='t-edit'){
          const t = arr.find(x=>x.id===id); if (!t) return;
          const newCategory = prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è:', t.category) || t.category;
          const newPriceStr = prompt('–¶–µ–Ω–∞ (¬•):', String(t.price)) || String(t.price);
          const newNote = prompt('–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:', t.note||'') || t.note;
          t.category = newCategory.trim();
          t.price = parseInt(newPriceStr, 10) || t.price;
          t.note = newNote.trim();
          updateTicketsPanel();
        }
      });

      render();
    })();
    </script>
  </body>
</html>


