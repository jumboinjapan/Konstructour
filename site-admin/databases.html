<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Konstructour — Базы данных</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../styles/admin-japanese.css" rel="stylesheet">
    <style>
      body{ background: rgb(var(--color-washi)); min-height:100vh; }
      .tab{ padding:14px 20px; font-size:16px; border-radius:10px; cursor:pointer; flex:1 1 0%; text-align:center; }
      .tab.active{ background:#fff; border:1px solid rgba(139,90,43,.15); }
      .tab-content{ display:none; }
      .tab-content.active{ display:block; }
      /* Fixed sizes to keep API action row stable */
      .api-select{ width: 180px; }
      .api-base-label{ display:inline-block; width: 120px; }
      .api-base-input{ width: 280px; }
      .api-table-label{ display:inline-block; width: 140px; }
      .api-table-input{ width: 220px; }
    </style>
  </head>
  <body data-no-redirect="true">
    <div class="dashboard-grid">
      <aside class="sidebar texture-wood">
        <div class="p-6">
          <div class="flex items-center mb-8">
            <div class="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center mr-3">
              <svg class="w-8 h-8 text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
            </div>
            <div>
              <h1 class="text-xl font-light text-gray-800">Konstructour</h1>
              <p class="text-xs text-gray-600">Site Admin</p>
            </div>
          </div>
          <nav class="space-y-2">
            <a href="dashboard.html" class="sidebar-link"><i class="fas fa-th-large mr-3 text-indigo-600"></i>Обзор</a>
            <a href="api-catalog.html" class="sidebar-link"><i class="fas fa-list mr-3 text-gray-600"></i>Каталог API</a>
            <a href="databases.html" class="menu-item active sidebar-link"><i class="fas fa-database mr-3 text-green-600"></i>Базы данных</a>
          </nav>
        </div>
      </aside>
      <main class="p-8">
        <header class="mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-light text-gray-800 mb-1">Базы данных</h2>
              <p class="text-gray-600">Выберите базу и управляйте данными через интеграции API</p>
            </div>
          </div>
        </header>

        <div class="glass-panel p-8 rounded-lg mb-6">
          <div class="flex items-center gap-3">
            <button class="tab active" data-tab="regions"><i class="fas fa-globe-asia mr-2 text-blue-600"></i>Регионы</button>
            <button class="tab" data-tab="tours"><i class="fas fa-route mr-2 text-green-600"></i>Туры</button>
            <button class="tab" data-tab="templates"><i class="fas fa-layer-group mr-2 text-purple-600"></i>Шаблоны</button>
          </div>
        </div>

        <!-- Регионы (иерархия карточек) -->
        <section id="tab-regions" class="tab-content active">
          <div class="glass-panel p-6 rounded-lg relative">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-globe-asia mr-2 text-blue-600"></i>Регионы</h3>
            </div>

            <!-- Хлебные крошки -->
            <div class="mb-4 -mt-1">
              <div id="db_breadcrumbs" class="flex items-center flex-wrap text-base text-gray-600"></div>
            </div>

            <!-- Контейнер карточек уровня (динамически) -->
            <div id="db_cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

            <!-- Кнопка добавления под сеткой -->
            <div class="mt-6 flex justify-center">
              <button id="db_fab_add" class="btn-japanese rounded-full w-12 h-12 flex items-center justify-center shadow-lg" title="Добавить">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
        </section>

        <!-- Туры -->
        <section id="tab-tours" class="tab-content">
          <div class="glass-panel p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-route mr-2 text-green-600"></i>Туры</h3>
            </div>
            <div id="tours_schema" class="text-sm text-gray-600">
              Структура берётся из Project Description.md. Настройка схемы будет подключена.
            </div>
            <div class="mt-4">
              <div class="text-xs text-gray-500 mb-2">Предпросмотр данных</div>
              <div id="tours_preview" class="japanese-table w-full rounded-lg overflow-hidden">
                <div class="p-4 text-gray-500">Нет данных. Нажмите «Синхронизировать».</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Шаблоны -->
        <section id="tab-templates" class="tab-content">
          <div class="glass-panel p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-layer-group mr-2 text-purple-600"></i>Шаблоны</h3>
            </div>
            <div id="templates_schema" class="text-sm text-gray-600">
              Структура настраивается индивидуально.
            </div>
            <div class="mt-4">
              <div class="text-xs text-gray-500 mb-2">Предпросмотр данных</div>
              <div id="templates_preview" class="japanese-table w-full rounded-lg overflow-hidden">
                <div class="p-4 text-gray-500">Нет данных. Нажмите «Синхронизировать».</div>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>

    <script>
    // Простые вкладки без сторонних зависимостей
    (function(){
      const tabs = document.querySelectorAll('.tab');
      const sections = {
        regions: document.getElementById('tab-regions'),
        tours: document.getElementById('tab-tours'),
        templates: document.getElementById('tab-templates')
      };
      tabs.forEach(btn=>{
        btn.addEventListener('click', function(e){
          e.preventDefault();
          tabs.forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          Object.values(sections).forEach(s=> s && s.classList.remove('active'));
          const key = this.getAttribute('data-tab');
          if (sections[key]) sections[key].classList.add('active');
        });
      });

      // Fake sync state toggling for icon demo (replace with real sync hooks)
      function setSyncing(scope, isSyncing){
        const el = document.getElementById(scope+'_sync_icon');
        if (!el) return;
        if (isSyncing) el.classList.add('animate-spin'); else el.classList.remove('animate-spin');
      }

      // Remove placeholder spinner handler to avoid side-effects on clicks

      // Base label auto-switch for API type
      function bindApiLabel(){ /* удалено вместе с UI */ }

      // Load saved config from server and populate fields
      let airtableReg = null; // cache for mapping header
      async function loadDbConfig(){
        try{
          const res = await fetch('../api/config-read.php', { headers: { 'X-Admin-Token': (window.ADMIN_TOKEN||'') } });
          if (!res.ok) return;
          const data = await res.json();
          const db = (data && data.databases) || {};
          const reg = (data && data.airtable_registry) || null;
          airtableReg = reg;
          function fill(){ /* UI удалён */ }
          fill('regions', db.regions);
          fill('tours', db.tours);
          fill('templates', db.templates);
          // Fill Airtable Mapping UI
          if (reg){
            const baseId = reg.baseId || reg.base_id || '';
            const t = reg.tables || {};
            document.getElementById('am_base_id') && (document.getElementById('am_base_id').value = baseId);
            function setv(id, val){ const el = document.getElementById(id); if (el && typeof val==='string') el.value = val; }
            setv('am_country_label', t.country?.label||''); setv('am_country_table', t.country?.tableId||''); setv('am_country_view', t.country?.viewId||'');
            setv('am_region_label',  t.region?.label||'');  setv('am_region_table',  t.region?.tableId||'');  setv('am_region_view',  t.region?.viewId||'');
            setv('am_city_label',    t.city?.label||'');    setv('am_city_table',    t.city?.tableId||'');    setv('am_city_view',    t.city?.viewId||'');
            setv('am_poi_label',     t.poi?.label||'');     setv('am_poi_table',     t.poi?.tableId||'');     setv('am_poi_view',     t.poi?.viewId||'');
            // Render mapping header for Regions
            // initial header will be set by render functions
          }
        }catch(e){ console.warn('loadDbConfig failed', e); }
      }
      loadDbConfig();

      function setMappingHeader(){ /* бейдж перенесён — здесь ничего не рендерим */ }
      // Сделаем доступной для других модулей на странице
      window.setMappingHeader = setMappingHeader;

      // Save Airtable Mapping
      async function saveAirtableRegistry(){
        const reg = {
          baseId: document.getElementById('am_base_id')?.value || '',
          tables: {
            country: { label: document.getElementById('am_country_label')?.value || '', tableId: document.getElementById('am_country_table')?.value || '', viewId: document.getElementById('am_country_view')?.value || '' },
            region:  { label: document.getElementById('am_region_label')?.value  || '', tableId: document.getElementById('am_region_table')?.value  || '', viewId: document.getElementById('am_region_view')?.value  || '' },
            city:    { label: document.getElementById('am_city_label')?.value    || '', tableId: document.getElementById('am_city_table')?.value    || '', viewId: document.getElementById('am_city_view')?.value    || '' },
            poi:     { label: document.getElementById('am_poi_label')?.value     || '', tableId: document.getElementById('am_poi_table')?.value     || '', viewId: document.getElementById('am_poi_view')?.value     || '' }
          }
        };
        try{
          await fetch('../api/config-store.php',{
            method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
            body: JSON.stringify({ airtable_registry: reg })
          });
        }catch(e){ console.warn('save registry failed', e); }
      }
      document.getElementById('am_save')?.addEventListener('click', saveAirtableRegistry);

      // Test Base / Table
      document.getElementById('am_test_base')?.addEventListener('click', async function(){
        const baseId = document.getElementById('am_base_id')?.value || '';
        const key = ''; // сервер возьмёт PAT из server keys
        const res = await fetch('../api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId));
        const t = await res.json();
        const label = document.getElementById('am_base_status');
        if (label) label.textContent = t.ok ? 'OK' : ('Ошибка: '+(t.error||''));
      });
      document.querySelectorAll('.am_test_table').forEach(btn=>{
        btn.addEventListener('click', async function(){
          const entity = this.getAttribute('data-entity');
          const baseId = document.getElementById('am_base_id')?.value || '';
          const tableId = document.getElementById('am_'+entity+'_table')?.value || '';
          const viewId = document.getElementById('am_'+entity+'_view')?.value || '';
          const url = '../api/test-proxy.php?provider=airtable&base_id='+encodeURIComponent(baseId)+'&table='+encodeURIComponent(tableId)+(viewId?('&view='+encodeURIComponent(viewId)):'');
          const res = await fetch(url);
          const t = await res.json();
          const label = document.getElementById('am_'+entity+'_status');
          if (label) label.textContent = t.ok ? 'OK' : ('Ошибка: '+(t.error||''));
        });
      });
    })();

    // Иерархия карточек: регионы → города → POI → билеты (UI, без API)
    (function(){
      // helper: save to server as server key
      async function saveDbConfig(scope){
        try{
          // UI полей удалён — функция оставлена на будущее, сейчас no-op
          await fetch('../api/config-store.php',{
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
            body: JSON.stringify({})
          }).then(r=>{
            if (!r.ok) throw new Error('HTTP '+r.status);
            if (window.osNotify){ window.osNotify('Сохранено','Конфигурация обновлена'); }
          }).catch(e=>{
            console.warn('saveDbConfig failed', e);
            if (window.osNotify){ window.osNotify('Ошибка','Не удалось сохранить'); }
          });
        }catch(e){ console.warn('saveDbConfig failed', e); }
      }

      const crumbs = document.getElementById('db_breadcrumbs');
      const cards = document.getElementById('db_cards');
      const fab = document.getElementById('db_fab_add');

      if (!crumbs || !cards) return;

      const regionColors = {
        'Хоккайдо':'bg-blue-100 text-blue-800',
        'Тохоку':'bg-green-100 text-green-800',
        'Канто':'bg-indigo-100 text-indigo-800',
        'Тюбу':'bg-yellow-100 text-yellow-800',
        'Кансай':'bg-purple-100 text-purple-800',
        'Тюгоку':'bg-pink-100 text-pink-800',
        'Сикоку':'bg-teal-100 text-teal-800',
        'Кюсю':'bg-red-100 text-red-800',
        'Окинава':'bg-cyan-100 text-cyan-800'
      };

      // State (in-memory for UI only). Источник правды — Airtable
      let regions = [];
      let citiesByRegion = {}; // regionId -> [ { id, name, type: 'city'|'location', parentCityId? } ]
      let poisByCity = {};     // cityId -> [ {id,name,type} ]
      let ticketsByPoi = {};   // poiId -> [ {id,category,price,currency,note} ]

      let level = 'regions';
      let selectedRegion = null;
      let selectedCity = null;
      let selectedPoi = null;

      // History helpers
      function renderFromState(state){
        if (!state || !state.level) { renderRegions(); return; }
        level = state.level;
        if (level === 'regions') { renderRegions(); return; }
        if (level === 'cities') {
          selectedRegion = regions.find(r=>r.id===state.regionId) || null;
          renderCities(); return;
        }
        if (level === 'pois') {
          selectedRegion = regions.find(r=>r.id===state.regionId) || null;
          const list = selectedRegion ? (citiesByRegion[selectedRegion.id]||[]) : [];
          selectedCity = list.find(c=>c.id===state.cityId) || null;
          renderPois(); return;
        }
        if (level === 'tickets') {
          selectedRegion = regions.find(r=>r.id===state.regionId) || null;
          const listC = selectedRegion ? (citiesByRegion[selectedRegion.id]||[]) : [];
          selectedCity = listC.find(c=>c.id===state.cityId) || null;
          const listP = selectedCity ? (poisByCity[selectedCity.id]||[]) : [];
          selectedPoi = listP.find(p=>p.id===state.poiId) || null;
          renderTickets(); return;
        }
        renderRegions();
      }
      function push(level, ids){
        const state = Object.assign({ level }, ids||{});
        history.pushState(state, '');
      }

      function renderCrumbs(){
        const parts = [];
        // Root
        if (level === 'regions'){
          parts.push('<span class="text-gray-800">Регионы</span>');
        } else {
          parts.push('<a href="#" data-level="regions" class="text-indigo-600 hover:underline">Регионы</a>');
        }
        // Region
        if (selectedRegion){
          parts.push('<span class="mx-2">/</span>');
          if (level === 'cities'){
            parts.push('<span class="text-gray-800">'+selectedRegion.name+'</span>');
          } else {
            parts.push('<a href="#" data-level="cities" data-region-id="'+selectedRegion.id+'" class="text-indigo-600 hover:underline">'+selectedRegion.name+'</a>');
          }
        }
        // City
        if (selectedCity){
          parts.push('<span class="mx-2">/</span>');
          if (level === 'pois'){
            parts.push('<span class="text-gray-800">'+selectedCity.name+'</span>');
          } else {
            parts.push('<a href="#" data-level="pois" data-region-id="'+(selectedRegion?selectedRegion.id:'')+'" data-city-id="'+selectedCity.id+'" class="text-indigo-600 hover:underline">'+selectedCity.name+'</a>');
          }
        }
        // POI (always last visible item is plain text)
        if (selectedPoi){
          parts.push('<span class="mx-2">/</span><span class="text-gray-800">'+selectedPoi.name+'</span>');
        }
        crumbs.innerHTML = parts.join('');
      }

      function card(actionsHtml, innerHtml){
        const actionsBlock = actionsHtml && actionsHtml.trim() ? '<div class="absolute top-2 right-2 flex items-center gap-2 opacity-70">'+actionsHtml+'</div>' : '';
        return '<div class="relative bg-white rounded-lg border border-gray-200 p-4 hover:shadow transition">'+actionsBlock+innerHtml+'</div>';
      }

      function renderRegions(){
        level='regions'; selectedRegion=null; selectedCity=null; selectedPoi=null; renderCrumbs(); setMappingHeader('region');
        if (!regions.length){
          cards.innerHTML = '<div class="text-gray-500">Нет регионов. Нажмите + чтобы добавить.</div>';
          return;
        }
        cards.innerHTML = regions.map(r=>{
          const count = (citiesByRegion[r.id]||[]).length;
          const inlineActions = '<div class="flex items-center gap-2 opacity-80">\
              '+(r.rid ? '<span class="ml-2 px-2 py-0.5 text-xs rounded border bg-gray-50 text-gray-600">'+r.rid+'</span>' : '')+'\
              <button data-act="edit-region" data-id="'+r.id+'" title="Редактировать" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>\
              <button data-act="del-region" data-id="'+r.id+'" title="Удалить" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>\
            </div>';
          const inner = '<div class="flex items-center justify-between">\
              <div class="flex items-center gap-2">\
                <svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" class="text-indigo-600"><path d="M3.5 6.5 9 4.5l6 2 5.5-2v13l-5.5 2-6-2-5.5 2v-13z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>\
                <div class="text-lg text-gray-800">'+r.name+'</div>\
              </div>\
              '+inlineActions+'\
              <div class="absolute inset-0 flex items-center justify-center pointer-events-none">\
                <div class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-50 border border-indigo-100 shadow-sm">\
                  <i class=\"fas fa-map-marker-alt text-indigo-600\"></i>\
                  <span class=\"text-xs font-medium text-indigo-700\">'+count+'</span>\
                </div>\
              </div>\
            </div>';
          return '<div class="cursor-pointer" data-go="cities" data-id="'+r.id+'">'+card('', inner)+'</div>';
        }).join('');
      }

      // Загрузка регионов из Airtable и отрисовка
      async function syncRegionsFromAirtable(){
        try{
          const res = await fetch('../api/db-sync.php',{
            method:'POST', headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ scope:'regions', action:'list' })
          });
          if (!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          if (!data.ok) throw new Error(data.error||'Airtable');
          const items = data.items || [];
          regions = items.map((it, idx)=>({
            id: it.id || ('REG-'+String(idx+1).padStart(3,'0')),
            name: (it.name || ('Регион '+(idx+1))),
            rid: (it.fields && (it.fields['Идентификатор'] || it.fields['Region ID'] || it.fields['ID'] || it.fields['Регион ID'])) || ''
          }));
          // сбросим счетчики; реальныеCounts можно подтянуть отдельно
          citiesByRegion = {};
          renderRegions();
        }catch(e){ console.warn('syncRegionsFromAirtable failed', e); }
      }

      async function deleteRegionOnServer(region){
        try{
          let recordId = region && region.id ? region.id : '';
          if (!/^rec/i.test(recordId)){
            // Найдём запись по полю Region ID или имени
            const res = await fetch('../api/db-sync.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ scope:'regions', action:'list' })
            });
            const j = await res.json();
            if (j && j.ok && Array.isArray(j.items)){
              const found = j.items.find(it => (it.fields && (it.fields['Region ID']===region.id || it.fields['Регион ID']===region.id)) || it.name===region.name);
              if (found && found.id) recordId = found.id;
            }
          }
          if (recordId && /^rec/i.test(recordId)){
            await fetch('../api/db-sync.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ scope:'regions', action:'delete', data:{ id: recordId } })
            });
          }
        }catch(e){ console.warn('deleteRegionOnServer failed', e); }
      }

      function renderCities(){
        level='cities'; /* keep selectedCity */ selectedPoi=null; renderCrumbs(); setMappingHeader('city');
        const list = citiesByRegion[selectedRegion.id] || [];
        // Если список пуст — показываем кнопку добавления через ту же +
        function findCityNameById(id){ const x=(list||[]).find(v=>v.id===id); return x?x.name:''; }
        cards.innerHTML = list.map(c=>{
          const actions = '<button data-act="edit-city" data-id="'+c.id+'" title="Редактировать" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
                          '<button data-act="del-city" data-id="'+c.id+'" title="Удалить" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>';
          const typeLabel = (c.type||'city') === 'location' ? 'Локация' : 'Город';
          const parentInfo = (c.type==='location' && c.parentCityId) ? ('<div class="text-xs text-gray-500 mt-0.5">Родитель: '+findCityNameById(c.parentCityId)+'</div>') : '';
          const inner = '<div class="flex items-center justify-between">\
              <div>\
                <div class="text-sm bg-gray-100 text-gray-700 inline-block px-2 py-0.5 rounded">'+typeLabel+'</div>\
                <div class="text-lg text-gray-800 mt-1">'+c.name+'</div>'+parentInfo+'\
              </div>\
              <div class="text-sm text-gray-500">'+((poisByCity[c.id]||[]).length)+' POI</div>\
            </div>';
          return '<div class="cursor-pointer" data-go="pois" data-id="'+c.id+'">'+card(actions, inner)+'</div>';
        }).join('') || '<div class="text-gray-500">Нет городов. Нажмите + чтобы добавить.</div>';
      }

      function renderPois(){
        level='pois'; /* keep selectedPoi */ renderCrumbs(); setMappingHeader('poi');
        const list = poisByCity[selectedCity.id] || [];
        const parentTypeLabel = selectedCity && selectedCity.type==='location' ? 'Локация' : 'Город';
        cards.innerHTML = list.map(p=>{
          const actions = '<button data-act="edit-poi" data-id="'+p.id+'" title="Редактировать" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
                          '<button data-act="del-poi" data-id="'+p.id+'" title="Удалить" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>';
          const inner = '<div class="flex items-start gap-3">\
              <div class="w-16 h-16 bg-gray-100 rounded overflow-hidden flex items-center justify-center"><i class="fas fa-landmark text-gray-400"></i></div>\
              <div class="flex-1">\
                <div class="flex items-center justify-between">\
                  <div class="text-lg text-gray-800">'+p.name+'</div>\
                  <div class="text-xs text-gray-500 flex items-center gap-3">\
                    <span title=\"Родитель\"><i class=\"fas fa-map-marker-alt mr-1 text-gray-400\"></i>'+parentTypeLabel+'</span>\
                    <span title="Тип"><i class="fas fa-tag mr-1 text-gray-400"></i>'+ (p.type||'—') +'</span>\
                    <span title="Билеты"><i class="fas fa-ticket mr-1 text-gray-400"></i>'+((ticketsByPoi[p.id]||[]).length)+'</span>\
                  </div>\
                </div>\
              </div>\
            </div>';
          return '<div class="cursor-pointer" data-go="tickets" data-id="'+p.id+'">'+card(actions, inner)+'</div>';
        }).join('') || '<div class="text-gray-500">Нет POI. Нажмите + чтобы добавить.</div>';
      }

      // Airtable-backed loaders for each level
      async function loadCitiesForRegion(region){
        try{
          const res = await fetch('../api/db-sync.php',{
            method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
            body: JSON.stringify({ scope:'cities', action:'list', data:{ filter:{ regionId: region.id, regionName: region.name } } })
          });
          const j = await res.json();
          const items = j.ok ? (j.items||[]) : [];
          citiesByRegion[region.id] = items.map(it=>({ id: it.id, name: it.name || it.fields?.['Name (RU)'] || it.fields?.['Название (RU)'] || '—', type: (it.fields?.Type||'city').toLowerCase()==='location'?'location':'city' }));
        }catch(e){ citiesByRegion[region.id] = []; }
      }

      async function loadPoisForCity(city){
        try{
          const res = await fetch('../api/db-sync.php',{
            method:'POST', headers:{ 'Content-Type':'application/json', 'X-Admin-Token': (window.ADMIN_TOKEN||'') },
            body: JSON.stringify({ scope:'pois', action:'list', data:{ filter:{ cityId: city.id, cityName: city.name } } })
          });
          const j = await res.json();
          const items = j.ok ? (j.items||[]) : [];
          poisByCity[city.id] = items.map(it=>({ id: it.id, name: it.name || '—', type: (it.fields?.Category||'') }));
        }catch(e){ poisByCity[city.id] = []; }
      }

      function renderTickets(){
        level='tickets'; renderCrumbs();
        const list = ticketsByPoi[selectedPoi.id] || [];
        cards.innerHTML = list.map(t=>{
          const actions = '<button data-act="edit-ticket" data-id="'+t.id+'" title="Редактировать" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
                          '<button data-act="del-ticket" data-id="'+t.id+'" title="Удалить" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>';
          const inner = '<div class="flex items-center justify-between">\
              <div class="text-gray-800"><span class="text-xs bg-gray-100 text-gray-700 inline-block px-2 py-0.5 rounded mr-2">🎟</span>'+t.category+'</div>\
              <div class="text-gray-700">'+t.price+'¥</div>\
            </div>';
          return card(actions, inner);
        }).join('') || '<div class="text-gray-500">Нет билетов. Нажмите + чтобы добавить.</div>';
      }

      // Navigation (cards) — делегировано на документ, чтобы исключить проблемы привязки
      document.addEventListener('click', async function(e){
        const go = e.target.closest('[data-go]');
        if (!go || !cards.contains(go)) return;
        const id = go.getAttribute('data-id');
        const to = go.getAttribute('data-go');
        if (to==='cities'){
          selectedRegion = regions.find(r=>r.id===id) || null;
          push('cities', { regionId: (selectedRegion ? selectedRegion.id : null) });
          await loadCitiesForRegion(selectedRegion);
          renderCities();
        } else if (to==='pois'){
          const list = citiesByRegion[selectedRegion.id] || [];
          selectedCity = list.find(c=>c.id===id) || null;
          push('pois', { regionId: (selectedRegion ? selectedRegion.id : null), cityId: (selectedCity ? selectedCity.id : null) });
          await loadPoisForCity(selectedCity);
          renderPois();
        } else if (to==='tickets'){
          const list = poisByCity[selectedCity.id] || [];
          selectedPoi = list.find(p=>p.id===id) || null;
          push('tickets', { regionId: (selectedRegion ? selectedRegion.id : null), cityId: (selectedCity ? selectedCity.id : null), poiId: (selectedPoi ? selectedPoi.id : null) });
          renderTickets();
        }
      });

      // Breadcrumbs
      document.addEventListener('click', function(e){
        const a = e.target.closest && e.target.closest('a[data-level]');
        if (!a || !crumbs.contains(a)) return;
        e.preventDefault();
        const lv = a.getAttribute('data-level');
        if (lv==='regions'){
          selectedRegion=null; selectedCity=null; selectedPoi=null;
          push('regions'); return renderRegions();
        }
        if (lv==='cities'){
          const regionId = a.getAttribute('data-region-id');
          selectedRegion = regions.find(r=>r.id===regionId) || selectedRegion;
          selectedCity=null; selectedPoi=null;
          push('cities', { regionId: (selectedRegion?selectedRegion.id:null) });
          return renderCities();
        }
        if (lv==='pois'){
          const regionId = a.getAttribute('data-region-id');
          const cityId = a.getAttribute('data-city-id');
          selectedRegion = regions.find(r=>r.id===regionId) || selectedRegion;
          const list = selectedRegion ? (citiesByRegion[selectedRegion.id]||[]) : [];
          selectedCity = list.find(c=>c.id===cityId) || selectedCity;
          selectedPoi=null;
          push('pois', { regionId: (selectedRegion?selectedRegion.id:null), cityId: (selectedCity?selectedCity.id:null) });
          return renderPois();
        }
      });

      // Back button
      document.getElementById('db_back')?.addEventListener('click', function(){
        if (level==='cities') return renderRegions();
        if (level==='pois') return renderCities();
        if (level==='tickets') return renderPois();
      });

      // Card action buttons
      cards.addEventListener('click', function(e){
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        e.stopPropagation();
        const act = btn.getAttribute('data-act');
        const id = btn.getAttribute('data-id');
        if (act==='edit-region'){
          const r = regions.find(x=>x.id===id); if(!r) return; const n=prompt('Название региона:', r.name); if(n){ r.name=n.trim(); renderRegions(); }
        } else if (act==='del-region'){
          const r = regions.find(x=>x.id===id);
          regions = regions.filter(x=>x.id!==id); delete citiesByRegion[id]; renderRegions();
          if (r) deleteRegionOnServer(r);
        } else if (act==='edit-city'){
          const list = citiesByRegion[selectedRegion.id]||[]; const c=list.find(x=>x.id===id); if(!c) return; const n=prompt('Название города:', c.name); if(n){ c.name=n.trim(); renderCities(); }
        } else if (act==='del-city'){
          const list = citiesByRegion[selectedRegion.id]||[]; citiesByRegion[selectedRegion.id] = list.filter(x=>x.id!==id); delete poisByCity[id]; renderCities();
        } else if (act==='edit-poi'){
          const list = poisByCity[selectedCity.id]||[]; const p=list.find(x=>x.id===id); if(!p) return; const n=prompt('Название POI:', p.name)||p.name; const t=prompt('Тип (культура/природа/гастро):', p.type||'')||p.type; p.name=n.trim(); p.type=t.trim(); renderPois();
        } else if (act==='del-poi'){
          const list = poisByCity[selectedCity.id]||[]; poisByCity[selectedCity.id] = list.filter(x=>x.id!==id); delete ticketsByPoi[id]; renderPois();
        } else if (act==='edit-ticket'){
          const list = ticketsByPoi[selectedPoi.id]||[]; const t = list.find(x=>x.id===id); if(!t) return; const c=prompt('Категория:', t.category)||t.category; const p=prompt('Цена (¥):', String(t.price))||String(t.price); const n=prompt('Примечание:', t.note||'')||t.note; t.category=c.trim(); t.price=parseInt(p,10)||t.price; t.note=n.trim(); renderTickets();
        } else if (act==='del-ticket'){
          const list = ticketsByPoi[selectedPoi.id]||[]; ticketsByPoi[selectedPoi.id] = list.filter(x=>x.id!==id); renderTickets();
        }
      });

      // Floating add button
      function genId(prefix, n){ return prefix+'-'+String(n).padStart(3,'0'); }

      // Модальное окно создания региона (RU/EN)
      function openCreateRegionModal(){
        return new Promise(resolve=>{
          const wrap = document.createElement('div');
          wrap.className = 'fixed inset-0 z-50 flex items-center justify-center';
          wrap.innerHTML = '\
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
            <div class="relative bg-white rounded-lg shadow-xl p-6 w-96">\
              <div class="text-lg text-gray-800 mb-4">Новый регион</div>\
              <div class="space-y-3">\
                <input id="cr_ru" class="input-japanese w-full" placeholder="Название (RU)"/>\
                <input id="cr_en" class="input-japanese w-full" placeholder="Название (EN)"/>\
              </div>\
              <div class="mt-5 flex justify-end gap-2">\
                <button id="cr_cancel" class="btn-japanese">Отмена</button>\
                <button id="cr_ok" class="btn-japanese accent">Сохранить</button>\
              </div>\
            </div>';
          document.body.appendChild(wrap);
          function done(val){ try{ document.body.removeChild(wrap); }catch{} resolve(val||null); }
          wrap.addEventListener('click', e=>{ if (e.target===wrap.firstChild) done(null); });
          wrap.querySelector('#cr_cancel').addEventListener('click', ()=>done(null));
          wrap.querySelector('#cr_ok').addEventListener('click', ()=>{
            const ru = wrap.querySelector('#cr_ru').value.trim();
            const en = wrap.querySelector('#cr_en').value.trim();
            if (!ru || !en){ alert('Заполните оба поля'); return; }
            done({ ru, en });
          });
          wrap.querySelector('#cr_ru').focus();
        });
      }

      // Выбор типа (Город/Локация) — модалка с 2 кнопками
      function chooseCityType(){
        if (level !== 'cities') { return Promise.resolve(null); }
        return new Promise((resolve)=>{
          const wrap = document.createElement('div');
          wrap.className = 'fixed inset-0 z-50 flex items-center justify-center';
          wrap.innerHTML = '\
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
            <div class="relative bg-white rounded-lg shadow-xl p-6 w-80">\
              <div class="text-lg text-gray-800 mb-4">Тип записи</div>\
              <div class="grid grid-cols-2 gap-3">\
                <button id="btn_type_city" class="btn-japanese w-full text-center">Город</button>\
                <button id="btn_type_location" class="btn-japanese w-full text-center">Локация</button>\
              </div>\
              <div class="mt-4 text-xs text-gray-500 text-center">Выберите тип записи</div>\
            </div>';
          document.body.appendChild(wrap);
          function done(val){
            document.body.removeChild(wrap);
            resolve(val);
          }
          wrap.querySelector('#btn_type_city').addEventListener('click', function(){ done('city'); });
          wrap.querySelector('#btn_type_location').addEventListener('click', function(){ done('location'); });
          wrap.addEventListener('click', function(e){ if (e.target===wrap.firstChild) { done(null); } });
          document.addEventListener('keydown', function onEsc(ev){ if (ev.key==='Escape'){ document.removeEventListener('keydown', onEsc); try{ document.body.removeChild(wrap); }catch{} resolve(null); } });
        });
      }

      if (fab) fab.addEventListener('click', async function(){
        if (level==='regions'){
          const data = await openCreateRegionModal();
          if (!data) return;
          try{
            const res = await fetch('/api/regions-create.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ name_ru: data.ru, name_en: data.en })
            });
            const j = await res.json().catch(()=>({}));
            if (!res.ok || !j.ok){
              const detailsMsg = (j && (j.details?.error?.message || j.details?.message || j.error)) || ('HTTP '+res.status);
              console.error('REGION_CREATE_ERR', j);
              throw new Error(detailsMsg);
            }
            if (window.osNotify){ window.osNotify('Сохранено','ID: '+j.region_id); } else { alert('Сохранено: '+j.region_id); }
            await syncRegionsFromAirtable();
          }catch(e){ alert('Не удалось сохранить регион: '+(e && e.message ? e.message : '')); }
        } else if (level==='cities'){
          // модалка выбора типа + ввод названия
          const picked = await chooseCityType(); if (!picked) return;
          const wrap = await new Promise(res=>{
            const w = document.createElement('div');
            w.className='fixed inset-0 z-50 flex items-center justify-center';
            w.innerHTML='\
              <div class="absolute inset-0 bg-black bg-opacity-30"></div>\
              <div class="relative bg-white rounded-lg shadow-xl p-6 w-96">\
                <div class="text-lg text-gray-800 mb-4">'+(picked==='location'?'Новая локация':'Новый город')+'</div>\
                <div class="space-y-3">\
                  <input id="nm_ru" class="input-japanese w-full" placeholder="Название (RU)"/>\
                  <input id="nm_en" class="input-japanese w-full" placeholder="Name (EN)"/>\
                </div>\
                <div class="mt-5 flex justify-end gap-2">\
                  <button id="c" class="btn-japanese">Отмена</button>\
                  <button id="o" class="btn-japanese accent">Сохранить</button>\
                </div>\
              </div>';
            document.body.appendChild(w);
            w.querySelector('#c').onclick=()=>{ try{document.body.removeChild(w);}catch{}; res(null); };
            w.querySelector('#o').onclick=()=>{ const ru=w.querySelector('#nm_ru').value.trim(); const en=w.querySelector('#nm_en').value.trim(); if(!ru){alert('Введите название RU');return;} try{document.body.removeChild(w);}catch{}; res({ru,en}); };
            w.addEventListener('click',e=>{ if(e.target===w.firstChild){ try{document.body.removeChild(w);}catch{}; res(null);} });
          });
          if (!wrap) return; const name_ru = wrap.ru; const name_en = wrap.en || wrap.ru;
          try{
            const res = await fetch('/api/cities-create.php',{
              method:'POST', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ name_ru: name_ru, name_en: name_en, type: picked, region_rec_id: selectedRegion.id })
            });
            const j = await res.json();
            if (!res.ok || !j.ok) throw new Error((j && (j.error || j.details?.error?.message)) || ('HTTP '+res.status));
            await loadCitiesForRegion(selectedRegion); renderCities();
          }catch(e){ alert('Не удалось сохранить: '+(e && e.message ? e.message : '')); }
        } else if (level==='pois'){
          const name = prompt('Название POI:'); if(!name) return;
          const type = prompt('Тип (культура/природа/гастро):','культура')||'';
          const list = poisByCity[selectedCity.id] || (poisByCity[selectedCity.id]=[]);
          const id = genId('POI', list.length+1);
          list.push({ id, name:name.trim(), type:type.trim() });
          renderPois();
        } else if (level==='tickets'){
          const category = prompt('Категория (Adult/Child/Infant/Senior/Special):','Adult')||'Adult';
          const price = parseInt(prompt('Цена (¥):','1000')||'1000',10)||0;
          const note = prompt('Примечание:','')||'';
          const list = ticketsByPoi[selectedPoi.id] || (ticketsByPoi[selectedPoi.id]=[]);
          const id = genId('TKT', list.length+1);
          list.push({ id, category, price, currency:'¥', note });
          renderTickets();
        }
      });

      // Поля ввода и иконки синхронизации удалены, бинды не требуются

      // History: handle back/forward
      window.addEventListener('popstate', function(ev){ renderFromState(ev.state); });
      // Initial state
      history.replaceState({ level: 'regions' }, '');
      // Попробуем загрузить из Airtable, если настроено, иначе локальный список
      syncRegionsFromAirtable().then(()=>{ if (regions.length===0) renderRegions(); }).catch(()=>renderRegions());

      // Deploy button placeholder removed per requirements
    })();
      // Удалён legacy-список «Каталог регионов» (табличный)

    // Каталог городов/локаций — UI-заглушка без обращений к реальным API
    (function(){
      const table = document.getElementById('cities_table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const addBtn = document.getElementById('cities_add');

      // Используем регионы из раздела выше как справочник
      function getRegionList(){
        const rows = document.querySelectorAll('#regions_table tbody tr');
        const list = [];
        rows.forEach(r=>{
          const id = r.querySelector('td:nth-child(1)')?.textContent?.trim();
          const name = r.querySelector('td:nth-child(2)')?.textContent?.trim();
          if (id && name && !id.startsWith('Нет данных')) list.push({id,name});
        });
        return list;
      }

      let items = [];

      function generateId(){
        const n = items.length + 1;
        return 'CL-' + String(n).padStart(4, '0');
      }

      function render(){
        tbody.innerHTML = '';
        if (items.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.className = 'px-4 py-4 text-gray-500';
          td.textContent = 'Нет данных. Добавьте запись.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        items.forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-gray-800">${it.id}</td>
            <td class="px-4 py-2 text-gray-800">${it.name}</td>
            <td class="px-4 py-2 text-gray-800">${it.regionName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.type}</td>
            <td class="px-4 py-2 text-gray-800">${it.coords || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.parentCity || ''}</td>
            <td class="px-4 py-2 text-right">
              <button data-action="edit" data-id="${it.id}" class="text-xs text-gray-700 hover:text-gray-900 mr-3"><i class="fas fa-pen mr-1"></i>Редактировать</button>
              <button data-action="delete" data-id="${it.id}" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-trash mr-1"></i>Удалить</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      function addOne(){
        const name = prompt('Название (город/локация):');
        if (!name) return;
        const type = prompt('Тип записи (Город|Локация):', 'Город');
        if (!type) return;
        let parentCity = '';
        if (type.trim().toLowerCase() === 'локация'){
          parentCity = prompt('Родительский город:') || '';
        }
        const coords = prompt('Координаты (опционально, например: 35.6895,139.6917):') || '';
        const r = getRegionList();
        let regionName = '';
        if (r.length){
          const names = r.map(x=>x.name).join(', ');
          const picked = prompt('Регион ('+names+'):') || '';
          const found = r.find(x=>x.name===picked.trim());
          regionName = found ? found.name : (r[0]?.name || '');
        }
        items.push({ id: generateId(), name: name.trim(), type: (type||'').trim(), parentCity: parentCity.trim(), coords: coords.trim(), regionName });
        render();
      }

      tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'delete'){
          items = items.filter(r=>r.id !== id);
          render();
        } else if (action === 'edit'){
          const it = items.find(x=>x.id===id);
          if (!it) return;
          const newName = prompt('Новое название:', it.name) || it.name;
          const newType = prompt('Тип записи (Город|Локация):', it.type) || it.type;
          const newCoords = prompt('Координаты:', it.coords) || it.coords;
          let newParent = it.parentCity;
          if ((newType||'').trim().toLowerCase()==='локация'){
            newParent = prompt('Родительский город:', it.parentCity||'') || it.parentCity || '';
          } else {
            newParent = '';
          }
          it.name = newName.trim();
          it.type = newType.trim();
          it.coords = newCoords.trim();
          it.parentCity = newParent.trim();
          render();
        }
      });

      addBtn && addBtn.addEventListener('click', addOne);

      render();
    })();

    // POIs — UI-заглушка (с билеты внутри блока)
    (function(){
      const table = document.getElementById('pois_table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const addBtn = document.getElementById('pois_add');
      const ticketsTitle = document.getElementById('poi_tickets_title');
      const ticketsTable = document.getElementById('tickets_table');
      const ticketsTbody = ticketsTable ? ticketsTable.querySelector('tbody') : null;
      const ticketsAddBtn = document.getElementById('tickets_add');

      function getCities(){
        const rows = document.querySelectorAll('#cities_table tbody tr');
        const list = [];
        rows.forEach(r=>{
          const id = r.querySelector('td:nth-child(1)')?.textContent?.trim();
          const name = r.querySelector('td:nth-child(2)')?.textContent?.trim();
          const region = r.querySelector('td:nth-child(3)')?.textContent?.trim();
          if (id && name && !id.startsWith('Нет данных')) list.push({id,name,region});
        });
        return list;
      }

      let items = [];
      let selectedPoiId = '';

      function genId(){ return 'POI-' + String(items.length+1).padStart(4,'0'); }

      function render(){
        tbody.innerHTML = '';
        if (items.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.className = 'px-4 py-4 text-gray-500';
          td.textContent = 'Нет данных. Добавьте POI.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          updateTicketsPanel();
          return;
        }
        items.forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-gray-800">${it.id}</td>
            <td class="px-4 py-2 text-gray-800">${it.name}</td>
            <td class="px-4 py-2 text-gray-800">${it.cityName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.regionName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.type || ''}</td>
            <td class="px-4 py-2 text-gray-800">${(it.tickets||[]).length}</td>
            <td class="px-4 py-2 text-right">
              <button data-action="tickets" data-id="${it.id}" class="text-xs text-indigo-600 hover:text-indigo-800 mr-3"><i class="fas fa-ticket mr-1"></i>Билеты</button>
              <button data-action="edit" data-id="${it.id}" class="text-xs text-gray-700 hover:text-gray-900 mr-3"><i class="fas fa-pen mr-1"></i>Редактировать</button>
              <button data-action="delete" data-id="${it.id}" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-trash mr-1"></i>Удалить</button>
            </td>`;
          tbody.appendChild(tr);
        });
        updateTicketsPanel();
      }

      function addOne(){
        const name = prompt('Название POI:');
        if (!name) return;
        const type = prompt('Тип объекта (культура, природа, гастро, …):', 'культура') || '';
        const cities = getCities();
        let cityName = '';
        let regionName = '';
        if (cities.length){
          const names = cities.map(x=>x.name).join(', ');
          const picked = prompt('Город/Локация ('+names+'):') || '';
          const found = cities.find(x=>x.name===picked.trim());
          cityName = found ? found.name : (cities[0]?.name || '');
          regionName = found ? (found.region || '') : (cities[0]?.region || '');
        }
        items.push({ id: genId(), name: name.trim(), type: type.trim(), cityName, regionName, tickets: []});
        render();
      }

      tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'delete'){
          items = items.filter(r=>r.id !== id);
          if (selectedPoiId === id) selectedPoiId = '';
          render();
        } else if (action === 'edit'){
          const it = items.find(x=>x.id===id);
          if (!it) return;
          const newName = prompt('Новое название:', it.name) || it.name;
          const newType = prompt('Тип объекта:', it.type) || it.type;
          it.name = newName.trim();
          it.type = newType.trim();
          render();
        } else if (action === 'tickets'){
          selectedPoiId = id;
          updateTicketsPanel();
        }
      });

      addBtn && addBtn.addEventListener('click', addOne);

      // Билеты внутри POI
      let tickets = {};// { poiId: [ {id,category,price,currency,note} ] }
      function ensureArr(poiId){ if (!tickets[poiId]) tickets[poiId] = []; return tickets[poiId]; }

      function updateTicketsPanel(){
        if (!ticketsTbody || !ticketsTitle) return;
        const poi = items.find(x=>x.id===selectedPoiId);
        ticketsTitle.textContent = poi ? poi.name : '— не выбран —';
        const list = poi ? ensureArr(poi.id) : [];
        ticketsTbody.innerHTML = '';
        if (!poi){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className='px-4 py-4 text-gray-500';
          td.textContent = 'Выберите POI (кнопка «Билеты»)';
          tr.appendChild(td); ticketsTbody.appendChild(tr); return;
        }
        if (list.length===0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className='px-4 py-4 text-gray-500';
          td.textContent = 'Нет билетов. Добавьте билет.';
          tr.appendChild(td); ticketsTbody.appendChild(tr); return;
        }
        list.forEach((t, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class=\"px-4 py-2 text-gray-800\">${t.id}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.category}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.price}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.currency}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.note||''}</td>
            <td class=\"px-4 py-2 text-right\">\n              <button data-action=\"t-edit\" data-id=\"${t.id}\" class=\"text-xs text-gray-700 hover:text-gray-900 mr-3\"><i class=\"fas fa-pen mr-1\"></i>Редактировать</button>\n              <button data-action=\"t-delete\" data-id=\"${t.id}\" class=\"text-xs text-red-600 hover:text-red-800\"><i class="fas fa-trash mr-1"></i>Удалить</button>
            </td>`;
          ticketsTbody.appendChild(tr);
        });
      }

      function genTicketId(poiId){
        const n = ensureArr(poiId).length + 1;
        return poiId.replace('POI-','TKT-') + '-' + String(n).padStart(2,'0');
        }

      ticketsAddBtn && ticketsAddBtn.addEventListener('click', function(){
        if (!selectedPoiId) { alert('Сначала выберите POI (кнопка «Билеты»).'); return; }
        const category = prompt('Категория (Adult / Child / Infant / Senior / Special):', 'Adult') || 'Adult';
        const priceStr = prompt('Цена (¥):', '1000') || '0';
        const price = parseInt(priceStr, 10) || 0;
        const currency = '¥';
        const note = prompt('Примечание:', '') || '';
        const arr = ensureArr(selectedPoiId);
        arr.push({ id: genTicketId(selectedPoiId), category, price, currency, note });
        updateTicketsPanel();
      });

      ticketsTbody && ticketsTbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn || !selectedPoiId) return;
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        const arr = ensureArr(selectedPoiId);
        if (action==='t-delete'){
          const idx = arr.findIndex(x=>x.id===id);
          if (idx>=0){ arr.splice(idx,1); updateTicketsPanel(); }
        } else if (action==='t-edit'){
          const t = arr.find(x=>x.id===id); if (!t) return;
          const newCategory = prompt('Категория:', t.category) || t.category;
          const newPriceStr = prompt('Цена (¥):', String(t.price)) || String(t.price);
          const newNote = prompt('Примечание:', t.note||'') || t.note;
          t.category = newCategory.trim();
          t.price = parseInt(newPriceStr, 10) || t.price;
          t.note = newNote.trim();
          updateTicketsPanel();
        }
      });

      render();
    })();
    </script>
  </body>
</html>


