<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Konstructour — Базы данных</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../styles/admin-japanese.css" rel="stylesheet">
    <style>
      body{ background: rgb(var(--color-washi)); min-height:100vh; }
      .tab{ padding:14px 20px; font-size:16px; border-radius:10px; cursor:pointer; flex:1 1 0%; text-align:center; }
      .tab.active{ background:#fff; border:1px solid rgba(139,90,43,.15); }
      .tab-content{ display:none; }
      .tab-content.active{ display:block; }
    </style>
  </head>
  <body data-no-redirect="true">
    <div class="dashboard-grid">
      <aside class="sidebar texture-wood">
        <div class="p-6">
          <div class="flex items-center mb-8">
            <div class="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center mr-3">
              <svg class="w-8 h-8 text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
            </div>
            <div>
              <h1 class="text-xl font-light text-gray-800">Konstructour</h1>
              <p class="text-xs text-gray-600">Site Admin</p>
            </div>
          </div>
          <nav class="space-y-2">
            <a href="dashboard.html" class="sidebar-link"><i class="fas fa-th-large mr-3 text-indigo-600"></i>Обзор</a>
            <a href="api-catalog.html" class="sidebar-link"><i class="fas fa-list mr-3 text-gray-600"></i>Каталог API</a>
            <a href="databases.html" class="menu-item active sidebar-link"><i class="fas fa-database mr-3 text-green-600"></i>Базы данных</a>
          </nav>
        </div>
      </aside>
      <main class="p-8">
        <header class="mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-light text-gray-800 mb-1">Базы данных</h2>
              <p class="text-gray-600">Выберите базу и управляйте данными через интеграции API</p>
            </div>
          </div>
        </header>

        <div class="glass-panel p-8 rounded-lg mb-6">
          <div class="flex items-center gap-3">
            <button class="tab active" data-tab="regions"><i class="fas fa-globe-asia mr-2 text-blue-600"></i>Регионы</button>
            <button class="tab" data-tab="tours"><i class="fas fa-route mr-2 text-green-600"></i>Туры</button>
            <button class="tab" data-tab="templates"><i class="fas fa-layer-group mr-2 text-purple-600"></i>Шаблоны</button>
          </div>
        </div>

        <!-- Регионы (иерархия карточек) -->
        <section id="tab-regions" class="tab-content active">
          <div class="glass-panel p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-globe-asia mr-2 text-blue-600"></i>Регионы → Города → POI → Билеты</h3>
              <div class="api-actions flex items-center gap-2 flex-wrap">
                <div class="text-xs text-gray-600">Тип API:</div>
                <select id="regions_api_type" class="input-japanese" style="padding:6px 10px;">
                  <option value="airtable">Airtable</option>
                  <option value="gsheets">Google Sheets</option>
                  <option value="brilliantdirectory">BD</option>
                </select>
                <button id="regions_sync" type="button" class="btn-japanese"><i class="fas fa-sync mr-2"></i>Синхронизировать</button>
              </div>
            </div>

            <!-- Хлебные крошки -->
            <div id="db_breadcrumbs" class="flex items-center flex-wrap text-sm text-gray-600 mb-4"></div>

            <!-- Контейнер карточек уровня -->
            <div id="db_cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

            <!-- Плавающая кнопка добавления -->
            <button id="db_fab_add" class="fixed bottom-8 right-8 btn-japanese rounded-full w-12 h-12 flex items-center justify-center shadow-lg" title="Добавить">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </section>

        <!-- Туры -->
        <section id="tab-tours" class="tab-content">
          <div class="glass-panel p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-route mr-2 text-green-600"></i>Туры</h3>
              <div class="api-actions flex items-center gap-2 flex-wrap">
                <div class="text-xs text-gray-600">Тип API:</div>
                <select id="tours_api_type" class="input-japanese" style="padding:6px 10px;">
                  <option value="airtable">Airtable</option>
                  <option value="gsheets">Google Sheets</option>
                  <option value="brilliantdirectory">BD</option>
                </select>
                <button id="tours_sync" type="button" class="btn-japanese"><i class="fas fa-sync mr-2"></i>Синхронизировать</button>
              </div>
            </div>
            <div id="tours_schema" class="text-sm text-gray-600">
              Структура берётся из Project Description.md. Настройка схемы будет подключена.
            </div>
            <div class="mt-4">
              <div class="text-xs text-gray-500 mb-2">Предпросмотр данных</div>
              <div id="tours_preview" class="japanese-table w-full rounded-lg overflow-hidden">
                <div class="p-4 text-gray-500">Нет данных. Нажмите «Синхронизировать».</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Шаблоны -->
        <section id="tab-templates" class="tab-content">
          <div class="glass-panel p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-light text-gray-800"><i class="fas fa-layer-group mr-2 text-purple-600"></i>Шаблоны</h3>
              <div class="api-actions flex items-center gap-2 flex-wrap">
                <div class="text-xs text-gray-600">Тип API:</div>
                <select id="templates_api_type" class="input-japanese" style="padding:6px 10px;">
                  <option value="airtable">Airtable</option>
                  <option value="gsheets">Google Sheets</option>
                  <option value="brilliantdirectory">BD</option>
                </select>
                <button id="templates_sync" type="button" class="btn-japanese"><i class="fas fa-sync mr-2"></i>Синхронизировать</button>
              </div>
            </div>
            <div id="templates_schema" class="text-sm text-gray-600">
              Структура настраивается индивидуально.
            </div>
            <div class="mt-4">
              <div class="text-xs text-gray-500 mb-2">Предпросмотр данных</div>
              <div id="templates_preview" class="japanese-table w-full rounded-lg overflow-hidden">
                <div class="p-4 text-gray-500">Нет данных. Нажмите «Синхронизировать».</div>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>

    <script>
    // Простые вкладки без сторонних зависимостей
    (function(){
      const tabs = document.querySelectorAll('.tab');
      const sections = {
        regions: document.getElementById('tab-regions'),
        tours: document.getElementById('tab-tours'),
        templates: document.getElementById('tab-templates')
      };
      tabs.forEach(btn=>{
        btn.addEventListener('click', function(e){
          e.preventDefault();
          tabs.forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          Object.values(sections).forEach(s=>s.classList.remove('active'));
          const key = this.getAttribute('data-tab');
          if (sections[key]) sections[key].classList.add('active');
        });
      });
    })();

    // Иерархия карточек: регионы → города → POI → билеты (UI, без API)
    (function(){
      const crumbs = document.getElementById('db_breadcrumbs');
      const cards = document.getElementById('db_cards');
      const fab = document.getElementById('db_fab_add');

      if (!crumbs || !cards || !fab) return;

      const regionColors = {
        'Хоккайдо':'bg-blue-100 text-blue-800',
        'Тохоку':'bg-green-100 text-green-800',
        'Канто':'bg-indigo-100 text-indigo-800',
        'Тюбу':'bg-yellow-100 text-yellow-800',
        'Кансай':'bg-purple-100 text-purple-800',
        'Тюгоку':'bg-pink-100 text-pink-800',
        'Сикоку':'bg-teal-100 text-teal-800',
        'Кюсю':'bg-red-100 text-red-800',
        'Окинава':'bg-cyan-100 text-cyan-800'
      };

      // State (in-memory for UI only)
      let regions = [ 'Хоккайдо','Тохоку','Канто','Тюбу','Кансай','Тюгоку','Сикоку','Кюсю','Окинава' ]
        .map((name, i)=>({ id:'REG-'+String(i+1).padStart(3,'0'), name }));
      let citiesByRegion = {}; // regionId -> [ {id,name} ]
      let poisByCity = {};     // cityId -> [ {id,name,type} ]
      let ticketsByPoi = {};   // poiId -> [ {id,category,price,currency,note} ]

      // Demo seed
      const kansai = regions.find(r=>r.name==='Кансай');
      if (kansai){
        citiesByRegion[kansai.id] = [
          { id:'CL-001', name:'Киото' }, { id:'CL-002', name:'Осака' }, { id:'CL-003', name:'Нара' }
        ];
        poisByCity['CL-001'] = [ { id:'POI-001', name:'Храм Киёмидзу', type:'культура' }, { id:'POI-002', name:'Золотой павильон', type:'культура' } ];
        ticketsByPoi['POI-001'] = [ { id:'TKT-001', category:'Adult', price:500, currency:'¥', note:'' }, { id:'TKT-002', category:'Child', price:200, currency:'¥', note:'6–11' } ];
      }

      let level = 'regions';
      let selectedRegion = null;
      let selectedCity = null;
      let selectedPoi = null;

      function renderCrumbs(){
        const parts = [];
        parts.push('<a href="#" data-level="regions" class="text-indigo-600 hover:underline">Регионы</a>');
        if (selectedRegion){
          parts.push('<span class="mx-2">/</span><a href="#" data-level="cities" class="text-indigo-600 hover:underline">'+selectedRegion.name+'</a>');
        }
        if (selectedCity){
          parts.push('<span class="mx-2">/</span><a href="#" data-level="pois" class="text-indigo-600 hover:underline">'+selectedCity.name+'</a>');
        }
        if (selectedPoi){
          parts.push('<span class="mx-2">/</span><span class="text-gray-800">'+selectedPoi.name+'</span>');
        }
        crumbs.innerHTML = parts.join('');
      }

      function card(actionsHtml, innerHtml){
        return '<div class="relative bg-white rounded-lg border border-gray-200 p-4 hover:shadow transition">\
          <div class="absolute top-2 right-2 flex items-center gap-2 opacity-70">'+actionsHtml+'</div>'+innerHtml+'</div>';
      }

      function renderRegions(){
        level='regions'; selectedRegion=null; selectedCity=null; selectedPoi=null; renderCrumbs();
        cards.innerHTML = regions.map(r=>{
          const color = regionColors[r.name] || 'bg-gray-100 text-gray-800';
          const actions = '<button data-act="edit-region" data-id="'+r.id+'" title="Редактировать" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
                          '<button data-act="del-region" data-id="'+r.id+'" title="Удалить" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>';
          const inner = '<div class="flex items-center justify-between">\
              <div>\
                <div class="text-sm '+color+' inline-block px-2 py-0.5 rounded">Регион</div>\
                <div class="text-lg text-gray-800 mt-1">'+r.name+'</div>\
              </div>\
              <div class="text-sm text-gray-500">'+((citiesByRegion[r.id]||[]).length)+' городов</div>\
            </div>';
          return '<div class="cursor-pointer" data-go="cities" data-id="'+r.id+'">'+card(actions, inner)+'</div>';
        }).join('');
      }

      function renderCities(){
        level='cities'; selectedCity=null; selectedPoi=null; renderCrumbs();
        const list = citiesByRegion[selectedRegion.id] || [];
        cards.innerHTML = list.map(c=>{
          const actions = '<button data-act="edit-city" data-id="'+c.id+'" title="Редактировать" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
                          '<button data-act="del-city" data-id="'+c.id+'" title="Удалить" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>';
          const inner = '<div class="flex items-center justify-between">\
              <div>\
                <div class="text-sm bg-gray-100 text-gray-700 inline-block px-2 py-0.5 rounded">Город</div>\
                <div class="text-lg text-gray-800 mt-1">'+c.name+'</div>\
              </div>\
              <div class="text-sm text-gray-500">'+((poisByCity[c.id]||[]).length)+' POI</div>\
            </div>';
          return '<div class="cursor-pointer" data-go="pois" data-id="'+c.id+'">'+card(actions, inner)+'</div>';
        }).join('') || '<div class="text-gray-500">Нет городов. Нажмите + чтобы добавить.</div>';
      }

      function renderPois(){
        level='pois'; selectedPoi=null; renderCrumbs();
        const list = poisByCity[selectedCity.id] || [];
        cards.innerHTML = list.map(p=>{
          const actions = '<button data-act="edit-poi" data-id="'+p.id+'" title="Редактировать" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
                          '<button data-act="del-poi" data-id="'+p.id+'" title="Удалить" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>';
          const inner = '<div class="flex items-start gap-3">\
              <div class="w-16 h-16 bg-gray-100 rounded overflow-hidden flex items-center justify-center"><i class="fas fa-landmark text-gray-400"></i></div>\
              <div class="flex-1">\
                <div class="flex items-center justify-between">\
                  <div class="text-lg text-gray-800">'+p.name+'</div>\
                  <div class="text-xs text-gray-500 flex items-center gap-3">\
                    <span title="Тип"><i class="fas fa-tag mr-1 text-gray-400"></i>'+ (p.type||'—') +'</span>\
                    <span title="Билеты"><i class="fas fa-ticket mr-1 text-gray-400"></i>'+((ticketsByPoi[p.id]||[]).length)+'</span>\
                  </div>\
                </div>\
              </div>\
            </div>';
          return '<div class="cursor-pointer" data-go="tickets" data-id="'+p.id+'">'+card(actions, inner)+'</div>';
        }).join('') || '<div class="text-gray-500">Нет POI. Нажмите + чтобы добавить.</div>';
      }

      function renderTickets(){
        level='tickets'; renderCrumbs();
        const list = ticketsByPoi[selectedPoi.id] || [];
        cards.innerHTML = list.map(t=>{
          const actions = '<button data-act="edit-ticket" data-id="'+t.id+'" title="Редактировать" class="text-gray-600 hover:text-gray-900"><i class="fas fa-pen"></i></button>'+
                          '<button data-act="del-ticket" data-id="'+t.id+'" title="Удалить" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>';
          const inner = '<div class="flex items-center justify-between">\
              <div class="text-gray-800"><span class="text-xs bg-gray-100 text-gray-700 inline-block px-2 py-0.5 rounded mr-2">🎟</span>'+t.category+'</div>\
              <div class="text-gray-700">'+t.price+'¥</div>\
            </div>';
          return card(actions, inner);
        }).join('') || '<div class="text-gray-500">Нет билетов. Нажмите + чтобы добавить.</div>';
      }

      // Navigation (cards)
      cards.addEventListener('click', function(e){
        const go = e.target.closest('[data-go]');
        if (!go) return;
        const id = go.getAttribute('data-id');
        const to = go.getAttribute('data-go');
        if (to==='cities'){
          selectedRegion = regions.find(r=>r.id===id) || null;
          renderCities();
        } else if (to==='pois'){
          const list = citiesByRegion[selectedRegion.id] || [];
          selectedCity = list.find(c=>c.id===id) || null;
          renderPois();
        } else if (to==='tickets'){
          const list = poisByCity[selectedCity.id] || [];
          selectedPoi = list.find(p=>p.id===id) || null;
          renderTickets();
        }
      });

      // Breadcrumbs
      crumbs.addEventListener('click', function(e){
        const a = e.target.closest('a[data-level]');
        if (!a) return;
        e.preventDefault();
        const lv = a.getAttribute('data-level');
        if (lv==='regions') return renderRegions();
        if (lv==='cities') return renderCities();
        if (lv==='pois') return renderPois();
      });

      // Card action buttons
      cards.addEventListener('click', function(e){
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        e.stopPropagation();
        const act = btn.getAttribute('data-act');
        const id = btn.getAttribute('data-id');
        if (act==='edit-region'){
          const r = regions.find(x=>x.id===id); if(!r) return; const n=prompt('Название региона:', r.name); if(n){ r.name=n.trim(); renderRegions(); }
        } else if (act==='del-region'){
          regions = regions.filter(x=>x.id!==id); delete citiesByRegion[id]; renderRegions();
        } else if (act==='edit-city'){
          const list = citiesByRegion[selectedRegion.id]||[]; const c=list.find(x=>x.id===id); if(!c) return; const n=prompt('Название города:', c.name); if(n){ c.name=n.trim(); renderCities(); }
        } else if (act==='del-city'){
          const list = citiesByRegion[selectedRegion.id]||[]; citiesByRegion[selectedRegion.id] = list.filter(x=>x.id!==id); delete poisByCity[id]; renderCities();
        } else if (act==='edit-poi'){
          const list = poisByCity[selectedCity.id]||[]; const p=list.find(x=>x.id===id); if(!p) return; const n=prompt('Название POI:', p.name)||p.name; const t=prompt('Тип (культура/природа/гастро):', p.type||'')||p.type; p.name=n.trim(); p.type=t.trim(); renderPois();
        } else if (act==='del-poi'){
          const list = poisByCity[selectedCity.id]||[]; poisByCity[selectedCity.id] = list.filter(x=>x.id!==id); delete ticketsByPoi[id]; renderPois();
        } else if (act==='edit-ticket'){
          const list = ticketsByPoi[selectedPoi.id]||[]; const t = list.find(x=>x.id===id); if(!t) return; const c=prompt('Категория:', t.category)||t.category; const p=prompt('Цена (¥):', String(t.price))||String(t.price); const n=prompt('Примечание:', t.note||'')||t.note; t.category=c.trim(); t.price=parseInt(p,10)||t.price; t.note=n.trim(); renderTickets();
        } else if (act==='del-ticket'){
          const list = ticketsByPoi[selectedPoi.id]||[]; ticketsByPoi[selectedPoi.id] = list.filter(x=>x.id!==id); renderTickets();
        }
      });

      // Floating add button
      function genId(prefix, n){ return prefix+'-'+String(n).padStart(3,'0'); }
      fab.addEventListener('click', function(){
        if (level==='regions'){
          const name = prompt('Название региона:'); if(!name) return;
          const id = genId('REG', regions.length+1);
          regions.push({ id, name:name.trim() });
          renderRegions();
        } else if (level==='cities'){
          const name = prompt('Название города:'); if(!name) return;
          const list = citiesByRegion[selectedRegion.id] || (citiesByRegion[selectedRegion.id]=[]);
          const id = genId('CL', list.length+1);
          list.push({ id, name:name.trim() });
          renderCities();
        } else if (level==='pois'){
          const name = prompt('Название POI:'); if(!name) return;
          const type = prompt('Тип (культура/природа/гастро):','культура')||'';
          const list = poisByCity[selectedCity.id] || (poisByCity[selectedCity.id]=[]);
          const id = genId('POI', list.length+1);
          list.push({ id, name:name.trim(), type:type.trim() });
          renderPois();
        } else if (level==='tickets'){
          const category = prompt('Категория (Adult/Child/Infant/Senior/Special):','Adult')||'Adult';
          const price = parseInt(prompt('Цена (¥):','1000')||'1000',10)||0;
          const note = prompt('Примечание:','')||'';
          const list = ticketsByPoi[selectedPoi.id] || (ticketsByPoi[selectedPoi.id]=[]);
          const id = genId('TKT', list.length+1);
          list.push({ id, category, price, currency:'¥', note });
          renderTickets();
        }
      });

      // Initial
      renderRegions();
    })();
    // Каталог регионов — UI-заглушка без обращений к реальным API
    (function(){
      const table = document.getElementById('regions_table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const addBtn = document.getElementById('regions_add');

      let regions = [];

      function generateId(){
        const n = regions.length + 1;
        return 'REG-' + String(n).padStart(3, '0');
      }

      // Предзаполним список регионов сразу
      regions = [
        'Хоккайдо','Тохоку','Канто','Тюбу','Кансай','Тюгоку','Сикоку','Кюсю','Окинава'
      ].map((name, i)=>({ id: 'REG-' + String(i+1).padStart(3,'0'), name, citiesCount: 0 }));

      function render(){
        tbody.innerHTML = '';
        if (regions.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4;
          td.className = 'px-4 py-4 text-gray-500';
          td.textContent = 'Нет данных. Добавьте регион.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        regions.forEach((r, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-gray-800">${r.id}</td>
            <td class="px-4 py-2 text-gray-800">${r.name}</td>
            <td class="px-4 py-2">
              <a href="#" class="text-indigo-600 hover:text-indigo-800 text-sm">Перейти к городам</a>
              <span class="text-xs text-gray-500 ml-2">(${r.citiesCount || 0})</span>
            </td>
            <td class="px-4 py-2 text-right">
              <button data-action="edit" data-id="${r.id}" class="text-xs text-gray-700 hover:text-gray-900 mr-3"><i class="fas fa-pen mr-1"></i>Редактировать</button>
              <button data-action="delete" data-id="${r.id}" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-trash mr-1"></i>Удалить</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      function addOne(){
        const name = prompt('Название региона:');
        if (!name) return;
        regions.push({ id: generateId(), name: name.trim(), citiesCount: 0 });
        render();
      }

      tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'delete'){
          regions = regions.filter(r=>r.id !== id);
          render();
        } else if (action === 'edit'){
          const r = regions.find(x=>x.id===id);
          if (!r) return;
          const newName = prompt('Новое название региона:', r.name);
          if (newName && newName.trim()){
            r.name = newName.trim();
            render();
          }
        }
      });

      addBtn && addBtn.addEventListener('click', addOne);

      render();
    })();

    // Каталог городов/локаций — UI-заглушка без обращений к реальным API
    (function(){
      const table = document.getElementById('cities_table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const addBtn = document.getElementById('cities_add');

      // Используем регионы из раздела выше как справочник
      function getRegionList(){
        const rows = document.querySelectorAll('#regions_table tbody tr');
        const list = [];
        rows.forEach(r=>{
          const id = r.querySelector('td:nth-child(1)')?.textContent?.trim();
          const name = r.querySelector('td:nth-child(2)')?.textContent?.trim();
          if (id && name && !id.startsWith('Нет данных')) list.push({id,name});
        });
        return list;
      }

      let items = [];

      function generateId(){
        const n = items.length + 1;
        return 'CL-' + String(n).padStart(4, '0');
      }

      function render(){
        tbody.innerHTML = '';
        if (items.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.className = 'px-4 py-4 text-gray-500';
          td.textContent = 'Нет данных. Добавьте запись.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        items.forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-gray-800">${it.id}</td>
            <td class="px-4 py-2 text-gray-800">${it.name}</td>
            <td class="px-4 py-2 text-gray-800">${it.regionName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.type}</td>
            <td class="px-4 py-2 text-gray-800">${it.coords || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.parentCity || ''}</td>
            <td class="px-4 py-2 text-right">
              <button data-action="edit" data-id="${it.id}" class="text-xs text-gray-700 hover:text-gray-900 mr-3"><i class="fas fa-pen mr-1"></i>Редактировать</button>
              <button data-action="delete" data-id="${it.id}" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-trash mr-1"></i>Удалить</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      function addOne(){
        const name = prompt('Название (город/локация):');
        if (!name) return;
        const type = prompt('Тип записи (Город|Локация):', 'Город');
        if (!type) return;
        let parentCity = '';
        if (type.trim().toLowerCase() === 'локация'){
          parentCity = prompt('Родительский город:') || '';
        }
        const coords = prompt('Координаты (опционально, например: 35.6895,139.6917):') || '';
        const r = getRegionList();
        let regionName = '';
        if (r.length){
          const names = r.map(x=>x.name).join(', ');
          const picked = prompt('Регион ('+names+'):') || '';
          const found = r.find(x=>x.name===picked.trim());
          regionName = found ? found.name : (r[0]?.name || '');
        }
        items.push({ id: generateId(), name: name.trim(), type: (type||'').trim(), parentCity: parentCity.trim(), coords: coords.trim(), regionName });
        render();
      }

      tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'delete'){
          items = items.filter(r=>r.id !== id);
          render();
        } else if (action === 'edit'){
          const it = items.find(x=>x.id===id);
          if (!it) return;
          const newName = prompt('Новое название:', it.name) || it.name;
          const newType = prompt('Тип записи (Город|Локация):', it.type) || it.type;
          const newCoords = prompt('Координаты:', it.coords) || it.coords;
          let newParent = it.parentCity;
          if ((newType||'').trim().toLowerCase()==='локация'){
            newParent = prompt('Родительский город:', it.parentCity||'') || it.parentCity || '';
          } else {
            newParent = '';
          }
          it.name = newName.trim();
          it.type = newType.trim();
          it.coords = newCoords.trim();
          it.parentCity = newParent.trim();
          render();
        }
      });

      addBtn && addBtn.addEventListener('click', addOne);

      render();
    })();

    // POIs — UI-заглушка (с билеты внутри блока)
    (function(){
      const table = document.getElementById('pois_table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const addBtn = document.getElementById('pois_add');
      const ticketsTitle = document.getElementById('poi_tickets_title');
      const ticketsTable = document.getElementById('tickets_table');
      const ticketsTbody = ticketsTable ? ticketsTable.querySelector('tbody') : null;
      const ticketsAddBtn = document.getElementById('tickets_add');

      function getCities(){
        const rows = document.querySelectorAll('#cities_table tbody tr');
        const list = [];
        rows.forEach(r=>{
          const id = r.querySelector('td:nth-child(1)')?.textContent?.trim();
          const name = r.querySelector('td:nth-child(2)')?.textContent?.trim();
          const region = r.querySelector('td:nth-child(3)')?.textContent?.trim();
          if (id && name && !id.startsWith('Нет данных')) list.push({id,name,region});
        });
        return list;
      }

      let items = [];
      let selectedPoiId = '';

      function genId(){ return 'POI-' + String(items.length+1).padStart(4,'0'); }

      function render(){
        tbody.innerHTML = '';
        if (items.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.className = 'px-4 py-4 text-gray-500';
          td.textContent = 'Нет данных. Добавьте POI.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          updateTicketsPanel();
          return;
        }
        items.forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class="px-4 py-2 text-gray-800">${it.id}</td>
            <td class="px-4 py-2 text-gray-800">${it.name}</td>
            <td class="px-4 py-2 text-gray-800">${it.cityName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.regionName || ''}</td>
            <td class="px-4 py-2 text-gray-800">${it.type || ''}</td>
            <td class="px-4 py-2 text-gray-800">${(it.tickets||[]).length}</td>
            <td class="px-4 py-2 text-right">
              <button data-action="tickets" data-id="${it.id}" class="text-xs text-indigo-600 hover:text-indigo-800 mr-3"><i class="fas fa-ticket mr-1"></i>Билеты</button>
              <button data-action="edit" data-id="${it.id}" class="text-xs text-gray-700 hover:text-gray-900 mr-3"><i class="fas fa-pen mr-1"></i>Редактировать</button>
              <button data-action="delete" data-id="${it.id}" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-trash mr-1"></i>Удалить</button>
            </td>`;
          tbody.appendChild(tr);
        });
        updateTicketsPanel();
      }

      function addOne(){
        const name = prompt('Название POI:');
        if (!name) return;
        const type = prompt('Тип объекта (культура, природа, гастро, …):', 'культура') || '';
        const cities = getCities();
        let cityName = '';
        let regionName = '';
        if (cities.length){
          const names = cities.map(x=>x.name).join(', ');
          const picked = prompt('Город/Локация ('+names+'):') || '';
          const found = cities.find(x=>x.name===picked.trim());
          cityName = found ? found.name : (cities[0]?.name || '');
          regionName = found ? (found.region || '') : (cities[0]?.region || '');
        }
        items.push({ id: genId(), name: name.trim(), type: type.trim(), cityName, regionName, tickets: []});
        render();
      }

      tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'delete'){
          items = items.filter(r=>r.id !== id);
          if (selectedPoiId === id) selectedPoiId = '';
          render();
        } else if (action === 'edit'){
          const it = items.find(x=>x.id===id);
          if (!it) return;
          const newName = prompt('Новое название:', it.name) || it.name;
          const newType = prompt('Тип объекта:', it.type) || it.type;
          it.name = newName.trim();
          it.type = newType.trim();
          render();
        } else if (action === 'tickets'){
          selectedPoiId = id;
          updateTicketsPanel();
        }
      });

      addBtn && addBtn.addEventListener('click', addOne);

      // Билеты внутри POI
      let tickets = {};// { poiId: [ {id,category,price,currency,note} ] }
      function ensureArr(poiId){ if (!tickets[poiId]) tickets[poiId] = []; return tickets[poiId]; }

      function updateTicketsPanel(){
        if (!ticketsTbody || !ticketsTitle) return;
        const poi = items.find(x=>x.id===selectedPoiId);
        ticketsTitle.textContent = poi ? poi.name : '— не выбран —';
        const list = poi ? ensureArr(poi.id) : [];
        ticketsTbody.innerHTML = '';
        if (!poi){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className='px-4 py-4 text-gray-500';
          td.textContent = 'Выберите POI (кнопка «Билеты»)';
          tr.appendChild(td); ticketsTbody.appendChild(tr); return;
        }
        if (list.length===0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className='px-4 py-4 text-gray-500';
          td.textContent = 'Нет билетов. Добавьте билет.';
          tr.appendChild(td); ticketsTbody.appendChild(tr); return;
        }
        list.forEach((t, idx)=>{
          const tr = document.createElement('tr');
          tr.className = idx % 2 ? 'bg-gray-50' : '';
          tr.innerHTML = `
            <td class=\"px-4 py-2 text-gray-800\">${t.id}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.category}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.price}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.currency}</td>
            <td class=\"px-4 py-2 text-gray-800\">${t.note||''}</td>
            <td class=\"px-4 py-2 text-right\">\n              <button data-action=\"t-edit\" data-id=\"${t.id}\" class=\"text-xs text-gray-700 hover:text-gray-900 mr-3\"><i class=\"fas fa-pen mr-1\"></i>Редактировать</button>\n              <button data-action=\"t-delete\" data-id=\"${t.id}\" class=\"text-xs text-red-600 hover:text-red-800\"><i class="fas fa-trash mr-1"></i>Удалить</button>
            </td>`;
          ticketsTbody.appendChild(tr);
        });
      }

      function genTicketId(poiId){
        const n = ensureArr(poiId).length + 1;
        return poiId.replace('POI-','TKT-') + '-' + String(n).padStart(2,'0');
        }

      ticketsAddBtn && ticketsAddBtn.addEventListener('click', function(){
        if (!selectedPoiId) { alert('Сначала выберите POI (кнопка «Билеты»).'); return; }
        const category = prompt('Категория (Adult / Child / Infant / Senior / Special):', 'Adult') || 'Adult';
        const priceStr = prompt('Цена (¥):', '1000') || '0';
        const price = parseInt(priceStr, 10) || 0;
        const currency = '¥';
        const note = prompt('Примечание:', '') || '';
        const arr = ensureArr(selectedPoiId);
        arr.push({ id: genTicketId(selectedPoiId), category, price, currency, note });
        updateTicketsPanel();
      });

      ticketsTbody && ticketsTbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if (!btn || !selectedPoiId) return;
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        const arr = ensureArr(selectedPoiId);
        if (action==='t-delete'){
          const idx = arr.findIndex(x=>x.id===id);
          if (idx>=0){ arr.splice(idx,1); updateTicketsPanel(); }
        } else if (action==='t-edit'){
          const t = arr.find(x=>x.id===id); if (!t) return;
          const newCategory = prompt('Категория:', t.category) || t.category;
          const newPriceStr = prompt('Цена (¥):', String(t.price)) || String(t.price);
          const newNote = prompt('Примечание:', t.note||'') || t.note;
          t.category = newCategory.trim();
          t.price = parseInt(newPriceStr, 10) || t.price;
          t.note = newNote.trim();
          updateTicketsPanel();
        }
      });

      render();
    })();
    </script>
  </body>
</html>


