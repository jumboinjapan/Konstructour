<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konstructour — Site Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../styles/admin-japanese.css" rel="stylesheet">
    <style>
        body { background: rgba(254, 251, 243, 1); min-height: 100vh; }
        .dashboard-grid { display: grid; grid-template-columns: 280px 1fr; gap: 0; min-height: 100vh; }
        .sidebar { background: linear-gradient(to bottom, rgba(254, 251, 243, 0.98), rgba(254, 251, 243, 0.95)); border-right: 1px solid rgba(139, 90, 43, 0.12); position: relative; backdrop-filter: blur(8px); }
        .sidebar::before { content: ''; position: absolute; inset: 0; background-image: repeating-linear-gradient(0deg, transparent, transparent 60px, rgba(139, 90, 43, 0.05) 60px, rgba(139, 90, 43, 0.05) 61px); pointer-events: none; }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(236,229,221,0.9)); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top:-50%; right:-50%; width:200%; height:200%; background: radial-gradient(circle, rgba(var(--stat-color, 38, 67, 120), 0.1), transparent); animation: pulse 4s ease-in-out infinite; }
        @keyframes pulse { 0%,100%{transform:scale(1);opacity:.5;} 50%{transform:scale(1.1);opacity:.3;} }
        .menu-item{ position:relative; transition: all .3s ease; }
        .menu-item::before{ content:''; position:absolute; left:0; top:50%; width:3px; height:0; background: linear-gradient(to bottom, rgba(179, 38, 30, .8), rgba(38,67,120,.8)); transition: all .3s ease; transform: translateY(-50%); }
        .menu-item.active::before, .menu-item:hover::before{ height:70%; }
        .menu-item.active{ background: linear-gradient(to right, rgba(179,38,30,.1), transparent); }
        .japanese-table{ background:#fff; border:1px solid rgba(139,90,43,.1); }
        .japanese-table thead{ background: linear-gradient(to bottom, rgba(236,229,221,.5), rgba(236,229,221,.3)); }
        .japanese-table tbody tr{ transition: all .2s ease; }
        .japanese-table tbody tr:hover{ background: rgba(179, 38, 30, .05); }
        .chart-container{ background:#fff; border-radius:8px; position:relative; overflow:hidden; }
        .chart-container::after{ content:''; position:absolute; bottom:0; left:0; right:0; height:60px; background: linear-gradient(to top, rgba(179,38,30,.1), transparent); pointer-events:none; }
        /* Error highlight */
        .has-errors{ background: linear-gradient(135deg, rgba(255,0,0,.08), rgba(236,0,0,.08)) !important; }
        .has-errors .text-2xl{ color:#ef4444; }
        /* Modal content fallback */
        .modal-content{ background:#fff; border:1px solid rgba(0,0,0,.1); }
        /* Health Dashboard styles */
        .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .dot{ width:10px; height:10px; border-radius:9999px; display:inline-block; background:#9ca3af;} 
        .dot.ok{ background:#10b981;} .dot.err{ background:#ef4444;} .dot.warn{ background:#f59e0b;} 
        .spin{ border:2px solid #a78bfa; border-top-color:transparent; border-radius:9999px; width:12px; height:12px; animation:spin .9s linear infinite; display:inline-block; }
        @keyframes spin{ to{ transform:rotate(360deg);} }
    </style>
</head>
<body>
    <div class="dashboard-grid">
        <!-- Боковая панель -->
        <aside class="sidebar texture-wood">
            <div class="p-6">
                <div class="flex items-center mb-8">
                    <div class="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center mr-3">
                        <svg class="w-8 h-8 text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-light text-gray-800">Konstructour</h1>
                        <p class="text-xs text-gray-600">Site Admin</p>
                    </div>
                </div>
                <nav class="space-y-2">
                    <a href="#dashboard" class="menu-item active sidebar-link"><i class="fas fa-th-large mr-3 text-indigo-600"></i>Обзор</a>
                    <a id="linkApiCatalog" href="api-catalog.html" class="menu-item sidebar-link"><i class="fas fa-list mr-3 text-gray-600"></i>Каталог API</a>
                    <a href="databases.html" class="menu-item sidebar-link"><i class="fas fa-database mr-3 text-green-600"></i>Базы данных</a>
                    <a href="#guides" class="menu-item sidebar-link"><i class="fas fa-users mr-3 text-blue-600"></i>Гиды</a>
                    <a href="#ai" class="menu-item sidebar-link"><i class="fas fa-brain mr-3 text-purple-600"></i>AI аналитика</a>
                    <a href="#settings" class="menu-item sidebar-link"><i class="fas fa-cog mr-3 text-gray-500"></i>Настройки</a>
                </nav>
            </div>
            <div class="absolute bottom-0 left-0 right-0 p-6 glass-panel border-t border-gray-200">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-red-500 flex items-center justify-center text-white font-medium mr-3">SA</div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">Site Admin</p>
                        <p class="text-xs text-gray-600">site-admin@konstructour.com</p>
                    </div>
                    <button id="logoutBtn" class="text-gray-400 hover:text-gray-600"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </aside>

        <!-- Основное содержимое -->
        <main class="p-8">
            <header class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-light text-gray-800 mb-1">Системный обзор</h2>
                        <p class="text-gray-600">API, база данных, интеграции и AI нагрузки</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="glass-panel px-4 py-2 rounded-lg flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-sm text-gray-700">Система работает</span>
                        </div>
                        <button data-theme-toggle class="glass-panel px-3 py-2 rounded-lg flex items-center space-x-2 text-gray-600 hover:text-gray-800" title="Переключить тему"><i class="fas fa-moon text-sm"></i><span class="text-xs">Тема</span></button>
                    </div>
                </div>
            </header>

            <!-- Метрики Site Admin -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card glass-panel p-6 rounded-lg" style="--stat-color: 38, 67, 120;">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Запросы к API</p>
                            <p class="text-2xl font-light text-gray-800">12,847</p>
                            <p class="text-xs text-green-600 mt-1">↑ 8.2% за день</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center"><i class="fas fa-chart-line text-indigo-600"></i></div>
                    </div>
                </div>
                <div class="stat-card glass-panel p-6 rounded-lg" style="--stat-color: 193, 216, 153;">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Нагрузка БД</p>
                            <p class="text-2xl font-light text-gray-800">45%</p>
                            <p class="text-xs text-blue-600 mt-1">Норма</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center"><i class="fas fa-database text-green-600"></i></div>
                    </div>
                </div>
                <div class="stat-card glass-panel p-6 rounded-lg" style="--stat-color: 179, 38, 30;">
                    <div class="flex items-center justify между">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">AI запросы</p>
                            <p class="text-2xl font-light text-gray-800">2,156</p>
                            <p class="text-xs text-purple-600 mt-1">↑ 15.3% за неделю</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center"><i class="fas fa-brain text-purple-600"></i></div>
                    </div>
                </div>
                <div class="stat-card glass-panel p-6 rounded-lg" style="--stat-color: 38, 67, 120;">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Ошибки в работе сайта</p>
                            <p class="text-2xl font-light text-gray-800">0</p>
                            <a href="#" id="btnShowErrors" data-show-errors class="text-xs text-yellow-600 mt-1 underline cursor-pointer">Нужно проверить</a>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center"><i class="fas fa-exclamation-triangle text-yellow-600"></i></div>
                    </div>
                </div>
            </div>

            <!-- Health Dashboard Section -->
            <div class="glass-panel p-6 rounded-lg mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-light text-gray-800"><i class="fas fa-heartbeat mr-2 text-red-600"></i>Health Dashboard</h3>
                    <div class="flex items-center gap-2 text-sm">
                        <button id="btnRefreshHealth" class="px-3 py-2 rounded-lg bg-gray-900 text-white hover:bg-black text-xs"><i class="fa-solid fa-rotate"></i> Обновить</button>
                        <label class="text-gray-600">Автообновление:
                            <select id="autoRefreshHealth" class="ml-2 border rounded px-2 py-1 text-xs">
                                <option value="0">Выкл</option>
                                <option value="30000">30 сек</option>
                                <option value="60000">1 мин</option>
                                <option value="300000">5 мин</option>
                            </select>
                        </label>
                    </div>
                </div>
                
                <!-- Health Status Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
                    <!-- Airtable Health -->
                    <div class="bg-white rounded-lg p-4 border">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span id="hAirtDot" class="dot"></span>
                                <h4 class="text-sm font-medium">Airtable</h4>
                            </div>
                            <button class="text-gray-400 hover:text-gray-600" id="btnShowHealth"><i class="fa-regular fa-eye text-xs"></i></button>
                        </div>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div class="flex justify-between"><span>Auth</span><span class="mono" id="hAirtAuth">—</span></div>
                            <div class="flex justify-between"><span>Latency</span><span class="mono" id="hAirtLatency">—</span></div>
                        </div>
                        <pre id="hAirtRaw" class="mt-2 hidden bg-gray-50 p-2 rounded text-xs overflow-auto max-h-32 mono"></pre>
                    </div>

                    <!-- Data Parity -->
                    <div class="bg-white rounded-lg p-4 border">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span id="parDot" class="dot"></span>
                                <h4 class="text-sm font-medium">Data Parity</h4>
                            </div>
                            <button class="text-gray-400 hover:text-gray-600" id="btnParity"><i class="fa-solid fa-scale-balanced text-xs"></i></button>
                        </div>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div class="flex justify-between"><span>Records</span><span class="mono" id="parCounts">—</span></div>
                            <div class="flex justify-between"><span>Orphans</span><span class="mono" id="parOrphans">—</span></div>
                        </div>
                        <pre id="parRaw" class="mt-2 hidden bg-gray-50 p-2 rounded text-xs overflow-auto max-h-32 mono"></pre>
                    </div>

                    <!-- Sync Status -->
                    <div class="bg-white rounded-lg p-4 border">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span id="syncDot" class="dot"></span>
                                <h4 class="text-sm font-medium">Sync</h4>
                            </div>
                            <button class="text-gray-400 hover:text-gray-600" id="btnSync"><i class="fa-solid fa-arrows-rotate text-xs"></i></button>
                        </div>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div class="flex justify-between"><span>Status</span><span class="mono" id="syncResult">—</span></div>
                        </div>
                        <pre id="syncRaw" class="mt-2 hidden bg-gray-50 p-2 rounded text-xs overflow-auto max-h-32 mono"></pre>
                    </div>

                    <!-- Performance -->
                    <div class="bg-white rounded-lg p-4 border">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span id="perfDot" class="dot"></span>
                                <h4 class="text-sm font-medium">Performance</h4>
                            </div>
                            <button class="text-gray-400 hover:text-gray-600" id="btnPerf"><i class="fa-solid fa-chart-line text-xs"></i></button>
                        </div>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div class="flex justify-between"><span>Avg (ms)</span><span class="mono" id="perfAvg">—</span></div>
                            <div class="flex justify-between"><span>Success</span><span class="mono" id="perfSuccess">—</span></div>
                        </div>
                        <div class="mt-2">
                            <div class="text-xs text-gray-500 mb-1">Recent:</div>
                            <div id="perfChart" class="h-8 bg-gray-50 rounded border flex items-end gap-1 p-1">
                                <!-- Mini chart bars will be inserted here -->
                            </div>
                        </div>
                        <pre id="perfRaw" class="mt-2 hidden bg-gray-50 p-2 rounded text-xs overflow-auto max-h-32 mono"></pre>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="flex items-center justify-between text-sm text-gray-600">
                    <div>
                        <span>Последнее обновление: </span><span id="lastUpdate" class="mono">—</span>
                    </div>
                    <div class="flex gap-2">
                        <a href="health-dashboard.html" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Полный дашборд</a>
                        <button id="btnQuickFix" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">🔧 Quick Fix</button>
                    </div>
                </div>
            </div>

            <!-- Таблица API и события -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-panel p-6 rounded-lg">
                    <h3 class="text-lg font-light text-gray-800 mb-4"><i class="fas fa-server mr-2 text-indigo-600"></i>Статус API сервисов</h3>
                    <div class="space-y-3" id="api-status-list">
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg" data-provider="airtable"><div class="flex items-center"><div class="w-2 h-2 rounded-full mr-2 bg-gray-300" data-dot></div><span class="text-sm font-medium">Airtable</span></div><span class="text-xs text-gray-500" data-text>—</span></div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg" data-provider="openai"><div class="flex items-center"><div class="w-2 h-2 rounded-full mr-2 bg-gray-300" data-dot></div><span class="text-sm font-medium">OpenAI</span></div><span class="text-xs text-gray-500" data-text>—</span></div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg" data-provider="gsheets"><div class="flex items-center"><div class="w-2 h-2 rounded-full mr-2 bg-gray-300" data-dot></div><span class="text-sm font-medium">Google Sheets</span></div><span class="text-xs text-gray-500" data-text>—</span></div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg" data-provider="gmaps"><div class="flex items-center"><div class="w-2 h-2 rounded-full mr-2 bg-gray-300" data-dot></div><span class="text-sm font-medium">Google Maps</span></div><span class="text-xs text-gray-500" data-text>—</span></div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg" data-provider="recaptcha"><div class="flex items-center"><div class="w-2 h-2 rounded-full mr-2 bg-gray-300" data-dot></div><span class="text-sm font-medium">reCAPTCHA</span></div><span class="text-xs text-gray-500" data-text>—</span></div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg" data-provider="brilliantdirectory"><div class="flex items-center"><div class="w-2 h-2 rounded-full mr-2 bg-gray-300" data-dot></div><span class="text-sm font-medium">Brilliant Directory</span></div><span class="text-xs text-gray-500" data-text>—</span></div>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-lg">
                    <h3 class="text-lg font-light text-gray-800 mb-4"><i class="fas fa-bell mr-2 text-yellow-600"></i>Системные события</h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        <div class="flex items-start space-x-3 p-3 bg-white rounded-lg"><div class="w-2 h-2 bg-green-500 rounded-full mt-2"></div><div class="flex-1"><p class="text-sm font-medium">Новый гид зарегистрирован</p><p class="text-xs text-gray-500">5 минут назад</p></div></div>
                        <div class="flex items-start space-x-3 p-3 bg-white rounded-lg"><div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div><div class="flex-1"><p class="text-sm font-medium">API обновлен до v2.1.0</p><p class="text-xs text-gray-500">15 минут назад</p></div></div>
                        <div class="flex items-start space-x-3 p-3 bg-white rounded-lg"><div class="w-2 h-2 bg-yellow-500 rounded-full mt-2"></div><div class="flex-1"><p class="text-sm font-medium">AI лимит на 80%</p><p class="text-xs text-gray-500">2 часа назад</p></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Quick Fix Modal -->
    <div id="quickFixModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">🔧 Quick Fix - Airtable Token</h3>
                <button id="closeQuickFix" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium text-yellow-800">Проблема обнаружена</h4>
                            <p class="text-sm text-yellow-700 mt-1">
                                Airtable токен отсутствует или недействителен. Введите новый PAT токен для восстановления работы.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Airtable PAT Token</label>
                        <input 
                            type="password" 
                            id="quickFixToken" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="patYOUR_TOKEN_HERE"
                        />
                        <p class="text-xs text-gray-500 mt-1">Введите ваш Airtable Personal Access Token</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Admin Token</label>
                        <input 
                            type="password" 
                            id="quickFixAdminToken" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Ваш админ токен"
                        />
                        <p class="text-xs text-gray-500 mt-1">Требуется для авторизации операции</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Слот для сохранения</label>
                        <select id="quickFixSlot" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="current">Current (активный)</option>
                            <option value="next">Next (резервный)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-500">
                    <span id="quickFixStatus">Готов к установке</span>
                </div>
                <div class="flex gap-2">
                    <button id="cancelQuickFix" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                        Отмена
                    </button>
                    <button id="applyQuickFix" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
                        <i class="fas fa-wrench mr-1"></i>Исправить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/admin-auth.js?v=20250923-errlog1"></script>
    <script src="../js/admin-dashboard.js?v=20250923-errlog1"></script>
    
    <!-- Health Dashboard Script -->
    <script>
    (function(){
      const $ = sel => document.querySelector(sel);
      const autoKey = 'kt_health_auto_ms';
      const perfKey = 'kt_health_perf_history';
      const setDot = (el, cls) => { el.classList.remove('ok','err','warn'); el.classList.add(cls); };
      const fmt = v => typeof v==='number' ? v.toString() : (v ?? '—');
      const now = () => new Date().toLocaleString('ru-RU', {
        year: 'numeric',
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZone: 'Asia/Tokyo'
      });
      
      // Performance tracking
      let performanceHistory = JSON.parse(localStorage.getItem(perfKey) || '[]');
      const maxHistoryLength = 20;

      function saveAuto(ms){ localStorage.setItem(autoKey, String(ms)); }
      function loadAuto(){ return parseInt(localStorage.getItem(autoKey)||'0',10); }

      async function fetchJson(u, opts={}){
        try {
          const r = await fetch(u, Object.assign({ cache:'no-store' }, opts));
          const txt = await r.text();
          try{ return { status:r.status, json: JSON.parse(txt), raw: txt }; }
          catch{ return { status:r.status, json:null, raw: txt }; }
        } catch (e) {
          return { status: 0, json: null, raw: `Network error: ${e.message}` };
        }
      }

      async function runHealth(){
        const dot = $('#hAirtDot'); 
        console.log('🔍 runHealth: Starting...', dot);
        if (!dot) {
          console.error('❌ runHealth: hAirtDot element not found!');
          return;
        }
        setDot(dot,'warn');
        console.log('🔍 runHealth: Making API request to health-airtable.php...');
        const out = await fetchJson('../api/health-airtable.php');
        console.log('🔍 runHealth: API response:', out);
        $('#hAirtRaw').textContent = out.raw || '';
        const j = out.json || {};
        const ok = !!j.ok;
        console.log('🔍 runHealth: ok =', ok, 'j =', j);
        setDot(dot, ok?'ok':'err');
        const auth = j.auth ? `${j.auth.current? 'current✔' : 'current✖'} / ${j.auth.next? 'next✔':'next✖'}` : '—';
        $('#hAirtAuth').textContent = auth;
        const lat = j.latency_ms != null ? j.latency_ms : (j.metrics && j.metrics.latency_ms);
        $('#hAirtLatency').textContent = fmt(lat);
        console.log('🔍 runHealth: Final dot classes:', dot.className);
      }

      async function runParity(){
        const dot = $('#parDot'); 
        console.log('🔍 runParity: Starting...', dot);
        setDot(dot,'warn');
        console.log('🔍 runParity: Making API request to data-parity.php...');
        const out = await fetchJson('../api/data-parity.php');
        $('#parRaw').textContent = out.raw || '';
        const j = out.json || {};
        const ok = !!j.ok;
        let warn = false;
        if (j.orphans){
          const sum = (j.orphans.city_orphans||0)+(j.orphans.poi_city_orphans||0)+(j.orphans.poi_region_orphans||0);
          warn = sum>0;
        }
        setDot(dot, ok ? (warn?'warn':'ok') : 'err');
        const counts = j.sqlite_counts ? `${j.sqlite_counts.regions ?? '—'}/${j.sqlite_counts.cities ?? '—'}/${j.sqlite_counts.pois ?? '—'}` : '—';
        $('#parCounts').textContent = counts;
        const orph = j.orphans ? `c:${j.orphans.city_orphans||0} • poi→city:${j.orphans.poi_city_orphans||0} • poi→region:${j.orphans.poi_region_orphans||0}` : '—';
        $('#parOrphans').textContent = orph;
      }

      async function runSyncProbe(){
        const dot = $('#syncDot'); 
        console.log('🔍 runSyncProbe: Starting...', dot);
        setDot(dot,'warn');
        console.log('🔍 runSyncProbe: Making API request to cron-sync.php...');
        const out = await fetchJson('../api/cron-sync.php');
        $('#syncRaw').textContent = out.raw || '';
        const j = out.json || {};
        const ok = !!j.ok;
        setDot(dot, ok?'ok':'err');
        const s = ok ? `regions:${j.regions ?? '—'} cities:${j.cities ?? '—'} pois:${j.pois ?? '—'}` : (j.error || j.message || `HTTP ${out.status}`);
        $('#syncResult').textContent = s;
      }

      async function runPerformance(){
        const dot = $('#perfDot'); 
        console.log('🔍 runPerformance: Starting...', dot);
        setDot(dot,'warn');
        const startTime = performance.now();
        
        // Run a quick whoami test for performance measurement
        console.log('🔍 runPerformance: Making API request to test-proxy-secure.php...');
        const out = await fetchJson('../api/test-proxy-secure.php?provider=airtable',{
          method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ whoami:true })
        });
        
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);
        
        // Add to performance history
        const success = !!(out.json?.ok && (out.json?.auth === true || out.json?.auth === undefined));
        performanceHistory.push({
          timestamp: Date.now(),
          responseTime: responseTime,
          success: success,
          status: out.status
        });
        
        // Keep only last N entries
        if (performanceHistory.length > maxHistoryLength) {
          performanceHistory = performanceHistory.slice(-maxHistoryLength);
        }
        
        // Save to localStorage
        localStorage.setItem(perfKey, JSON.stringify(performanceHistory));
        
        $('#perfRaw').textContent = JSON.stringify(performanceHistory.slice(-5), null, 2);
        
        // Calculate metrics
        const recent = performanceHistory.slice(-10);
        const avgResponse = recent.length > 0 ? Math.round(recent.reduce((sum, entry) => sum + entry.responseTime, 0) / recent.length) : 0;
        const successRate = recent.length > 0 ? Math.round((recent.filter(entry => entry.success).length / recent.length) * 100) : 0;
        
        setDot(dot, successRate >= 90 ? 'ok' : (successRate >= 70 ? 'warn' : 'err'));
        
        $('#perfAvg').textContent = avgResponse;
        $('#perfSuccess').textContent = `${successRate}%`;
        
        // Update mini chart
        updatePerformanceChart();
      }

      function updatePerformanceChart(){
        const chart = $('#perfChart');
        chart.innerHTML = '';
        
        const recent = performanceHistory.slice(-10);
        if (recent.length === 0) return;
        
        const maxTime = Math.max(100, ...recent.map(entry => entry.responseTime || 0));
        
        recent.forEach(entry => {
          const height = Math.round(((entry.responseTime || 0) / maxTime) * 100);
          const color = entry.success ? '#10b981' : '#ef4444';
          const bar = document.createElement('div');
          bar.style.height = `${height}%`;
          bar.style.backgroundColor = color;
          bar.style.flex = '1';
          bar.style.borderRadius = '2px';
          bar.style.minHeight = '4px';
          bar.title = `${entry.responseTime || 0}ms (${entry.success ? 'OK' : 'FAIL'})`;
          chart.appendChild(bar);
        });
      }

      async function runAll(){
        console.log('🔄 Health Dashboard widget: Starting refresh...');
        try {
          const results = await Promise.allSettled([runHealth(), runParity(), runSyncProbe(), runPerformance()]);
          console.log('🔍 runAll: Promise.allSettled completed, results:', results);
          results.forEach((result, index) => {
            if (result.status === 'rejected') {
              console.error(`❌ Health widget error in function ${index}:`, result.reason);
            } else {
              console.log(`✅ Health widget function ${index} completed successfully`);
            }
          });
          $('#lastUpdate').textContent = now();
          console.log('✅ Health Dashboard widget: Refresh completed');
        } catch (e) {
          console.error('❌ runAll: Critical error:', e);
        }
      }

      // rotateToken function removed - token rotation not needed

      // Quick Fix functionality
      function showQuickFixModal() {
        $('#quickFixModal').classList.remove('hidden');
        $('#quickFixToken').focus();
      }

      function hideQuickFixModal() {
        $('#quickFixModal').classList.add('hidden');
        $('#quickFixToken').value = '';
        $('#quickFixAdminToken').value = '';
        $('#quickFixSlot').value = 'current';
        $('#quickFixStatus').textContent = 'Готов к установке';
      }

      async function applyQuickFix() {
        const token = $('#quickFixToken').value.trim();
        const adminToken = $('#quickFixAdminToken').value.trim();
        const slot = $('#quickFixSlot').value;
        
        if (!token || !adminToken) {
          $('#quickFixStatus').textContent = 'Заполните все поля';
          return;
        }
        
        if (!token.match(/^pat\.[A-Za-z0-9_\-]{20,}$/)) {
          $('#quickFixStatus').textContent = 'Неверный формат PAT токена';
          return;
        }
        
        $('#quickFixStatus').textContent = 'Проверяем токен...';
        $('#applyQuickFix').disabled = true;
        
        try {
          const out = await fetchJson('../api/set-token-api.php', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'X-Admin-Token': adminToken
            },
            body: JSON.stringify({ token: token, slot: slot })
          });
          
          if (out.json?.ok) {
            $('#quickFixStatus').textContent = '✅ Токен установлен успешно!';
            setTimeout(() => {
              hideQuickFixModal();
              runAll(); // Refresh dashboard
            }, 1500);
          } else {
            $('#quickFixStatus').textContent = '❌ Ошибка: ' + (out.json?.error || 'Unknown error');
          }
        } catch (e) {
          $('#quickFixStatus').textContent = '❌ Ошибка: ' + e.message;
        } finally {
          $('#applyQuickFix').disabled = false;
        }
      }

      // UI bindings
      $('#btnRefreshHealth').addEventListener('click', runAll);
      $('#btnShowHealth').addEventListener('click', ()=> $('#hAirtRaw').classList.toggle('hidden'));
      $('#btnParity').addEventListener('click', ()=> $('#parRaw').classList.toggle('hidden'));
      $('#btnSync').addEventListener('click', ()=> $('#syncRaw').classList.toggle('hidden'));
      $('#btnPerf').addEventListener('click', ()=> $('#perfRaw').classList.toggle('hidden'));
      // btnTokenRotate event listener removed
      $('#btnQuickFix').addEventListener('click', showQuickFixModal);
      $('#closeQuickFix').addEventListener('click', hideQuickFixModal);
      $('#cancelQuickFix').addEventListener('click', hideQuickFixModal);
      $('#applyQuickFix').addEventListener('click', applyQuickFix);
      $('#autoRefreshHealth').addEventListener('change', (e)=>{ const ms = parseInt(e.target.value,10)||0; saveAuto(ms); schedule(ms); });

      // Quick Fix modal keyboard shortcuts
      $('#quickFixModal').addEventListener('keydown', (e) => {
        if (e.key === 'Escape') hideQuickFixModal();
        if (e.key === 'Enter' && e.ctrlKey) applyQuickFix();
      });

      // auto-refresh machinery
      let timer = null;
      function schedule(ms){ if (timer){ clearInterval(timer); timer=null; } if (ms>0){ timer = setInterval(runAll, ms); } }

      // init
      console.log('🚀 Health Dashboard widget: Initializing...');
      
      // Проверяем доступность элементов
      const elements = ['hAirtDot', 'parDot', 'syncDot', 'perfDot'];
      elements.forEach(id => {
        const el = $(`#${id}`);
        console.log(`🔍 Element #${id}:`, el ? 'Found' : 'NOT FOUND', el);
      });
      
      const ms0 = loadAuto();
      if (ms0>0) $('#autoRefreshHealth').value = String(ms0);
      schedule(ms0);
      console.log('🚀 Health Dashboard widget: Starting runAll()...');
      runAll();
    })();
    </script>
</body>
</html>

