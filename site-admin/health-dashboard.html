<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Konstructour ‚Äî Health Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root { --ok:#10b981; --err:#ef4444; --warn:#f59e0b; --muted:#9ca3af; }
    .dot{ width:10px; height:10px; border-radius:9999px; display:inline-block; background:var(--muted);} 
    .dot.ok{ background:var(--ok);} .dot.err{ background:var(--err);} .dot.warn{ background:var(--warn);} 
    .spin{ border:2px solid #a78bfa; border-top-color:transparent; border-radius:9999px; width:12px; height:12px; animation:spin .9s linear infinite; display:inline-block; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
    .card{
      background:#fff;
      border-radius:0.75rem;            /* ~rounded-xl */
      box-shadow:0 1px 2px rgba(0,0,0,.05), 0 1px 1px rgba(0,0,0,.03); /* ~shadow */
      padding:1.25rem;                  /* ~p-5 */
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .kbd{
      padding:0.125rem 0.375rem;        /* px-1.5 py-0.5 */
      border-radius:0.25rem;
      background:#f3f4f6;               /* gray-100 */
      border:1px solid #e5e7eb;         /* gray-200 */
      font-size:0.75rem;                /* text-xs */
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-light text-gray-800">Konstructour ‚Äî Health Dashboard</h1>
        <p class="text-sm text-gray-500">–ù–∞–≥–ª—è–¥–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</p>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <button id="btnRefresh" class="px-3 py-2 rounded-lg bg-gray-900 text-white hover:bg-black"><i class="fa-solid fa-rotate"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
        <label class="ml-3 text-gray-600">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
          <select id="autoRefresh" class="ml-2 border rounded px-2 py-1">
            <option value="0">–í—ã–∫–ª</option>
            <option value="15000">15 —Å–µ–∫</option>
            <option value="30000">30 —Å–µ–∫</option>
            <option value="60000">1 –º–∏–Ω</option>
            <option value="300000">5 –º–∏–Ω</option>
          </select>
        </label>
      </div>
    </header>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ -->
    <section class="card">
      <div class="flex flex-wrap items-end gap-3">
        <div class="flex-1" style="min-width:260px">
          <label class="block text-sm text-gray-600 mb-1">–ë–∞–∑–æ–≤—ã–π URL API</label>
          <input id="baseUrl" class="w-full border rounded px-3 py-2" placeholder="https://api.konstructour.com" />
          <p class="text-xs text-gray-500 mt-1">–•—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏.</p>
        </div>
        <div>
          <button id="btnSaveBase" class="px-3 py-2 rounded bg-white border hover:bg-gray-50">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
        </div>
        <div class="ml-auto text-sm text-gray-500">
          <span>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: </span><span id="lastUpdate" class="mono">‚Äî</span>
        </div>
      </div>
    </section>

    <!-- –°—Ç–∞—Ç—É—Å—ã -->
    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
      <!-- Airtable Health -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="hAirtDot" class="dot"></span><h2 class="text-lg font-medium">Airtable Health</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnShowHealth"><i class="fa-regular fa-eye"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Auth (current/next)</span><span class="mono" id="hAirtAuth">‚Äî</span></div>
          <div class="flex justify-between"><span>Latency (ms)</span><span class="mono" id="hAirtLatency">‚Äî</span></div>
          <div class="flex justify-between"><span>Message</span><span class="mono truncate" style="max-width:60%;display:inline-block" id="hAirtMsg">‚Äî</span></div>
        </div>
        <pre id="hAirtRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- WhoAmI via Proxy -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="whoDot" class="dot"></span><h2 class="text-lg font-medium">Proxy WhoAmI</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnWho"><i class="fa-solid fa-person-circle-check"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Auth</span><span class="mono" id="whoAuth">‚Äî</span></div>
          <div class="flex justify-between"><span>Status</span><span class="mono" id="whoStatus">‚Äî</span></div>
        </div>
        <pre id="whoRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- Data Parity -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="parDot" class="dot"></span><h2 class="text-lg font-medium">Data Parity</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnParity"><i class="fa-solid fa-scale-balanced"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Regions / Cities / POI</span><span class="mono" id="parCounts">‚Äî</span></div>
          <div class="flex justify-between"><span>Orphans</span><span class="mono" id="parOrphans">‚Äî</span></div>
        </div>
        <pre id="parRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- Sync Probe -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="syncDot" class="dot"></span><h2 class="text-lg font-medium">Sync Probe</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnSync"><i class="fa-solid fa-arrows-rotate"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Last result</span><span class="mono" id="syncResult">‚Äî</span></div>
        </div>
        <pre id="syncRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- Airtable Token Status -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="airtableTokenDot" class="dot"></span><h2 class="text-lg font-medium">Airtable Token Status</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnAirtableTokenInfo"><i class="fa-solid fa-shield-alt"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Token Source</span><span class="mono" id="airtableTokenSource">‚Äî</span></div>
          <div class="flex justify-between"><span>Token Status</span><span class="mono" id="airtableTokenStatus">‚Äî</span></div>
          <div class="flex justify-between"><span>Last Check</span><span class="mono" id="airtableTokenLastCheck">‚Äî</span></div>
          <div class="flex justify-between"><span>Response Time</span><span class="mono" id="airtableTokenResponseTime">‚Äî</span></div>
        </div>
        <div class="text-xs text-gray-500 mt-2"><span class="mono" id="airtableTokenMsg">‚Äî</span></div>
        <pre id="airtableTokenRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- Token Management -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="tokenDot" class="dot"></span><h2 class="text-lg font-medium">Token Management</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnTokenInfo"><i class="fa-solid fa-key"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Current Status</span><span class="mono" id="tokenCurrent">‚Äî</span></div>
          <div class="flex justify-between"><span>Next Available</span><span class="mono" id="tokenNext">‚Äî</span></div>
        </div>
        <div class="mt-3 flex gap-2">
          <button id="btnInitSecrets" class="px-3 py-1 text-xs bg-yellow-100 text-yellow-800 rounded hover:bg-yellow-200">
            Initialize Secrets
          </button>
          <button id="btnPromote" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 hidden">
            Promote Next
          </button>
          <button id="btnRotate" class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200">
            Rotate Token
          </button>
        </div>
        <div class="text-xs text-gray-500 mt-2"><span class="mono" id="tokenMsg">‚Äî</span></div>
        <pre id="tokenRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- Performance Metrics -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="perfDot" class="dot"></span><h2 class="text-lg font-medium">Performance</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnPerf"><i class="fa-solid fa-chart-line"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Avg Response (ms)</span><span class="mono" id="perfAvg">‚Äî</span></div>
          <div class="flex justify-between"><span>Success Rate</span><span class="mono" id="perfSuccess">‚Äî</span></div>
          <div class="flex justify-between"><span>Rate Limit Hits</span><span class="mono" id="perfRateLimit">‚Äî</span></div>
        </div>
        <div class="mt-3">
          <div class="text-xs text-gray-500 mb-1">Recent Performance (last 10 checks):</div>
          <div id="perfChart" class="h-16 bg-gray-50 rounded border flex items-end gap-1 p-2 overflow-hidden">
            <!-- Mini chart bars will be inserted here -->
          </div>
        </div>
        <pre id="perfRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- Logs hint -->
      <div class="card md:col-span-2 xl:col-span-1">
        <h2 class="text-lg font-medium mb-2">–ü–æ–¥—Å–∫–∞–∑–∫–∏</h2>
        <ul class="list-disc pl-5 text-gray-600 text-sm space-y-1">
          <li>–û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: –∏—â–∏—Ç–µ –º–µ—Ç–∫–∏ <span class="kbd">AIRT/AUTH fail 401</span> –≤ –ª–æ–≥–∞—Ö.</li>
          <li>–ü—Ä–æ–º–æ—É—à–Ω –∫–ª—é—á–∞: <span class="kbd">AIRT/PROMOTE next‚Üícurrent</span>.</li>
          <li>–õ–∏–º–∏—Ç—ã Airtable: <span class="kbd">429</span> + backoff. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ <span class="kbd">Retry-After</span>.</li>
        </ul>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-400 py-6">¬© Konstructour ¬∑ Health Dashboard</footer>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const baseKey = 'kt_health_base_url';
  const autoKey = 'kt_health_auto_ms';
  const perfKey = 'kt_health_perf_history';
  const getBase = () => {
    let v = ($('#baseUrl').value || '').trim().replace(/\/$/, '');
    if (v && !/^https?:\/\//i.test(v)) v = 'https://' + v;
    return v;
  };
  const url = path => (getBase() ? getBase()+path : path);
  const setDot = (el, cls) => { el.classList.remove('ok','err','warn'); el.classList.add(cls); };
  const fmt = v => typeof v==='number' ? v.toString() : (v ?? '‚Äî');
  const now = () => new Date().toLocaleString('ru-RU', {
    year: 'numeric',
    month: '2-digit', 
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    timeZone: 'Europe/Moscow'
  });
  
  // Performance tracking
  let performanceHistory = JSON.parse(localStorage.getItem(perfKey) || '[]');
  const maxHistoryLength = 20;

  function saveBase(){
    let v = getBase();
    if (v && !/^https?:\/\//i.test(v)) v = 'https://' + v; // ensure protocol
    localStorage.setItem(baseKey, v);
    $('#baseUrl').value = v;
  }
  function loadBase(){ const v = localStorage.getItem(baseKey) || 'https://www.konstructour.com'; $('#baseUrl').value = v; }
  function saveAuto(ms){ localStorage.setItem(autoKey, String(ms)); }
  function loadAuto(){ return parseInt(localStorage.getItem(autoKey)||'0',10); }

  async function fetchJson(u, opts={}){
    try{
      const r = await fetch(u, Object.assign({ cache:'no-store' }, opts));
      const txt = await r.text();
      try{ return { status:r.status, json: JSON.parse(txt), raw: txt }; }
      catch{ return { status:r.status, json:null, raw: txt }; }
    }catch(e){
      return { status:0, json:null, raw:String(e && e.message ? e.message : e) };
    }
  }

  async function runHealth(){
    const dot = $('#hAirtDot'); setDot(dot,'warn');
    const startTime = performance.now();
    const out = await fetchJson(url('/api/health-airtable.php'));
    const endTime = performance.now();
    const realLatency = Math.round(endTime - startTime);
    
    $('#hAirtRaw').textContent = out.raw || '';
    const j = out.json || {};
    const ok = !!j.ok;
    setDot(dot, ok?'ok':'err');
    
    // Enhanced auth display with state info
    let auth = '‚Äî';
    if (j.auth) {
      auth = `${j.auth.current? 'current‚úî' : 'current‚úñ'} / ${j.auth.next? 'next‚úî':'next‚úñ'}`;
    }
    if (j.state) {
      const state = j.state;
      if (state.php_user) auth += ` (${state.php_user})`;
      if (!state.file_exists) auth += ' [FILE MISSING]';
      else if (!state.file_readable) auth += ' [PERMISSION DENIED]';
    }
    $('#hAirtAuth').textContent = auth;
    
    // Show real latency, with server RTT as secondary info
    const serverLatency = j.latency_ms != null ? j.latency_ms : (j.metrics && j.metrics.latency_ms);
    const latencyText = serverLatency ? `${realLatency}ms (server: ${serverLatency}ms)` : `${realLatency}ms`;
    $('#hAirtLatency').textContent = latencyText;
    
    // Rate limit removed - not useful for this dashboard
    
    // Enhanced message with specific error handling
    let msg = j.message || j.error || j.reason || '';
    if (j.reason === 'file_missing') {
      msg = 'üî¥ –°–µ–∫—Ä–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ó–∞–ø—É—Å—Ç–∏—Ç–µ bootstrap_airtable_secret.sh';
    } else if (j.reason === 'permission_denied') {
      msg = 'üî¥ –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É —Å–µ–∫—Ä–µ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ chown/chmod';
    } else if (j.reason === 'token_missing') {
      msg = 'üî¥ –ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ñ–∞–π–ª–µ —Å–µ–∫—Ä–µ—Ç–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ PAT —á–µ—Ä–µ–∑ API';
    }
    
    const msgEl = $('#hAirtMsg');
    if (msgEl) msgEl.textContent = msg ? String(msg) : '‚Äî';
  }

  async function runWho(){
    const dot = $('#whoDot'); setDot(dot,'warn');
    const out = await fetchJson(url('/api/test-proxy-secure.php?provider=airtable'),{
      method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ whoami:true })
    });
    $('#whoRaw').textContent = out.raw || '';
    const j = out.json || {};
    const ok = !!(j.ok && j.auth);
    setDot(dot, ok?'ok':'err');
    $('#whoAuth').textContent = ok ? 'OK' : 'FAIL';
    $('#whoStatus').textContent = out.status;
    // Message field removed - not useful for this dashboard
  }

  async function runParity(){
    const dot = $('#parDot'); setDot(dot,'warn');
    const out = await fetchJson(url('/api/data-parity.php'));
    $('#parRaw').textContent = out.raw || '';
    const j = out.json || {};
    const ok = !!j.ok;

    // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–µ —Ñ–æ—Ä–º—ã: counts.sqlite.* –ò–õ–ò sqlite_counts.*
    const countsObj = (j.counts && j.counts.sqlite) ? j.counts.sqlite : (j.sqlite_counts || {});
    const orphansObj = j.orphans || j.sqlite_orphans || {};

    // –°—É–º–º–∏—Ä—É–µ–º —Å–∏—Ä–æ—Ç, —É—á–∏—Ç—ã–≤–∞—è –æ–±–∞ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ø–æ–ª–µ–π
    const sumOrphans =
      (orphansObj.city ?? orphansObj.city_orphans ?? 0) +
      (orphansObj.poi_city ?? orphansObj.poi_city_orphans ?? 0) +
      (orphansObj.poi_region ?? orphansObj.poi_region_orphans ?? 0);

    setDot(dot, ok ? (sumOrphans > 0 ? 'warn' : 'ok') : 'err');

    const counts = countsObj
      ? `${countsObj.regions ?? '‚Äî'}/${countsObj.cities ?? '‚Äî'}/${countsObj.pois ?? '‚Äî'}`
      : '‚Äî';
    $('#parCounts').textContent = counts;

    const orphText = `c:${(orphansObj.city ?? orphansObj.city_orphans) || 0} ‚Ä¢ ` +
                     `poi‚Üícity:${(orphansObj.poi_city ?? orphansObj.poi_city_orphans) || 0} ‚Ä¢ ` +
                     `poi‚Üíregion:${(orphansObj.poi_region ?? orphansObj.poi_region_orphans) || 0}`;
    $('#parOrphans').textContent = ok ? orphText : '‚Äî';
  }

  async function runSyncProbe(){
    const dot = $('#syncDot'); setDot(dot,'warn');
    const out = await fetchJson(url('/api/cron-sync.php'));
    $('#syncRaw').textContent = out.raw || '';
    const j = out.json || {};
    const ok = !!j.ok;
    setDot(dot, ok?'ok':'err');
    const s = ok ? `regions:${j.regions ?? '‚Äî'} cities:${j.cities ?? '‚Äî'} pois:${j.pois ?? '‚Äî'}` : (j.error || `HTTP ${out.status}`);
    $('#syncResult').textContent = s;
  }

  async function runTokenManagement(){
    const dot = $('#tokenDot'); setDot(dot,'warn');
    const out = await fetchJson(url('/api/health-airtable.php'));
    $('#tokenRaw').textContent = out.raw || '';
    const j = out.json || {};
    const ok = !!j.ok;
    setDot(dot, ok?'ok':'err');
    
    const current = j.auth?.current ? 'Active' : 'Inactive';
    const next = j.auth?.next ? 'Available' : 'None';
    
    $('#tokenCurrent').textContent = current;
    $('#tokenNext').textContent = next;
    
    // Show promote button if next is available
    const promoteBtn = $('#btnPromote');
    if (j.auth?.next && !j.auth?.current) {
      promoteBtn.classList.remove('hidden');
    } else {
      promoteBtn.classList.add('hidden');
    }
    
    // If just promoted, refresh other cards
    if (j.reason === 'next_promoted') {
      await runWho();
      await runHealth();
    }
    
    // Update rotate button state (traffic light) - hide if no next token
    const rotateBtn = $('#btnRotate');
    if (j.auth?.next) {
      rotateBtn.className = 'px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200';
      rotateBtn.textContent = 'Rotate Token (Next Available)';
      rotateBtn.style.display = 'inline-block';
      rotateBtn.disabled = false;
    } else {
      // Hide button completely when no next token
      rotateBtn.style.display = 'none';
    }
    const tmsg = j.message || j.error || j.reason || '';
    const tmsgEl = $('#tokenMsg');
    if (tmsgEl) tmsgEl.textContent = tmsg ? String(tmsg) : '‚Äî';
  }

  async function runPerformance(){
    const dot = $('#perfDot'); setDot(dot,'warn');
    const startTime = performance.now();
    
    // Run a quick whoami test for performance measurement
    const out = await fetchJson(url('/api/test-proxy-secure.php?provider=airtable'),{
      method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ whoami:true })
    });
    
    const endTime = performance.now();
    const responseTime = Math.round(endTime - startTime);
    
    // Add to performance history
    const j = out.json || {};
    const success = !!(j.ok && (j.auth === true || j.auth === undefined));
    performanceHistory.push({
      timestamp: Date.now(),
      responseTime: responseTime,
      success,
      status: out.status
    });
    
    // Keep only last N entries
    if (performanceHistory.length > maxHistoryLength) {
      performanceHistory = performanceHistory.slice(-maxHistoryLength);
    }
    
    // Save to localStorage
    localStorage.setItem(perfKey, JSON.stringify(performanceHistory));
    
    $('#perfRaw').textContent = JSON.stringify(performanceHistory.slice(-5), null, 2);
    
    // Calculate metrics
    const recent = performanceHistory.slice(-10);
    const avgResponse = recent.length > 0 ? Math.round(recent.reduce((sum, entry) => sum + entry.responseTime, 0) / recent.length) : 0;
    const successRate = recent.length > 0 ? Math.round((recent.filter(entry => entry.success).length / recent.length) * 100) : 0;
    const rateLimitHits = recent.filter(entry => entry.status === 429).length;
    
    setDot(dot, successRate >= 90 ? 'ok' : (successRate >= 70 ? 'warn' : 'err'));
    
    $('#perfAvg').textContent = avgResponse;
    $('#perfSuccess').textContent = `${successRate}%`;
    $('#perfRateLimit').textContent = rateLimitHits;
    
    // Update mini chart
    updatePerformanceChart();
  }

  function updatePerformanceChart(){
    const chart = $('#perfChart');
    chart.innerHTML = '';
    const recent = performanceHistory.slice(-10);
    if (recent.length === 0) return;
    const maxTime = Math.max(100, ...recent.map(e => e.responseTime || 0));
    recent.forEach(entry => {
      const height = Math.round(((entry.responseTime || 0) / maxTime) * 100);
      const bar = document.createElement('div');
      bar.style.height = `${height}%`;
      bar.style.backgroundColor = entry.success ? '#10b981' : '#ef4444';
      bar.style.flex = '1';
      bar.style.borderRadius = '2px';
      bar.style.minHeight = '4px';
      bar.title = `${entry.responseTime ?? 0}ms (${entry.success ? 'OK' : 'FAIL'})`;
      chart.appendChild(bar);
    });
  }

  // Airtable Token Status check
  async function runAirtableToken(){
    const dot = $('#airtableTokenDot');
    const source = $('#airtableTokenSource');
    const status = $('#airtableTokenStatus');
    const lastCheck = $('#airtableTokenLastCheck');
    const responseTime = $('#airtableTokenResponseTime');
    const msg = $('#airtableTokenMsg');
    const raw = $('#airtableTokenRaw');
    
    if (dot) dot.classList.remove('ok', 'err', 'warn');
    if (dot) dot.classList.add('loading');
    
    try {
      const startTime = Date.now();
      const out = await fetchJson(url('/api/health-airtable.php'));
      const elapsed = Date.now() - startTime;
      
      if (out.json) {
        const j = out.json;
        const hasToken = !!(j.state && j.state.token_current_present);
        const isWorking = !!(j.ok);
        
        // Update dot
        if (dot) {
          dot.classList.remove('loading');
          if (isWorking) {
            dot.classList.add('ok');
          } else if (hasToken) {
            dot.classList.add('warn');
          } else {
            dot.classList.add('err');
          }
        }
        
        // Update fields
        if (source) source.textContent = hasToken ? 'GitHub Secrets' : 'Not Found';
        if (status) status.textContent = isWorking ? 'Active' : (hasToken ? 'Invalid' : 'Missing');
        if (lastCheck) lastCheck.textContent = now();
        if (responseTime) responseTime.textContent = `${elapsed}ms`;
        
        // Update message
        if (msg) {
          if (isWorking) {
            msg.textContent = 'Token is working correctly';
          } else if (hasToken) {
            msg.textContent = j.message || 'Token exists but authentication failed';
          } else {
            msg.textContent = j.message || 'No token configured';
          }
        }
        
        // Show raw data
        if (raw) {
          raw.textContent = JSON.stringify(j, null, 2);
          raw.classList.toggle('hidden', false);
        }
      } else {
        // Error case
        if (dot) {
          dot.classList.remove('loading');
          dot.classList.add('err');
        }
        if (source) source.textContent = 'Error';
        if (status) status.textContent = 'Failed';
        if (lastCheck) lastCheck.textContent = now();
        if (responseTime) responseTime.textContent = `${elapsed}ms`;
        if (msg) msg.textContent = out.raw || 'Network error';
        if (raw) {
          raw.textContent = out.raw || 'No response';
          raw.classList.toggle('hidden', false);
        }
      }
    } catch (e) {
      if (dot) {
        dot.classList.remove('loading');
        dot.classList.add('err');
      }
      if (source) source.textContent = 'Error';
      if (status) status.textContent = 'Failed';
      if (lastCheck) lastCheck.textContent = now();
      if (responseTime) responseTime.textContent = '‚Äî';
      if (msg) msg.textContent = e.message || 'Unknown error';
      if (raw) {
        raw.textContent = e.message || 'Unknown error';
        raw.classList.toggle('hidden', false);
      }
    }
  }

  async function runAll(){
    await Promise.allSettled([runHealth(), runWho(), runParity(), runSyncProbe(), runAirtableToken(), runTokenManagement(), runPerformance()]);
    $('#lastUpdate').textContent = now();
  }

  // Initialize secrets function
  async function initSecrets(){
    try{
      const adminToken = prompt('–í–≤–µ–¥–∏—Ç–µ ADMIN token (X-Admin-Token) –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ–∫—Ä–µ—Ç–∞:');
      if (!adminToken) return;
      
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API
      let out = await fetchJson(url('/api/init-secrets.php'), {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'X-Admin-Token': adminToken },
        body: JSON.stringify({})
      });
      
      // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º force-create
      if (!out.json?.ok) {
        out = await fetchJson(url('/api/force-create-secrets.php'), {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'X-Admin-Token': adminToken },
          body: JSON.stringify({})
        });
      }
      
      alert('Init result: ' + (out.raw || JSON.stringify(out.json)));
      await runHealth();
      await runTokenManagement();
    }catch(e){
      alert('Init error: ' + (e?.message || e));
    }
  }

  // Token management functions
  async function promoteToken(){
    try {
      const out = await fetchJson(url('/api/health-airtable.php'));
      if (out.json?.auth?.next) {
        // Trigger promotion by making a whoami request
        await fetchJson(url('/api/test-proxy-secure.php?provider=airtable'),{
          method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ whoami:true })
        });
        runTokenManagement();
        alert('Token promoted successfully!');
      }
    } catch (e) {
      alert('Failed to promote token: ' + e.message);
    }
  }

  async function rotateToken(){
    const newToken = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π Airtable PAT (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "pat.") ‚Äî –æ–Ω –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ —Å–ª–æ—Ç NEXT:');
    if (!newToken) return;
    
    if (!newToken.match(/^pat\.[A-Za-z0-9_\-]{20,}$/)) {
      alert('Invalid PAT format. Must start with "pat." and be at least 20 characters.');
      return;
    }
    
    try {
      const adminToken = prompt('–í–≤–µ–¥–∏—Ç–µ ADMIN token –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Admin-Token):');
      if (!adminToken) return;
      
      const out = await fetchJson(url('/api/config-store-secure.php'), {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-Admin-Token': adminToken
        },
        body: JSON.stringify({ airtable: { api_key: newToken } })
      });
      
      if (out.json?.ok) {
        alert('Token saved to next slot successfully!');
        runTokenManagement();
      } else {
        alert('Failed to save token: ' + (out.json?.error || 'Unknown error'));
      }
    } catch (e) {
      alert('Failed to rotate token: ' + e.message);
    }
  }

  // UI bindings
  $('#btnRefresh').addEventListener('click', runAll);
  $('#btnShowHealth').addEventListener('click', ()=> $('#hAirtRaw').classList.toggle('hidden'));
  $('#btnWho').addEventListener('click', ()=> $('#whoRaw').classList.toggle('hidden'));
  $('#btnParity').addEventListener('click', ()=> $('#parRaw').classList.toggle('hidden'));
  $('#btnInitSecrets').addEventListener('click', initSecrets);
  $('#btnSync').addEventListener('click', ()=> $('#syncRaw').classList.toggle('hidden'));
  $('#btnAirtableTokenInfo').addEventListener('click', ()=> $('#airtableTokenRaw').classList.toggle('hidden'));
  $('#btnTokenInfo').addEventListener('click', ()=> $('#tokenRaw').classList.toggle('hidden'));
  $('#btnPerf').addEventListener('click', ()=> $('#perfRaw').classList.toggle('hidden'));
  $('#btnPromote').addEventListener('click', promoteToken);
  $('#btnRotate').addEventListener('click', rotateToken);
  $('#btnSaveBase').addEventListener('click', ()=>{ saveBase(); runAll(); });
  $('#autoRefresh').addEventListener('change', (e)=>{ const ms = parseInt(e.target.value,10)||0; saveAuto(ms); schedule(ms); });

  // auto-refresh machinery
  let timer = null;
  function schedule(ms){ if (timer){ clearInterval(timer); timer=null; } if (ms>0){ timer = setInterval(runAll, ms); } }

  // init
  loadBase();
  const ms0 = loadAuto();
  if (ms0>0) $('#autoRefresh').value = String(ms0);
  schedule(ms0);
  runAll();
})();
</script>
</body>
</html>
