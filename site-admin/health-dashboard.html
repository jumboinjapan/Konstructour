<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Konstructour — Health Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root { --ok:#10b981; --err:#ef4444; --warn:#f59e0b; --muted:#9ca3af; }
    .dot{ width:10px; height:10px; border-radius:9999px; display:inline-block; background:var(--muted);} 
    .dot.ok{ background:var(--ok);} .dot.err{ background:var(--err);} .dot.warn{ background:var(--warn);} 
    .spin{ border:2px solid #a78bfa; border-top-color:transparent; border-radius:9999px; width:12px; height:12px; animation:spin .9s linear infinite; display:inline-block; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
    .card{ @apply bg-white rounded-xl shadow p-5; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .kbd{ @apply px-1.5 py-0.5 rounded bg-gray-100 border text-xs; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-light text-gray-800">Konstructour — Health Dashboard</h1>
        <p class="text-sm text-gray-500">Наглядная диагностика интеграции и синхронизации</p>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <button id="btnRefresh" class="px-3 py-2 rounded-lg bg-gray-900 text-white hover:bg-black"><i class="fa-solid fa-rotate"></i> Обновить</button>
        <label class="ml-3 text-gray-600">Автообновление:
          <select id="autoRefresh" class="ml-2 border rounded px-2 py-1">
            <option value="0">Выкл</option>
            <option value="15000">15 сек</option>
            <option value="30000">30 сек</option>
            <option value="60000">1 мин</option>
            <option value="300000">5 мин</option>
          </select>
        </label>
      </div>
    </header>

    <!-- Настройки источника -->
    <section class="card">
      <div class="flex flex-wrap items-end gap-3">
        <div class="flex-1 min-w-[260px]">
          <label class="block text-sm text-gray-600 mb-1">Базовый URL API</label>
          <input id="baseUrl" class="w-full border rounded px-3 py-2" placeholder="https://api.konstructour.com" />
          <p class="text-xs text-gray-500 mt-1">Хранится локально в браузере. По умолчанию — относительные пути.</p>
        </div>
        <div>
          <button id="btnSaveBase" class="px-3 py-2 rounded bg-white border hover:bg-gray-50">Сохранить URL</button>
        </div>
        <div class="ml-auto text-sm text-gray-500">
          <span>Последнее обновление: </span><span id="lastUpdate" class="mono">—</span>
        </div>
      </div>
    </section>

    <!-- Статусы -->
    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
      <!-- Airtable Health -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="hAirtDot" class="dot"></span><h2 class="text-lg font-medium">Airtable Health</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnShowHealth"><i class="fa-regular fa-eye"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Auth (current/next)</span><span class="mono" id="hAirtAuth">—</span></div>
          <div class="flex justify-between"><span>Latency (ms)</span><span class="mono" id="hAirtLatency">—</span></div>
          <div class="flex justify-between"><span>Rate Limit</span><span class="mono" id="hAirtRate">—</span></div>
        </div>
        <pre id="hAirtRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- WhoAmI via Proxy -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="whoDot" class="dot"></span><h2 class="text-lg font-medium">Proxy WhoAmI</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnWho"><i class="fa-solid fa-person-circle-check"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Auth</span><span class="mono" id="whoAuth">—</span></div>
          <div class="flex justify-between"><span>Status</span><span class="mono" id="whoStatus">—</span></div>
        </div>
        <pre id="whoRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- Data Parity -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="parDot" class="dot"></span><h2 class="text-lg font-medium">Data Parity</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnParity"><i class="fa-solid fa-scale-balanced"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Regions / Cities / POI</span><span class="mono" id="parCounts">—</span></div>
          <div class="flex justify-between"><span>Orphans</span><span class="mono" id="parOrphans">—</span></div>
        </div>
        <pre id="parRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- Sync Probe -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="syncDot" class="dot"></span><h2 class="text-lg font-medium">Sync Probe</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnSync"><i class="fa-solid fa-arrows-rotate"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Last result</span><span class="mono" id="syncResult">—</span></div>
        </div>
        <pre id="syncRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- Token Management -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="tokenDot" class="dot"></span><h2 class="text-lg font-medium">Token Management</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnTokenInfo"><i class="fa-solid fa-key"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Current Status</span><span class="mono" id="tokenCurrent">—</span></div>
          <div class="flex justify-between"><span>Next Available</span><span class="mono" id="tokenNext">—</span></div>
          <div class="flex justify-between"><span>Last Promotion</span><span class="mono" id="tokenPromotion">—</span></div>
        </div>
        <div class="mt-3 flex gap-2">
          <button id="btnPromote" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 hidden">Promote Next</button>
          <button id="btnRotate" class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200">Rotate Token</button>
        </div>
        <pre id="tokenRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- Performance Metrics -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2"><span id="perfDot" class="dot"></span><h2 class="text-lg font-medium">Performance</h2></div>
          <button class="text-gray-500 hover:text-gray-700" id="btnPerf"><i class="fa-solid fa-chart-line"></i></button>
        </div>
        <div class="text-sm text-gray-600 space-y-2">
          <div class="flex justify-between"><span>Avg Response (ms)</span><span class="mono" id="perfAvg">—</span></div>
          <div class="flex justify-between"><span>Success Rate</span><span class="mono" id="perfSuccess">—</span></div>
          <div class="flex justify-between"><span>Rate Limit Hits</span><span class="mono" id="perfRateLimit">—</span></div>
        </div>
        <div class="mt-3">
          <div class="text-xs text-gray-500 mb-1">Recent Performance (last 10 checks):</div>
          <div id="perfChart" class="h-16 bg-gray-50 rounded border flex items-end gap-1 p-2">
            <!-- Mini chart bars will be inserted here -->
          </div>
        </div>
        <pre id="perfRaw" class="mt-3 hidden bg-gray-50 p-3 rounded border mono text-xs overflow-auto max-h-48"></pre>
      </div>

      <!-- Logs hint -->
      <div class="card md:col-span-2 xl:col-span-1">
        <h2 class="text-lg font-medium mb-2">Подсказки</h2>
        <ul class="list-disc pl-5 text-gray-600 text-sm space-y-1">
          <li>Ошибки авторизации: ищите метки <span class="kbd">AIRT/AUTH fail 401</span> в логах.</li>
          <li>Промоушн ключа: <span class="kbd">AIRT/PROMOTE next→current</span>.</li>
          <li>Лимиты Airtable: <span class="kbd">429</span> + backoff. Проверьте <span class="kbd">Retry-After</span>.</li>
          <li>Rate limiting: <span class="kbd">429</span> + backoff. Проверьте <span class="kbd">Retry-After</span>.</li>
        </ul>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-400 py-6">© Konstructour · Health Dashboard</footer>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const baseKey = 'kt_health_base_url';
  const autoKey = 'kt_health_auto_ms';
  const perfKey = 'kt_health_perf_history';
  const getBase = () => ($('#baseUrl').value || '').trim().replace(/\/$/, '');
  const url = path => (getBase() ? getBase()+path : path);
  const setDot = (el, cls) => { el.classList.remove('ok','err','warn'); el.classList.add(cls); };
  const fmt = v => typeof v==='number' ? v.toString() : (v ?? '—');
  const now = () => new Date().toLocaleString();
  
  // Performance tracking
  let performanceHistory = JSON.parse(localStorage.getItem(perfKey) || '[]');
  const maxHistoryLength = 20;

  function saveBase(){ localStorage.setItem(baseKey, getBase()); }
  function loadBase(){ const v = localStorage.getItem(baseKey) || ''; $('#baseUrl').value = v; }
  function saveAuto(ms){ localStorage.setItem(autoKey, String(ms)); }
  function loadAuto(){ return parseInt(localStorage.getItem(autoKey)||'0',10); }

  async function fetchJson(u, opts={}){
    const r = await fetch(u, Object.assign({ cache:'no-store' }, opts));
    const txt = await r.text();
    try{ return { status:r.status, json: JSON.parse(txt), raw: txt }; }
    catch{ return { status:r.status, json:null, raw: txt }; }
  }

  async function runHealth(){
    const dot = $('#hAirtDot'); setDot(dot,'warn');
    const out = await fetchJson(url('/api/health-airtable.php'));
    $('#hAirtRaw').textContent = out.raw || '';
    const j = out.json || {};
    const ok = !!j.ok;
    setDot(dot, ok?'ok':'err');
    const auth = j.auth ? `${j.auth.current? 'current✔' : 'current✖'} / ${j.auth.next? 'next✔':'next✖'}` : '—';
    $('#hAirtAuth').textContent = auth;
    const lat = j.latency_ms != null ? j.latency_ms : (j.metrics && j.metrics.latency_ms);
    $('#hAirtLatency').textContent = fmt(lat);
    const rate = j.rate ? `${j.rate.remaining ?? '—'} left` + (j.rate.reset_at? `, reset ${j.rate.reset_at}`:'' ) : '—';
    $('#hAirtRate').textContent = rate;
  }

  async function runWho(){
    const dot = $('#whoDot'); setDot(dot,'warn');
    const out = await fetchJson(url('/api/test-proxy-secure.php?provider=airtable'),{
      method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ whoami:true })
    });
    $('#whoRaw').textContent = out.raw || '';
    const j = out.json || {};
    const ok = !!(j.ok && j.auth);
    setDot(dot, ok?'ok':'err');
    $('#whoAuth').textContent = ok ? 'OK' : 'FAIL';
    $('#whoStatus').textContent = out.status;
  }

  async function runParity(){
    const dot = $('#parDot'); setDot(dot,'warn');
    const out = await fetchJson(url('/api/data-parity.php'));
    $('#parRaw').textContent = out.raw || '';
    const j = out.json || {};
    const ok = !!j.ok;
    let warn = false;
    if (j.orphans){
      const sum = (j.orphans.city_orphans||0)+(j.orphans.poi_city_orphans||0)+(j.orphans.poi_region_orphans||0);
      warn = sum>0;
    }
    setDot(dot, ok ? (warn?'warn':'ok') : 'err');
    const counts = j.sqlite_counts ? `${j.sqlite_counts.regions ?? '—'}/${j.sqlite_counts.cities ?? '—'}/${j.sqlite_counts.pois ?? '—'}` : '—';
    $('#parCounts').textContent = counts;
    const orph = j.orphans ? `c:${j.orphans.city_orphans||0} • poi→city:${j.orphans.poi_city_orphans||0} • poi→region:${j.orphans.poi_region_orphans||0}` : '—';
    $('#parOrphans').textContent = orph;
  }

  async function runSyncProbe(){
    const dot = $('#syncDot'); setDot(dot,'warn');
    const out = await fetchJson(url('/api/cron-sync.php'));
    $('#syncRaw').textContent = out.raw || '';
    const j = out.json || {};
    const ok = !!j.ok;
    setDot(dot, ok?'ok':'err');
    const s = ok ? `regions:${j.regions ?? '—'} cities:${j.cities ?? '—'} pois:${j.pois ?? '—'}` : (j.error || `HTTP ${out.status}`);
    $('#syncResult').textContent = s;
  }

  async function runTokenManagement(){
    const dot = $('#tokenDot'); setDot(dot,'warn');
    const out = await fetchJson(url('/api/health-airtable.php'));
    $('#tokenRaw').textContent = out.raw || '';
    const j = out.json || {};
    const ok = !!j.ok;
    setDot(dot, ok?'ok':'err');
    
    const current = j.auth?.current ? 'Active' : 'Inactive';
    const next = j.auth?.next ? 'Available' : 'None';
    const promotion = j.reason === 'next_promoted' ? 'Just promoted' : '—';
    
    $('#tokenCurrent').textContent = current;
    $('#tokenNext').textContent = next;
    $('#tokenPromotion').textContent = promotion;
    
    // Show promote button if next is available
    const promoteBtn = $('#btnPromote');
    if (j.auth?.next && !j.auth?.current) {
      promoteBtn.classList.remove('hidden');
    } else {
      promoteBtn.classList.add('hidden');
    }
  }

  async function runPerformance(){
    const dot = $('#perfDot'); setDot(dot,'warn');
    const startTime = performance.now();
    
    // Run a quick whoami test for performance measurement
    const out = await fetchJson(url('/api/test-proxy-secure.php?provider=airtable'),{
      method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ whoami:true })
    });
    
    const endTime = performance.now();
    const responseTime = Math.round(endTime - startTime);
    
    // Add to performance history
    performanceHistory.push({
      timestamp: Date.now(),
      responseTime: responseTime,
      success: out.json?.ok || false,
      status: out.status
    });
    
    // Keep only last N entries
    if (performanceHistory.length > maxHistoryLength) {
      performanceHistory = performanceHistory.slice(-maxHistoryLength);
    }
    
    // Save to localStorage
    localStorage.setItem(perfKey, JSON.stringify(performanceHistory));
    
    $('#perfRaw').textContent = JSON.stringify(performanceHistory.slice(-5), null, 2);
    
    // Calculate metrics
    const recent = performanceHistory.slice(-10);
    const avgResponse = recent.length > 0 ? Math.round(recent.reduce((sum, entry) => sum + entry.responseTime, 0) / recent.length) : 0;
    const successRate = recent.length > 0 ? Math.round((recent.filter(entry => entry.success).length / recent.length) * 100) : 0;
    const rateLimitHits = recent.filter(entry => entry.status === 429).length;
    
    setDot(dot, successRate >= 90 ? 'ok' : (successRate >= 70 ? 'warn' : 'err'));
    
    $('#perfAvg').textContent = avgResponse;
    $('#perfSuccess').textContent = `${successRate}%`;
    $('#perfRateLimit').textContent = rateLimitHits;
    
    // Update mini chart
    updatePerformanceChart();
  }

  function updatePerformanceChart(){
    const chart = $('#perfChart');
    chart.innerHTML = '';
    
    const recent = performanceHistory.slice(-10);
    const maxTime = Math.max(...recent.map(entry => entry.responseTime), 100);
    
    recent.forEach(entry => {
      const height = Math.round((entry.responseTime / maxTime) * 100);
      const color = entry.success ? '#10b981' : '#ef4444';
      const bar = document.createElement('div');
      bar.style.height = `${height}%`;
      bar.style.backgroundColor = color;
      bar.style.flex = '1';
      bar.style.borderRadius = '2px';
      bar.style.minHeight = '4px';
      bar.title = `${entry.responseTime}ms (${entry.success ? 'OK' : 'FAIL'})`;
      chart.appendChild(bar);
    });
  }

  async function runAll(){
    await Promise.allSettled([runHealth(), runWho(), runParity(), runSyncProbe(), runTokenManagement(), runPerformance()]);
    $('#lastUpdate').textContent = now();
  }

  // Token management functions
  async function promoteToken(){
    try {
      const out = await fetchJson(url('/api/health-airtable.php'));
      if (out.json?.auth?.next) {
        // Trigger promotion by making a whoami request
        await fetchJson(url('/api/test-proxy-secure.php?provider=airtable'),{
          method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ whoami:true })
        });
        runTokenManagement();
        alert('Token promoted successfully!');
      }
    } catch (e) {
      alert('Failed to promote token: ' + e.message);
    }
  }

  async function rotateToken(){
    const newToken = prompt('Enter new Airtable PAT token:');
    if (!newToken) return;
    
    if (!newToken.match(/^pat\.[A-Za-z0-9_\-]{20,}$/)) {
      alert('Invalid PAT format. Must start with "pat." and be at least 20 characters.');
      return;
    }
    
    try {
      const adminToken = prompt('Enter admin token:');
      if (!adminToken) return;
      
      const out = await fetchJson(url('/api/config-store-secure.php'), {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-Admin-Token': adminToken
        },
        body: JSON.stringify({ airtable: { api_key: newToken } })
      });
      
      if (out.json?.ok) {
        alert('Token saved to next slot successfully!');
        runTokenManagement();
      } else {
        alert('Failed to save token: ' + (out.json?.error || 'Unknown error'));
      }
    } catch (e) {
      alert('Failed to rotate token: ' + e.message);
    }
  }

  // UI bindings
  $('#btnRefresh').addEventListener('click', runAll);
  $('#btnShowHealth').addEventListener('click', ()=> $('#hAirtRaw').classList.toggle('hidden'));
  $('#btnWho').addEventListener('click', ()=> $('#whoRaw').classList.toggle('hidden'));
  $('#btnParity').addEventListener('click', ()=> $('#parRaw').classList.toggle('hidden'));
  $('#btnSync').addEventListener('click', ()=> $('#syncRaw').classList.toggle('hidden'));
  $('#btnTokenInfo').addEventListener('click', ()=> $('#tokenRaw').classList.toggle('hidden'));
  $('#btnPerf').addEventListener('click', ()=> $('#perfRaw').classList.toggle('hidden'));
  $('#btnPromote').addEventListener('click', promoteToken);
  $('#btnRotate').addEventListener('click', rotateToken);
  $('#btnSaveBase').addEventListener('click', ()=>{ saveBase(); runAll(); });
  $('#autoRefresh').addEventListener('change', (e)=>{ const ms = parseInt(e.target.value,10)||0; saveAuto(ms); schedule(ms); });

  // auto-refresh machinery
  let timer = null;
  function schedule(ms){ if (timer){ clearInterval(timer); timer=null; } if (ms>0){ timer = setInterval(runAll, ms); } }

  // init
  loadBase();
  const ms0 = loadAuto();
  if (ms0>0) $('#autoRefresh').value = String(ms0);
  schedule(ms0);
  runAll();
})();
</script>
</body>
</html>
