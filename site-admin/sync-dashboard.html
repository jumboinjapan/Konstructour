<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд синхронизации - Konstructour</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../styles/admin-japanese.css" rel="stylesheet">
    <style>
        body { background: rgba(254, 251, 243, 1); min-height: 100vh; }
        .dashboard-grid { display: grid; grid-template-columns: 280px 1fr; gap: 0; min-height: 100vh; }
        .sidebar { background: linear-gradient(to bottom, rgba(254, 251, 243, 0.98), rgba(254, 251, 243, 0.95)); border-right: 1px solid rgba(139, 90, 43, 0.12); position: relative; backdrop-filter: blur(8px); }
        .sidebar::before { content: ''; position: absolute; inset: 0; background-image: repeating-linear-gradient(0deg, transparent, transparent 60px, rgba(139, 90, 43, 0.05) 60px, rgba(139, 90, 43, 0.05) 61px); pointer-events: none; }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(236,229,221,0.9)); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top:-50%; right:-50%; width:200%; height:200%; background: radial-gradient(circle, rgba(var(--stat-color, 38, 67, 120), 0.1), transparent); animation: pulse 4s ease-in-out infinite; }
        @keyframes pulse { 0%,100%{transform:scale(1);opacity:.5;} 50%{transform:scale(1.1);opacity:.3;} }
        .menu-item{ position:relative; transition: all .3s ease; }
        .menu-item::before{ content:''; position:absolute; left:0; top:50%; width:3px; height:0; background: linear-gradient(to bottom, rgba(179, 38, 30, .8), rgba(38,67,120,.8)); transition: all .3s ease; transform: translateY(-50%); }
        .menu-item.active::before, .menu-item:hover::before{ height:70%; }
        .menu-item.active{ background: linear-gradient(to right, rgba(179,38,30,.1), transparent); }
        .japanese-table{ background:#fff; border:1px solid rgba(139,90,43,.1); }
        .japanese-table thead{ background: linear-gradient(to bottom, rgba(236,229,221,.5), rgba(236,229,221,.3)); }
        .japanese-table tbody tr{ transition: all .2s ease; }
        .japanese-table tbody tr:hover{ background: rgba(179, 38, 30, .05); }
        .chart-container{ background:#fff; border-radius:8px; position:relative; overflow:hidden; }
        .chart-container::after{ content:''; position:absolute; bottom:0; left:0; right:0; height:60px; background: linear-gradient(to top, rgba(179,38,30,.1), transparent); pointer-events:none; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-success { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .status-info { background-color: #3b82f6; }
    </style>
</head>
<body>
    <div class="dashboard-grid">
        <!-- Боковая панель -->
        <aside class="sidebar texture-wood">
            <div class="p-6">
                <div class="flex items-center mb-8">
                    <div class="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center mr-3">
                        <svg class="w-8 h-8 text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-light text-gray-800">Konstructour</h1>
                        <p class="text-xs text-gray-600">Sync Dashboard</p>
                    </div>
                </div>
                <nav class="space-y-2">
                    <a href="dashboard.html" class="menu-item sidebar-link"><i class="fas fa-th-large mr-3 text-indigo-600"></i>Обзор</a>
                    <a href="databases.html" class="menu-item sidebar-link"><i class="fas fa-database mr-3 text-blue-600"></i>Базы данных</a>
                    <a href="sync-dashboard.html" class="menu-item active sidebar-link"><i class="fas fa-sync-alt mr-3 text-green-600"></i>Синхронизация</a>
                    <a href="api-catalog.html" class="menu-item sidebar-link"><i class="fas fa-code mr-3 text-purple-600"></i>API Каталог</a>
                </nav>
            </div>
        </aside>

        <!-- Основной контент -->
        <main class="p-8">
            <header class="mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-light text-gray-800 mb-1">Дашборд синхронизации</h2>
                        <p class="text-gray-600">Мониторинг синхронизации между локальной БД и Airtable</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="refresh-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i class="fas fa-sync-alt"></i>
                            <span>Обновить</span>
                        </button>
                        <button id="sync-now-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                            <i class="fas fa-play"></i>
                            <span>Синхронизировать сейчас</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Статистика синхронизации -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card p-6 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Статус подключения</p>
                            <p class="text-2xl font-bold text-gray-800" id="connection-status">Проверка...</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-link text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card p-6 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Последняя синхронизация</p>
                            <p class="text-2xl font-bold text-gray-800" id="last-sync">Загрузка...</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-clock text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card p-6 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Ошибки за 24ч</p>
                            <p class="text-2xl font-bold text-gray-800" id="error-count">0</p>
                        </div>
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card p-6 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Успешных операций</p>
                            <p class="text-2xl font-bold text-gray-800" id="success-count">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Логи синхронизации -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-panel p-6 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">
                        <i class="fas fa-list mr-2 text-blue-600"></i>Последние операции
                    </h3>
                    <div id="recent-logs" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-4">Загрузка логов...</div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">
                        <i class="fas fa-exclamation-triangle mr-2 text-red-600"></i>Последние ошибки
                    </h3>
                    <div id="recent-errors" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-4">Загрузка ошибок...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Загрузка данных при инициализации
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            
            // Обработчики кнопок
            document.getElementById('refresh-btn').addEventListener('click', loadDashboardData);
            document.getElementById('sync-now-btn').addEventListener('click', performSync);
            
            // Автообновление каждые 30 секунд
            setInterval(loadDashboardData, 30000);
        });

        async function loadDashboardData() {
            try {
                // Загружаем статистику
                const statsResponse = await fetch('/api/sync-logger.php?action=stats');
                const statsData = await statsResponse.json();
                
                if (statsData.ok) {
                    updateStats(statsData.stats);
                }
                
                // Загружаем последние логи
                const logsResponse = await fetch('/api/sync-logger.php?action=logs&limit=10');
                const logsData = await logsResponse.json();
                
                if (logsData.ok) {
                    updateRecentLogs(logsData.logs);
                }
                
                // Загружаем последние ошибки
                const errorsResponse = await fetch('/api/sync-logger.php?action=errors&limit=5');
                const errorsData = await errorsResponse.json();
                
                if (errorsData.ok) {
                    updateRecentErrors(errorsData.errors);
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateStats(stats) {
            let successCount = 0;
            let errorCount = 0;
            let lastSync = 'Никогда';
            
            stats.forEach(stat => {
                if (stat.status === 'success') {
                    successCount += parseInt(stat.count);
                } else if (stat.status === 'error') {
                    errorCount += parseInt(stat.count);
                }
                
                if (stat.action === 'sync_complete' && stat.status === 'success') {
                    lastSync = new Date(stat.last_occurrence).toLocaleString('ru-RU');
                }
            });
            
            document.getElementById('success-count').textContent = successCount;
            document.getElementById('error-count').textContent = errorCount;
            document.getElementById('last-sync').textContent = lastSync;
            
            // Определяем статус подключения
            const connectionStatus = errorCount > 0 ? 'Проблемы' : 'ОК';
            document.getElementById('connection-status').textContent = connectionStatus;
        }

        function updateRecentLogs(logs) {
            const container = document.getElementById('recent-logs');
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Нет логов</div>';
                return;
            }
            
            container.innerHTML = logs.map(log => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <span class="status-indicator status-${log.status}"></span>
                        <div>
                            <div class="font-medium text-sm">${log.action}</div>
                            <div class="text-xs text-gray-500">${log.entity_type}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleTimeString('ru-RU')}</div>
                        <div class="text-xs text-gray-400">${log.message}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateRecentErrors(errors) {
            const container = document.getElementById('recent-errors');
            
            if (errors.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Нет ошибок</div>';
                return;
            }
            
            container.innerHTML = errors.map(error => `
                <div class="flex items-start p-3 bg-red-50 rounded-lg border border-red-200">
                    <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                    <div class="flex-1">
                        <div class="font-medium text-sm text-red-800">${error.action}</div>
                        <div class="text-xs text-red-600 mt-1">${error.message}</div>
                        <div class="text-xs text-red-400 mt-1">${new Date(error.timestamp).toLocaleString('ru-RU')}</div>
                    </div>
                </div>
            `).join('');
        }

        async function performSync() {
            const btn = document.getElementById('sync-now-btn');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Синхронизация...';
            
            try {
                const response = await fetch('/api/bidirectional-sync.php?action=full');
                const result = await response.json();
                
                if (result.ok) {
                    showNotification('Синхронизация успешна', `Синхронизировано: ${result.airtable_to_local} из Airtable, ${result.local_to_airtable} в Airtable`, 'success');
                    loadDashboardData(); // Обновляем данные
                } else {
                    throw new Error(result.error || 'Ошибка синхронизации');
                }
            } catch (error) {
                showNotification('Ошибка синхронизации', error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-triangle' :
                        'fa-info-circle'
                    } mr-2 mt-1"></i>
                    <div>
                        <div class="font-medium">${title}</div>
                        <div class="text-sm opacity-90">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
