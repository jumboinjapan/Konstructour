<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Konstructour ‚Äî –ö–∞—Ç–∞–ª–æ–≥ API</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../styles/admin-japanese.css" rel="stylesheet">
    <style>
      body{ background: rgb(var(--color-washi)); min-height:100vh; }
      .api-card{ position:relative; transition:transform .2s ease, box-shadow .2s ease; }
      .api-card:hover{ transform: translateY(-2px); box-shadow:0 12px 24px rgba(0,0,0,.08); }
      .api-actions .btn-japanese{ padding:8px 14px; font-size:12px; }
      .api-status{ display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#6b7280; }
      .api-dot{ width:10px; height:10px; border-radius:50%; background:#d1d5db; display:inline-block; }
      .api-dot.loading{ border:2px solid #a78bfa; border-top-color:transparent; width:12px; height:12px; border-radius:50%; animation: spin .9s linear infinite; background:transparent; }
      .api-dot.ok{ background:#10b981; }
      .api-dot.err{ background:#ef4444; }
      .api-dot.warn{ background:#f59e0b; }
      .api-dot.none{ background:#9ca3af; }
      .stable-status { color: #059669 !important; font-weight: 500; }
      @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
      .map-row{ display:grid; grid-template-columns: 1fr 1fr auto auto; align-items:center; gap:10px; }
      .map-entity{ display:flex; align-items:center; gap:8px; font-weight:500; }
      .map-test{ font-size:11px; padding:6px 10px; }
      .expand-icon{ position:absolute; bottom:10px; right:12px; cursor:pointer; color:#6b7280; opacity:.9; transform: scale(.7); }
      .expand-icon:hover{ color:#374151; }
      .btn-icon{ width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border:1px solid #e5e7eb; border-radius:8px; background:#f5f5f4; color:#374151; }
      .btn-icon:hover{ background:#eee; }
    </style>
</head>
<body data-no-redirect="true">
    <div class="dashboard-grid">
        <aside class="sidebar texture-wood">
            <div class="p-6">
                <div class="flex items-center mb-8">
                    <div class="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center mr-3">
                        <svg class="w-8 h-8 text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-light text-gray-800">Konstructour</h1>
                        <p class="text-xs text-gray-600">Site Admin</p>
                    </div>
                </div>
                <nav class="space-y-2">
                    <a href="dashboard.html" class="sidebar-link"><i class="fas fa-th-large mr-3 text-indigo-600"></i>–û–±–∑–æ—Ä</a>
                    <a href="api-catalog.html" class="menu-item active sidebar-link"><i class="fas fa-list mr-3 text-gray-600"></i>–ö–∞—Ç–∞–ª–æ–≥ API</a>
                    <a href="databases.html" class="sidebar-link"><i class="fas fa-database mr-3 text-green-600"></i>–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</a>
                    <a href="health-dashboard.html" class="sidebar-link"><i class="fas fa-heartbeat mr-3 text-red-600"></i>Health Dashboard</a>
                </nav>
            </div>
        </aside>
        <main class="p-8">
            <header class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-light text-gray-800 mb-1">API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                        <p class="text-gray-600">–°–µ–∫—Ä–µ—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage)</p>
                    </div>
                
                </div>
            </header>

            <section class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="airtable">
                <!-- Airtable -->
                <div class="glass-panel p-6 rounded-lg api-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-table mr-2 text-blue-600"></i>Airtable</h3>
                            <span id="statusAirtable" class="api-status"><span class="api-dot"></span><span>–ü—Ä–æ–≤–µ—Ä–∫–∞...</span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveAirtable" type="button" class="btn-japanese"><i class="fas fa-save mr-2"></i>Save Mapping</button>
                            <button id="btnTestAirtable" type="button" class="btn-japanese"><i class="fas fa-vial mr-2"></i>Test</button>
                            <button id="am_toggle" type="button" class="btn-icon" title="Toggle"><i class="fas fa-chevron-up"></i></button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionAirtable">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input id="airtable_api_key" type="text" class="input-japanese" placeholder="–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ —á–µ—Ä–µ–∑ GitHub Secrets" readonly style="background-color: #f0f9ff; color: #0369a1;">
                            <div class="text-xs text-blue-600 mt-1">üîê –¢–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∏ –¥–µ–ø–ª–æ–µ</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Base ID</label>
                            <input id="airtable_base_id" type="text" class="input-japanese" placeholder="appXXXXXXXXXXXXXX">
                        </div>
                        <div class="lg:col-span-2" id="am_mapping">
                          <div class="text-sm font-medium mb-2">Mapping (–ª–µ–≤–æ: Table ID, –ø—Ä–∞–≤–æ: View ID)</div>
                          <div class="space-y-2">
                            <div class="map-row">
                              <div class="map-entity"><span class="api-dot" id="am_dot_country"></span><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9" stroke-width="1.5"/><path d="M3 12h18M12 3c-2.5 2.8-2.5 14.2 0 18" stroke-width="1.5" stroke-linecap="round"/></svg><span>Country</span></div>
                              <input id="am_country_table" class="input-japanese" placeholder="tbl...">
                              <input id="am_country_view" class="input-japanese" placeholder="viw...">
                            </div>
                            <div class="map-row">
                              <div class="map-entity"><span class="api-dot" id="am_dot_region"></span><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><path d="M3.5 6.5 9 4.5l6 2 5.5-2v13l-5.5 2-6-2-5.5 2v-13z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Region</span></div>
                              <input id="am_region_table" class="input-japanese" placeholder="tbl...">
                              <input id="am_region_view" class="input-japanese" placeholder="viw...">
                            </div>
                            <div class="map-row">
                              <div class="map-entity"><span class="api-dot" id="am_dot_city"></span><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><rect x="6" y="8" width="5" height="10" rx="1" stroke-width="1.5"/><rect x="13" y="5" width="5" height="13" rx="1" stroke-width="1.5"/><path d="M3 19h18" stroke-width="1.5" stroke-linecap="round"/></svg><span>City</span></div>
                              <input id="am_city_table" class="input-japanese" placeholder="tbl...">
                              <input id="am_city_view" class="input-japanese" placeholder="viw...">
                            </div>
                            <div class="map-row">
                              <div class="map-entity"><span class="api-dot" id="am_dot_poi"></span><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><path d="M12 20s5.5-4.6 5.5-9.5A5.5 5.5 0 1 0 6.5 10.5C6.5 15.4 12 20 12 20z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="10.5" r="1.8" stroke-width="1.5"/></svg><span>POI</span></div>
                              <input id="am_poi_table" class="input-japanese" placeholder="tbl...">
                              <input id="am_poi_view" class="input-japanese" placeholder="viw...">
                            </div>
                          </div>
                        </div>
                    </div>
                </div>

                <!-- OpenAI -->
                <div class="glass-panel p-6 rounded-lg api-card" id="openai">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-robot mr-2 text-indigo-600"></i>OpenAI</h3>
                            <span id="statusOpenAI" class="api-status"><span class="api-dot"></span><span></span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveOpenAI" type="button" class="btn-japanese"><i class="fas fa-plus mr-2"></i>Add</button>
                            <button id="btnEraseOpenAI" type="button" class="btn-japanese"><i class="fas fa-trash mr-2"></i>Erase</button>
                            <button id="btnTestOpenAI" type="button" class="btn-japanese" data-no-redirect="true"><i class="fas fa-vial mr-2"></i>Test</button>
                            <button id="toggleOpenAI" type="button" class="btn-icon" title="Toggle"><i class="fas fa-chevron-up"></i></button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionOpenAI">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input id="openai_api_key" type="password" class="input-japanese" placeholder="sk-...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–ú–æ–¥–µ–ª—å</label>
                            <input id="openai_model" type="text" class="input-japanese" placeholder="gpt-4o-mini">
                        </div>
                    </div>
                </div>

                <!-- Google Sheets -->
                <div class="glass-panel p-6 rounded-lg api-card" id="gsheets">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-file-excel mr-2 text-green-600"></i>Google Sheets</h3>
                            <span id="statusGSheets" class="api-status"><span class="api-dot"></span><span></span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveGSheets" type="button" class="btn-japanese"><i class="fas fa-plus mr-2"></i>Add</button>
                            <button id="btnEraseGSheets" type="button" class="btn-japanese"><i class="fas fa-trash mr-2"></i>Erase</button>
                            <button id="btnTestGSheets" type="button" class="btn-japanese"><i class="fas fa-vial mr-2"></i>Test</button>
                            <button id="toggleGSheets" type="button" class="btn-icon" title="Toggle"><i class="fas fa-chevron-up"></i></button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionGSheets">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input id="gsheets_api_key" type="password" class="input-japanese" placeholder="AIza...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Spreadsheet ID</label>
                            <input id="gsheets_spreadsheet_id" type="text" class="input-japanese" placeholder="1AbC...">
                        </div>
                    </div>
                </div>

                <!-- Google Maps -->
                <div class="glass-panel p-6 rounded-lg api-card" id="gmaps">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-map-marked-alt mr-2 text-red-600"></i>Google Maps</h3>
                            <span id="statusGMaps" class="api-status"><span class="api-dot"></span><span></span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveGMaps" type="button" class="btn-japanese"><i class="fas fa-plus mr-2"></i>Add</button>
                            <button id="btnEraseGMaps" type="button" class="btn-japanese"><i class="fas fa-trash mr-2"></i>Erase</button>
                            <button id="btnTestGMaps" type="button" class="btn-japanese"><i class="fas fa-vial mr-2"></i>Test</button>
                            <button id="toggleGMaps" type="button" class="btn-icon" title="Toggle"><i class="fas fa-chevron-up"></i></button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionGMaps">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maps API Key</label>
                            <input id="gmaps_api_key" type="password" class="input-japanese" placeholder="AIza...">
                            <p class="hint">–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ–º–µ–Ω—ã: konstructour.com, *.konstructour.com</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–†–µ–≥–∏–æ–Ω</label>
                            <input id="gmaps_region" type="text" class="input-japanese" placeholder="JP">
                        </div>
                    </div>
                </div>

                <!-- Google reCAPTCHA -->
                <div class="glass-panel p-6 rounded-lg api-card" id="recaptcha">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-shield-alt mr-2 text-gray-600"></i>Google reCAPTCHA</h3>
                            <span id="statusRecaptcha" class="api-status"><span class="api-dot"></span><span></span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveRecaptcha" type="button" class="btn-japanese"><i class="fas fa-plus mr-2"></i>Add</button>
                            <button id="btnEraseRecaptcha" type="button" class="btn-japanese"><i class="fas fa-trash mr-2"></i>Erase</button>
                            <button id="btnTestRecaptcha" type="button" class="btn-japanese"><i class="fas fa-vial mr-2"></i>Test</button>
                            <button id="toggleRecaptcha" type="button" class="btn-icon" title="Toggle"><i class="fas fa-chevron-up"></i></button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionRecaptcha">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Site Key</label>
                            <input id="recaptcha_site_key" type="text" class="input-japanese" placeholder="...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Secret Key</label>
                            <input id="recaptcha_secret" type="password" class="input-japanese" placeholder="...">
                        </div>
                    </div>
                </div>

                <!-- Brilliant Directory -->
                <div class="glass-panel p-6 rounded-lg api-card" id="brilliantdb">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-database mr-2 text-purple-600"></i>BD</h3>
                            <span id="statusBrilliant" class="api-status"><span class="api-dot"></span><span></span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveBrilliant" type="button" class="btn-japanese"><i class="fas fa-plus mr-2"></i>Add</button>
                            <button id="btnEraseBrilliant" type="button" class="btn-japanese"><i class="fas fa-trash mr-2"></i>Erase</button>
                            <button id="btnTestBrilliant" type="button" class="btn-japanese"><i class="fas fa-vial mr-2"></i>Test</button>
                            <button id="toggleBrilliant" type="button" class="btn-icon" title="Toggle"><i class="fas fa-chevron-up"></i></button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionBrilliant">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input id="brilliantdb_api_key" type="password" class="input-japanese" placeholder="...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Endpoint Base</label>
                            <input id="brilliantdb_base_url" type="text" class="input-japanese" placeholder="https://api.brilliantdb.com/v1/">
                        </div>
                        <div class="lg:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Collection</label>
                            <input id="brilliantdb_collection" type="text" class="input-japanese" placeholder="tours">
                        </div>
                    </div>
                </div>
            </section>

            <div class="mt-8 flex items-center space-x-3">
                <button id="btnTestAll" class="btn-japanese"><i class="fas fa-vial mr-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
                <span id="statusText" class="text-sm text-gray-600"></span>
            </div>
        </main>
    </div>

    <script src="../js/api-settings.js?v=20250921-24"></script>
    <script>
      (function(){
        const toggle = document.getElementById('am_toggle');
        const mappingRoot = document.getElementById('sectionAirtable');
        if (toggle && mappingRoot){
          const icon = toggle.querySelector('i');
          const isCollapsed = ()=> window.getComputedStyle(mappingRoot).display === 'none';
          const renderIcon = ()=>{ if (!icon) return; const collapsed = isCollapsed(); icon.classList.remove('fa-chevron-up','fa-chevron-down'); icon.classList.add(collapsed?'fa-chevron-down':'fa-chevron-up'); };
          // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–∫—Ü–∏—è —Å–≤—ë—Ä–Ω—É—Ç–∞, —á—Ç–æ–±—ã —Å—Ç—Ä–µ–ª–∫–∞ —Å—Ä–∞–∑—É –±—ã–ª–∞ –≤–Ω–∏–∑ –±–µ–∑ –º–∏–≥–∞–Ω–∏—è
          if (!isCollapsed()) { mappingRoot.style.display = 'none'; }
          renderIcon();
          toggle.addEventListener('click', function(){ const collapsed = isCollapsed(); mappingRoot.style.display = collapsed ? '' : 'none'; renderIcon(); });
          const addBtn = document.getElementById('btnSaveAirtable');
          if (addBtn){ addBtn.addEventListener('click', function(){ mappingRoot.style.display=''; renderIcon(); }); }
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ toggle –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        function bindToggle(btnId, sectionId){
          const btn = document.getElementById(btnId); const root = document.getElementById(sectionId); if (!btn || !root) return;
          const ic = btn.querySelector('i');
          const sync = ()=>{ const collapsed = window.getComputedStyle(root).display === 'none'; if (ic){ ic.classList.remove('fa-chevron-up','fa-chevron-down'); ic.classList.add(collapsed?'fa-chevron-down':'fa-chevron-up'); } };
          if (window.getComputedStyle(root).display !== 'none') { root.style.display = 'none'; }
          sync();
          btn.addEventListener('click', ()=>{ const collapsed = window.getComputedStyle(root).display === 'none'; root.style.display = collapsed ? '' : 'none'; sync(); });
          // Add- –∫–Ω–æ–ø–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç
          const add = document.getElementById('btnSave'+(sectionId.replace('section','')));
          if (add){ add.addEventListener('click', ()=>{ root.style.display=''; sync(); }); }
        }
        bindToggle('toggleOpenAI','sectionOpenAI');
        bindToggle('toggleGSheets','sectionGSheets');
        bindToggle('toggleGMaps','sectionGMaps');
        bindToggle('toggleRecaptcha','sectionRecaptcha');
        bindToggle('toggleBrilliant','sectionBrilliant');
        // –£—Ç–∏–ª–∏—Ç–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫—ç—à–µ–π
        function clearLocalCaches(){
          try{
            [
              'konstructour_regions_cache_v1',
              'konstructour_cities_cache_v2',
              'konstructour_pois_cache_v2',
              'konstructour_last_refresh',
              'konstructour_last_sync'
            ].forEach(k=> localStorage.removeItem(k));
          }catch(_){ /* ignore */ }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π PAT —Ç–æ–∫–µ–Ω
        function isValidPatToken(token) {
          return token && /^pat[A-Za-z0-9]{14}\.[A-Za-z0-9]{22}$/.test(token);
        }

        async function testTable(entity){
          clearLocalCaches();
          const baseId = document.getElementById('airtable_base_id')?.value || '';
          const tableId = document.getElementById('am_'+entity+'_table')?.value || '';
          const viewId = document.getElementById('am_'+entity+'_view')?.value || '';
          const dot = document.getElementById('am_dot_'+entity);
          const msg = document.getElementById('am_msg_'+entity);
          if (dot){ dot.classList.remove('ok','err'); dot.classList.add('loading'); }
          try{
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –∏–∑ GitHub Secrets (—á–µ—Ä–µ–∑ test-proxy-secure.php)
            const body = { base_id: baseId, table: tableId, view: viewId, whoami: true };
            const r = await fetch(`../api/test-proxy-secure.php?provider=airtable&_=${Date.now()}`,{
              method:'POST',
              cache:'no-store',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify(body)
            });
            const t = await r.json();
            const authOk = !!(t && t.ok && t.auth !== false && t.status !== 401);
            if (dot){ dot.classList.remove('loading'); dot.classList.add(authOk?'ok':'err'); }
            if (msg){ msg.textContent = authOk ? 'OK' : (t && (t.error || t.message) ? (t.error || t.message) : ('HTTP '+(t && t.status || ''))); }
            // –ù–∞ Test —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ú–ê–ü–ü–ò–ù–ì, –ù–ò–ö–û–ì–î–ê –Ω–µ –∫–ª—é—á
            if (authOk){
              try{ await saveRegistry(false); }catch(_){ /* ignore */ }
            }
          }catch(e){
            if (dot){ dot.classList.remove('loading'); dot.classList.add('err'); }
            if (msg){ msg.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'; }
          }
        }
        // map-test buttons removed - using auto-updating indicators instead

        // autoTestMapping function removed - replaced with updateMappingIndicators

        // Load saved registry from server and populate fields
        async function loadRegistry(){
          try{
            const headers = {};
            if (window.ADMIN_TOKEN) headers['X-Admin-Token'] = window.ADMIN_TOKEN;
            const r = await fetch('../api/config-read.php', { headers });
            const j = await r.json();
            const reg = j && j.airtable_registry;
            if (!reg) { autoTestMapping(); return; }
            const baseId = reg.baseId || reg.base_id || '';
            const t = reg.tables || {};
            const setv = (id,val)=>{ const el=document.getElementById(id); if (el && val!==undefined) el.value=val; };
            setv('airtable_base_id', baseId);
            setv('am_country_table', t.country?.tableId||''); setv('am_country_view', t.country?.viewId||'');
            setv('am_region_table',  t.region?.tableId||'');  setv('am_region_view',  t.region?.viewId||'');
            // Region ID Field —É–±—Ä–∞–Ω - –Ω–µ –Ω—É–∂–µ–Ω
            setv('am_city_table',    t.city?.tableId||'');    setv('am_city_view',    t.city?.viewId||'');
            setv('am_poi_table',     t.poi?.tableId||'');     setv('am_poi_view',     t.poi?.viewId||'');
            // autoTestMapping(); // –û—Ç–∫–ª—é—á–µ–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º
            // refreshServerKeyBadge –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          }catch(_){ /* ignore */ }
        }

        // Save registry (–∏ –æ–ø—Ü. PAT) –Ω–∞ —Å–µ—Ä–≤–µ—Ä; –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–∏—Ä–∞—Ç—å
        async function saveRegistry(saveKeyAlso){
          try{
            const val = id=> (document.getElementById(id)?.value||'').trim();
            const payload = {};
            const baseId = val('airtable_base_id');
            const tables = {};
            const pushField = (obj, key, v)=>{ if (typeof v==='string' && v.trim()!=='') obj[key]=v.trim(); };
            const addTable = (name, tblId, viewId)=>{
              const t = {}; pushField(t,'tableId', tblId); pushField(t,'viewId', viewId);
              // Region ID Field —É–±—Ä–∞–Ω - –Ω–µ –Ω—É–∂–µ–Ω
              if (Object.keys(t).length) tables[name]=t;
            };
            addTable('country', val('am_country_table'), val('am_country_view'));
            addTable('region',  val('am_region_table'),  val('am_region_view'));
            addTable('city',    val('am_city_table'),    val('am_city_view'));
            addTable('poi',     val('am_poi_table'),     val('am_poi_view'));
            const reg = { tables };
            if (baseId) reg.baseId = baseId;
            payload.airtable_registry = reg;
            if (saveKeyAlso){
              const apiKey = val('airtable_api_key');
              const isRealPat = /^pat\.[A-Za-z0-9_\-]{20,}$/.test(apiKey);
              if (isRealPat){ payload.airtable = { api_key: apiKey }; }
            }
            const headers = { 'Content-Type':'application/json' };
            if (window.ADMIN_TOKEN) headers['X-Admin-Token'] = window.ADMIN_TOKEN;
            await fetch('../api/config-store.php', { method:'POST', headers, body: JSON.stringify(payload) });
            // refreshServerKeyBadge –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
          }catch(_){ /* ignore */ }
        }

        document.getElementById('btnSaveAirtable')?.addEventListener('click', function(){
          // –¢–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ GitHub Secrets, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –º–∞–ø–ø–∏–Ω–≥
          alert('Airtable —Ç–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ GitHub Secrets. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –º–∞–ø–ø–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü.');
          return saveRegistry(false);
        });

        // –ö–Ω–æ–ø–∫–∞ Token Locked —É–±—Ä–∞–Ω–∞ - –Ω–µ –Ω–µ—Å–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏

        // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π
        function val(id) {
          return document.getElementById(id)?.value || '';
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—á–µ—Ä–Ω–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
        async function updateMappingIndicators() {
          console.log('üîç updateMappingIndicators: Starting...');
          const entities = ['country', 'region', 'city', 'poi'];
          const baseId = val('airtable_base_id');
          console.log('üîç Base ID:', baseId);
          
          // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–π –¥–æ—Å—Ç—É–ø –∫ Airtable
          let generalAccess = false;
          try {
            const healthResponse = await fetch('../api/health-airtable.php', { cache: 'no-store' });
            const healthData = await healthResponse.json();
            generalAccess = !!(healthData && healthData.ok);
          } catch (e) {
            console.warn('Health check failed:', e);
          }
          
          for (const entity of entities) {
            const dot = document.getElementById(`am_dot_${entity}`);
            const tableId = val(`am_${entity}_table`);
            const viewId = val(`am_${entity}_view`);
            
            console.log(`üîç ${entity}:`, { dot: !!dot, tableId, viewId });
            
            if (!dot) {
              console.warn(`‚ùå ${entity}: Dot element not found!`);
              continue;
            }
            
            // –ï—Å–ª–∏ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ - —Å–µ—Ä—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            if (!tableId || !viewId) {
              dot.classList.remove('ok', 'err', 'warn', 'none');
              dot.classList.add('none');
              dot.title = `${entity}: –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ (–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç Table ID –∏–ª–∏ View ID)`;
              continue;
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç Base ID - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            if (!baseId) {
              dot.classList.remove('ok', 'err', 'warn', 'none');
              dot.classList.add('warn');
              dot.title = `${entity}: –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Base ID`;
              continue;
            }
            
            // –ï—Å–ª–∏ –æ–±—â–∏–π –¥–æ—Å—Ç—É–ø –∫ Airtable –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –æ—à–∏–±–∫–∞
            if (!generalAccess) {
              dot.classList.remove('ok', 'err', 'warn', 'none');
              dot.classList.add('err');
              dot.title = `${entity}: Airtable –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ–∫–µ–Ω–æ–º)`;
              continue;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
            try {
              const response = await fetch('../api/test-proxy-secure.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  provider: 'airtable',
                  baseId: baseId,
                  table: tableId,
                  view: viewId,
                  limit: 1
                })
              });
              
              const result = await response.json();
              const isOk = !!(result && result.ok);
              
              dot.classList.remove('ok', 'err', 'warn', 'none');
              dot.classList.add(isOk ? 'ok' : 'err');
              
              // –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ tooltip
              if (isOk) {
                dot.title = `${entity}: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (Table: ${tableId}, View: ${viewId})`;
              } else {
                const error = result.error || result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                dot.title = `${entity}: ‚ùå –û—à–∏–±–∫–∞ - ${error}`;
              }
              
            } catch (e) {
              dot.classList.remove('ok', 'err', 'warn', 'none');
              dot.classList.add('err');
              dot.title = `${entity}: ‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ - ${e.message}`;
            }
          }
        }

        let isRefreshing = false; // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
        
        async function refreshServerKeyBadge(showLoading = true){
          if (isRefreshing) return; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã
          isRefreshing = true;
          
          clearLocalCaches();
          const badge = document.getElementById('badgeAirtable');
          const status = document.getElementById('statusAirtable');
          const dot = status ? status.querySelector('.api-dot') : null;
          if (dot && showLoading){ 
            dot.classList.remove('ok','err'); 
            dot.classList.add('loading'); 
          }
          try{
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ health-airtable.php (GitHub Secrets)
            const r1 = await fetch(`../api/health-airtable.php?_=${Date.now()}`, { cache:'no-store' });
            const j1 = await r1.json();
            const hasToken = !!(j1 && j1.state && j1.state.token_current_present);
            const isWorking = !!(j1 && j1.ok);
            
            // –ë–µ–π–¥–∂ —É–±—Ä–∞–Ω - —Å—Ç–∞—Ç—É—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            const statusText = status ? status.querySelector('span:last-child') : null;
            
            if (!hasToken){
              if (dot){ dot.classList.remove('loading','ok'); dot.classList.add('err'); }
              if (statusText) statusText.textContent = '–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞';
              return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ health check
            if (dot){ 
              dot.classList.remove('loading'); 
              dot.classList.toggle('ok', isWorking); 
              dot.classList.toggle('err', !isWorking); 
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
            if (statusText) {
              if (isWorking) {
                statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ (GitHub Secrets)';
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
                statusText.classList.add('stable-status');
              } else {
                statusText.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                statusText.classList.remove('stable-status');
              }
            }
          }catch(_){ 
            if (dot){ 
              dot.classList.remove('loading'); 
              dot.classList.add('err'); 
            }
            const statusText = status ? status.querySelector('span:last-child') : null;
            if (statusText) statusText.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏';
          } finally {
            isRefreshing = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
          }
        }

        loadRegistry();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        const status = document.getElementById('statusAirtable');
        const statusText = status ? status.querySelector('span:last-child') : null;
        if (statusText) statusText.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–±–µ–∑ loading)
        setTimeout(() => refreshServerKeyBadge(false), 2000);
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—á–µ—Ä–Ω–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
        const mappingInputs = ['am_country_table', 'am_country_view', 'am_region_table', 'am_region_view', 
                              'am_city_table', 'am_city_view', 'am_poi_table', 'am_poi_view', 'airtable_base_id'];
        
        mappingInputs.forEach(inputId => {
          const input = document.getElementById(inputId);
          if (input) {
            input.addEventListener('input', () => {
              setTimeout(updateMappingIndicators, 500); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –¥–µ–±–∞—É–Ω—Å–∞
            });
          }
        });
        
        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—á–µ—Ä–Ω–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
        console.log('üöÄ API Catalog: Starting mapping indicators...');
        setTimeout(() => {
          console.log('üîç API Catalog: Running updateMappingIndicators...');
          updateMappingIndicators();
        }, 3000);
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å–∞–π—Ç–∞)
        setInterval(() => {
          console.log('üîÑ API Catalog: Periodic updateMappingIndicators...');
          updateMappingIndicators();
        }, 30000);
        
        // –°—Ç–∞—Ç—É—Å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —á–µ—Ä–µ–∑ GitHub Secrets - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
      })();
    </script>
</body>
</html>


