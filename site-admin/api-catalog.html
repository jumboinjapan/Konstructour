<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Konstructour — Каталог API</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../styles/admin-japanese.css" rel="stylesheet">
    <style>
      body{ background: rgb(var(--color-washi)); min-height:100vh; }
      .api-card{ position:relative; transition:transform .2s ease, box-shadow .2s ease; }
      .api-card:hover{ transform: translateY(-2px); box-shadow:0 12px 24px rgba(0,0,0,.08); }
      .api-actions .btn-japanese{ padding:8px 14px; font-size:12px; }
      .api-status{ display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#6b7280; }
      .api-dot{ width:10px; height:10px; border-radius:50%; background:#d1d5db; display:inline-block; }
      .api-dot.loading{ border:2px solid #a78bfa; border-top-color:transparent; width:12px; height:12px; border-radius:50%; animation: spin .9s linear infinite; background:transparent; }
      .api-dot.ok{ background:#10b981; }
      .api-dot.err{ background:#ef4444; }
      @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
      .map-row{ display:grid; grid-template-columns: 1fr 1fr auto auto; align-items:center; gap:10px; }
      .map-entity{ display:flex; align-items:center; gap:8px; font-weight:500; }
      .map-test{ font-size:11px; padding:6px 10px; }
      .expand-icon{ position:absolute; bottom:10px; right:12px; cursor:pointer; color:#6b7280; opacity:.9; transform: scale(.7); }
      .expand-icon:hover{ color:#374151; }
      .btn-icon{ width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border:1px solid #e5e7eb; border-radius:8px; background:#f5f5f4; color:#374151; }
      .btn-icon:hover{ background:#eee; }
    </style>
</head>
<body data-no-redirect="true">
    <div class="dashboard-grid">
        <aside class="sidebar texture-wood">
            <div class="p-6">
                <div class="flex items-center mb-8">
                    <div class="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center mr-3">
                        <svg class="w-8 h-8 text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-light text-gray-800">Konstructour</h1>
                        <p class="text-xs text-gray-600">Site Admin</p>
                    </div>
                </div>
                <nav class="space-y-2">
                    <a href="dashboard.html" class="sidebar-link"><i class="fas fa-th-large mr-3 text-indigo-600"></i>Обзор</a>
                    <a href="api-catalog.html" class="menu-item active sidebar-link"><i class="fas fa-list mr-3 text-gray-600"></i>Каталог API</a>
                    <a href="databases.html" class="sidebar-link"><i class="fas fa-database mr-3 text-green-600"></i>Базы данных</a>
                </nav>
            </div>
        </aside>
        <main class="p-8">
            <header class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-light text-gray-800 mb-1">API настройки</h2>
                        <p class="text-gray-600">Секреты хранятся только в браузере (localStorage)</p>
                    </div>
                
                </div>
            </header>

            <section class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="airtable">
                <!-- Airtable -->
                <div class="glass-panel p-6 rounded-lg api-card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-table mr-2 text-blue-600"></i>Airtable</h3>
                            <span id="badgeAirtable" class="text-xs text-gray-500 hidden"><i class="fas fa-shield-alt mr-1"></i>Server key</span>
                            <span id="statusAirtable" class="api-status"><span class="api-dot"></span><span></span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveAirtable" type="button" class="btn-japanese"><i class="fas fa-plus mr-2"></i>Add</button>
                            <button id="btnEraseAirtable" type="button" class="btn-japanese"><i class="fas fa-trash mr-2"></i>Erase</button>
                            <button id="btnTestAirtable" type="button" class="btn-japanese"><i class="fas fa-vial mr-2"></i>Test</button>
                            <button id="am_toggle" type="button" class="btn-icon" title="Toggle"><i class="fas fa-chevron-up"></i></button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionAirtable">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input id="airtable_api_key" type="password" class="input-japanese" placeholder="pat...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Base ID</label>
                            <input id="airtable_base_id" type="text" class="input-japanese" placeholder="appXXXXXXXXXXXXXX">
                        </div>
                        <div class="lg:col-span-2" id="am_mapping">
                          <div class="text-sm font-medium mb-2">Mapping (лево: Table ID, право: View ID)</div>
                          <div class="space-y-2">
                            <div class="map-row">
                              <div class="map-entity"><span class="api-dot" id="am_dot_country"></span><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9" stroke-width="1.5"/><path d="M3 12h18M12 3c-2.5 2.8-2.5 14.2 0 18" stroke-width="1.5" stroke-linecap="round"/></svg><span>Country</span></div>
                              <input id="am_country_table" class="input-japanese" placeholder="tbl...">
                              <input id="am_country_view" class="input-japanese" placeholder="viw...">
                              <button data-entity="country" class="map-test btn-japanese">Test</button>
                              <span id="am_msg_country" class="text-xs text-gray-500"></span>
                            </div>
                            <div class="map-row">
                              <div class="map-entity"><span class="api-dot" id="am_dot_region"></span><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><path d="M3.5 6.5 9 4.5l6 2 5.5-2v13l-5.5 2-6-2-5.5 2v-13z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Region</span></div>
                              <input id="am_region_table" class="input-japanese" placeholder="tbl...">
                              <input id="am_region_view" class="input-japanese" placeholder="viw...">
                              <button data-entity="region" class="map-test btn-japanese">Test</button>
                              <span id="am_msg_region" class="text-xs text-gray-500"></span>
                            </div>
                            <div class="map-row">
                              <div class="map-entity"><span class="api-dot" id="am_dot_city"></span><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><rect x="6" y="8" width="5" height="10" rx="1" stroke-width="1.5"/><rect x="13" y="5" width="5" height="13" rx="1" stroke-width="1.5"/><path d="M3 19h18" stroke-width="1.5" stroke-linecap="round"/></svg><span>City</span></div>
                              <input id="am_city_table" class="input-japanese" placeholder="tbl...">
                              <input id="am_city_view" class="input-japanese" placeholder="viw...">
                              <button data-entity="city" class="map-test btn-japanese">Test</button>
                              <span id="am_msg_city" class="text-xs text-gray-500"></span>
                            </div>
                            <div class="map-row">
                              <div class="map-entity"><span class="api-dot" id="am_dot_poi"></span><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><path d="M12 20s5.5-4.6 5.5-9.5A5.5 5.5 0 1 0 6.5 10.5C6.5 15.4 12 20 12 20z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="10.5" r="1.8" stroke-width="1.5"/></svg><span>POI</span></div>
                              <input id="am_poi_table" class="input-japanese" placeholder="tbl...">
                              <input id="am_poi_view" class="input-japanese" placeholder="viw...">
                              <button data-entity="poi" class="map-test btn-japanese">Test</button>
                              <span id="am_msg_poi" class="text-xs text-gray-500"></span>
                            </div>
                          </div>
                        </div>
                    </div>
                </div>

                <!-- OpenAI -->
                <div class="glass-panel p-6 rounded-lg api-card" id="openai">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-robot mr-2 text-indigo-600"></i>OpenAI</h3>
                            <span id="badgeOpenAI" class="text-xs text-gray-500 hidden"><i class="fas fa-shield-alt mr-1"></i>Server key</span>
                            <span id="statusOpenAI" class="api-status"><span class="api-dot"></span><span></span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveOpenAI" type="button" class="btn-japanese"><i class="fas fa-plus mr-2"></i>Add</button>
                            <button id="btnEraseOpenAI" type="button" class="btn-japanese"><i class="fas fa-trash mr-2"></i>Erase</button>
                            <button id="btnTestOpenAI" type="button" class="btn-japanese" data-no-redirect="true"><i class="fas fa-vial mr-2"></i>Test</button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionOpenAI">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input id="openai_api_key" type="password" class="input-japanese" placeholder="sk-...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Модель</label>
                            <input id="openai_model" type="text" class="input-japanese" placeholder="gpt-4o-mini">
                        </div>
                    </div>
                </div>

                <!-- Google Sheets -->
                <div class="glass-panel p-6 rounded-lg api-card" id="gsheets">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-file-excel mr-2 text-green-600"></i>Google Sheets</h3>
                            <span id="badgeGSheets" class="text-xs text-gray-500 hidden"><i class="fas fa-shield-alt mr-1"></i>Server key</span>
                            <span id="statusGSheets" class="api-status"><span class="api-dot"></span><span></span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveGSheets" type="button" class="btn-japanese"><i class="fas fa-plus mr-2"></i>Add</button>
                            <button id="btnEraseGSheets" type="button" class="btn-japanese"><i class="fas fa-trash mr-2"></i>Erase</button>
                            <button id="btnTestGSheets" type="button" class="btn-japanese"><i class="fas fa-vial mr-2"></i>Test</button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionGSheets">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input id="gsheets_api_key" type="password" class="input-japanese" placeholder="AIza...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Spreadsheet ID</label>
                            <input id="gsheets_spreadsheet_id" type="text" class="input-japanese" placeholder="1AbC...">
                        </div>
                    </div>
                </div>

                <!-- Google Maps -->
                <div class="glass-panel p-6 rounded-lg api-card" id="gmaps">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-map-marked-alt mr-2 text-red-600"></i>Google Maps</h3>
                            <span id="badgeGMaps" class="text-xs text-gray-500 hidden"><i class="fas fa-shield-alt mr-1"></i>Server key</span>
                            <span id="statusGMaps" class="api-status"><span class="api-dot"></span><span></span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveGMaps" type="button" class="btn-japanese"><i class="fas fa-plus mr-2"></i>Add</button>
                            <button id="btnEraseGMaps" type="button" class="btn-japanese"><i class="fas fa-trash mr-2"></i>Erase</button>
                            <button id="btnTestGMaps" type="button" class="btn-japanese"><i class="fas fa-vial mr-2"></i>Test</button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionGMaps">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maps API Key</label>
                            <input id="gmaps_api_key" type="password" class="input-japanese" placeholder="AIza...">
                            <p class="hint">Ограничьте домены: konstructour.com, *.konstructour.com</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Регион</label>
                            <input id="gmaps_region" type="text" class="input-japanese" placeholder="JP">
                        </div>
                    </div>
                </div>

                <!-- Google reCAPTCHA -->
                <div class="glass-panel p-6 rounded-lg api-card" id="recaptcha">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-shield-alt mr-2 text-gray-600"></i>Google reCAPTCHA</h3>
                            <span id="badgeRecaptcha" class="text-xs text-gray-500 hidden"><i class="fas fa-shield-alt mr-1"></i>Server key</span>
                            <span id="statusRecaptcha" class="api-status"><span class="api-dot"></span><span></span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveRecaptcha" type="button" class="btn-japanese"><i class="fas fa-plus mr-2"></i>Add</button>
                            <button id="btnEraseRecaptcha" type="button" class="btn-japanese"><i class="fas fa-trash mr-2"></i>Erase</button>
                            <button id="btnTestRecaptcha" type="button" class="btn-japanese"><i class="fas fa-vial mr-2"></i>Test</button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionRecaptcha">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Site Key</label>
                            <input id="recaptcha_site_key" type="text" class="input-japanese" placeholder="...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Secret Key</label>
                            <input id="recaptcha_secret" type="password" class="input-japanese" placeholder="...">
                        </div>
                    </div>
                </div>

                <!-- Brilliant Directory -->
                <div class="glass-panel p-6 rounded-lg api-card" id="brilliantdb">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-light text-gray-800"><i class="fas fa-database mr-2 text-purple-600"></i>BD</h3>
                            <span id="badgeBrilliant" class="text-xs text-gray-500 hidden"><i class="fas fa-shield-alt mr-1"></i>Server key</span>
                            <span id="statusBrilliant" class="api-status"><span class="api-dot"></span><span></span></span>
                        </div>
                        <div class="api-actions flex items-center gap-2 flex-wrap">
                            <button id="btnSaveBrilliant" type="button" class="btn-japanese"><i class="fas fa-plus mr-2"></i>Add</button>
                            <button id="btnEraseBrilliant" type="button" class="btn-japanese"><i class="fas fa-trash mr-2"></i>Erase</button>
                            <button id="btnTestBrilliant" type="button" class="btn-japanese"><i class="fas fa-vial mr-2"></i>Test</button>
                        </div>
                    </div>
                    <div class="form-grid" id="sectionBrilliant">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                            <input id="brilliantdb_api_key" type="password" class="input-japanese" placeholder="...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Endpoint Base</label>
                            <input id="brilliantdb_base_url" type="text" class="input-japanese" placeholder="https://api.brilliantdb.com/v1/">
                        </div>
                        <div class="lg:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Collection</label>
                            <input id="brilliantdb_collection" type="text" class="input-japanese" placeholder="tours">
                        </div>
                    </div>
                </div>
            </section>

            <div class="mt-8 flex items-center space-x-3">
                <button id="btnTestAll" class="btn-japanese"><i class="fas fa-vial mr-2"></i>Проверить конфиг (локально)</button>
                <span id="statusText" class="text-sm text-gray-600"></span>
            </div>
        </main>
    </div>

    <script src="../js/api-settings.js?v=20250921-24"></script>
    <script>
      (function(){
        const toggle = document.getElementById('am_toggle');
        const mapping = document.getElementById('am_mapping');
        if (toggle && mapping){
          let collapsed = false;
          toggle.addEventListener('click', function(){
            collapsed = !collapsed;
            mapping.style.display = collapsed ? 'none' : '';
            this.innerHTML = '<i class="fas '+(collapsed?'fa-chevron-down':'fa-chevron-up')+' mr-2"></i>Toggle';
          });
        }
        async function testTable(entity){
          const baseId = document.getElementById('airtable_base_id')?.value || '';
          const tableId = document.getElementById('am_'+entity+'_table')?.value || '';
          const viewId = document.getElementById('am_'+entity+'_view')?.value || '';
          const apiKey = document.getElementById('airtable_api_key')?.value || '';
          const dot = document.getElementById('am_dot_'+entity);
          const msg = document.getElementById('am_msg_'+entity);
          if (dot){ dot.classList.remove('ok','err'); dot.classList.add('loading'); }
          try{
            const r = await fetch('../api/test-proxy.php?provider=airtable',{
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ base_id: baseId, table: tableId, view: viewId, api_key: apiKey || undefined })
            });
            const t = await r.json();
            if (dot){ dot.classList.remove('loading'); dot.classList.add(t.ok?'ok':'err'); }
            if (msg){ msg.textContent = t.ok ? 'OK' : (t.error || ('HTTP '+(t.status||''))); }
            if (t.ok){
              // успешный тест = сохранить текущий mapping на сервере
              try{ await saveRegistry(); }catch(_){ /* ignore */ }
            }
          }catch(e){ if (dot){ dot.classList.remove('loading'); dot.classList.add('err'); } }
        }
        document.querySelectorAll('.map-test').forEach(btn=>{
          btn.addEventListener('click', function(){ testTable(this.getAttribute('data-entity')); });
        });

        // Auto-test on load if Base + Table present, and re-test after edits
        function autoTestMapping(){
          const baseId = document.getElementById('airtable_base_id')?.value || '';
          if (!baseId) return;
          ['country','region','city','poi'].forEach(ent=>{
            const tbl = document.getElementById('am_'+ent+'_table')?.value || '';
            if (tbl) testTable(ent);
          });
        }
        const debounce = (fn, ms)=>{ let t; return ()=>{ clearTimeout(t); t=setTimeout(fn, ms); }; };
        ['airtable_base_id','am_country_table','am_country_view','am_region_table','am_region_view','am_city_table','am_city_view','am_poi_table','am_poi_view']
          .forEach(id=>{ const el = document.getElementById(id); if (el){ el.addEventListener('input', debounce(autoTestMapping, 600)); el.addEventListener('change', autoTestMapping); } });

        // Load saved registry from server and populate fields
        async function loadRegistry(){
          try{
            const headers = {};
            if (window.ADMIN_TOKEN) headers['X-Admin-Token'] = window.ADMIN_TOKEN;
            const r = await fetch('../api/config-read.php', { headers });
            const j = await r.json();
            const reg = j && j.airtable_registry;
            if (!reg) { autoTestMapping(); return; }
            const baseId = reg.baseId || reg.base_id || '';
            const t = reg.tables || {};
            const setv = (id,val)=>{ const el=document.getElementById(id); if (el && val!==undefined) el.value=val; };
            setv('airtable_base_id', baseId);
            setv('am_country_table', t.country?.tableId||''); setv('am_country_view', t.country?.viewId||'');
            setv('am_region_table',  t.region?.tableId||'');  setv('am_region_view',  t.region?.viewId||'');
            setv('am_city_table',    t.city?.tableId||'');    setv('am_city_view',    t.city?.viewId||'');
            setv('am_poi_table',     t.poi?.tableId||'');     setv('am_poi_view',     t.poi?.viewId||'');
            autoTestMapping();
          }catch(_){ /* ignore */ }
        }

        // Save registry to server (called together с обычным Save Airtable)
        async function saveRegistry(){
          try{
            const reg = {
              baseId: document.getElementById('airtable_base_id')?.value || '',
              tables: {
                country: { tableId: document.getElementById('am_country_table')?.value || '', viewId: document.getElementById('am_country_view')?.value || '' },
                region:  { tableId: document.getElementById('am_region_table')?.value  || '', viewId: document.getElementById('am_region_view')?.value  || '' },
                city:    { tableId: document.getElementById('am_city_table')?.value    || '', viewId: document.getElementById('am_city_view')?.value    || '' },
                poi:     { tableId: document.getElementById('am_poi_table')?.value     || '', viewId: document.getElementById('am_poi_view')?.value     || '' }
              }
            };
            const headers = { 'Content-Type':'application/json' };
            if (window.ADMIN_TOKEN) headers['X-Admin-Token'] = window.ADMIN_TOKEN;
            await fetch('../api/config-store.php', { method:'POST', headers, body: JSON.stringify({ airtable_registry: reg }) });
          }catch(_){ /* ignore */ }
        }

        document.getElementById('btnSaveAirtable')?.addEventListener('click', function(){ saveRegistry(); });

        loadRegistry();
      })();
    </script>
</body>
</html>


