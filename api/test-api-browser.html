<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #e8f5e8; }
        .error { background: #ffe8e8; }
    </style>
</head>
<body>
    <h1>Тест API</h1>
    
    <div id="results"></div>
    
    <script>
        async function testAPI() {
            console.log('Starting API tests...');
            const results = document.getElementById('results');
            let html = '';
            
            // Test stats
            try {
                const res = await fetch('/api/data-api.php?action=stats');
                const data = await res.json();
                
                if (data.ok) {
                    html += `<div class="test success">
                        <h3>✅ Статистика API работает</h3>
                        <p>Регионы: ${data.regions}</p>
                        <p>Города: ${data.cities}</p>
                        <p>POI: ${data.pois}</p>
                    </div>`;
                } else {
                    html += `<div class="test error">
                        <h3>❌ Ошибка API</h3>
                        <p>${data.error || 'Неизвестная ошибка'}</p>
                    </div>`;
                }
            } catch (e) {
                html += `<div class="test error">
                    <h3>❌ Ошибка подключения</h3>
                    <p>${e.message}</p>
                </div>`;
            }
            
            // Test Airtable Connection
            try {
                console.log('Testing Airtable API...');
                const res = await fetch('/api/airtable-ping.php');
                console.log('Airtable response status:', res.status);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                console.log('Airtable response data:', data);
                
                if (data.ok) {
                    html += `<div class="test success">
                        <h3>✅ Airtable подключение работает</h3>
                        <p>Base ID: ${data.base_id}</p>
                        <p>Table ID: ${data.table_id}</p>
                        <p>Token: ${data.token_preview}</p>
                        <p>Записей в выборке: ${data.sample.length}</p>
                    </div>`;
                } else {
                    html += `<div class="test error">
                        <h3>❌ Ошибка Airtable</h3>
                        <p>Код: ${data.code || 'N/A'}</p>
                        <p>Ошибка: ${data.details || data.error || 'Неизвестная ошибка'}</p>
                        <p>Подсказка: ${data.hint || ''}</p>
                        <p>Детали: ${JSON.stringify(data, null, 2)}</p>
                    </div>`;
                }
            } catch (e) {
                console.error('Airtable test error:', e);
                html += `<div class="test error">
                    <h3>❌ Ошибка подключения к Airtable</h3>
                    <p>Ошибка: ${e.message}</p>
                    <p>Тип: ${e.name}</p>
                </div>`;
            }
            
            // Test Airtable Tables
            const tables = [
                { name: 'Страны', tableId: 'tble0eh9mstZeBKxM', viewId: 'viw4xRveasCiSwUzF' },
                { name: 'Регионы', tableId: 'tblbSajWkzI8X7M4U', viewId: 'viwQKtna9sVP4kb2K' },
                { name: 'Города', tableId: 'tblHaHc9NV0mA8bSa', viewId: 'viwWMNPxORlN0hpV8' },
                { name: 'POI', tableId: 'tblVCmFcHRpXUT24y', viewId: 'viwttimtGAX67EyZt' }
            ];
            
            for (const table of tables) {
                try {
                    console.log(`Testing ${table.name} table...`);
                    const res = await fetch(`/api/test-proxy.php?provider=airtable&base_id=apppwhjFN82N9zNqm&table_id=${table.tableId}`);
                    
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    
                    const data = await res.json();
                    console.log(`${table.name} response:`, data);
                    
                    if (data.ok) {
                        html += `<div class="test success">
                            <h3>✅ Таблица "${table.name}" работает</h3>
                            <p>Table ID: ${table.tableId}</p>
                            <p>View ID: ${table.viewId}</p>
                            <p>Записей в выборке: ${data.records_count || 0}</p>
                            ${data.sample_record ? `<p>Пример записи: ${JSON.stringify(data.sample_record.fields || {}, null, 2)}</p>` : ''}
                        </div>`;
                    } else {
                        html += `<div class="test error">
                            <h3>❌ Ошибка таблицы "${table.name}"</h3>
                            <p>Ошибка: ${data.error || 'Неизвестная ошибка'}</p>
                            <p>Детали: ${JSON.stringify(data, null, 2)}</p>
                        </div>`;
                    }
                } catch (e) {
                    console.error(`${table.name} test error:`, e);
                    html += `<div class="test error">
                        <h3>❌ Ошибка подключения к таблице "${table.name}"</h3>
                        <p>Ошибка: ${e.message}</p>
                    </div>`;
                }
            }
            
            // Test regions
            try {
                const res = await fetch('/api/data-api.php?action=regions');
                const data = await res.json();
                
                if (data.ok) {
                    html += `<div class="test success">
                        <h3>✅ Регионы API работает</h3>
                        <p>Загружено регионов: ${data.items.length}</p>
                        <ul>
                            ${data.items.slice(0, 5).map(r => `<li>${r.name_ru}</li>`).join('')}
                        </ul>
                    </div>`;
                } else {
                    html += `<div class="test error">
                        <h3>❌ Ошибка регионов API</h3>
                        <p>${data.error || 'Неизвестная ошибка'}</p>
                    </div>`;
                }
            } catch (e) {
                html += `<div class="test error">
                    <h3>❌ Ошибка подключения к регионам</h3>
                    <p>${e.message}</p>
                </div>`;
            }
            
            results.innerHTML = html;
        }
        
        // Run test on page load
        testAPI();
    </script>
</body>
</html>
