name: Sync Airtable Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 UTC

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      API_BASE: ${{ secrets.API_BASE }}
      SECRET_DIR: ${{ secrets.SECRET_DIR }}
      SECRET_FILE: ${{ secrets.SECRET_DIR }}/airtable.json
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH key
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        echo "SSH key ready"
        
    - name: Sync Airtable data
      shell: bash
      run: |
        set -euo pipefail
        echo "üîÑ Starting Airtable sync..."
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        SYNC_RESULT=$(ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          cd ${{ secrets.SERVER_PATH }} &&
          php api/sync-airtable-filtering.php
        ")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        echo "Sync result: $SYNC_RESULT"
        
        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º JSON –æ—Ç–≤–µ—Ç
        if echo "$SYNC_RESULT" | jq -e '.ok == true' > /dev/null; then
          echo "‚úÖ Airtable sync completed successfully!"
          echo "Stats: $(echo "$SYNC_RESULT" | jq '.stats')"
        else
          echo "‚ùå Airtable sync failed!"
          echo "Error: $(echo "$SYNC_RESULT" | jq '.error // "Unknown error"')"
          exit 1
        fi
