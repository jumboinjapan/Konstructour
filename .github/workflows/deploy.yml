name: Deploy to Bluehost

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH key
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        echo "SSH key ready"
        
    - name: Deploy to server
      shell: bash
      run: |
        set -euo pipefail
        echo "ðŸš€ Starting deployment..."
        
        # Clean up old backups and ensure directory exists
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          # Remove old backup directories
          rm -rf '${{ secrets.SERVER_PATH }}_backup_'*
          echo 'Old backups cleaned up'
          
          # Ensure main directory exists
          if [ ! -d '${{ secrets.SERVER_PATH }}' ]; then
            mkdir -p '${{ secrets.SERVER_PATH }}'
            echo 'Directory created'
          fi
        "
        
        # Sync files
        rsync -avz --delete --rsync-path='rsync' \
          --exclude='api/config.php' \
          --exclude='api/backups/' \
          -e "ssh -i ~/.ssh/id_rsa" \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.github' \
          --exclude='*.log' \
          ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PATH }}/
        
        # Set permissions
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          find '${{ secrets.SERVER_PATH }}' -type f -exec chmod 644 {} \;
          find '${{ secrets.SERVER_PATH }}' -type d -exec chmod 755 {} \;
          echo 'âœ… File permissions set'
        "
        
        # Bootstrap Airtable secrets (FORCE CREATE)
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' <<'REMOTE'
        set -euo pipefail
        SECRET_DIR=/var/konstructour/secrets
        SECRET_FILE="$SECRET_DIR/airtable.json"
        sudo mkdir -p "$SECRET_DIR"
        sudo chown www-data:www-data "$SECRET_DIR"
        sudo chmod 700 "$SECRET_DIR"
        TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        sudo tee "$SECRET_FILE" >/dev/null <<JSON
        {"current":{"token":"${{ secrets.AIRTABLE_PAT }}","since":"$TS"},"next":{"token":null,"since":null}}
        JSON
        sudo chown www-data:www-data "$SECRET_FILE"
        sudo chmod 600 "$SECRET_FILE"
        if sudo -u www-data test -r "$SECRET_FILE"; then
          echo "âœ… Secret readable by PHP"
        else
          echo "âŒ Secret NOT readable by PHP"; exit 1
        fi
        REMOTE
        
        # Final verification
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          echo 'ðŸ” Verifying deployment...'
          if [ -f '/var/konstructour/secrets/airtable.json' ]; then
            echo 'âœ… Secret file exists'
            if sudo -u www-data test -r /var/konstructour/secrets/airtable.json; then
              echo 'âœ… Secret file is readable by PHP'
            else
              echo 'âŒ Secret file is not readable by PHP'
            fi
          else
            echo 'âŒ Secret file does not exist'
          fi
          echo 'âœ… Deployment completed!'
        "