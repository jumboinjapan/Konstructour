name: Deploy to Bluehost

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      API_BASE: ${{ secrets.API_BASE }}
      SECRET_DIR: ${{ secrets.SECRET_DIR }}
      SECRET_FILE: ${{ secrets.SECRET_DIR }}/airtable.json
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH key
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        echo "SSH key ready"
        
    - name: Deploy to server
      shell: bash
      run: |
        set -euo pipefail
        echo "ðŸš€ Starting deployment..."
        
        # Clean up old backups and ensure directory exists
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          # Remove old backup directories
          rm -rf '${{ secrets.SERVER_PATH }}_backup_'*
          echo 'Old backups cleaned up'
          
          # Ensure main directory exists
          if [ ! -d '${{ secrets.SERVER_PATH }}' ]; then
            mkdir -p '${{ secrets.SERVER_PATH }}'
            echo 'Directory created'
          fi
        "
        
        # Sync files
        rsync -avz --delete --rsync-path='rsync' \
          --exclude='api/config.php' \
          --exclude='api/backups/' \
          -e "ssh -i ~/.ssh/id_rsa" \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.github' \
          --exclude='*.log' \
          ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PATH }}/
        
        # Set permissions
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          find '${{ secrets.SERVER_PATH }}' -type f -exec chmod 644 {} \;
          find '${{ secrets.SERVER_PATH }}' -type d -exec chmod 755 {} \;
          echo 'âœ… File permissions set'
        "
        
        # Bootstrap Airtable secrets (NO SUDO, user-scope)
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' <<'REMOTE'
        set -euo pipefail
        : "${SECRET_DIR:=${HOME}/konstructour/secrets}"
        : "${SECRET_FILE:=${SECRET_DIR}/airtable.json}"

        echo "ðŸ”§ Using SECRET_DIR=$SECRET_DIR"
        mkdir -p "$SECRET_DIR"
        chmod 700 "$SECRET_DIR" || true  # Ð½Ð° ÑˆÐ°Ñ€ÐµÐ´-Ñ…Ð¾ÑÑ‚Ð¸Ð½Ð³Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ðµ Ð´Ð°Ñ‚ÑŒ 700 â€” Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ

        TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        # Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð»Ð° Ð½ÐµÑ‚ â€” ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼. Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ â€” Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ‚Ð¾ÐºÐµÐ½.
        cat > "$SECRET_FILE" <<JSON
        {"current":{"token":"${{ secrets.AIRTABLE_PAT }}","since":"$TS"},"next":{"token":null,"since":null}}
        JSON

        chmod 600 "$SECRET_FILE" || true

        # Ð’ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð½Ð° Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼
        if [ -r "$SECRET_FILE" ]; then
          echo "âœ… Secret file created and readable: $SECRET_FILE"
        else
          echo "âŒ Secret file exists but NOT readable: $SECRET_FILE"; exit 1
        fi
        REMOTE
        
        # Final verification (NO SUDO)
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' <<'REMOTE'
        set -euo pipefail
        : "${SECRET_DIR:=${HOME}/konstructour/secrets}"
        : "${SECRET_FILE:=${SECRET_DIR}/airtable.json}"

        echo 'ðŸ” Verifying deployment...'
        if [ -f "$SECRET_FILE" ]; then
          echo "âœ… Secret file exists: $SECRET_FILE"
          if [ -r "$SECRET_FILE" ]; then
            echo 'âœ… Secret file is readable'
          else
            echo 'âŒ Secret file is not readable'; exit 1
          fi
        else
          echo 'âŒ Secret file does not exist'; exit 1
        fi
        echo 'âœ… Deployment completed!'
        REMOTE