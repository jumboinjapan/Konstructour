name: Deploy to Bluehost

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      API_BASE: ${{ secrets.API_BASE }}
      SECRET_DIR: ${{ secrets.SECRET_DIR }}
      SECRET_FILE: ${{ secrets.SECRET_DIR }}/airtable.json
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH key
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        echo "SSH key ready"
        
    - name: Deploy to server
      shell: bash
      run: |
        set -euo pipefail
        echo "üöÄ Starting deployment..."
        
        # Clean up old backups and ensure directory exists
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          # Remove old backup directories
          rm -rf '${{ secrets.SERVER_PATH }}_backup_'*
          echo 'Old backups cleaned up'
          
          # Ensure main directory exists
          if [ ! -d '${{ secrets.SERVER_PATH }}' ]; then
            mkdir -p '${{ secrets.SERVER_PATH }}'
            echo 'Directory created'
          fi
        "
        
        # Sync files
        rsync -avz --delete --rsync-path='rsync' \
          --exclude='api/config.php' \
          --exclude='api/backups/' \
          -e "ssh -i ~/.ssh/id_rsa" \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.github' \
          --exclude='*.log' \
          ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PATH }}/
        
        # Set permissions
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          find '${{ secrets.SERVER_PATH }}' -type f -exec chmod 644 {} \;
          find '${{ secrets.SERVER_PATH }}' -type d -exec chmod 755 {} \;
          echo '‚úÖ File permissions set'
        "
        
        # Bootstrap Airtable secrets (NO SUDO, user-scope)
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' <<'REMOTE'
        set -euo pipefail
        : "${SECRET_DIR:=${HOME}/konstructour/secrets}"
        : "${SECRET_FILE:=${SECRET_DIR}/airtable.json}"

        echo "üîß Using SECRET_DIR=$SECRET_DIR"
        mkdir -p "$SECRET_DIR"
        chmod 700 "$SECRET_DIR" || true  # –Ω–∞ —à–∞—Ä–µ–¥-—Ö–æ—Å—Ç–∏–Ω–≥–µ –º–æ–∂–Ω–æ –Ω–µ –¥–∞—Ç—å 700 ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É

        TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω.
        cat > "$SECRET_FILE" <<JSON
        {"current":{"token":"${{ secrets.AIRTABLE_PAT }}","since":"$TS"},"next":{"token":null,"since":null}}
        JSON

        chmod 600 "$SECRET_FILE" || true

        # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ —á—Ç–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        if [ -r "$SECRET_FILE" ]; then
          echo "‚úÖ Secret file created and readable: $SECRET_FILE"
        else
          echo "‚ùå Secret file exists but NOT readable: $SECRET_FILE"; exit 1
        fi
        REMOTE
        
        # Final verification (NO SUDO)
        ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' <<'REMOTE'
        set -euo pipefail
        : "${SECRET_DIR:=${HOME}/konstructour/secrets}"
        : "${SECRET_FILE:=${SECRET_DIR}/airtable.json}"

        echo 'üîç Verifying deployment...'
        if [ -f "$SECRET_FILE" ]; then
          echo "‚úÖ Secret file exists: $SECRET_FILE"
          if [ -r "$SECRET_FILE" ]; then
            echo '‚úÖ Secret file is readable'
          else
            echo '‚ùå Secret file is not readable'; exit 1
          fi
        else
          echo '‚ùå Secret file does not exist'; exit 1
        fi
        echo '‚úÖ Deployment completed!'
        REMOTE
        
        # Health checks
        echo "üîé Checking Airtable health‚Ä¶"
        HEALTH_JSON=$(curl -sS "$API_BASE/api/health-airtable.php" || echo '{}')
        echo "$HEALTH_JSON" | jq . || echo "$HEALTH_JSON"

        echo "üîé Proxy WhoAmI‚Ä¶"
        curl -sS -X POST "$API_BASE/api/test-proxy-secure.php?provider=airtable" \
          -H "Content-Type: application/json" \
          -d '{"whoami":true}' || true
        echo

        if echo "$HEALTH_JSON" | jq -e '.ok == true' >/dev/null 2>&1; then
          echo "‚úÖ Airtable Health OK"
        else
          echo "‚ùå Airtable Health NOT OK"
          exit 1
        fi