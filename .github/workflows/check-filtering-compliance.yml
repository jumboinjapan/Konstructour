name: Check Filtering.md Compliance

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  check-compliance:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        
    - name: Check Filtering.md compliance
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏—è Filtering.md..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
        TEST_FILES=$(find . -name "test-*.php" -o -name "create-test-*.php" -o -name "sample-*.php" -o -name "mock-*.php" | grep -v node_modules | grep -v .git)
        if [ ! -z "$TEST_FILES" ]; then
          echo "‚ùå –ù–∞–π–¥–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã:"
          echo "$TEST_FILES"
          exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ data-api.php –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (–∫—ç—à + Airtable)
        if ! grep -q "getCachedRegions\|cacheRegions" api/data-api.php; then
          echo "‚ùå data-api.php –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ"
          exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SecretManager
        if ! grep -q "secret-manager.php" api/data-api.php; then
          echo "‚ùå data-api.php –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SecretManager"
          exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å enforce-filtering.php
        if [ ! -f "api/enforce-filtering.php" ]; then
          echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç api/enforce-filtering.php"
          exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ PHP API (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ PHP API..."
        if command -v php >/dev/null 2>&1; then
          # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API
          cat > test_compliance.php << 'EOF'
<?php
// –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ API –±–µ–∑ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    if (!file_exists('api/enforce-filtering.php')) {
        echo "‚ùå enforce-filtering.php –Ω–µ –Ω–∞–π–¥–µ–Ω\n";
        exit(1);
    }
    
    if (!file_exists('api/secret-manager.php')) {
        echo "‚ùå secret-manager.php –Ω–µ –Ω–∞–π–¥–µ–Ω\n";
        exit(1);
    }
    
    if (!file_exists('api/data-api.php')) {
        echo "‚ùå data-api.php –Ω–µ –Ω–∞–π–¥–µ–Ω\n";
        exit(1);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ data-api.php
    $dataApiContent = file_get_contents('api/data-api.php');
    if (strpos($dataApiContent, 'getCachedRegions') === false) {
        echo "‚ùå data-api.php –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç getCachedRegions\n";
        exit(1);
    }
    
    if (strpos($dataApiContent, 'secret-manager.php') === false) {
        echo "‚ùå data-api.php –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç secret-manager.php\n";
        exit(1);
    }
    
    echo "‚úÖ PHP API –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã\n";
} catch (Exception $e) {
    echo "‚ùå –û—à–∏–±–∫–∞ PHP API: " . $e->getMessage() . "\n";
    exit(1);
}
EOF
          
          php test_compliance.php
          rm test_compliance.php
        fi
        
        echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
